var Ee=Object.defineProperty;var $e=(t,e,s)=>e in t?Ee(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var R=(t,e,s)=>$e(t,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function s(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(r){if(r.ep)return;r.ep=!0;const n=s(r);fetch(r.href,n)}})();const de=["unarmed","knife","spear","archery","throwing","shield","crafting"],He=50,Be=1.3,qe={unarmed:"Unarmed",knife:"Knife",spear:"Spear",archery:"Archery",throwing:"Throwing",shield:"Shield",crafting:"Crafting"},Te={unarmed:"Fighting with fists. Increases unarmed damage and hit chance.",knife:"Skill with knives and daggers. Faster attacks, more crits.",spear:"Mastery of spears and polearms. Higher damage and reach.",archery:"Proficiency with bows. Better accuracy and damage at range.",throwing:"Throwing weapons accurately. Rocks, javelins, etc.",shield:"Shield blocking effectiveness. Better block chance and reduction.",crafting:"General crafting ability. Better quality items, fewer failures."};function Ie(t=0){return{level:t,xp:0,xpToNextLevel:me(t+1),lastGainedAt:-1}}function Pe(){const t={};for(const e of de)t[e]=Ie(0);return t}function me(t){return Math.floor(He*Math.pow(t,Be))}function j(t,e,s=0){t.xp+=e,t.lastGainedAt=s;let a=0;for(;t.xp>=t.xpToNextLevel;)t.xp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=me(t.level+1),a++;return{levelsGained:a,newLevel:t.level}}function Re(t){return t*.01}function De(t){return .25/(1+t/50)}function Oe(t){const e=Math.random()*100,s=t/(t+100),a=60*(1-s),r=a+35-20*s,n=r+4+46*s,i=n+.9+27.1*s;return e<a?"poor":e<r?"normal":e<n?"good":e<i?"excellent":"masterwork"}const H={combatHit:10,combatMiss:3,craftSuccess:15,craftFailure:5};function xe(t){return t&&{stoneKnife:"knife",ironKnife:"knife",steelKnife:"knife",stoneSpear:"spear",ironSpear:"spear",steelSpear:"spear",bow:"archery",longbow:"archery",crossbow:"archery"}[t]||"unarmed"}const X=["vitality","strength","agility","precision","endurance","arcane","luck"],Ge=100,Ne=1.5,_e=3,Ye=2;function fe(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function je(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function Fe(t=1,e){const s=fe();return e&&Object.assign(s,e),{level:t,xp:0,xpToNextLevel:he(t+1),freeStatPoints:0,stats:s,statUsage:je()}}function he(t){return Math.floor(Ge*Math.pow(t,Ne))}function Ue(t,e){t.xp+=e;let s=0;const a=[];for(;t.xp>=t.xpToNextLevel;){t.xp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=he(t.level+1),t.freeStatPoints+=Ye,s++;const r=We(t,_e);a.push(...r)}return{levelsGained:s,autoStats:a}}function We(t,e){const s=[],a=t.statUsage,r=Object.values(a).reduce((n,i)=>n+i,0);for(let n=0;n<e;n++){let i;if(r===0||Math.random()<.3)i=X[Math.floor(Math.random()*X.length)];else{let o=Math.random()*r;i="vitality";for(const[c,l]of Object.entries(a))if(o-=l,o<=0){i=c;break}}t.stats[i]++,s.push(i)}return Object.keys(t.statUsage).forEach(n=>{t.statUsage[n]=0}),s}function Ke(t,e){return t.freeStatPoints<=0?!1:(t.freeStatPoints--,t.stats[e]++,!0)}function A(t,e,s=1){t.statUsage[e]+=s}function ge(t){return t.vitality*5+t.endurance*2}function Xe(t){const e=t.strength,s=Math.floor(t.strength*t.agility*.05);return e+s}function Ve(t){const e=t.precision,s=Math.floor(t.precision*t.agility*.05);return e+s}function Qe(t,e,s=0){return t.precision*5+t.agility*3+e*2+s+10}function ze(t,e,s=0){return Math.max(0,t.agility*5+t.luck*2+e*2+10-s)}function Je(t,e,s=0){return s===0?0:t.strength*3+t.agility*2+e*2+s}function Ze(t,e=0){return t.strength*2+e}function et(t,e){return t===0?0:t/(t+e*.7)}function tt(t,e,s,a){const r=s+1,n=a+1,i=2*r/(r+n);return t/(t+e)*i}function st(t){return t.agility*2}function pe(t){return t.endurance}function at(t){return Math.min(.5,t.endurance*.01)}function nt(t){return Math.min(.3,t.luck*.015+t.precision*.005)}function rt(t){return 1.5+t.luck*.02}function it(t){return t.luck*.05}function F(t,e,s,a={}){const{attackerWeaponAccuracy:r=0,attackerSkillLevel:n=0,defenderArmorPenalty:i=0,defenderBlockBonus:o=0,defenderShieldArmor:c=0,defenderShieldSkillLevel:l=0}=a,m=t.levelInfo.stats,u=e.levelInfo.stats,d=t.levelInfo.level,h=e.levelInfo.level,f=n,p=Qe(m,d,r+f),v=1+Re(n);let g=Math.floor(s*v);const b=nt(m),w=Math.random()<b;if(w){const T=rt(m);g=Math.floor(g*T)}if(o>0){const T=l,Se=Je(u,h,o+T),Le=et(Se,p);if(Math.random()<Le){const Me=Ze(u,c),Ae=Math.max(1,g-Me);return{hit:!0,dodged:!1,blocked:!0,critical:w,damage:Ae,message:w?"blocked critical":"blocked"}}}const L=ze(u,h,i),M=tt(p,L,d,h),$=Math.random();if($>M){const T=$<M+.15;return{hit:!1,dodged:T,blocked:!1,critical:!1,damage:0,message:T?"dodged":"missed"}}return{hit:!0,dodged:!1,blocked:!1,critical:w,damage:g,message:w?"critical":"hit"}}const V={vitality:"Vitality",strength:"Strength",agility:"Agility",precision:"Precision",endurance:"Endurance",arcane:"Arcane",luck:"Luck"},ot={vitality:"+5 Max HP per point",strength:"+1 Melee damage, +3 Block Rating, block damage reduction",agility:"+5 Dodge Rating, +3 Attack Rating, +2 Speed",precision:"+5 Attack Rating, +1 Ranged damage",endurance:"+1 Max Saturation, reduces hunger decay",arcane:"Magic capacity (future)",luck:"+2 Dodge Rating, crit chance, loot bonus"},ct={poor:.7,normal:1,good:1.15,excellent:1.3,masterwork:1.5},lt={berries:{id:"berries",name:"Berries",description:"Sweet, ripe berries. Can be eaten for sustenance.",stackable:!0,tags:["food","raw","foraged"],weight:.1,saturationGain:4},sticks:{id:"sticks",name:"Sticks",description:"Dry wooden sticks. Useful for crafting or as a makeshift weapon.",stackable:!0,tags:["material","wood","foraged","weapon"],weight:.5,equipSlot:"mainHand",minDamage:1,maxDamage:4,strengthScaling:.3,agilityScaling:.2,accuracy:0},rocks:{id:"rocks",name:"Rocks",description:"Sturdy rocks. Can be thrown or used for crafting.",stackable:!0,tags:["material","stone","foraged","throwable"],weight:2},fiber:{id:"fiber",name:"Fiber",description:"Plant fiber from tall grass. Used for crafting rope and bindings.",stackable:!0,tags:["material","foraged"],weight:.2},rawMeat:{id:"rawMeat",name:"Raw Meat",description:"Raw meat from a slain creature. Should be cooked before eating.",stackable:!0,tags:["food","raw","meat"],weight:1,saturationGain:2},cookedMeat:{id:"cookedMeat",name:"Cooked Meat",description:"Well-cooked meat. Nutritious and filling.",stackable:!0,tags:["food","cooked","meat"],weight:1,saturationGain:8},rawLeather:{id:"rawLeather",name:"Raw Leather",description:"Untreated animal hide. Must be processed at a campfire with a knife.",stackable:!0,tags:["material","loot"],weight:2},venomGland:{id:"venomGland",name:"Venom Gland",description:"A gland filled with potent venom. Handle with care.",stackable:!0,tags:["material","loot","poison"],weight:.3},leather:{id:"leather",name:"Leather",description:"Treated leather, ready for crafting armor.",stackable:!0,tags:["material","crafted"],weight:1.5},arrow:{id:"arrow",name:"Arrow",description:"A simple arrow. Requires a bow to use.",stackable:!0,tags:["ammo","crafted"],weight:.1},stoneKnife:{id:"stoneKnife",name:"Stone Knife",description:"A sharp flint knife. Good for combat and processing leather.",stackable:!1,tags:["weapon","tool","crafted"],weight:1,equipSlot:"mainHand",minDamage:3,maxDamage:8,strengthScaling:.5,agilityScaling:1,accuracy:15},stoneSpear:{id:"stoneSpear",name:"Stone Spear",description:"A spear with a stone tip. Decent reach and damage.",stackable:!1,tags:["weapon","crafted"],weight:2.5,equipSlot:"mainHand",minDamage:5,maxDamage:12,strengthScaling:1,agilityScaling:.5,accuracy:5},bow:{id:"bow",name:"Bow",description:"A wooden bow. Requires arrows. Effective against fleeing enemies.",stackable:!1,tags:["weapon","ranged","crafted"],weight:1.5,equipSlot:"mainHand",twoHanded:!0,minDamage:4,maxDamage:10,precisionScaling:1,agilityScaling:.3,rangedBonus:15,accuracy:20},woodenShield:{id:"woodenShield",name:"Wooden Shield",description:"A crude wooden shield. Block attacks to reduce damage.",stackable:!1,tags:["armor","shield","crafted"],weight:3,equipSlot:"offHand",armorBonus:5,blockBonus:25},leatherHelm:{id:"leatherHelm",name:"Leather Helm",description:"A hardened leather helmet.",stackable:!1,tags:["armor","crafted"],weight:1,equipSlot:"head",armorBonus:3,dodgePenalty:2},leatherChest:{id:"leatherChest",name:"Leather Chest",description:"A leather chestpiece offering decent protection.",stackable:!1,tags:["armor","crafted"],weight:3,equipSlot:"chest",armorBonus:6,dodgePenalty:5},leatherLegs:{id:"leatherLegs",name:"Leather Leggings",description:"Leather leg protection.",stackable:!1,tags:["armor","crafted"],weight:2,equipSlot:"legs",armorBonus:4,dodgePenalty:3},leatherBoots:{id:"leatherBoots",name:"Leather Boots",description:"Sturdy leather boots.",stackable:!1,tags:["armor","crafted"],weight:1.5,equipSlot:"feet",armorBonus:2,dodgePenalty:1},campfire:{id:"campfire",name:"Campfire",description:"A portable campfire kit. Place it to cook meat.",stackable:!1,tags:["structure","crafted"],weight:5}};function y(t){return lt[t]}function ut(t,e){const s=y(t);if(!s)throw new Error(`Unknown item: ${t}`);const a=ct[e],r={itemId:t,quality:e};return s.minDamage!==void 0&&(r.minDamage=Math.max(1,Math.floor(s.minDamage*a))),s.maxDamage!==void 0&&(r.maxDamage=Math.max(1,Math.floor(s.maxDamage*a))),s.armorBonus!==void 0&&(r.armorBonus=Math.max(1,Math.floor(s.armorBonus*a))),s.blockBonus!==void 0&&(r.blockBonus=Math.max(1,Math.floor(s.blockBonus*a))),s.accuracy!==void 0&&(r.accuracy=Math.floor(s.accuracy*a)),r}function te(t){const e=y(t);return e?e.equipSlot!==void 0||e.tags.includes("weapon")||e.tags.includes("armor")||e.tags.includes("shield"):!1}function ye(t,e,s={}){const{maxTicks:a=1e4,speed:r=100,carryCapacity:n=30,maxHealth:i=100,damage:o=10,saturation:c=10,maxSaturation:l=20,inventory:m={},equipment:u={},equipmentInstances:d={},actions:h=[],level:f=1,stats:p,skills:v}=s,g=Fe(f,p),b=i+ge(g.stats),w=l+pe(g.stats);return{id:t,name:e,ticks:a,maxTicks:a,speed:r,carryCapacity:n,health:b,maxHealth:b,damage:o,saturation:c,maxSaturation:w,inventory:{...m},equipment:{...u},equipmentInstances:{...d},actions:[...h],levelInfo:g,skills:v??Pe()}}function se(t,e=100,s=20){const a=t.levelInfo.stats,r=t.maxHealth;t.maxHealth=e+ge(a),t.maxSaturation=s+pe(a),t.maxHealth>r&&(t.health+=t.maxHealth-r),t.health=Math.min(t.health,t.maxHealth),t.saturation=Math.min(t.saturation,t.maxSaturation)}function Q(t,e){return t.ticks>=e.tickCost}function z(t,e){t.ticks=Math.min(t.ticks+e,t.maxTicks)}function dt(t,e){return t.ticks<e?!1:(t.ticks-=e,!0)}function P(t,e){t.health=Math.max(0,t.health-e)}function mt(t,e){t.health=Math.min(t.maxHealth,t.health+e)}function E(t){return t.health>0}function ft(t,e){t.saturation=Math.min(t.maxSaturation,t.saturation+e)}function ae(t,e){t.saturation=Math.max(0,t.saturation-e)}const ht=10;function gt(t){return t.saturation>ht}function pt(t){return t.saturation<=0}function yt(t){return 5}function k(t,e){return t.inventory[e]??0}function C(t,e,s){t.inventory[e]=(t.inventory[e]??0)+s}function N(t,e,s){const a=t.inventory[e]??0;return a<s?!1:(t.inventory[e]=a-s,!0)}function ke(t){let e=0;for(const[s,a]of Object.entries(t.inventory))if(a>0){const r=y(s);r&&(e+=r.weight*a)}return e}function kt(t){return ke(t)/t.carryCapacity}function ve(t){const e=kt(t);return e<=.5?20*(1-e*2):e<=1?0:-50*(e-1)}function B(t){const e=st(t.levelInfo.stats);return Math.max(10,t.speed+ve(t)+e)}function vt(t,e,s){const a=y(e);return!a||!a.equipSlot||k(t,e)<=0?!1:(a.twoHanded?(Y(t,"mainHand"),Y(t,"offHand"),t.equipment.mainHand=e,t.equipment.offHand=e):(Y(t,s),t.equipment[s]=e),N(t,e,1),!0)}function Y(t,e){const s=t.equipment[e];if(!s)return!1;const a=y(s);return a!=null&&a.twoHanded&&e==="mainHand"||a!=null&&a.twoHanded&&e==="offHand"?(delete t.equipment.mainHand,delete t.equipment.offHand,C(t,s,1)):(delete t.equipment[e],C(t,s,1)),!0}function O(t){let e=0;const s=new Set;for(const[a,r]of Object.entries(t.equipment))if(r&&!s.has(r)){s.add(r);const n=t.equipmentInstances[a];if(n&&n.armorBonus!==void 0)e+=n.armorBonus;else{const i=y(r);i!=null&&i.armorBonus&&(e+=i.armorBonus)}}return e}function x(t){let e=0;const s=new Set;for(const a of Object.values(t.equipment))if(a&&!s.has(a)){s.add(a);const r=y(a);r!=null&&r.rangedBonus&&(e+=r.rangedBonus)}return e}const ne=1,re=3;function bt(t){const e=t.equipment.mainHand;if(!e)return{min:ne,max:re};const s=t.equipmentInstances.mainHand;if(s&&s.minDamage!==void 0&&s.maxDamage!==void 0)return{min:s.minDamage,max:s.maxDamage};const a=y(e);return(a==null?void 0:a.minDamage)!==void 0&&(a==null?void 0:a.maxDamage)!==void 0?{min:a.minDamage,max:a.maxDamage}:{min:ne,max:re}}function wt(t){const e=t.equipment.mainHand,s=t.levelInfo.stats;if(!e)return Math.floor(s.strength*.5+s.agility*.3);const a=y(e);if(!a)return Math.floor(s.strength*.5+s.agility*.3);let r=0;return a.strengthScaling&&(r+=s.strength*a.strengthScaling),a.agilityScaling&&(r+=s.agility*a.agilityScaling),a.precisionScaling&&(r+=s.precision*a.precisionScaling),Math.floor(r)}function be(t){const e=bt(t),s=wt(t);return{min:e.min+s,max:e.max+s}}function we(t){const e=be(t);return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function G(t,e){const s=e/(e+20);return Math.max(1,Math.floor(t*(1-s)))}function J(t){const e=t.equipment.mainHand;if(!e)return 0;const s=t.equipmentInstances.mainHand;if(s&&s.accuracy!==void 0)return s.accuracy;const a=y(e);return(a==null?void 0:a.accuracy)??0}function U(t){let e=0;const s=new Set;for(const a of Object.values(t.equipment))if(a&&!s.has(a)){s.add(a);const r=y(a);r!=null&&r.dodgePenalty&&(e+=r.dodgePenalty)}return e}function Ct(t){const e=t.equipment.offHand;if(!e)return 0;const s=t.equipmentInstances.offHand;if(s&&s.blockBonus!==void 0)return s.blockBonus;const a=y(e);return(a==null?void 0:a.blockBonus)??0}function St(t){const e=t.equipment.offHand;if(!e)return 0;const s=t.equipmentInstances.offHand;if(s&&s.armorBonus!==void 0)return s.armorBonus;const a=y(e);return a!=null&&a.blockBonus?a.armorBonus??0:0}const Ce={berryBush:{id:"berryBush",name:"Berry Bush",description:"A bush laden with ripe berries.",gatherActionId:"gather-berries",discoveryChance:.2,discoveryMessage:"You stumble upon a bush laden with ripe berries!",depletionChance:.6,dropOffChance:.15},fallenBranches:{id:"fallenBranches",name:"Fallen Branches",description:"Some fallen branches on the ground.",gatherActionId:"gather-sticks",discoveryChance:.2,discoveryMessage:"You find some fallen branches on the ground.",depletionChance:.5,dropOffChance:.1},rockyOutcrop:{id:"rockyOutcrop",name:"Rocky Outcrop",description:"Some useful rocks jutting from the ground.",gatherActionId:"gather-rocks",discoveryChance:.15,discoveryMessage:"You notice some useful rocks nearby.",depletionChance:.4,dropOffChance:.05},tallGrass:{id:"tallGrass",name:"Tall Grass",description:"A patch of tall grass with useful fibers.",gatherActionId:"gather-fiber",discoveryChance:.2,discoveryMessage:"You find a patch of tall grass.",depletionChance:.5,dropOffChance:.12}};function ie(t){return Ce[t]}function Lt(){return Object.values(Ce)}function Mt(){const t=Lt();let e=0;const s=Math.random();for(const a of t)if(e+=a.discoveryChance,s<e)return a;return null}const At={campfire:{id:"campfire",name:"Craft Campfire",description:"Craft a portable campfire using sticks and rocks.",inputs:{sticks:5,rocks:3},outputs:{campfire:1},tickCost:400},cookedMeat:{id:"cookedMeat",name:"Cook Meat",description:"Cook raw meat on the campfire.",inputs:{rawMeat:1},outputs:{cookedMeat:1},tickCost:200,requiresCampfire:!0},leather:{id:"leather",name:"Process Leather",description:"Process raw leather at the campfire. Requires a knife.",inputs:{rawLeather:2},outputs:{leather:1},tickCost:300,requiresCampfire:!0},stoneKnife:{id:"stoneKnife",name:"Craft Stone Knife",description:"Craft a stone knife from rocks and sticks.",inputs:{rocks:2,sticks:1},outputs:{stoneKnife:1},tickCost:250},stoneSpear:{id:"stoneSpear",name:"Craft Stone Spear",description:"Craft a stone spear from rocks, sticks, and fiber.",inputs:{rocks:1,sticks:3,fiber:2},outputs:{stoneSpear:1},tickCost:300},bow:{id:"bow",name:"Craft Bow",description:"Craft a bow from sticks and fiber.",inputs:{sticks:3,fiber:5},outputs:{bow:1},tickCost:400},arrow:{id:"arrow",name:"Craft Arrows",description:"Craft arrows from sticks and rocks.",inputs:{sticks:2,rocks:1},outputs:{arrow:5},tickCost:150},woodenShield:{id:"woodenShield",name:"Craft Wooden Shield",description:"Craft a wooden shield from sticks and fiber.",inputs:{sticks:6,fiber:3},outputs:{woodenShield:1},tickCost:350},leatherHelm:{id:"leatherHelm",name:"Craft Leather Helm",description:"Craft a leather helmet.",inputs:{leather:2},outputs:{leatherHelm:1},tickCost:200},leatherChest:{id:"leatherChest",name:"Craft Leather Chest",description:"Craft a leather chestpiece.",inputs:{leather:4},outputs:{leatherChest:1},tickCost:300},leatherLegs:{id:"leatherLegs",name:"Craft Leather Leggings",description:"Craft leather leggings.",inputs:{leather:3},outputs:{leatherLegs:1},tickCost:250},leatherBoots:{id:"leatherBoots",name:"Craft Leather Boots",description:"Craft leather boots.",inputs:{leather:2},outputs:{leatherBoots:1},tickCost:200}};function S(t){return At[t]}function _(t,e,s){if(t.requiresCampfire&&!s.has("campfire"))return{canCraft:!1,reason:"Requires a placed campfire."};for(const[a,r]of Object.entries(t.inputs)){const n=e[a]??0;if(n<r)return{canCraft:!1,reason:`Need ${r} ${a}, have ${n}.`}}return{canCraft:!0}}function W(t,e){for(const[s,a]of Object.entries(t.inputs))e[s]=(e[s]??0)-a;for(const[s,a]of Object.entries(t.outputs))e[s]=(e[s]??0)+a}function q(t,e,s,a,r=0){const{canCraft:n,reason:i}=_(t,s,a);if(!n)return{success:!1,failed:!1,message:i};const o=e.skills.crafting,c=o.level,l=De(c),m=Math.random()<l;for(const[f,p]of Object.entries(t.inputs))s[f]=(s[f]??0)-p;const u=m?H.craftFailure:H.craftSuccess,d=j(o,u,r);if(m)return{success:!1,failed:!0,message:`Crafting failed! Materials were lost. (+${u} crafting XP)`,skillGain:d};const h=[];for(const[f,p]of Object.entries(t.outputs)){const v=te(f)?Oe(c):"normal";for(let g=0;g<p;g++)if(te(f)){const b=ut(f,v);h.push({itemId:f,quality:v,instance:b})}else h.push({itemId:f,quality:"normal"});s[f]=(s[f]??0)+p}return{success:!0,failed:!1,message:Et(h,u),craftedItems:h,skillGain:d}}function Et(t,e){if(!t||t.length===0)return"Crafted successfully!";const a=t[0].quality,r=new Map;for(const o of t)r.set(o.itemId,(r.get(o.itemId)??0)+1);const n=Array.from(r.entries()).map(([o,c])=>c>1?`${c}x ${o}`:o).join(", ");let i="";return a!=="normal"&&(i=` (${a.charAt(0).toUpperCase()+a.slice(1)} quality!)`),`Crafted ${n}${i} (+${e} crafting XP)`}const $t={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(t,e)=>({success:!0,message:"You rest, recovering some energy."})},Ht={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(t,e)=>{var n;if((n=e==null?void 0:e.game)!=null&&n.structures.has("campfire"))return{success:!1,message:"You can't wander off with a campfire burning! Pick it up or smother it first."};const s=Mt();if(s)return{success:!0,message:s.discoveryMessage,foundResource:s.id};const a=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:a[Math.floor(Math.random()*a.length)]}}},Bt={id:"gather-berries",name:"Gather Berries",description:"Pick berries from the bush.",tickCost:150,tags:["gathering","non-combat"],execute:(t,e)=>{const s=2+Math.floor(Math.random()*3);return C(t,"berries",s),{success:!0,message:`You gather ${s} berries. (${k(t,"berries")} total)`}}},qt={id:"gather-sticks",name:"Gather Sticks",description:"Collect sticks from the ground.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const s=2+Math.floor(Math.random()*3);return C(t,"sticks",s),{success:!0,message:`You gather ${s} sticks. (${k(t,"sticks")} total)`}}},Tt={id:"gather-rocks",name:"Gather Rocks",description:"Collect rocks from the ground.",tickCost:120,tags:["gathering","non-combat"],execute:(t,e)=>{const s=1+Math.floor(Math.random()*2);return C(t,"rocks",s),{success:!0,message:`You gather ${s} rocks. (${k(t,"rocks")} total)`}}},It={id:"gather-fiber",name:"Gather Fiber",description:"Collect fiber from tall grass.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const s=3+Math.floor(Math.random()*3);return C(t,"fiber",s),{success:!0,message:`You gather ${s} fiber. (${k(t,"fiber")} total)`}}},Pt={id:"craft-campfire",name:"Craft Campfire",description:"Craft a portable campfire. (5 sticks, 3 rocks)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var i;const s=S("campfire"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:n}=_(s,t.inventory,a);return r?(W(s,t.inventory),{success:!0,message:"You craft a campfire. Place it to cook meat!"}):{success:!1,message:n}}},Rt={id:"place-campfire",name:"Place Campfire",description:"Place your campfire on the ground.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return k(t,"campfire")<=0?{success:!1,message:"You have no campfire to place."}:(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?{success:!1,message:"A campfire is already placed."}:(N(t,"campfire",1),e!=null&&e.game&&e.game.structures.add("campfire"),{success:!0,message:"You place the campfire. You can now cook meat!"})}},Dt={id:"pickup-campfire",name:"Pick Up Campfire",description:"Pick up your placed campfire.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?(e.game.structures.delete("campfire"),C(t,"campfire",1),{success:!0,message:"You pick up the campfire."}):{success:!1,message:"No campfire is placed."}}},Ot={id:"smother-campfire",name:"Smother Campfire",description:"Extinguish and discard your placed campfire.",tickCost:25,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?(e.game.structures.delete("campfire"),{success:!0,message:"You smother the campfire. It is destroyed."}):{success:!1,message:"No campfire is placed."}}},xt={id:"cook-meat",name:"Cook Meat",description:"Cook raw meat on the campfire.",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var i;const s=S("cookedMeat"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:n}=_(s,t.inventory,a);return r?(W(s,t.inventory),{success:!0,message:`You cook the meat. (${k(t,"cookedMeat")} cooked meat)`}):{success:!1,message:n}}},Gt={id:"craft-stone-knife",name:"Craft Stone Knife",description:"Craft a stone knife. (2 rocks, 1 stick)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("stoneKnife"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message+" A fast weapon that scales with agility!"}}},Nt={id:"craft-stone-spear",name:"Craft Stone Spear",description:"Craft a stone spear. (1 rock, 3 sticks, 2 fiber)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("stoneSpear"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message+" A powerful weapon that scales with strength!"}}},_t={id:"craft-bow",name:"Craft Bow",description:"Craft a bow. (3 sticks, 5 fiber)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("bow"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message+" Equip it and craft arrows to shoot!"}}},Yt={id:"craft-arrows",name:"Craft Arrows",description:"Craft 5 arrows. (2 sticks, 1 rock)",tickCost:150,tags:["crafting","non-combat"],execute:(t,e)=>{var i;const s=S("arrow"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:n}=_(s,t.inventory,a);return r?(W(s,t.inventory),{success:!0,message:`You craft 5 arrows. (${k(t,"arrow")} total)`}):{success:!1,message:n}}},jt={id:"craft-wooden-shield",name:"Craft Wooden Shield",description:"Craft a wooden shield. (6 sticks, 3 fiber)",tickCost:350,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("woodenShield"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message+" Equip it for blocking!"}}},Ft={id:"process-leather",name:"Process Leather",description:"Process raw leather at campfire. (2 raw leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var i;const s=S("leather"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:n}=_(s,t.inventory,a);return r?(W(s,t.inventory),{success:!0,message:`You process the leather. (${k(t,"leather")} leather)`}):{success:!1,message:n}}},Ut={id:"craft-leather-helm",name:"Craft Leather Helm",description:"Craft a leather helmet. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("leatherHelm"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message}}},Wt={id:"craft-leather-chest",name:"Craft Leather Chest",description:"Craft a leather chestpiece. (4 leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("leatherChest"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message}}},Kt={id:"craft-leather-legs",name:"Craft Leather Leggings",description:"Craft leather leggings. (3 leather)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("leatherLegs"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message}}},Xt={id:"craft-leather-boots",name:"Craft Leather Boots",description:"Craft leather boots. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var i,o;const s=S("leatherBoots"),a=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,n=q(s,t,t.inventory,a,r);return!n.success&&!n.failed?{success:!1,message:n.message}:n.failed?{success:!0,message:n.message}:{success:!0,message:n.message}}};function Z(t,e,s,a){var n;const r=y(t);return{id:e,name:s,description:`Eat ${((n=r==null?void 0:r.name)==null?void 0:n.toLowerCase())??t} to restore saturation.`,tickCost:a,tags:["consumption","non-combat"],execute:(i,o)=>{var m,u;if(k(i,t)<=0)return{success:!1,message:`You have no ${((m=r==null?void 0:r.name)==null?void 0:m.toLowerCase())??t} to eat.`};N(i,t,1);const l=(r==null?void 0:r.saturationGain)??1;return ft(i,l),{success:!0,message:`You eat the ${((u=r==null?void 0:r.name)==null?void 0:u.toLowerCase())??t}. (+${l} saturation, ${i.saturation}/${i.maxSaturation})`}}}}const Vt=Z("berries","eat-berries","Eat Berries",50),Qt=Z("cookedMeat","eat-cooked-meat","Eat Cooked Meat",75),zt=Z("rawMeat","eat-raw-meat","Eat Raw Meat",50),Jt={id:"attack",name:"Attack",description:"Strike your enemy with equipped weapon.",tickCost:200,tags:["combat","offensive"],execute:(t,e)=>{var b,w,L;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to attack."};const s=e.encounter.enemy;A(t.levelInfo,"strength",1),A(t.levelInfo,"precision",.5);const a=t.equipment.mainHand,r=xe(a),n=we(t),i=J(t),o=U(s),c=t.skills[r].level,l=((w=(b=s.skills)==null?void 0:b.shield)==null?void 0:w.level)??0,m=F(t,s,n,{attackerWeaponAccuracy:i,attackerSkillLevel:c,defenderArmorPenalty:o,defenderShieldSkillLevel:l}),u=m.hit?H.combatHit:H.combatMiss,d=((L=e==null?void 0:e.game)==null?void 0:L.turn)??0,h=j(t.skills[r],u,d);if(!m.hit)return{success:!0,message:m.dodged?`The ${s.name} dodges your attack!`:`You swing at the ${s.name} but miss!`};const f=O(s),p=G(m.damage,f);P(s,p),m.critical&&A(t.levelInfo,"luck",1);const v=m.critical?" Critical hit!":"",g=h.levelsGained>0?` ${r} leveled up!`:"";return E(s)?{success:!0,message:`You strike the ${s.name} for ${p} damage.${v}${g} (${s.health}/${s.maxHealth} HP)`}:{success:!0,message:`You strike the ${s.name} for ${p} damage.${v}${g} Defeated!`,encounterEnded:!0}}},Zt={id:"throw-rock",name:"Throw Rock",description:"Throw a rock at your enemy. Ranged attack.",tickCost:150,tags:["combat","offensive","ranged"],execute:(t,e)=>{var L,M,$;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to throw at."};if(k(t,"rocks")<=0)return{success:!1,message:"You have no rocks to throw."};N(t,"rocks",1);const s=e.encounter.enemy;A(t.levelInfo,"precision",1),A(t.levelInfo,"agility",.3);const a=5,r=10,n=Ve(t.levelInfo.stats);let i=a+n+Math.floor(Math.random()*(r-a+1));const o=x(t),c=e.encounter.enemyFleeing?Math.floor(o/2):0;i+=c;const l=U(s),m=t.skills.throwing.level,u=((M=(L=s.skills)==null?void 0:L.shield)==null?void 0:M.level)??0,d=F(t,s,i,{attackerWeaponAccuracy:5,attackerSkillLevel:m,defenderArmorPenalty:l,defenderShieldSkillLevel:u}),h=d.hit?H.combatHit:H.combatMiss,f=(($=e==null?void 0:e.game)==null?void 0:$.turn)??0,p=j(t.skills.throwing,h,f);if(!d.hit)return{success:!0,message:d.dodged?`The ${s.name} dodges your thrown rock!`:`You throw a rock at the ${s.name} but miss!`,projectileUsed:{type:"rock",outcome:d.dodged?"dodged":"missed"}};d.critical&&A(t.levelInfo,"luck",1);const v=O(s),g=G(d.damage,v);P(s,g);const b=d.critical?" Critical hit!":"",w=p.levelsGained>0?" Throwing leveled up!":"";return E(s)?{success:!0,message:`Your rock hits the ${s.name} for ${g} damage.${b}${w} (${s.health}/${s.maxHealth} HP)`,projectileUsed:{type:"rock",outcome:"hit"}}:{success:!0,message:`Your rock strikes the ${s.name} for ${g} damage.${b}${w} Defeated!`,encounterEnded:!0,projectileUsed:{type:"rock",outcome:"hit"}}}},es={id:"ranged-attack",name:"Shoot Arrow",description:"Fire an arrow at your enemy. Very effective against fleeing targets.",tickCost:180,tags:["combat","offensive","ranged"],execute:(t,e)=>{var w,L,M;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to shoot."};if(t.equipment.mainHand!=="bow")return{success:!1,message:"You need a bow equipped."};if(k(t,"arrow")<=0)return{success:!1,message:"You have no arrows."};N(t,"arrow",1);const a=e.encounter.enemy;A(t.levelInfo,"precision",1.5),A(t.levelInfo,"agility",.5);let r=we(t);const n=x(t),i=e.encounter.enemyFleeing?n:0;r+=i;const o=J(t),c=U(a),l=t.skills.archery.level,m=((L=(w=a.skills)==null?void 0:w.shield)==null?void 0:L.level)??0,u=F(t,a,r,{attackerWeaponAccuracy:o,attackerSkillLevel:l,defenderArmorPenalty:c,defenderShieldSkillLevel:m}),d=u.hit?H.combatHit:H.combatMiss,h=((M=e==null?void 0:e.game)==null?void 0:M.turn)??0,f=j(t.skills.archery,d,h);if(!u.hit)return{success:!0,message:u.dodged?`The ${a.name} narrowly dodges your arrow!`:`Your arrow flies past the ${a.name}!`,projectileUsed:{type:"arrow",outcome:u.dodged?"dodged":"missed"}};u.critical&&A(t.levelInfo,"luck",1);const p=O(a),v=G(u.damage,p);P(a,v);const g=u.critical?" Critical hit!":"",b=f.levelsGained>0?" Archery leveled up!":"";if(!E(a)){const $=e.encounter.enemyFleeing?" as it flees":"";return{success:!0,message:`Your arrow strikes the ${a.name}${$} for ${v} damage.${g}${b} Defeated!`,encounterEnded:!0,projectileUsed:{type:"arrow",outcome:"hit"}}}return{success:!0,message:`Your arrow hits the ${a.name} for ${v} damage.${g}${b} (${a.health}/${a.maxHealth} HP)`,projectileUsed:{type:"arrow",outcome:"hit"}}}},ts={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const s=e.encounter.enemy,a=B(t),r=B(s),n=a/r,o=Math.min(.9,.4*n);return Math.random()<o?{success:!0,message:`You turn and run from the ${s.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${s.name} blocks your escape!`,fled:!1}}},ss={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const s=e.encounter.enemy,a=B(t),r=B(s),n=a/r,o=Math.min(.85,.5*n);return Math.random()<o?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${s.name}!`}):{success:!0,message:`The ${s.name} escapes into the distance.`,encounterEnded:!0}}},as=[Jt,Zt,es,ts,ss],ns=[Bt,qt,Tt,It],rs=[Pt,Rt,Dt,Ot,xt,Gt,Nt,_t,Yt,jt,Ft,Ut,Wt,Kt,Xt],is=[Vt,Qt,zt],os=[$t,Ht,...as,...ns,...rs,...is],cs=1e4,ls=100,us=100,ds=15,ms={vitality:5,strength:5,agility:5,precision:5,endurance:3,arcane:0,luck:2};function fs(){return ye("player","Player",{maxTicks:cs,speed:ls,maxHealth:us,damage:ds,actions:os,stats:ms,level:0})}const D=[{id:"rabbit",name:"Rabbit",maxHealth:15,damage:2,speed:150,fleeThreshold:.9,aggressiveness:.05,loot:{rawMeat:{min:1,max:1,chance:1}},statGrowth:{vitality:.5,strength:.2,agility:3,precision:.5,baseLevel:1,xpReward:8}},{id:"deer",name:"Deer",maxHealth:35,damage:6,speed:130,fleeThreshold:.8,aggressiveness:.1,loot:{rawMeat:{min:2,max:3,chance:1},rawLeather:{min:1,max:2,chance:.9}},statGrowth:{vitality:1,strength:.5,agility:2,precision:.5,baseLevel:1,xpReward:15}},{id:"wolf",name:"Wolf",maxHealth:50,damage:10,speed:120,fleeThreshold:.3,aggressiveness:.6,loot:{rawMeat:{min:1,max:2,chance:.9},rawLeather:{min:1,max:2,chance:.7}},statGrowth:{vitality:1.5,strength:1,agility:1.5,precision:1,baseLevel:1,xpReward:25}},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8,loot:{rawMeat:{min:2,max:4,chance:1},rawLeather:{min:1,max:3,chance:.8}},statGrowth:{vitality:3,strength:2,agility:.5,precision:1,baseLevel:2,xpReward:35}},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4,loot:{rawMeat:{min:1,max:1,chance:.5},venomGland:{min:1,max:2,chance:.8}},statGrowth:{vitality:.5,strength:2.5,agility:3,precision:2,baseLevel:1,xpReward:30}},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5,loot:{},usesInventory:!0,statGrowth:{vitality:1.5,strength:1.5,agility:1.5,precision:1.5,baseLevel:2,xpReward:40}}];function hs(){const t={};return Math.random()<.5&&(t.berries=Math.floor(Math.random()*4)+1),Math.random()<.6&&(t.sticks=Math.floor(Math.random()*3)+1),Math.random()<.4&&(t.rocks=Math.floor(Math.random()*2)+1),Math.random()<.3&&(t.rawMeat=Math.floor(Math.random()*2)+1),Math.random()<.2&&(t.cookedMeat=1),t}function gs(t,e){const{baseLevel:s}=t.statGrowth,a=Math.floor((e-1)*.4),r=Math.floor(Math.random()*3)-1;return Math.max(1,s+a+r)}function ps(t,e){const{statGrowth:s}=t,a=fe(),r=()=>.8+Math.random()*.4,n=Math.max(0,e-1);return a.vitality=Math.floor(s.vitality*n*r()),a.strength=Math.floor(s.strength*n*r()),a.agility=Math.floor(s.agility*n*r()),a.precision=Math.floor(s.precision*n*r()),a.endurance=0,a.arcane=0,a.luck=Math.floor(Math.random()*2),a}function ys(t,e=1){const s=t.usesInventory?hs():{},a=gs(t,e),r=ps(t,a),n=1+(a-1)*.1,i=Math.floor(t.maxHealth*n),o=Math.floor(t.damage*n);return ye(t.id,t.name,{maxHealth:i,damage:o,speed:t.speed,maxTicks:5e3,inventory:s,actions:[],level:a,stats:r})}function ks(t,e=0){const s=K(t);if(!s)return{};if(s.usesInventory)return{...t.inventory};const a={};for(const[r,n]of Object.entries(s.loot))if(Math.random()<n.chance){const i=Math.floor(Math.random()*(n.max-n.min+1))+n.min,o=Math.floor(i*e);a[r]=i+o}return a}function vs(t=1){let e;if(t<=2){const a=D.filter(n=>n.id==="rabbit"||n.id==="deer"),r=D.filter(n=>n.id!=="rabbit"&&n.id!=="deer"&&n.statGrowth.baseLevel<=t);Math.random()<.5&&a.length>0?e=a:r.length>0?e=r:e=a.length>0?a:D}else e=D.filter(a=>a.statGrowth.baseLevel<=t),e.length===0&&(e=D);const s=e[Math.floor(Math.random()*e.length)];return ys(s,t)}function bs(t,e){const s=K(t);if(!s)return 10;const a=s.statGrowth.xpReward,r=t.levelInfo.level,n=r-e;let i=1;return n>0?i=1+n*.1:n<0&&(i=Math.max(.1,1+n*.15)),Math.floor(a*r*i)}function K(t){return D.find(e=>e.id===t.id)}function ws(t){const e=t.damage,s=Math.floor(e*.3),a=Math.max(1,e-s),r=e+s,n=Xe(t.levelInfo.stats);return a+n+Math.floor(Math.random()*(r-a+1))}function Cs(t,e=1){const s=t??vs(e),a=K(s),r=(a==null?void 0:a.aggressiveness)??.5;return{enemy:s,playerFleeing:!1,enemyFleeing:!1,aggressiveness:r,ended:!1,projectilesUsed:{arrows:{hit:0,dodged:0,blocked:0,missed:0},rocks:{hit:0,dodged:0,blocked:0,missed:0}}}}function I(t,e){t.ended=!0,t.result=e}function Ss(t,e){const s=t.enemy,a=K(s),r=t.aggressiveness;if(t.playerFleeing)return Es(t,e);if(t.enemyFleeing)return As(t,e);if(r<.2)return{type:"attack",message:`The ${s.name} watches you cautiously.`,damage:0};const n=s.health/s.maxHealth,i=(a==null?void 0:a.fleeThreshold)??.3;if(n<=i){const o=e.health/e.maxHealth,c=(1-r)*(1-o*.5);if(Math.random()<c)return Ms(t)}return Ls(t,e)}function Ls(t,e){const s=t.enemy,a=ws(s),r=J(s),n=U(e),i=Ct(e),o=St(e),c=F(s,e,a,{attackerWeaponAccuracy:r,defenderArmorPenalty:n,defenderBlockBonus:i,defenderShieldArmor:o});if(!c.hit&&!c.blocked)return{type:"attack",message:c.dodged?`You dodge the ${s.name}'s attack!`:`The ${s.name} attacks but misses!`,damage:0};if(c.blocked){const f=O(e),p=x(e),v=f+Math.floor(p/3),g=G(c.damage,v);P(e,g);const b=c.critical?" (crit blocked!)":"";return E(e)?{type:"attack",message:`You block the ${s.name}'s attack, taking ${g} damage.${b} (${e.health}/${e.maxHealth} HP)`,damage:g}:{type:"attack",message:`You block the ${s.name}'s attack but take ${g} damage.${b} You have been defeated!`,damage:g,encounterEnded:!0}}const l=O(e),m=x(e),u=l+Math.floor(m/3),d=G(c.damage,u);P(e,d);const h=c.critical?" Critical hit!":"";return E(e)?{type:"attack",message:`The ${s.name} strikes you for ${d} damage.${h} (${e.health}/${e.maxHealth} HP)`,damage:d}:{type:"attack",message:`The ${s.name} strikes you for ${d} damage.${h} You have been defeated!`,damage:d,encounterEnded:!0}}function Ms(t){return t.enemyFleeing=!0,{type:"flee",message:`The ${t.enemy.name} turns to flee!`,fled:!1}}function As(t,e){const s=t.enemy,a=B(s),r=B(e),n=a/r,o=Math.min(.9,.4*n);return Math.random()<o?{type:"flee",message:`The ${s.name} escapes!`,fled:!0,encounterEnded:!0}:(t.enemyFleeing=!1,{type:"flee",message:`The ${s.name} fails to escape and turns to fight!`,fled:!1})}function Es(t,e){const s=t.enemy,a=t.aggressiveness;if(a<.2)return{type:"chase",message:`The ${s.name} lets you go.`,encounterEnded:!0};const r=e.health/e.maxHealth,n=a+(1-r)*.3;if(Math.random()<n){const i=B(s),o=B(e),c=i/o,l=Math.min(.85,.5*c);return Math.random()<l?(t.playerFleeing=!1,{type:"chase",message:`The ${s.name} catches up to you!`}):{type:"chase",message:`The ${s.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${s.name} lets you flee.`,encounterEnded:!0}}function $s(t,e){const s=t.enemy,a=s.speed*2;z(s,a);const r=200;return s.ticks<r?null:(s.ticks-=r,Ss(t,e))}const Hs=.3,Bs=.1;function qs(t,e,s,a){if(e.fled===!0&&(t.playerFleeing=!0),a!=null&&a.isAttack?t.aggressiveness=Math.min(1,t.aggressiveness+Hs):a!=null&&a.isIdle&&(t.aggressiveness=Math.max(0,t.aggressiveness-Bs)),e.projectileUsed){const{type:r,outcome:n}=e.projectileUsed;r==="arrow"?t.projectilesUsed.arrows[n]++:r==="rock"&&t.projectilesUsed.rocks[n]++}if(t.enemyFleeing&&!(a!=null&&a.isChase)&&!e.encounterEnded){I(t,"enemy_escaped");return}e.encounterEnded&&(E(t.enemy)?t.playerFleeing||e.fled?I(t,"player_escaped"):t.enemyFleeing&&I(t,"enemy_escaped"):I(t,"victory"))}const oe={hit:1,blocked:.9,dodged:.7,missed:.6},Ts=.95,Is=.6,Ps=.25;function Rs(t){const e=t.result==="enemy_escaped",{arrows:s,rocks:a}=t.projectilesUsed;let r=0,n=0;for(const[i,o]of Object.entries(s)){if(o<=0)continue;let c=Is*oe[i];e&&(c*=Ps);for(let l=0;l<o;l++)Math.random()<c&&r++}for(const[i,o]of Object.entries(a)){if(o<=0)continue;const c=Ts*oe[i];for(let l=0;l<o;l++)Math.random()<c&&n++}return{arrows:r,rocks:n}}const ce=2,Ds=1,le=500,ue=10,Os=.1;class xs{constructor(){R(this,"state");R(this,"listeners",new Map);this.state=this.createInitialState()}createInitialState(){return{player:fs(),turn:0,log:[],encounter:null,availableNodes:{},structures:new Set,pendingLoot:null,gameOver:!1}}restart(){this.state=this.createInitialState(),this.log("A new journey begins..."),this.emit("turn")}start(){this.log("Welcome to Iterra.")}performAction(e){if(this.state.gameOver)return!1;const s=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;if(!Q(s,e))return this.log(`Not enough ticks for ${e.name}. Need ${e.tickCost}, have ${s.ticks}.`),!1;dt(s,e.tickCost),e.tickGain&&z(s,e.tickGain);const a={encounter:this.state.encounter??void 0,game:this.state},r=e.execute(s,a);if(this.state.turn++,this.log(r.message),r.foundResource){const n=r.foundResource;this.state.availableNodes[n]=(this.state.availableNodes[n]??0)+1}if(e.tags.includes("gathering")&&this.processResourceDepletion(e.id),this.state.encounter){const n=e.tags.includes("offensive"),i=e.id==="chase",o=e.id==="idle",c={isAttack:n,isChase:i,isIdle:o};qs(this.state.encounter,r,s,c),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()}else e.id==="wander"&&this.processNodeDropOff(),e.id==="wander"&&!r.foundResource?this.checkForEncounter(.25):e.tags.includes("combat")||this.checkForEncounter(.03);return this.processHunger(),this.processRegen(),this.processStarvation(),this.processPassOut(),this.emit("turn"),!0}processHunger(){const e=this.state.player,s=at(e.levelInfo.stats);Math.random()<Os*(1-s)&&ae(e,1)}processRegen(){const e=this.state.player;gt(e)&&e.health<e.maxHealth&&(mt(e,ce),ae(e,Ds),this.log(`You feel restored. (+${ce} HP, ${e.health}/${e.maxHealth})`))}processStarvation(){const e=this.state.player;if(pt(e)){const s=yt();P(e,s),this.log(`You are starving! (-${s} HP, ${e.health}/${e.maxHealth})`),E(e)||(this.log("You have starved to death..."),this.triggerGameOver())}}canAffordAnyAction(){const e=this.getAvailableActions(),s=this.state.player;return e.some(a=>Q(s,a))}processPassOut(){if(this.state.gameOver||this.canAffordAnyAction())return;const e=this.state.player;if(this.log("You collapse from exhaustion..."),P(e,ue),z(e,le),this.state.turn++,this.log(`You wake up weakened. (-${ue} HP, +${le} ticks)`),!E(e)){this.log("You never wake up..."),this.triggerGameOver();return}this.state.encounter&&!this.state.encounter.ended&&(this.log(`The ${this.state.encounter.enemy.name} attacks while you're vulnerable!`),this.processEnemyTurns()),this.emit("turn")}triggerGameOver(){this.state.gameOver=!0,this.log("GAME OVER"),this.emit("game-over")}processResourceDepletion(e){const a={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e];if(!a)return;const r=ie(a);if(!r)return;const n=this.state.availableNodes[a]??0;n<=0||Math.random()<r.depletionChance&&(this.state.availableNodes[a]=n-1,this.state.availableNodes[a]<=0&&delete this.state.availableNodes[a])}processNodeDropOff(){for(const[e,s]of Object.entries(this.state.availableNodes)){if(s<=0)continue;const a=ie(e);if(!a)continue;let r=0;for(let n=0;n<s;n++)Math.random()<a.dropOffChance&&r++;if(r>0){const n=s-r;n<=0?delete this.state.availableNodes[e]:this.state.availableNodes[e]=n}}}checkForEncounter(e=.25){Math.random()<e&&this.startEncounter()}startEncounter(e){const s=this.state.player.levelInfo.level,a=Cs(e,s);this.state.encounter=a;const r=a.enemy.levelInfo.level,n=r>1?` (Lv.${r})`:"";this.log(`A wild ${a.enemy.name}${n} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,s=this.state.player,a=$s(e,s);a&&(this.log(a.message),a.encounterEnded&&(E(s)?a.fled?I(e,"enemy_escaped"):e.playerFleeing&&I(e,"player_escaped"):I(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,s=this.state.encounter.enemy,a=this.state.player;switch(e){case"victory":this.log(`You defeated the ${s.name}!`);const r=bs(s,a.levelInfo.level),{levelsGained:n,autoStats:i}=Ue(a.levelInfo,r);if(this.log(`+${r} XP`),n>0){if(se(a),this.log(`LEVEL UP! You are now level ${a.levelInfo.level}!`),i.length>0){const o={};for(const l of i)o[l]=(o[l]||0)+1;const c=Object.entries(o).map(([l,m])=>`+${m} ${V[l]}`).join(", ");this.log(`Auto stats: ${c}`)}a.levelInfo.freeStatPoints>0&&this.log(`You have ${a.levelInfo.freeStatPoints} stat points to allocate!`),this.emit("level-up")}this.setPendingLoot(s),this.recoverProjectiles();break;case"defeat":this.log("You have been defeated..."),this.state.encounter=null,this.triggerGameOver();return;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${s.name} got away.`),this.recoverProjectiles();break}this.state.encounter=null,this.emit("encounter-end")}recoverProjectiles(){if(!this.state.encounter)return;const e=Rs(this.state.encounter),s=this.state.player,a=[];e.arrows>0&&(C(s,"arrow",e.arrows),a.push(`${e.arrows} arrow${e.arrows>1?"s":""}`)),e.rocks>0&&(C(s,"rocks",e.rocks),a.push(`${e.rocks} rock${e.rocks>1?"s":""}`)),a.length>0&&this.log(`Recovered: ${a.join(", ")}`)}setPendingLoot(e){const s=it(this.state.player.levelInfo.stats),a=ks(e,s),r={};for(const[n,i]of Object.entries(a))i>0&&(r[n]=i);if(Object.keys(r).length>0){this.state.pendingLoot=r;const n=Object.entries(r).map(([i,o])=>{const c=y(i);return`${o} ${(c==null?void 0:c.name)??i}`});this.log(`Loot available: ${n.join(", ")}`)}}takeLoot(e,s=1){if(!this.state.pendingLoot||!this.state.pendingLoot[e])return!1;const a=this.state.pendingLoot[e],r=Math.min(s,a);C(this.state.player,e,r),this.state.pendingLoot[e]-=r,this.state.pendingLoot[e]<=0&&delete this.state.pendingLoot[e],Object.keys(this.state.pendingLoot).length===0&&(this.state.pendingLoot=null);const n=y(e);return this.log(`Took ${r} ${(n==null?void 0:n.name)??e}.`),this.emit("turn"),!0}takeAllLoot(){if(this.state.pendingLoot){for(const[e,s]of Object.entries(this.state.pendingLoot))C(this.state.player,e,s);this.log("Took all loot."),this.state.pendingLoot=null,this.emit("turn")}}leaveLoot(){this.state.pendingLoot&&(this.log("Left the loot behind."),this.state.pendingLoot=null,this.emit("turn"))}dropItem(e,s=1){const a=this.state.player,r=k(a,e);if(r<=0)return!1;const n=Math.min(s,r);a.inventory[e]-=n,a.inventory[e]<=0&&delete a.inventory[e];const i=y(e);return this.log(`Dropped ${n} ${(i==null?void 0:i.name)??e}.`),this.emit("turn"),!0}equip(e,s){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const a=this.state.player,r=y(e);return r?vt(a,e,s)?(this.log(`Equipped ${r.name}.`),this.emit("turn"),!0):(this.log(`Cannot equip ${r.name}.`),!1):!1}unequip(e){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const s=this.state.player,a=s.equipment[e];if(!a)return!1;const r=y(a);return Y(s,e)?(this.log(`Unequipped ${(r==null?void 0:r.name)??a}.`),this.emit("turn"),!0):!1}allocateStat(e){const s=this.state.player;return Ke(s.levelInfo,e)?(se(s),this.log(`+1 ${V[e]}!`),this.emit("turn"),!0):(this.log("No stat points available."),!1)}log(e){const s={turn:this.state.turn,message:e};this.state.log.unshift(s),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,s){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s)}off(e,s){var a;(a=this.listeners.get(e))==null||a.delete(s)}emit(e){var s;(s=this.listeners.get(e))==null||s.forEach(a=>a(this))}getAvailableActions(){var c;const e=this.state.player.actions,s=this.state.encounter!==null,a=((c=this.state.encounter)==null?void 0:c.enemyFleeing)??!1,r=this.state.player,n={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"},i={"eat-berries":"berries","eat-cooked-meat":"cookedMeat","eat-raw-meat":"rawMeat"},o={"craft-campfire":{requiresItems:{sticks:5,rocks:3}},"place-campfire":{requiresNoCampfire:!0,requiresItems:{campfire:1}},"pickup-campfire":{requiresCampfire:!0},"smother-campfire":{requiresCampfire:!0},"cook-meat":{requiresCampfire:!0,requiresItems:{rawMeat:1}},"craft-stone-knife":{requiresItems:{rocks:2,sticks:1}},"craft-stone-spear":{requiresItems:{rocks:1,sticks:3,fiber:2}},"craft-bow":{requiresItems:{sticks:3,fiber:5}},"craft-arrows":{requiresItems:{sticks:2,rocks:1}},"craft-wooden-shield":{requiresItems:{sticks:6,fiber:3}},"process-leather":{requiresCampfire:!0,requiresItems:{rawLeather:2}},"craft-leather-helm":{requiresItems:{leather:2}},"craft-leather-chest":{requiresItems:{leather:4}},"craft-leather-legs":{requiresItems:{leather:3}},"craft-leather-boots":{requiresItems:{leather:2}}};return e.filter(l=>{var h;if(s&&l.tags.includes("non-combat")||!s&&l.tags.includes("combat")||l.id==="chase"&&!a||l.id==="flee"&&((h=this.state.encounter)!=null&&h.playerFleeing))return!1;const m=n[l.id];if(m&&(this.state.availableNodes[m]??0)<=0)return!1;const u=i[l.id];if(u&&k(r,u)<=0)return!1;const d=o[l.id];if(d){if(d.requiresCampfire&&!this.state.structures.has("campfire")||d.requiresNoCampfire&&this.state.structures.has("campfire"))return!1;if(d.requiresItems){for(const[f,p]of Object.entries(d.requiresItems))if(k(r,f)<p)return!1}}return!(l.id==="throw-rock"&&k(r,"rocks")<=0||l.id==="ranged-attack"&&(r.equipment.mainHand!=="bow"||k(r,"arrow")<=0)||l.id==="wander"&&this.state.structures.has("campfire"))})}filterActions(e){const s=this.getAvailableActions(),a=e.toLowerCase().trim();let r=s;return a&&(r=s.filter(n=>{const i=n.name.toLowerCase().includes(a),o=n.description.toLowerCase().includes(a),c=n.tags.some(l=>l.toLowerCase().includes(a));return i||o||c})),this.sortActionsByPriority(r)}getActionPriority(e){var o;const s=this.state.player,a=this.state.encounter!==null,r=((o=this.state.encounter)==null?void 0:o.enemyFleeing)??!1;let n=0;if(a)return e.id==="attack"&&(n+=100),e.id==="flee"&&(n+=80),e.id==="ranged-attack"&&s.equipment.mainHand==="bow"&&(n+=95),e.id==="throw-rock"&&(n+=70),e.id==="chase"&&r&&(n+=90),n;const i=s.saturation/s.maxSaturation;if(e.tags.includes("consumption")&&(i<.3?n+=100:i<.5?n+=80:n+=30),e.id==="idle"){n+=40;const c=s.ticks/s.maxTicks;c<.1?n+=80:c<.2?n+=50:c<.3&&(n+=30)}if(e.id==="wander"&&(n+=60),e.tags.includes("gathering")&&(n+=50),e.tags.includes("crafting"))if(e.id==="craft-arrows"&&s.equipment.mainHand==="bow"){const c=k(s,"arrow");c<5?n+=85:c<15?n+=60:n+=25}else e.id==="cook-meat"?n+=70:e.id==="process-leather"?n+=55:e.id==="craft-stone-knife"||e.id==="craft-stone-spear"||e.id==="craft-bow"?s.equipment.mainHand?n+=25:n+=75:e.id.startsWith("craft-leather-")?n+=45:e.id==="craft-wooden-shield"?s.equipment.offHand?n+=20:n+=55:e.id==="craft-campfire"?k(s,"campfire")===0&&!this.state.structures.has("campfire")?n+=50:n+=5:e.id==="place-campfire"?n+=55:e.id==="pickup-campfire"?n+=15:e.id==="smother-campfire"?n+=10:n+=30;return n}sortActionsByPriority(e){return[...e].sort((s,a)=>{const r=this.getActionPriority(s);return this.getActionPriority(a)-r})}getGroupedActions(){const e=this.sortActionsByPriority(this.getAvailableActions());if(this.state.encounter!==null)return[{category:"Combat",actions:e}];const a={Suggested:[],Explore:[],Gather:[],Eat:[],Craft:[],Other:[]},r=e.slice(0,3);a.Suggested=r;for(const n of e)n.id==="idle"||n.id==="wander"?a.Explore.push(n):n.tags.includes("gathering")?a.Gather.push(n):n.tags.includes("consumption")?a.Eat.push(n):n.tags.includes("crafting")?a.Craft.push(n):a.Other.push(n);return Object.entries(a).filter(([n,i])=>i.length>0).map(([n,i])=>({category:n,actions:i}))}}class Gs{constructor(e){R(this,"game");R(this,"actionGroupState",new Map);R(this,"elements");this.game=e,this.elements={levelCount:document.getElementById("level-count"),xpCount:document.getElementById("xp-count"),xpNext:document.getElementById("xp-next"),tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),saturationCount:document.getElementById("saturation-count"),maxSaturation:document.getElementById("max-saturation"),weightCount:document.getElementById("weight-count"),maxWeight:document.getElementById("max-weight"),characterStatsList:document.getElementById("character-stats-list"),freePointsDisplay:document.getElementById("free-points-display"),equipmentList:document.getElementById("equipment-list"),inventoryList:document.getElementById("inventory-list"),structuresPanel:document.getElementById("structures-panel"),structuresList:document.getElementById("structures-list"),lootPanel:document.getElementById("loot-panel"),lootList:document.getElementById("loot-list"),takeAllLoot:document.getElementById("take-all-loot"),leaveLoot:document.getElementById("leave-loot"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status"),gameOverPanel:document.getElementById("game-over-panel"),restartButton:document.getElementById("restart-button"),skillsList:document.getElementById("skills-list")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),this.elements.restartButton.addEventListener("click",()=>{this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.render()}),this.elements.takeAllLoot.addEventListener("click",()=>{this.game.takeAllLoot()}),this.elements.leaveLoot.addEventListener("click",()=>{this.game.leaveLoot()}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())}),document.querySelectorAll(".collapsible .section-header").forEach(e=>{e.addEventListener("click",()=>{const s=e.closest(".collapsible");if(s){const a=s.querySelector(".section-content"),r=s.classList.toggle("collapsed"),n=e.querySelector(".toggle-icon");n&&(n.textContent=r?"":""),a&&(a.style.display=r?"none":"")}})}),window.matchMedia("(max-width: 600px)").matches&&document.querySelectorAll(".collapsed-mobile").forEach(e=>{e.classList.add("collapsed");const s=e.querySelector(".section-content"),a=e.querySelector(".toggle-icon");s&&(s.style.display="none"),a&&(a.textContent="")})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("level-up",()=>{this.renderStatus(),this.renderCharacterStats()}),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("game-over",()=>{this.renderGameOver()})}renderGameOver(){this.elements.gameOverPanel.classList.remove("hidden")}render(){this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player,s=e.levelInfo;this.elements.levelCount.textContent=s.level.toString(),this.elements.xpCount.textContent=s.xp.toString(),this.elements.xpNext.textContent=s.xpToNextLevel.toString(),this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString(),this.elements.saturationCount.textContent=e.saturation.toString(),this.elements.maxSaturation.textContent=e.maxSaturation.toString();const a=ke(e),r=ve(e),n=r>0?"+":"";this.elements.weightCount.textContent=a.toFixed(1),this.elements.maxWeight.textContent=`${e.carryCapacity} (${n}${Math.round(r)} spd)`}renderCharacterStats(){const s=this.game.state.player.levelInfo,a=s.stats,r=s.freeStatPoints,n=this.game.state.encounter!==null;r>0?(this.elements.freePointsDisplay.textContent=`(${r} points)`,this.elements.freePointsDisplay.classList.add("has-points")):(this.elements.freePointsDisplay.textContent="",this.elements.freePointsDisplay.classList.remove("has-points"));let i="";for(const o of X){const c=a[o],l=V[o],m=ot[o],u=r>0&&!n;i+=`
        <div class="stat-row">
          <span class="stat-name" title="${m}">${l}</span>
          <span class="stat-value">${c}</span>
          ${u?`<button class="allocate-btn" data-stat="${o}" title="Allocate point">+</button>`:""}
        </div>
      `}this.elements.characterStatsList.innerHTML=i,this.elements.characterStatsList.querySelectorAll(".allocate-btn").forEach(o=>{o.addEventListener("click",c=>{const l=c.target.getAttribute("data-stat");l&&this.game.allocateStat(l)})})}renderSkills(){const s=this.game.state.player.skills,a=de.filter(n=>{const i=s[n];return i.level>0||i.xp>0}).sort((n,i)=>s[i].lastGainedAt-s[n].lastGainedAt);if(a.length===0){this.elements.skillsList.innerHTML='<div class="no-skills">No skills yet. Fight or craft to gain skills!</div>';return}let r="";for(const n of a){const i=s[n],o=qe[n],c=Te[n],l=i.xpToNextLevel>0?Math.floor(i.xp/i.xpToNextLevel*100):100;r+=`
        <div class="skill-row" title="${c}">
          <span class="skill-name">${o}</span>
          <span class="skill-level">${i.level}</span>
          <div class="skill-xp-bar">
            <div class="skill-xp-fill" style="width: ${l}%"></div>
          </div>
          <span class="skill-xp">${i.xp}/${i.xpToNextLevel}</span>
        </div>
      `}this.elements.skillsList.innerHTML=r}renderEquipment(){const e=this.game.state.player,s=e.equipment,a=this.game.state.encounter!==null,r=[{slot:"mainHand",label:"Main Hand"},{slot:"offHand",label:"Off Hand"},{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"}],n=be(e),i=O(e),o=x(e),c=[];c.push(`${n.min}-${n.max} Dmg`),i>0&&c.push(`+${i} Armor`),o>0&&c.push(`+${o} Ranged`);let l="";c.length>0&&(l+=`<div class="equipment-bonuses">${c.join(" | ")}</div>`);const m=s.mainHand&&s.mainHand===s.offHand?s.mainHand:null;for(const{slot:u,label:d}of r){const h=s[u];if(u==="offHand"&&m)continue;const f=h?y(h):null,p=(f==null?void 0:f.name)??"Empty",g=(f==null?void 0:f.twoHanded)?"Both Hands":d;l+=`
        <div class="equipment-slot">
          <span class="slot-label">${g}:</span>
          <span class="slot-item">${p}</span>
          ${h&&!a?`<button class="unequip-btn" data-slot="${u}" title="Unequip"></button>`:""}
        </div>
      `}this.elements.equipmentList.innerHTML=l,this.elements.equipmentList.querySelectorAll(".unequip-btn").forEach(u=>{u.addEventListener("click",d=>{const h=d.target.getAttribute("data-slot");h&&this.game.unequip(h)})})}renderInventory(){const s=this.game.state.player.inventory,a=this.game.state.encounter!==null,r=Object.entries(s).filter(([n,i])=>i>0).map(([n,i])=>{const o=y(n),c=(o==null?void 0:o.name)??n,l=(o==null?void 0:o.equipSlot)&&!a;return`
          <div class="inventory-item">
            <span class="item-name">${c}: <span class="item-count">${i}</span></span>
            <div class="item-actions">
              ${l?`<button class="equip-btn" data-item-id="${n}" data-slot="${o.equipSlot}" title="Equip">E</button>`:""}
              <button class="drop-btn" data-item-id="${n}" title="Drop 1">-</button>
            </div>
          </div>
        `});r.length===0?this.elements.inventoryList.innerHTML='<span class="inventory-empty">Empty</span>':(this.elements.inventoryList.innerHTML=r.join(""),this.elements.inventoryList.querySelectorAll(".equip-btn").forEach(n=>{n.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id"),c=i.target.getAttribute("data-slot");o&&c&&this.game.equip(o,c)})}),this.elements.inventoryList.querySelectorAll(".drop-btn").forEach(n=>{n.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id");o&&this.game.dropItem(o,1)})}))}renderStructures(){const e=this.game.state.structures;if(e.size===0){this.elements.structuresPanel.classList.add("hidden");return}this.elements.structuresPanel.classList.remove("hidden");const s={campfire:"Campfire"},a=Array.from(e).map(r=>`<span class="structure-item">${s[r]??r}</span>`);this.elements.structuresList.innerHTML=a.join("")}renderLoot(){const e=this.game.state.pendingLoot;if(!e){this.elements.lootPanel.classList.add("hidden");return}this.elements.lootPanel.classList.remove("hidden");const s=Object.entries(e).filter(([a,r])=>r>0).map(([a,r])=>{const n=y(a),i=(n==null?void 0:n.name)??a,o=(n==null?void 0:n.weight)??0;return`
          <div class="loot-item">
            <span class="item-name">${i}: ${r} (${(o*r).toFixed(1)} wt)</span>
            <button class="take-btn" data-item-id="${a}" title="Take 1">+</button>
          </div>
        `});this.elements.lootList.innerHTML=s.join(""),this.elements.lootList.querySelectorAll(".take-btn").forEach(a=>{a.addEventListener("click",r=>{const n=r.target.getAttribute("data-item-id");n&&this.game.takeLoot(n,1)})})}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const s=e.enemy;this.elements.enemyName.textContent=s.name,this.elements.enemyHealth.textContent=s.health.toString(),this.elements.enemyMaxHealth.textContent=s.maxHealth.toString();let a="";e.enemyFleeing?a="Enemy is fleeing!":e.playerFleeing&&(a="You are fleeing!"),this.elements.encounterStatus.textContent=a}renderActions(){const e=this.elements.actionSearch.value;if(e.trim()){const s=this.game.filterActions(e);this.elements.actionsList.innerHTML=s.map(a=>this.renderActionItem(a)).join("")}else{const s=this.game.getGroupedActions();this.elements.actionsList.innerHTML=s.map((a,r)=>{const n=r===0,i=this.actionGroupState.get(a.category),o=i!==void 0?i:n;return this.renderActionGroup(a.category,a.actions,o)}).join("")}this.elements.actionsList.querySelectorAll(".action-item").forEach(s=>{const a=s.getAttribute("data-action-id");s.addEventListener("click",()=>{const r=this.game.getAvailableActions().find(n=>n.id===a);r&&this.handleActionClick(r)})}),this.elements.actionsList.querySelectorAll(".action-category-header").forEach(s=>{s.addEventListener("click",()=>{const a=s.getAttribute("data-category"),r=s.nextElementSibling,n=s.classList.toggle("collapsed");a&&this.actionGroupState.set(a,!n);const i=s.querySelector(".category-toggle");i&&(i.textContent=n?"":""),r&&(r.style.display=n?"none":"flex")})})}renderActionGroup(e,s,a=!0){const r=s.map(o=>this.renderActionItem(o)).join(""),n=a?"":"collapsed",i=a?"flex":"none";return`
      <div class="action-category">
        <div class="action-category-header ${n}" data-category="${e}">
          <span class="category-toggle">${a?"":""}</span>
          <span class="category-name">${e}</span>
          <span class="category-count">${s.length}</span>
        </div>
        <div class="action-category-content" style="display: ${i}">
          ${r}
        </div>
      </div>
    `}renderActionItem(e){const s=this.game.state.player,a=Q(s,e);let r;if(e.tickGain&&e.tickCost){const n=e.tickGain-e.tickCost;r=`${e.tickCost} cost, +${n} net`}else e.tickGain?r=`+${e.tickGain} ticks`:r=`${e.tickCost} ticks`;return`
      <div class="action-item ${a?"":"disabled"}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${a?"affordable":""}">${r}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(s=>`
        <div class="log-entry">
          <span class="timestamp">[${s.turn}]</span>
          ${s.message}
        </div>
      `).join("")}}const ee=new xs,Ns=new Gs(ee);Ns.render();ee.start();window.game=ee;
