var fe=Object.defineProperty;var ge=(t,e,n)=>e in t?fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var I=(t,e,n)=>ge(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const G=["vitality","strength","agility","precision","endurance","arcane","luck"],pe=100,ye=1.5,ke=3,be=2;function te(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function ve(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function Ce(t=1,e){const n=te();return e&&Object.assign(n,e),{level:t,xp:0,xpToNextLevel:ne(t+1),freeStatPoints:0,stats:n,statUsage:ve()}}function ne(t){return Math.floor(pe*Math.pow(t,ye))}function we(t,e){t.xp+=e;let n=0;const s=[];for(;t.xp>=t.xpToNextLevel;){t.xp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=ne(t.level+1),t.freeStatPoints+=be,n++;const a=Se(t,ke);s.push(...a)}return{levelsGained:n,autoStats:s}}function Se(t,e){const n=[],s=t.statUsage,a=Object.values(s).reduce((r,o)=>r+o,0);for(let r=0;r<e;r++){let o;if(a===0||Math.random()<.3)o=G[Math.floor(Math.random()*G.length)];else{let i=Math.random()*a;o="vitality";for(const[c,l]of Object.entries(s))if(i-=l,i<=0){o=c;break}}t.stats[o]++,n.push(o)}return Object.keys(t.statUsage).forEach(r=>{t.statUsage[r]=0}),n}function Me(t,e){return t.freeStatPoints<=0?!1:(t.freeStatPoints--,t.stats[e]++,!0)}function S(t,e,n=1){t.statUsage[e]+=n}function se(t){return t.vitality*5+t.endurance*2}function Le(t){const e=t.strength,n=Math.floor(t.strength*t.agility*.05);return e+n}function Ae(t){const e=t.precision,n=Math.floor(t.precision*t.agility*.05);return e+n}function Ee(t,e,n=0){return t.precision*5+t.agility*3+e*2+n+10}function $e(t,e,n=0){return Math.max(0,t.agility*5+t.luck*2+e*2+10-n)}function He(t,e,n=0){return n===0?0:t.strength*3+t.agility*2+e*2+n}function qe(t,e=0){return t.strength*2+e}function Be(t,e){return t===0?0:t/(t+e*.7)}function Ie(t,e,n,s){const a=2*n/(n+s);return t/(t+e)*a}function Pe(t){return t.agility*2}function ae(t){return t.endurance}function Te(t){return Math.min(.5,t.endurance*.01)}function Re(t){return Math.min(.3,t.luck*.015+t.precision*.005)}function xe(t){return 1.5+t.luck*.02}function De(t){return t.luck*.05}function D(t,e,n,s={}){const{attackerWeaponAccuracy:a=0,defenderArmorPenalty:r=0,defenderBlockBonus:o=0,defenderShieldArmor:i=0}=s,c=t.levelInfo.stats,l=e.levelInfo.stats,u=t.levelInfo.level,m=e.levelInfo.level,d=Ee(c,u,a);let h=n;const p=Re(c),y=Math.random()<p;if(y){const $=xe(c);h=Math.floor(h*$)}if(o>0){const $=He(l,m,o),me=Be($,d);if(Math.random()<me){const de=qe(l,i),he=Math.max(1,h-de);return{hit:!0,dodged:!1,blocked:!0,critical:y,damage:he,message:y?"blocked critical":"blocked"}}}const A=$e(l,m,r),k=Ie(d,A,u,m),B=Math.random();if(B>k){const $=B<k+.15;return{hit:!1,dodged:$,blocked:!1,critical:!1,damage:0,message:$?"dodged":"missed"}}return{hit:!0,dodged:!1,blocked:!1,critical:y,damage:h,message:y?"critical":"hit"}}const N={vitality:"Vitality",strength:"Strength",agility:"Agility",precision:"Precision",endurance:"Endurance",arcane:"Arcane",luck:"Luck"},Ye={vitality:"+5 Max HP per point",strength:"+1 Melee damage, +3 Block Rating, block damage reduction",agility:"+5 Dodge Rating, +3 Attack Rating, +2 Speed",precision:"+5 Attack Rating, +1 Ranged damage",endurance:"+1 Max Saturation, reduces hunger decay",arcane:"Magic capacity (future)",luck:"+2 Dodge Rating, crit chance, loot bonus"},Oe={berries:{id:"berries",name:"Berries",description:"Sweet, ripe berries. Can be eaten for sustenance.",stackable:!0,tags:["food","raw","foraged"],weight:.1,saturationGain:4},sticks:{id:"sticks",name:"Sticks",description:"Dry wooden sticks. Useful for crafting or as a makeshift weapon.",stackable:!0,tags:["material","wood","foraged","weapon"],weight:.5,equipSlot:"mainHand",minDamage:1,maxDamage:4,strengthScaling:.3,agilityScaling:.2,accuracy:0},rocks:{id:"rocks",name:"Rocks",description:"Sturdy rocks. Can be thrown or used for crafting.",stackable:!0,tags:["material","stone","foraged","throwable"],weight:2},fiber:{id:"fiber",name:"Fiber",description:"Plant fiber from tall grass. Used for crafting rope and bindings.",stackable:!0,tags:["material","foraged"],weight:.2},rawMeat:{id:"rawMeat",name:"Raw Meat",description:"Raw meat from a slain creature. Should be cooked before eating.",stackable:!0,tags:["food","raw","meat"],weight:1,saturationGain:2},cookedMeat:{id:"cookedMeat",name:"Cooked Meat",description:"Well-cooked meat. Nutritious and filling.",stackable:!0,tags:["food","cooked","meat"],weight:1,saturationGain:8},rawLeather:{id:"rawLeather",name:"Raw Leather",description:"Untreated animal hide. Must be processed at a campfire with a knife.",stackable:!0,tags:["material","loot"],weight:2},venomGland:{id:"venomGland",name:"Venom Gland",description:"A gland filled with potent venom. Handle with care.",stackable:!0,tags:["material","loot","poison"],weight:.3},leather:{id:"leather",name:"Leather",description:"Treated leather, ready for crafting armor.",stackable:!0,tags:["material","crafted"],weight:1.5},arrow:{id:"arrow",name:"Arrow",description:"A simple arrow. Requires a bow to use.",stackable:!0,tags:["ammo","crafted"],weight:.1},stoneKnife:{id:"stoneKnife",name:"Stone Knife",description:"A sharp flint knife. Good for combat and processing leather.",stackable:!1,tags:["weapon","tool","crafted"],weight:1,equipSlot:"mainHand",minDamage:3,maxDamage:8,strengthScaling:.5,agilityScaling:1,accuracy:15},stoneSpear:{id:"stoneSpear",name:"Stone Spear",description:"A spear with a stone tip. Decent reach and damage.",stackable:!1,tags:["weapon","crafted"],weight:2.5,equipSlot:"mainHand",minDamage:5,maxDamage:12,strengthScaling:1,agilityScaling:.5,accuracy:5},bow:{id:"bow",name:"Bow",description:"A wooden bow. Requires arrows. Effective against fleeing enemies.",stackable:!1,tags:["weapon","ranged","crafted"],weight:1.5,equipSlot:"mainHand",twoHanded:!0,minDamage:4,maxDamage:10,precisionScaling:1,agilityScaling:.3,rangedBonus:15,accuracy:20},woodenShield:{id:"woodenShield",name:"Wooden Shield",description:"A crude wooden shield. Block attacks to reduce damage.",stackable:!1,tags:["armor","shield","crafted"],weight:3,equipSlot:"offHand",armorBonus:5,blockBonus:25},leatherHelm:{id:"leatherHelm",name:"Leather Helm",description:"A hardened leather helmet.",stackable:!1,tags:["armor","crafted"],weight:1,equipSlot:"head",armorBonus:3,dodgePenalty:2},leatherChest:{id:"leatherChest",name:"Leather Chest",description:"A leather chestpiece offering decent protection.",stackable:!1,tags:["armor","crafted"],weight:3,equipSlot:"chest",armorBonus:6,dodgePenalty:5},leatherLegs:{id:"leatherLegs",name:"Leather Leggings",description:"Leather leg protection.",stackable:!1,tags:["armor","crafted"],weight:2,equipSlot:"legs",armorBonus:4,dodgePenalty:3},leatherBoots:{id:"leatherBoots",name:"Leather Boots",description:"Sturdy leather boots.",stackable:!1,tags:["armor","crafted"],weight:1.5,equipSlot:"feet",armorBonus:2,dodgePenalty:1},campfire:{id:"campfire",name:"Campfire",description:"A portable campfire kit. Place it to cook meat.",stackable:!1,tags:["structure","crafted"],weight:5}};function f(t){return Oe[t]}function re(t,e,n={}){const{maxTicks:s=1e4,speed:a=100,carryCapacity:r=30,maxHealth:o=100,damage:i=10,saturation:c=10,maxSaturation:l=20,inventory:u={},equipment:m={},actions:d=[],level:h=1,stats:p}=n,y=Ce(h,p),A=o+se(y.stats),k=l+ae(y.stats);return{id:t,name:e,ticks:s,maxTicks:s,speed:a,carryCapacity:r,health:A,maxHealth:A,damage:i,saturation:c,maxSaturation:k,inventory:{...u},equipment:{...m},actions:[...d],levelInfo:y}}function X(t,e=100,n=20){const s=t.levelInfo.stats,a=t.maxHealth;t.maxHealth=e+se(s),t.maxSaturation=n+ae(s),t.maxHealth>a&&(t.health+=t.maxHealth-a),t.health=Math.min(t.health,t.maxHealth),t.saturation=Math.min(t.saturation,t.maxSaturation)}function _(t,e){return t.ticks>=e.tickCost}function F(t,e){t.ticks=Math.min(t.ticks+e,t.maxTicks)}function Ge(t,e){return t.ticks<e?!1:(t.ticks-=e,!0)}function E(t,e){t.health=Math.max(0,t.health-e)}function Ne(t,e){t.health=Math.min(t.maxHealth,t.health+e)}function M(t){return t.health>0}function _e(t,e){t.saturation=Math.min(t.maxSaturation,t.saturation+e)}function V(t,e){t.saturation=Math.max(0,t.saturation-e)}const Fe=10;function je(t){return t.saturation>Fe}function Ue(t){return t.saturation<=0}function We(t){return 5}function g(t,e){return t.inventory[e]??0}function w(t,e,n){t.inventory[e]=(t.inventory[e]??0)+n}function R(t,e,n){const s=t.inventory[e]??0;return s<n?!1:(t.inventory[e]=s-n,!0)}function oe(t){let e=0;for(const[n,s]of Object.entries(t.inventory))if(s>0){const a=f(n);a&&(e+=a.weight*s)}return e}function Ke(t){return oe(t)/t.carryCapacity}function ie(t){const e=Ke(t);return e<=.5?20*(1-e*2):e<=1?0:-50*(e-1)}function L(t){const e=Pe(t.levelInfo.stats);return Math.max(10,t.speed+ie(t)+e)}function Xe(t,e,n){const s=f(e);return!s||!s.equipSlot||g(t,e)<=0?!1:(s.twoHanded?(x(t,"mainHand"),x(t,"offHand"),t.equipment.mainHand=e,t.equipment.offHand=e):(x(t,n),t.equipment[n]=e),R(t,e,1),!0)}function x(t,e){const n=t.equipment[e];if(!n)return!1;const s=f(n);return s!=null&&s.twoHanded&&e==="mainHand"||s!=null&&s.twoHanded&&e==="offHand"?(delete t.equipment.mainHand,delete t.equipment.offHand,w(t,n,1)):(delete t.equipment[e],w(t,n,1)),!0}function q(t){let e=0;const n=new Set;for(const s of Object.values(t.equipment))if(s&&!n.has(s)){n.add(s);const a=f(s);a!=null&&a.armorBonus&&(e+=a.armorBonus)}return e}function P(t){let e=0;const n=new Set;for(const s of Object.values(t.equipment))if(s&&!n.has(s)){n.add(s);const a=f(s);a!=null&&a.rangedBonus&&(e+=a.rangedBonus)}return e}const z=1,J=3;function Ve(t){const e=t.equipment.mainHand;if(!e)return{min:z,max:J};const n=f(e);return(n==null?void 0:n.minDamage)!==void 0&&(n==null?void 0:n.maxDamage)!==void 0?{min:n.minDamage,max:n.maxDamage}:{min:z,max:J}}function ze(t){const e=t.equipment.mainHand,n=t.levelInfo.stats;if(!e)return Math.floor(n.strength*.5+n.agility*.3);const s=f(e);if(!s)return Math.floor(n.strength*.5+n.agility*.3);let a=0;return s.strengthScaling&&(a+=n.strength*s.strengthScaling),s.agilityScaling&&(a+=n.agility*s.agilityScaling),s.precisionScaling&&(a+=n.precision*s.precisionScaling),Math.floor(a)}function ce(t){const e=Ve(t),n=ze(t);return{min:e.min+n,max:e.max+n}}function le(t){const e=ce(t);return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function T(t,e){const n=e/(e+20);return Math.max(1,Math.floor(t*(1-n)))}function U(t){const e=t.equipment.mainHand;if(!e)return 0;const n=f(e);return(n==null?void 0:n.accuracy)??0}function Y(t){let e=0;const n=new Set;for(const s of Object.values(t.equipment))if(s&&!n.has(s)){n.add(s);const a=f(s);a!=null&&a.dodgePenalty&&(e+=a.dodgePenalty)}return e}function Je(t){const e=t.equipment.offHand;if(!e)return 0;const n=f(e);return(n==null?void 0:n.blockBonus)??0}function Qe(t){const e=t.equipment.offHand;if(!e)return 0;const n=f(e);return n!=null&&n.blockBonus?n.armorBonus??0:0}const ue={berryBush:{id:"berryBush",name:"Berry Bush",description:"A bush laden with ripe berries.",gatherActionId:"gather-berries",discoveryChance:.2,discoveryMessage:"You stumble upon a bush laden with ripe berries!",depletionChance:.6},fallenBranches:{id:"fallenBranches",name:"Fallen Branches",description:"Some fallen branches on the ground.",gatherActionId:"gather-sticks",discoveryChance:.2,discoveryMessage:"You find some fallen branches on the ground.",depletionChance:.5},rockyOutcrop:{id:"rockyOutcrop",name:"Rocky Outcrop",description:"Some useful rocks jutting from the ground.",gatherActionId:"gather-rocks",discoveryChance:.15,discoveryMessage:"You notice some useful rocks nearby.",depletionChance:.4},tallGrass:{id:"tallGrass",name:"Tall Grass",description:"A patch of tall grass with useful fibers.",gatherActionId:"gather-fiber",discoveryChance:.2,discoveryMessage:"You find a patch of tall grass.",depletionChance:.5}};function Ze(t){return ue[t]}function et(){return Object.values(ue)}function tt(){const t=et();let e=0;const n=Math.random();for(const s of t)if(e+=s.discoveryChance,n<e)return s;return null}const nt={campfire:{id:"campfire",name:"Craft Campfire",description:"Craft a portable campfire using sticks and rocks.",inputs:{sticks:5,rocks:3},outputs:{campfire:1},tickCost:400},cookedMeat:{id:"cookedMeat",name:"Cook Meat",description:"Cook raw meat on the campfire.",inputs:{rawMeat:1},outputs:{cookedMeat:1},tickCost:200,requiresCampfire:!0},leather:{id:"leather",name:"Process Leather",description:"Process raw leather at the campfire. Requires a knife.",inputs:{rawLeather:2},outputs:{leather:1},tickCost:300,requiresCampfire:!0},stoneKnife:{id:"stoneKnife",name:"Craft Stone Knife",description:"Craft a stone knife from rocks and sticks.",inputs:{rocks:2,sticks:1},outputs:{stoneKnife:1},tickCost:250},stoneSpear:{id:"stoneSpear",name:"Craft Stone Spear",description:"Craft a stone spear from rocks, sticks, and fiber.",inputs:{rocks:1,sticks:3,fiber:2},outputs:{stoneSpear:1},tickCost:300},bow:{id:"bow",name:"Craft Bow",description:"Craft a bow from sticks and fiber.",inputs:{sticks:3,fiber:5},outputs:{bow:1},tickCost:400},arrow:{id:"arrow",name:"Craft Arrows",description:"Craft arrows from sticks and rocks.",inputs:{sticks:2,rocks:1},outputs:{arrow:5},tickCost:150},woodenShield:{id:"woodenShield",name:"Craft Wooden Shield",description:"Craft a wooden shield from sticks and fiber.",inputs:{sticks:6,fiber:3},outputs:{woodenShield:1},tickCost:350},leatherHelm:{id:"leatherHelm",name:"Craft Leather Helm",description:"Craft a leather helmet.",inputs:{leather:2},outputs:{leatherHelm:1},tickCost:200},leatherChest:{id:"leatherChest",name:"Craft Leather Chest",description:"Craft a leather chestpiece.",inputs:{leather:4},outputs:{leatherChest:1},tickCost:300},leatherLegs:{id:"leatherLegs",name:"Craft Leather Leggings",description:"Craft leather leggings.",inputs:{leather:3},outputs:{leatherLegs:1},tickCost:250},leatherBoots:{id:"leatherBoots",name:"Craft Leather Boots",description:"Craft leather boots.",inputs:{leather:2},outputs:{leatherBoots:1},tickCost:200}};function b(t){return nt[t]}function v(t,e,n){if(t.requiresCampfire&&!n.has("campfire"))return{canCraft:!1,reason:"Requires a placed campfire."};for(const[s,a]of Object.entries(t.inputs)){const r=e[s]??0;if(r<a)return{canCraft:!1,reason:`Need ${a} ${s}, have ${r}.`}}return{canCraft:!0}}function C(t,e){for(const[n,s]of Object.entries(t.inputs))e[n]=(e[n]??0)-s;for(const[n,s]of Object.entries(t.outputs))e[n]=(e[n]??0)+s}const st={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(t,e)=>({success:!0,message:"You rest, recovering some energy."})},at={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(t,e)=>{const n=tt();if(n)return{success:!0,message:n.discoveryMessage,foundResource:n.id};const s=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:s[Math.floor(Math.random()*s.length)]}}},rt={id:"gather-berries",name:"Gather Berries",description:"Pick berries from the bush.",tickCost:150,tags:["gathering","non-combat"],execute:(t,e)=>{const n=2+Math.floor(Math.random()*3);return w(t,"berries",n),{success:!0,message:`You gather ${n} berries. (${g(t,"berries")} total)`}}},ot={id:"gather-sticks",name:"Gather Sticks",description:"Collect sticks from the ground.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const n=2+Math.floor(Math.random()*3);return w(t,"sticks",n),{success:!0,message:`You gather ${n} sticks. (${g(t,"sticks")} total)`}}},it={id:"gather-rocks",name:"Gather Rocks",description:"Collect rocks from the ground.",tickCost:120,tags:["gathering","non-combat"],execute:(t,e)=>{const n=1+Math.floor(Math.random()*2);return w(t,"rocks",n),{success:!0,message:`You gather ${n} rocks. (${g(t,"rocks")} total)`}}},ct={id:"gather-fiber",name:"Gather Fiber",description:"Collect fiber from tall grass.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const n=3+Math.floor(Math.random()*3);return w(t,"fiber",n),{success:!0,message:`You gather ${n} fiber. (${g(t,"fiber")} total)`}}},lt={id:"craft-campfire",name:"Craft Campfire",description:"Craft a portable campfire. (5 sticks, 3 rocks)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("campfire"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a campfire. Place it to cook meat!"}):{success:!1,message:r}}},ut={id:"place-campfire",name:"Place Campfire",description:"Place your campfire on the ground.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var n;return g(t,"campfire")<=0?{success:!1,message:"You have no campfire to place."}:(n=e==null?void 0:e.game)!=null&&n.structures.has("campfire")?{success:!1,message:"A campfire is already placed."}:(R(t,"campfire",1),e!=null&&e.game&&e.game.structures.add("campfire"),{success:!0,message:"You place the campfire. You can now cook meat!"})}},mt={id:"pickup-campfire",name:"Pick Up Campfire",description:"Pick up your placed campfire.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var n;return(n=e==null?void 0:e.game)!=null&&n.structures.has("campfire")?(e.game.structures.delete("campfire"),w(t,"campfire",1),{success:!0,message:"You pick up the campfire."}):{success:!1,message:"No campfire is placed."}}},dt={id:"cook-meat",name:"Cook Meat",description:"Cook raw meat on the campfire.",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("cookedMeat"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:`You cook the meat. (${g(t,"cookedMeat")} cooked meat)`}):{success:!1,message:r}}},ht={id:"craft-stone-knife",name:"Craft Stone Knife",description:"Craft a stone knife. (2 rocks, 1 stick)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("stoneKnife"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a stone knife. A fast weapon that scales with agility!"}):{success:!1,message:r}}},ft={id:"craft-stone-spear",name:"Craft Stone Spear",description:"Craft a stone spear. (1 rock, 3 sticks, 2 fiber)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("stoneSpear"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a stone spear. A powerful weapon that scales with strength!"}):{success:!1,message:r}}},gt={id:"craft-bow",name:"Craft Bow",description:"Craft a bow. (3 sticks, 5 fiber)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("bow"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a bow. Equip it and craft arrows to shoot!"}):{success:!1,message:r}}},pt={id:"craft-arrows",name:"Craft Arrows",description:"Craft 5 arrows. (2 sticks, 1 rock)",tickCost:150,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("arrow"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:`You craft 5 arrows. (${g(t,"arrow")} total)`}):{success:!1,message:r}}},yt={id:"craft-wooden-shield",name:"Craft Wooden Shield",description:"Craft a wooden shield. (6 sticks, 3 fiber)",tickCost:350,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("woodenShield"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a wooden shield. Equip it for +5 armor!"}):{success:!1,message:r}}},kt={id:"process-leather",name:"Process Leather",description:"Process raw leather at campfire. (2 raw leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("leather"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:`You process the leather. (${g(t,"leather")} leather)`}):{success:!1,message:r}}},bt={id:"craft-leather-helm",name:"Craft Leather Helm",description:"Craft a leather helmet. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("leatherHelm"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a leather helm. Equip it for +3 armor!"}):{success:!1,message:r}}},vt={id:"craft-leather-chest",name:"Craft Leather Chest",description:"Craft a leather chestpiece. (4 leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("leatherChest"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft a leather chestpiece. Equip it for +6 armor!"}):{success:!1,message:r}}},Ct={id:"craft-leather-legs",name:"Craft Leather Leggings",description:"Craft leather leggings. (3 leather)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("leatherLegs"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft leather leggings. Equip them for +4 armor!"}):{success:!1,message:r}}},wt={id:"craft-leather-boots",name:"Craft Leather Boots",description:"Craft leather boots. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var o;const n=b("leatherBoots"),s=((o=e==null?void 0:e.game)==null?void 0:o.structures)??new Set,{canCraft:a,reason:r}=v(n,t.inventory,s);return a?(C(n,t.inventory),{success:!0,message:"You craft leather boots. Equip them for +2 armor!"}):{success:!1,message:r}}};function W(t,e,n,s){var r;const a=f(t);return{id:e,name:n,description:`Eat ${((r=a==null?void 0:a.name)==null?void 0:r.toLowerCase())??t} to restore saturation.`,tickCost:s,tags:["consumption","non-combat"],execute:(o,i)=>{var u,m;if(g(o,t)<=0)return{success:!1,message:`You have no ${((u=a==null?void 0:a.name)==null?void 0:u.toLowerCase())??t} to eat.`};R(o,t,1);const l=(a==null?void 0:a.saturationGain)??1;return _e(o,l),{success:!0,message:`You eat the ${((m=a==null?void 0:a.name)==null?void 0:m.toLowerCase())??t}. (+${l} saturation, ${o.saturation}/${o.maxSaturation})`}}}}const St=W("berries","eat-berries","Eat Berries",50),Mt=W("cookedMeat","eat-cooked-meat","Eat Cooked Meat",75),Lt=W("rawMeat","eat-raw-meat","Eat Raw Meat",50),At={id:"attack",name:"Attack",description:"Strike your enemy with equipped weapon.",tickCost:200,tags:["combat","offensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to attack."};const n=e.encounter.enemy;S(t.levelInfo,"strength",1),S(t.levelInfo,"precision",.5);const s=le(t),a=U(t),r=Y(n),o=D(t,n,s,{attackerWeaponAccuracy:a,defenderArmorPenalty:r});if(!o.hit)return{success:!0,message:o.dodged?`The ${n.name} dodges your attack!`:`You swing at the ${n.name} but miss!`};const i=q(n),c=T(o.damage,i);E(n,c),o.critical&&S(t.levelInfo,"luck",1);const l=o.critical?" Critical hit!":"";return M(n)?{success:!0,message:`You strike the ${n.name} for ${c} damage.${l} (${n.health}/${n.maxHealth} HP)`}:{success:!0,message:`You strike the ${n.name} for ${c} damage.${l} Defeated!`,encounterEnded:!0}}},Et={id:"throw-rock",name:"Throw Rock",description:"Throw a rock at your enemy. Ranged attack.",tickCost:150,tags:["combat","offensive","ranged"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to throw at."};if(g(t,"rocks")<=0)return{success:!1,message:"You have no rocks to throw."};R(t,"rocks",1);const n=e.encounter.enemy;S(t.levelInfo,"precision",1),S(t.levelInfo,"agility",.3);const s=5,a=10,r=Ae(t.levelInfo.stats);let o=s+r+Math.floor(Math.random()*(a-s+1));const i=P(t),c=e.encounter.enemyFleeing?Math.floor(i/2):0;o+=c;const l=Y(n),u=D(t,n,o,{attackerWeaponAccuracy:5,defenderArmorPenalty:l});if(!u.hit)return{success:!0,message:u.dodged?`The ${n.name} dodges your thrown rock!`:`You throw a rock at the ${n.name} but miss!`};u.critical&&S(t.levelInfo,"luck",1);const m=q(n),d=T(u.damage,m);E(n,d);const h=u.critical?" Critical hit!":"";return M(n)?{success:!0,message:`Your rock hits the ${n.name} for ${d} damage.${h} (${n.health}/${n.maxHealth} HP)`}:{success:!0,message:`Your rock strikes the ${n.name} for ${d} damage.${h} Defeated!`,encounterEnded:!0}}},$t={id:"ranged-attack",name:"Shoot Arrow",description:"Fire an arrow at your enemy. Very effective against fleeing targets.",tickCost:180,tags:["combat","offensive","ranged"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to shoot."};if(t.equipment.mainHand!=="bow")return{success:!1,message:"You need a bow equipped."};if(g(t,"arrow")<=0)return{success:!1,message:"You have no arrows."};R(t,"arrow",1);const s=e.encounter.enemy;S(t.levelInfo,"precision",1.5),S(t.levelInfo,"agility",.5);let a=le(t);const r=P(t),o=e.encounter.enemyFleeing?r:0;a+=o;const i=U(t),c=Y(s),l=D(t,s,a,{attackerWeaponAccuracy:i,defenderArmorPenalty:c});if(!l.hit)return{success:!0,message:l.dodged?`The ${s.name} narrowly dodges your arrow!`:`Your arrow flies past the ${s.name}!`};l.critical&&S(t.levelInfo,"luck",1);const u=q(s),m=T(l.damage,u);E(s,m);const d=l.critical?" Critical hit!":"";if(!M(s)){const h=e.encounter.enemyFleeing?" as it flees":"";return{success:!0,message:`Your arrow strikes the ${s.name}${h} for ${m} damage.${d} Defeated!`,encounterEnded:!0}}return{success:!0,message:`Your arrow hits the ${s.name} for ${m} damage.${d} (${s.health}/${s.maxHealth} HP)`}}},Ht={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const n=e.encounter.enemy,s=L(t),a=L(n),r=s/a,i=Math.min(.9,.4*r);return Math.random()<i?{success:!0,message:`You turn and run from the ${n.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${n.name} blocks your escape!`,fled:!1}}},qt={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const n=e.encounter.enemy,s=L(t),a=L(n),r=s/a,i=Math.min(.85,.5*r);return Math.random()<i?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${n.name}!`}):{success:!0,message:`The ${n.name} escapes into the distance.`,encounterEnded:!0}}},Bt={id:"let-go",name:"Let Go",description:"Allow the enemy to escape.",tickCost:50,tags:["combat"],execute:(t,e)=>e!=null&&e.encounter?{success:!0,message:`You let the ${e.encounter.enemy.name} flee.`,encounterEnded:!0}:{success:!1,message:"Nothing to let go."}},It=[At,Et,$t,Ht,qt,Bt],Pt=[rt,ot,it,ct],Tt=[lt,ut,mt,dt,ht,ft,gt,pt,yt,kt,bt,vt,Ct,wt],Rt=[St,Mt,Lt],xt=[st,at,...It,...Pt,...Tt,...Rt],Dt=1e4,Yt=100,Ot=100,Gt=15;function Nt(){return re("player","Player",{maxTicks:Dt,speed:Yt,maxHealth:Ot,damage:Gt,actions:xt})}const j=[{id:"wolf",name:"Wolf",maxHealth:60,damage:12,speed:120,fleeThreshold:.3,aggressiveness:.6,loot:{rawMeat:{min:1,max:2,chance:.9},rawLeather:{min:1,max:2,chance:.7}},statGrowth:{vitality:2,strength:1.5,agility:2,precision:1,baseLevel:1,xpReward:25}},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8,loot:{rawMeat:{min:2,max:4,chance:1},rawLeather:{min:1,max:3,chance:.8}},statGrowth:{vitality:3,strength:2,agility:.5,precision:1,baseLevel:2,xpReward:35}},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4,loot:{rawMeat:{min:1,max:1,chance:.5},venomGland:{min:1,max:2,chance:.8}},statGrowth:{vitality:.5,strength:2.5,agility:3,precision:2,baseLevel:1,xpReward:30}},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5,loot:{},usesInventory:!0,statGrowth:{vitality:1.5,strength:1.5,agility:1.5,precision:1.5,baseLevel:2,xpReward:40}}];function _t(){const t={};return Math.random()<.5&&(t.berries=Math.floor(Math.random()*4)+1),Math.random()<.6&&(t.sticks=Math.floor(Math.random()*3)+1),Math.random()<.4&&(t.rocks=Math.floor(Math.random()*2)+1),Math.random()<.3&&(t.rawMeat=Math.floor(Math.random()*2)+1),Math.random()<.2&&(t.cookedMeat=1),t}function Ft(t,e){const{baseLevel:n}=t.statGrowth,s=Math.floor((e-1)*.4),a=Math.floor(Math.random()*3)-1;return Math.max(1,n+s+a)}function jt(t,e){const{statGrowth:n}=t,s=te(),a=()=>.8+Math.random()*.4,r=Math.max(0,e-1);return s.vitality=Math.floor(n.vitality*r*a()),s.strength=Math.floor(n.strength*r*a()),s.agility=Math.floor(n.agility*r*a()),s.precision=Math.floor(n.precision*r*a()),s.endurance=0,s.arcane=0,s.luck=Math.floor(Math.random()*2),s}function Ut(t,e=1){const n=t.usesInventory?_t():{},s=Ft(t,e),a=jt(t,s),r=1+(s-1)*.1,o=Math.floor(t.maxHealth*r),i=Math.floor(t.damage*r);return re(t.id,t.name,{maxHealth:o,damage:i,speed:t.speed,maxTicks:5e3,inventory:n,actions:[],level:s,stats:a})}function Wt(t,e=0){const n=O(t);if(!n)return{};if(n.usesInventory)return{...t.inventory};const s={};for(const[a,r]of Object.entries(n.loot))if(Math.random()<r.chance){const o=Math.floor(Math.random()*(r.max-r.min+1))+r.min,i=Math.floor(o*e);s[a]=o+i}return s}function Kt(t=1){const e=j[Math.floor(Math.random()*j.length)];return Ut(e,t)}function Xt(t,e){const n=O(t);if(!n)return 10;const s=n.statGrowth.xpReward,a=t.levelInfo.level,r=a-e;let o=1;return r>0?o=1+r*.1:r<0&&(o=Math.max(.1,1+r*.15)),Math.floor(s*a*o)}function O(t){return j.find(e=>e.id===t.id)}function Vt(t){const e=t.damage,n=Math.floor(e*.3),s=Math.max(1,e-n),a=e+n,r=Le(t.levelInfo.stats);return s+r+Math.floor(Math.random()*(a-s+1))}function zt(t,e=1){return{enemy:t??Kt(e),playerFleeing:!1,enemyFleeing:!1,ended:!1}}function H(t,e){t.ended=!0,t.result=e}function Jt(t,e){const n=t.enemy,s=O(n);if(t.playerFleeing)return tn(t,e);if(t.enemyFleeing)return en(t,e);const a=n.health/n.maxHealth,r=(s==null?void 0:s.fleeThreshold)??.3,o=(s==null?void 0:s.aggressiveness)??.5;if(a<=r){const i=e.health/e.maxHealth,c=(1-o)*(1-i*.5);if(Math.random()<c)return Zt(t)}return Qt(t,e)}function Qt(t,e){const n=t.enemy,s=Vt(n),a=U(n),r=Y(e),o=Je(e),i=Qe(e),c=D(n,e,s,{attackerWeaponAccuracy:a,defenderArmorPenalty:r,defenderBlockBonus:o,defenderShieldArmor:i});if(!c.hit&&!c.blocked)return{type:"attack",message:c.dodged?`You dodge the ${n.name}'s attack!`:`The ${n.name} attacks but misses!`,damage:0};if(c.blocked){const p=q(e),y=P(e),A=p+Math.floor(y/3),k=T(c.damage,A);E(e,k);const B=c.critical?" (crit blocked!)":"";return M(e)?{type:"attack",message:`You block the ${n.name}'s attack, taking ${k} damage.${B} (${e.health}/${e.maxHealth} HP)`,damage:k}:{type:"attack",message:`You block the ${n.name}'s attack but take ${k} damage.${B} You have been defeated!`,damage:k,encounterEnded:!0}}const l=q(e),u=P(e),m=l+Math.floor(u/3),d=T(c.damage,m);E(e,d);const h=c.critical?" Critical hit!":"";return M(e)?{type:"attack",message:`The ${n.name} strikes you for ${d} damage.${h} (${e.health}/${e.maxHealth} HP)`,damage:d}:{type:"attack",message:`The ${n.name} strikes you for ${d} damage.${h} You have been defeated!`,damage:d,encounterEnded:!0}}function Zt(t){return t.enemyFleeing=!0,{type:"flee",message:`The ${t.enemy.name} turns to flee!`,fled:!1}}function en(t,e){const n=t.enemy,s=L(n),a=L(e),r=s/a,i=Math.min(.9,.4*r);return Math.random()<i?{type:"flee",message:`The ${n.name} escapes!`,fled:!0,encounterEnded:!0}:(t.enemyFleeing=!1,{type:"flee",message:`The ${n.name} fails to escape and turns to fight!`,fled:!1})}function tn(t,e){const n=t.enemy,s=O(n),a=(s==null?void 0:s.aggressiveness)??.5,r=e.health/e.maxHealth,o=a+(1-r)*.3;if(Math.random()<o){const i=L(n),c=L(e),l=i/c,u=Math.min(.85,.5*l);return Math.random()<u?(t.playerFleeing=!1,{type:"chase",message:`The ${n.name} catches up to you!`}):{type:"chase",message:`The ${n.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${n.name} lets you flee.`,encounterEnded:!0}}function nn(t,e){const n=t.enemy,s=n.speed*2;F(n,s);const a=200;return n.ticks<a?null:(n.ticks-=a,Jt(t,e))}function sn(t,e,n){e.fled===!0&&(t.playerFleeing=!0),e.encounterEnded&&(M(t.enemy)?t.playerFleeing||e.fled?H(t,"player_escaped"):t.enemyFleeing&&H(t,"enemy_escaped"):H(t,"victory"))}const Q=2,an=1,Z=500,ee=10,rn=.1;class on{constructor(){I(this,"state");I(this,"listeners",new Map);this.state=this.createInitialState()}createInitialState(){return{player:Nt(),turn:0,log:[],encounter:null,availableNodes:new Set,structures:new Set,pendingLoot:null,gameOver:!1}}restart(){this.state=this.createInitialState(),this.log("A new journey begins..."),this.emit("turn")}start(){this.log("Welcome to Iterra.")}performAction(e){if(this.state.gameOver)return!1;const n=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;if(!_(n,e))return this.log(`Not enough ticks for ${e.name}. Need ${e.tickCost}, have ${n.ticks}.`),!1;Ge(n,e.tickCost),e.tickGain&&F(n,e.tickGain);const s={encounter:this.state.encounter??void 0,game:this.state},a=e.execute(n,s);return this.state.turn++,this.log(a.message),a.foundResource&&this.state.availableNodes.add(a.foundResource),e.tags.includes("gathering")&&this.processResourceDepletion(e.id),this.state.encounter?(sn(this.state.encounter,a),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()):e.id==="wander"&&!a.foundResource&&this.checkForEncounter(),this.processHunger(),this.processRegen(),this.processStarvation(),this.processPassOut(),this.emit("turn"),!0}processHunger(){const e=this.state.player,n=Te(e.levelInfo.stats);Math.random()<rn*(1-n)&&V(e,1)}processRegen(){const e=this.state.player;je(e)&&e.health<e.maxHealth&&(Ne(e,Q),V(e,an),this.log(`You feel restored. (+${Q} HP, ${e.health}/${e.maxHealth})`))}processStarvation(){const e=this.state.player;if(Ue(e)){const n=We();E(e,n),this.log(`You are starving! (-${n} HP, ${e.health}/${e.maxHealth})`),M(e)||(this.log("You have starved to death..."),this.triggerGameOver())}}canAffordAnyAction(){const e=this.getAvailableActions(),n=this.state.player;return e.some(s=>_(n,s))}processPassOut(){if(this.state.gameOver||this.canAffordAnyAction())return;const e=this.state.player;if(this.log("You collapse from exhaustion..."),E(e,ee),F(e,Z),this.state.turn++,this.log(`You wake up weakened. (-${ee} HP, +${Z} ticks)`),!M(e)){this.log("You never wake up..."),this.triggerGameOver();return}this.state.encounter&&!this.state.encounter.ended&&(this.log(`The ${this.state.encounter.enemy.name} attacks while you're vulnerable!`),this.processEnemyTurns()),this.emit("turn")}triggerGameOver(){this.state.gameOver=!0,this.log("GAME OVER"),this.emit("game-over")}processResourceDepletion(e){const s={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e];if(!s)return;const a=Ze(s);a&&Math.random()<a.depletionChance&&(this.state.availableNodes.delete(s),this.log(`The ${a.name.toLowerCase()} is now depleted.`))}checkForEncounter(){Math.random()<.25&&this.startEncounter()}startEncounter(e){const n=this.state.player.levelInfo.level,s=zt(e,n);this.state.encounter=s;const a=s.enemy.levelInfo.level,r=a>1?` (Lv.${a})`:"";this.log(`A wild ${s.enemy.name}${r} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,n=this.state.player,s=nn(e,n);s&&(this.log(s.message),s.encounterEnded&&(M(n)?s.fled?H(e,"enemy_escaped"):e.playerFleeing&&H(e,"player_escaped"):H(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,n=this.state.encounter.enemy,s=this.state.player;switch(e){case"victory":this.log(`You defeated the ${n.name}!`);const a=Xt(n,s.levelInfo.level),{levelsGained:r,autoStats:o}=we(s.levelInfo,a);if(this.log(`+${a} XP`),r>0){if(X(s),this.log(`LEVEL UP! You are now level ${s.levelInfo.level}!`),o.length>0){const i={};for(const l of o)i[l]=(i[l]||0)+1;const c=Object.entries(i).map(([l,u])=>`+${u} ${N[l]}`).join(", ");this.log(`Auto stats: ${c}`)}s.levelInfo.freeStatPoints>0&&this.log(`You have ${s.levelInfo.freeStatPoints} stat points to allocate!`),this.emit("level-up")}this.setPendingLoot(n);break;case"defeat":this.log("You have been defeated..."),this.state.encounter=null,this.triggerGameOver();return;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${n.name} got away.`);break}this.state.encounter=null,this.emit("encounter-end")}setPendingLoot(e){const n=De(this.state.player.levelInfo.stats),s=Wt(e,n),a={};for(const[r,o]of Object.entries(s))o>0&&(a[r]=o);if(Object.keys(a).length>0){this.state.pendingLoot=a;const r=Object.entries(a).map(([o,i])=>{const c=f(o);return`${i} ${(c==null?void 0:c.name)??o}`});this.log(`Loot available: ${r.join(", ")}`)}}takeLoot(e,n=1){if(!this.state.pendingLoot||!this.state.pendingLoot[e])return!1;const s=this.state.pendingLoot[e],a=Math.min(n,s);w(this.state.player,e,a),this.state.pendingLoot[e]-=a,this.state.pendingLoot[e]<=0&&delete this.state.pendingLoot[e],Object.keys(this.state.pendingLoot).length===0&&(this.state.pendingLoot=null);const r=f(e);return this.log(`Took ${a} ${(r==null?void 0:r.name)??e}.`),this.emit("turn"),!0}takeAllLoot(){if(this.state.pendingLoot){for(const[e,n]of Object.entries(this.state.pendingLoot))w(this.state.player,e,n);this.log("Took all loot."),this.state.pendingLoot=null,this.emit("turn")}}leaveLoot(){this.state.pendingLoot&&(this.log("Left the loot behind."),this.state.pendingLoot=null,this.emit("turn"))}dropItem(e,n=1){const s=this.state.player,a=g(s,e);if(a<=0)return!1;const r=Math.min(n,a);s.inventory[e]-=r,s.inventory[e]<=0&&delete s.inventory[e];const o=f(e);return this.log(`Dropped ${r} ${(o==null?void 0:o.name)??e}.`),this.emit("turn"),!0}equip(e,n){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const s=this.state.player,a=f(e);return a?Xe(s,e,n)?(this.log(`Equipped ${a.name}.`),this.emit("turn"),!0):(this.log(`Cannot equip ${a.name}.`),!1):!1}unequip(e){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const n=this.state.player,s=n.equipment[e];if(!s)return!1;const a=f(s);return x(n,e)?(this.log(`Unequipped ${(a==null?void 0:a.name)??s}.`),this.emit("turn"),!0):!1}allocateStat(e){const n=this.state.player;return Me(n.levelInfo,e)?(X(n),this.log(`+1 ${N[e]}!`),this.emit("turn"),!0):(this.log("No stat points available."),!1)}log(e){const n={turn:this.state.turn,message:e};this.state.log.unshift(n),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,n){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(n)}off(e,n){var s;(s=this.listeners.get(e))==null||s.delete(n)}emit(e){var n;(n=this.listeners.get(e))==null||n.forEach(s=>s(this))}getAvailableActions(){var c;const e=this.state.player.actions,n=this.state.encounter!==null,s=((c=this.state.encounter)==null?void 0:c.enemyFleeing)??!1,a=this.state.player,r={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"},o={"eat-berries":"berries","eat-cooked-meat":"cookedMeat","eat-raw-meat":"rawMeat"},i={"craft-campfire":{requiresItems:{sticks:5,rocks:3}},"place-campfire":{requiresNoCampfire:!0,requiresItems:{campfire:1}},"pickup-campfire":{requiresCampfire:!0},"cook-meat":{requiresCampfire:!0,requiresItems:{rawMeat:1}},"craft-stone-knife":{requiresItems:{rocks:2,sticks:1}},"craft-stone-spear":{requiresItems:{rocks:1,sticks:3,fiber:2}},"craft-bow":{requiresItems:{sticks:3,fiber:5}},"craft-arrows":{requiresItems:{sticks:2,rocks:1}},"craft-wooden-shield":{requiresItems:{sticks:6,fiber:3}},"process-leather":{requiresCampfire:!0,requiresItems:{rawLeather:2}},"craft-leather-helm":{requiresItems:{leather:2}},"craft-leather-chest":{requiresItems:{leather:4}},"craft-leather-legs":{requiresItems:{leather:3}},"craft-leather-boots":{requiresItems:{leather:2}}};return e.filter(l=>{var h;if(n&&l.tags.includes("non-combat")||!n&&l.tags.includes("combat")||l.id==="chase"&&!s||l.id==="let-go"&&!s||l.id==="flee"&&((h=this.state.encounter)!=null&&h.playerFleeing))return!1;const u=r[l.id];if(u&&!this.state.availableNodes.has(u))return!1;const m=o[l.id];if(m&&g(a,m)<=0)return!1;const d=i[l.id];if(d){if(d.requiresCampfire&&!this.state.structures.has("campfire")||d.requiresNoCampfire&&this.state.structures.has("campfire"))return!1;if(d.requiresItems){for(const[p,y]of Object.entries(d.requiresItems))if(g(a,p)<y)return!1}}return!(l.id==="throw-rock"&&g(a,"rocks")<=0||l.id==="ranged-attack"&&(a.equipment.mainHand!=="bow"||g(a,"arrow")<=0))})}filterActions(e){const n=this.getAvailableActions(),s=e.toLowerCase().trim();return s?n.filter(a=>{const r=a.name.toLowerCase().includes(s),o=a.description.toLowerCase().includes(s),i=a.tags.some(c=>c.toLowerCase().includes(s));return r||o||i}):n}}class cn{constructor(e){I(this,"game");I(this,"elements");this.game=e,this.elements={levelCount:document.getElementById("level-count"),xpCount:document.getElementById("xp-count"),xpNext:document.getElementById("xp-next"),tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),saturationCount:document.getElementById("saturation-count"),maxSaturation:document.getElementById("max-saturation"),weightCount:document.getElementById("weight-count"),maxWeight:document.getElementById("max-weight"),characterStatsList:document.getElementById("character-stats-list"),freePointsDisplay:document.getElementById("free-points-display"),equipmentList:document.getElementById("equipment-list"),inventoryList:document.getElementById("inventory-list"),structuresPanel:document.getElementById("structures-panel"),structuresList:document.getElementById("structures-list"),lootPanel:document.getElementById("loot-panel"),lootList:document.getElementById("loot-list"),takeAllLoot:document.getElementById("take-all-loot"),leaveLoot:document.getElementById("leave-loot"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status"),gameOverPanel:document.getElementById("game-over-panel"),restartButton:document.getElementById("restart-button")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),this.elements.restartButton.addEventListener("click",()=>{this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.render()}),this.elements.takeAllLoot.addEventListener("click",()=>{this.game.takeAllLoot()}),this.elements.leaveLoot.addEventListener("click",()=>{this.game.leaveLoot()}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderCharacterStats(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("level-up",()=>{this.renderStatus(),this.renderCharacterStats()}),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("game-over",()=>{this.renderGameOver()})}renderGameOver(){this.elements.gameOverPanel.classList.remove("hidden")}render(){this.renderStatus(),this.renderCharacterStats(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player,n=e.levelInfo;this.elements.levelCount.textContent=n.level.toString(),this.elements.xpCount.textContent=n.xp.toString(),this.elements.xpNext.textContent=n.xpToNextLevel.toString(),this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString(),this.elements.saturationCount.textContent=e.saturation.toString(),this.elements.maxSaturation.textContent=e.maxSaturation.toString();const s=oe(e),a=ie(e),r=a>0?"+":"";this.elements.weightCount.textContent=s.toFixed(1),this.elements.maxWeight.textContent=`${e.carryCapacity} (${r}${Math.round(a)} spd)`}renderCharacterStats(){const n=this.game.state.player.levelInfo,s=n.stats,a=n.freeStatPoints,r=this.game.state.encounter!==null;a>0?(this.elements.freePointsDisplay.textContent=`(${a} points)`,this.elements.freePointsDisplay.classList.add("has-points")):(this.elements.freePointsDisplay.textContent="",this.elements.freePointsDisplay.classList.remove("has-points"));let o="";for(const i of G){const c=s[i],l=N[i],u=Ye[i],m=a>0&&!r;o+=`
        <div class="stat-row">
          <span class="stat-name" title="${u}">${l}</span>
          <span class="stat-value">${c}</span>
          ${m?`<button class="allocate-btn" data-stat="${i}" title="Allocate point">+</button>`:""}
        </div>
      `}this.elements.characterStatsList.innerHTML=o,this.elements.characterStatsList.querySelectorAll(".allocate-btn").forEach(i=>{i.addEventListener("click",c=>{const l=c.target.getAttribute("data-stat");l&&this.game.allocateStat(l)})})}renderEquipment(){const e=this.game.state.player,n=e.equipment,s=this.game.state.encounter!==null,a=[{slot:"mainHand",label:"Main Hand"},{slot:"offHand",label:"Off Hand"},{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"}],r=ce(e),o=q(e),i=P(e),c=[];c.push(`${r.min}-${r.max} Dmg`),o>0&&c.push(`+${o} Armor`),i>0&&c.push(`+${i} Ranged`);let l="";c.length>0&&(l+=`<div class="equipment-bonuses">${c.join(" | ")}</div>`);const u=n.mainHand&&n.mainHand===n.offHand?n.mainHand:null;for(const{slot:m,label:d}of a){const h=n[m];if(m==="offHand"&&u)continue;const p=h?f(h):null,y=(p==null?void 0:p.name)??"Empty",k=(p==null?void 0:p.twoHanded)?"Both Hands":d;l+=`
        <div class="equipment-slot">
          <span class="slot-label">${k}:</span>
          <span class="slot-item">${y}</span>
          ${h&&!s?`<button class="unequip-btn" data-slot="${m}" title="Unequip">Ã—</button>`:""}
        </div>
      `}this.elements.equipmentList.innerHTML=l,this.elements.equipmentList.querySelectorAll(".unequip-btn").forEach(m=>{m.addEventListener("click",d=>{const h=d.target.getAttribute("data-slot");h&&this.game.unequip(h)})})}renderInventory(){const n=this.game.state.player.inventory,s=this.game.state.encounter!==null,a=Object.entries(n).filter(([r,o])=>o>0).map(([r,o])=>{const i=f(r),c=(i==null?void 0:i.name)??r,l=(i==null?void 0:i.equipSlot)&&!s;return`
          <div class="inventory-item">
            <span class="item-name">${c}: <span class="item-count">${o}</span></span>
            <div class="item-actions">
              ${l?`<button class="equip-btn" data-item-id="${r}" data-slot="${i.equipSlot}" title="Equip">E</button>`:""}
              <button class="drop-btn" data-item-id="${r}" title="Drop 1">-</button>
            </div>
          </div>
        `});a.length===0?this.elements.inventoryList.innerHTML='<span class="inventory-empty">Empty</span>':(this.elements.inventoryList.innerHTML=a.join(""),this.elements.inventoryList.querySelectorAll(".equip-btn").forEach(r=>{r.addEventListener("click",o=>{const i=o.target.getAttribute("data-item-id"),c=o.target.getAttribute("data-slot");i&&c&&this.game.equip(i,c)})}),this.elements.inventoryList.querySelectorAll(".drop-btn").forEach(r=>{r.addEventListener("click",o=>{const i=o.target.getAttribute("data-item-id");i&&this.game.dropItem(i,1)})}))}renderStructures(){const e=this.game.state.structures;if(e.size===0){this.elements.structuresPanel.classList.add("hidden");return}this.elements.structuresPanel.classList.remove("hidden");const n={campfire:"Campfire"},s=Array.from(e).map(a=>`<span class="structure-item">${n[a]??a}</span>`);this.elements.structuresList.innerHTML=s.join("")}renderLoot(){const e=this.game.state.pendingLoot;if(!e){this.elements.lootPanel.classList.add("hidden");return}this.elements.lootPanel.classList.remove("hidden");const n=Object.entries(e).filter(([s,a])=>a>0).map(([s,a])=>{const r=f(s),o=(r==null?void 0:r.name)??s,i=(r==null?void 0:r.weight)??0;return`
          <div class="loot-item">
            <span class="item-name">${o}: ${a} (${(i*a).toFixed(1)} wt)</span>
            <button class="take-btn" data-item-id="${s}" title="Take 1">+</button>
          </div>
        `});this.elements.lootList.innerHTML=n.join(""),this.elements.lootList.querySelectorAll(".take-btn").forEach(s=>{s.addEventListener("click",a=>{const r=a.target.getAttribute("data-item-id");r&&this.game.takeLoot(r,1)})})}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const n=e.enemy;this.elements.enemyName.textContent=n.name,this.elements.enemyHealth.textContent=n.health.toString(),this.elements.enemyMaxHealth.textContent=n.maxHealth.toString();let s="";e.enemyFleeing?s="Enemy is fleeing!":e.playerFleeing&&(s="You are fleeing!"),this.elements.encounterStatus.textContent=s}renderActions(){const e=this.elements.actionSearch.value,n=this.game.filterActions(e);this.elements.actionsList.innerHTML=n.map(s=>this.renderActionItem(s)).join(""),this.elements.actionsList.querySelectorAll(".action-item").forEach(s=>{const a=s.getAttribute("data-action-id"),r=n.find(o=>o.id===a);r&&s.addEventListener("click",()=>this.handleActionClick(r))})}renderActionItem(e){const n=this.game.state.player,s=_(n,e);let a;if(e.tickGain&&e.tickCost){const r=e.tickGain-e.tickCost;a=`${e.tickCost} cost, +${r} net`}else e.tickGain?a=`+${e.tickGain} ticks`:a=`${e.tickCost} ticks`;return`
      <div class="action-item ${s?"":"disabled"}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${s?"affordable":""}">${a}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(n=>`
        <div class="log-entry">
          <span class="timestamp">[${n.turn}]</span>
          ${n.message}
        </div>
      `).join("")}}const K=new on,ln=new cn(K);ln.render();K.start();window.game=K;
