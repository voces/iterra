var E=Object.defineProperty;var C=(n,e,t)=>e in n?E(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>C(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();function f(n,e,t={}){const{maxTicks:s=1e4,speed:a=100,maxHealth:r=100,damage:i=10,actions:o=[]}=t;return{id:n,name:e,ticks:s,maxTicks:s,speed:a,health:r,maxHealth:r,damage:i,actions:[...o]}}function g(n,e){return n.ticks>=e.tickCost}function y(n,e){n.ticks=Math.min(n.ticks+e,n.maxTicks)}function b(n,e){return n.ticks<e?!1:(n.ticks-=e,!0)}function p(n,e){n.health=Math.max(0,n.health-e)}function m(n){return n.health>0}const A={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(n,e)=>({success:!0,message:"You rest, recovering some energy."})},v={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(n,e)=>{const t=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:t[Math.floor(Math.random()*t.length)]}}},$={id:"attack",name:"Attack",description:"Strike your enemy.",tickCost:200,tags:["combat","offensive"],execute:(n,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to attack."};const t=e.encounter.enemy,s=n.damage;return p(t,s),m(t)?{success:!0,message:`You strike the ${t.name} for ${s} damage. (${t.health}/${t.maxHealth} HP)`}:{success:!0,message:`You strike the ${t.name} for ${s} damage, defeating it!`,encounterEnded:!0}}},L={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(n,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const t=e.encounter.enemy,s=n.speed/t.speed,r=Math.min(.9,.4*s);return Math.random()<r?{success:!0,message:`You turn and run from the ${t.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${t.name} blocks your escape!`,fled:!1}}},T={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(n,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const t=e.encounter.enemy,s=n.speed/t.speed,r=Math.min(.85,.5*s);return Math.random()<r?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${t.name}!`}):{success:!0,message:`The ${t.name} escapes into the distance.`,encounterEnded:!0}}},H={id:"let-go",name:"Let Go",description:"Allow the enemy to escape.",tickCost:50,tags:["combat"],execute:(n,e)=>e!=null&&e.encounter?{success:!0,message:`You let the ${e.encounter.enemy.name} flee.`,encounterEnded:!0}:{success:!1,message:"Nothing to let go."}},M=[$,L,T,H],w=[A,v,...M],S=1e4,x=100,F=100,P=15;function I(){return f("player","Player",{maxTicks:S,speed:x,maxHealth:F,damage:P,actions:w})}const h=[{id:"wolf",name:"Wolf",maxHealth:60,damage:12,speed:120,fleeThreshold:.3,aggressiveness:.6},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5}];function Y(n){return f(n.id,n.name,{maxHealth:n.maxHealth,damage:n.damage,speed:n.speed,maxTicks:5e3,actions:[]})}function _(){const n=h[Math.floor(Math.random()*h.length)];return Y(n)}function k(n){return h.find(e=>e.id===n.id)}function B(n){return{enemy:n??_(),playerFleeing:!1,enemyFleeing:!1,ended:!1}}function c(n,e){n.ended=!0,n.result=e}function G(n,e){const t=n.enemy,s=k(t);if(n.playerFleeing)return O(n,e);if(n.enemyFleeing)return D(n,e);const a=t.health/t.maxHealth,r=(s==null?void 0:s.fleeThreshold)??.3,i=(s==null?void 0:s.aggressiveness)??.5;if(a<=r){const o=e.health/e.maxHealth,l=(1-i)*(1-o*.5);if(Math.random()<l)return R(n)}return N(n,e)}function N(n,e){const t=n.enemy,s=t.damage;return p(e,s),m(e)?{type:"attack",message:`The ${t.name} strikes you for ${s} damage. (${e.health}/${e.maxHealth} HP)`,damage:s}:{type:"attack",message:`The ${t.name} strikes you for ${s} damage. You have been defeated!`,damage:s,encounterEnded:!0}}function R(n){return n.enemyFleeing=!0,{type:"flee",message:`The ${n.enemy.name} turns to flee!`,fled:!1}}function D(n,e){const t=n.enemy,s=t.speed/e.speed,r=Math.min(.9,.4*s);return Math.random()<r?{type:"flee",message:`The ${t.name} escapes!`,fled:!0,encounterEnded:!0}:(n.enemyFleeing=!1,{type:"flee",message:`The ${t.name} fails to escape and turns to fight!`,fled:!1})}function O(n,e){const t=n.enemy,s=k(t),a=(s==null?void 0:s.aggressiveness)??.5,r=e.health/e.maxHealth,i=a+(1-r)*.3;if(Math.random()<i){const o=t.speed/e.speed,l=Math.min(.85,.5*o);return Math.random()<l?(n.playerFleeing=!1,{type:"chase",message:`The ${t.name} catches up to you!`}):{type:"chase",message:`The ${t.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${t.name} lets you flee.`,encounterEnded:!0}}function q(n,e){const t=n.enemy,s=t.speed*2;y(t,s);const a=200;return t.ticks<a?null:(t.ticks-=a,G(n,e))}function W(n,e,t){e.fled===!0&&(n.playerFleeing=!0),e.encounterEnded&&(m(n.enemy)?n.playerFleeing||e.fled?c(n,"player_escaped"):n.enemyFleeing&&c(n,"enemy_escaped"):c(n,"victory"))}class j{constructor(){u(this,"state");u(this,"listeners",new Map);this.state={player:I(),turn:0,log:[],encounter:null}}start(){this.log("Welcome to Iterra.")}performAction(e){const t=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;if(!g(t,e))return this.log(`Not enough ticks for ${e.name}. Need ${e.tickCost}, have ${t.ticks}.`),!1;b(t,e.tickCost),e.tickGain&&y(t,e.tickGain);const s={encounter:this.state.encounter??void 0},a=e.execute(t,s);return this.state.turn++,this.log(a.message),this.state.encounter?(W(this.state.encounter,a),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()):e.id==="wander"&&this.checkForEncounter(),this.emit("turn"),!0}checkForEncounter(){Math.random()<.3&&this.startEncounter()}startEncounter(e){const t=B(e);this.state.encounter=t,this.log(`A wild ${t.enemy.name} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,t=this.state.player,s=q(e,t);s&&(this.log(s.message),s.encounterEnded&&(m(t)?s.fled?c(e,"enemy_escaped"):e.playerFleeing&&c(e,"player_escaped"):c(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,t=this.state.encounter.enemy;switch(e){case"victory":this.log(`You defeated the ${t.name}!`);break;case"defeat":this.log("You have been defeated...");break;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${t.name} got away.`);break}this.state.encounter=null,this.emit("encounter-end")}log(e){const t={turn:this.state.turn,message:e};this.state.log.unshift(t),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){var s;(s=this.listeners.get(e))==null||s.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(s=>s(this))}getAvailableActions(){var a;const e=this.state.player.actions,t=this.state.encounter!==null,s=((a=this.state.encounter)==null?void 0:a.enemyFleeing)??!1;return e.filter(r=>{var i;return!(t&&r.tags.includes("non-combat")||!t&&r.tags.includes("combat")||r.id==="chase"&&!s||r.id==="let-go"&&!s||r.id==="flee"&&((i=this.state.encounter)!=null&&i.playerFleeing))})}filterActions(e){const t=this.getAvailableActions(),s=e.toLowerCase().trim();return s?t.filter(a=>{const r=a.name.toLowerCase().includes(s),i=a.description.toLowerCase().includes(s),o=a.tags.some(l=>l.toLowerCase().includes(s));return r||i||o}):t}}class K{constructor(e){u(this,"game");u(this,"elements");this.game=e,this.elements={tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderEncounter(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions()})}render(){this.renderStatus(),this.renderEncounter(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player;this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString()}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const t=e.enemy;this.elements.enemyName.textContent=t.name,this.elements.enemyHealth.textContent=t.health.toString(),this.elements.enemyMaxHealth.textContent=t.maxHealth.toString();let s="";e.enemyFleeing?s="Enemy is fleeing!":e.playerFleeing&&(s="You are fleeing!"),this.elements.encounterStatus.textContent=s}renderActions(){const e=this.elements.actionSearch.value,t=this.game.filterActions(e);this.elements.actionsList.innerHTML=t.map(s=>this.renderActionItem(s)).join(""),this.elements.actionsList.querySelectorAll(".action-item").forEach(s=>{const a=s.getAttribute("data-action-id"),r=t.find(i=>i.id===a);r&&s.addEventListener("click",()=>this.handleActionClick(r))})}renderActionItem(e){const t=this.game.state.player,s=g(t,e);let a;if(e.tickGain&&e.tickCost){const r=e.tickGain-e.tickCost;a=`${e.tickCost} cost, +${r} net`}else e.tickGain?a=`+${e.tickGain} ticks`:a=`${e.tickCost} ticks`;return`
      <div class="action-item ${s?"":"disabled"}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${s?"affordable":""}">${a}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(t=>`
        <div class="log-entry">
          <span class="timestamp">[${t.turn}]</span>
          ${t.message}
        </div>
      `).join("")}}const d=new j,X=new K(d);X.render();d.start();window.game=d;
