var we=Object.defineProperty;var Se=(s,e,t)=>e in s?we(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var H=(s,e,t)=>Se(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const W=["vitality","strength","agility","precision","endurance","arcane","luck"],Me=100,Ee=1.5,Ae=3,$e=2;function ce(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function xe(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function Ie(s=1,e){const t=ce();return e&&Object.assign(t,e),{level:s,xp:0,xpToNextLevel:le(s+1),freeStatPoints:0,stats:t,statUsage:xe()}}function le(s){return Math.floor(Me*Math.pow(s,Ee))}function He(s,e){s.xp+=e;let t=0;const n=[];for(;s.xp>=s.xpToNextLevel;){s.xp-=s.xpToNextLevel,s.level++,s.xpToNextLevel=le(s.level+1),s.freeStatPoints+=$e,t++;const a=Be(s,Ae);n.push(...a)}return{levelsGained:t,autoStats:n}}function Be(s,e){const t=[],n=s.statUsage,a=Object.values(n).reduce((r,i)=>r+i,0);for(let r=0;r<e;r++){let i;if(a===0||Math.random()<.3)i=W[Math.floor(Math.random()*W.length)];else{let o=Math.random()*a;i="vitality";for(const[c,l]of Object.entries(n))if(o-=l,o<=0){i=c;break}}s.stats[i]++,t.push(i)}return Object.keys(s.statUsage).forEach(r=>{s.statUsage[r]=0}),t}function qe(s,e){return s.freeStatPoints<=0?!1:(s.freeStatPoints--,s.stats[e]++,!0)}function w(s,e,t=1){s.statUsage[e]+=t}function ue(s){return s.vitality*5+s.endurance*2}function Te(s){const e=s.strength,t=Math.floor(s.strength*s.agility*.05);return e+t}function De(s){const e=s.precision,t=Math.floor(s.precision*s.agility*.05);return e+t}function Pe(s,e,t=0){return s.precision*5+s.agility*3+e*2+t+10}function Re(s,e,t=0){return Math.max(0,s.agility*5+s.luck*2+e*2+10-t)}function Oe(s,e,t=0){return t===0?0:s.strength*3+s.agility*2+e*2+t}function Ye(s,e=0){return s.strength*2+e}function Ge(s,e){return s===0?0:s/(s+e*.7)}function Ne(s,e,t,n){const a=t+1,r=n+1,i=2*a/(a+r);return s/(s+e)*i}function _e(s){return s.agility*2}function de(s){return s.endurance}function Fe(s){return Math.min(.5,s.endurance*.01)}function je(s){return Math.min(.3,s.luck*.015+s.precision*.005)}function Ue(s){return 1.5+s.luck*.02}function We(s){return s.luck*.05}function N(s,e,t,n={}){const{attackerWeaponAccuracy:a=0,defenderArmorPenalty:r=0,defenderBlockBonus:i=0,defenderShieldArmor:o=0}=n,c=s.levelInfo.stats,l=e.levelInfo.stats,u=s.levelInfo.level,m=e.levelInfo.level,h=Pe(c,u,a);let d=t;const f=je(c),g=Math.random()<f;if(g){const E=Ue(c);d=Math.floor(d*E)}if(i>0){const E=Oe(l,m,i),ke=Ge(E,h);if(Math.random()<ke){const Ce=Ye(l,o),Le=Math.max(1,d-Ce);return{hit:!0,dodged:!1,blocked:!0,critical:g,damage:Le,message:g?"blocked critical":"blocked"}}}const v=Re(l,m,r),b=Ne(h,v,u,m),M=Math.random();if(M>b){const E=M<b+.15;return{hit:!1,dodged:E,blocked:!1,critical:!1,damage:0,message:E?"dodged":"missed"}}return{hit:!0,dodged:!1,blocked:!1,critical:g,damage:d,message:g?"critical":"hit"}}const K={vitality:"Vitality",strength:"Strength",agility:"Agility",precision:"Precision",endurance:"Endurance",arcane:"Arcane",luck:"Luck"},Ke={vitality:"+5 Max HP per point",strength:"+1 Melee damage, +3 Block Rating, block damage reduction",agility:"+5 Dodge Rating, +3 Attack Rating, +2 Speed",precision:"+5 Attack Rating, +1 Ranged damage",endurance:"+1 Max Saturation, reduces hunger decay",arcane:"Magic capacity (future)",luck:"+2 Dodge Rating, crit chance, loot bonus"},Xe=["unarmed","knife","spear","archery","throwing","shield","crafting"],Ve=50,Qe=1.3,Y=100;function ze(s=0){return{level:s,xp:0,xpToNextLevel:me(s+1)}}function Je(){const s={};for(const e of Xe)s[e]=ze(0);return s}function me(s){return Math.floor(Ve*Math.pow(s,Qe))}function _(s,e){if(s.level>=Y)return{levelsGained:0,newLevel:s.level};s.xp+=e;let t=0;for(;s.xp>=s.xpToNextLevel&&s.level<Y;)s.xp-=s.xpToNextLevel,s.level++,s.xpToNextLevel=me(s.level+1),t++;return s.level>=Y&&(s.level=Y,s.xp=0,s.xpToNextLevel=0),{levelsGained:t,newLevel:s.level}}function Ze(s){const t=s/100;return Math.max(0,.25*(1-t))}function et(s){const e=Math.random()*100,t=s/100,n=60*(1-t),a=n+35-15*t,r=a+4+46*t,i=r+.9+24.1*t;return e<n?"poor":e<a?"normal":e<r?"good":e<i?"excellent":"masterwork"}const A={combatHit:10,combatMiss:3,craftSuccess:15,craftFailure:5};function tt(s){return s&&{stoneKnife:"knife",ironKnife:"knife",steelKnife:"knife",stoneSpear:"spear",ironSpear:"spear",steelSpear:"spear",bow:"archery",longbow:"archery",crossbow:"archery"}[s]||"unarmed"}const st={poor:.7,normal:1,good:1.15,excellent:1.3,masterwork:1.5},nt={berries:{id:"berries",name:"Berries",description:"Sweet, ripe berries. Can be eaten for sustenance.",stackable:!0,tags:["food","raw","foraged"],weight:.1,saturationGain:4},sticks:{id:"sticks",name:"Sticks",description:"Dry wooden sticks. Useful for crafting or as a makeshift weapon.",stackable:!0,tags:["material","wood","foraged","weapon"],weight:.5,equipSlot:"mainHand",minDamage:1,maxDamage:4,strengthScaling:.3,agilityScaling:.2,accuracy:0},rocks:{id:"rocks",name:"Rocks",description:"Sturdy rocks. Can be thrown or used for crafting.",stackable:!0,tags:["material","stone","foraged","throwable"],weight:2},fiber:{id:"fiber",name:"Fiber",description:"Plant fiber from tall grass. Used for crafting rope and bindings.",stackable:!0,tags:["material","foraged"],weight:.2},rawMeat:{id:"rawMeat",name:"Raw Meat",description:"Raw meat from a slain creature. Should be cooked before eating.",stackable:!0,tags:["food","raw","meat"],weight:1,saturationGain:2},cookedMeat:{id:"cookedMeat",name:"Cooked Meat",description:"Well-cooked meat. Nutritious and filling.",stackable:!0,tags:["food","cooked","meat"],weight:1,saturationGain:8},rawLeather:{id:"rawLeather",name:"Raw Leather",description:"Untreated animal hide. Must be processed at a campfire with a knife.",stackable:!0,tags:["material","loot"],weight:2},venomGland:{id:"venomGland",name:"Venom Gland",description:"A gland filled with potent venom. Handle with care.",stackable:!0,tags:["material","loot","poison"],weight:.3},leather:{id:"leather",name:"Leather",description:"Treated leather, ready for crafting armor.",stackable:!0,tags:["material","crafted"],weight:1.5},arrow:{id:"arrow",name:"Arrow",description:"A simple arrow. Requires a bow to use.",stackable:!0,tags:["ammo","crafted"],weight:.1},stoneKnife:{id:"stoneKnife",name:"Stone Knife",description:"A sharp flint knife. Good for combat and processing leather.",stackable:!1,tags:["weapon","tool","crafted"],weight:1,equipSlot:"mainHand",minDamage:3,maxDamage:8,strengthScaling:.5,agilityScaling:1,accuracy:15},stoneSpear:{id:"stoneSpear",name:"Stone Spear",description:"A spear with a stone tip. Decent reach and damage.",stackable:!1,tags:["weapon","crafted"],weight:2.5,equipSlot:"mainHand",minDamage:5,maxDamage:12,strengthScaling:1,agilityScaling:.5,accuracy:5},bow:{id:"bow",name:"Bow",description:"A wooden bow. Requires arrows. Effective against fleeing enemies.",stackable:!1,tags:["weapon","ranged","crafted"],weight:1.5,equipSlot:"mainHand",twoHanded:!0,minDamage:4,maxDamage:10,precisionScaling:1,agilityScaling:.3,rangedBonus:15,accuracy:20},woodenShield:{id:"woodenShield",name:"Wooden Shield",description:"A crude wooden shield. Block attacks to reduce damage.",stackable:!1,tags:["armor","shield","crafted"],weight:3,equipSlot:"offHand",armorBonus:5,blockBonus:25},leatherHelm:{id:"leatherHelm",name:"Leather Helm",description:"A hardened leather helmet.",stackable:!1,tags:["armor","crafted"],weight:1,equipSlot:"head",armorBonus:3,dodgePenalty:2},leatherChest:{id:"leatherChest",name:"Leather Chest",description:"A leather chestpiece offering decent protection.",stackable:!1,tags:["armor","crafted"],weight:3,equipSlot:"chest",armorBonus:6,dodgePenalty:5},leatherLegs:{id:"leatherLegs",name:"Leather Leggings",description:"Leather leg protection.",stackable:!1,tags:["armor","crafted"],weight:2,equipSlot:"legs",armorBonus:4,dodgePenalty:3},leatherBoots:{id:"leatherBoots",name:"Leather Boots",description:"Sturdy leather boots.",stackable:!1,tags:["armor","crafted"],weight:1.5,equipSlot:"feet",armorBonus:2,dodgePenalty:1},campfire:{id:"campfire",name:"Campfire",description:"A portable campfire kit. Place it to cook meat.",stackable:!1,tags:["structure","crafted"],weight:5}};function p(s){return nt[s]}function at(s,e){const t=p(s);if(!t)throw new Error(`Unknown item: ${s}`);const n=st[e],a={itemId:s,quality:e};return t.minDamage!==void 0&&(a.minDamage=Math.max(1,Math.floor(t.minDamage*n))),t.maxDamage!==void 0&&(a.maxDamage=Math.max(1,Math.floor(t.maxDamage*n))),t.armorBonus!==void 0&&(a.armorBonus=Math.max(1,Math.floor(t.armorBonus*n))),t.blockBonus!==void 0&&(a.blockBonus=Math.max(1,Math.floor(t.blockBonus*n))),t.accuracy!==void 0&&(a.accuracy=Math.floor(t.accuracy*n)),a}function Z(s){const e=p(s);return e?e.equipSlot!==void 0||e.tags.includes("weapon")||e.tags.includes("armor")||e.tags.includes("shield"):!1}function fe(s,e,t={}){const{maxTicks:n=1e4,speed:a=100,carryCapacity:r=30,maxHealth:i=100,damage:o=10,saturation:c=10,maxSaturation:l=20,inventory:u={},equipment:m={},equipmentInstances:h={},actions:d=[],level:f=1,stats:g,skills:v}=t,b=Ie(f,g),M=i+ue(b.stats),E=l+de(b.stats);return{id:s,name:e,ticks:n,maxTicks:n,speed:a,carryCapacity:r,health:M,maxHealth:M,damage:o,saturation:c,maxSaturation:E,inventory:{...u},equipment:{...m},equipmentInstances:{...h},actions:[...d],levelInfo:b,skills:v??Je()}}function ee(s,e=100,t=20){const n=s.levelInfo.stats,a=s.maxHealth;s.maxHealth=e+ue(n),s.maxSaturation=t+de(n),s.maxHealth>a&&(s.health+=s.maxHealth-a),s.health=Math.min(s.health,s.maxHealth),s.saturation=Math.min(s.saturation,s.maxSaturation)}function X(s,e){s.ticks=Math.min(s.ticks+e,s.maxTicks)}function rt(s,e){return s.ticks<e?!1:(s.ticks-=e,!0)}function I(s,e){s.health=Math.max(0,s.health-e)}function it(s,e){s.health=Math.min(s.maxHealth,s.health+e)}function S(s){return s.health>0}function ot(s,e){s.saturation=Math.min(s.maxSaturation,s.saturation+e)}function te(s,e){s.saturation=Math.max(0,s.saturation-e)}const ct=10;function lt(s){return s.saturation>ct}function ut(s){return s.saturation<=0}function dt(s){return 5}function y(s,e){return s.inventory[e]??0}function L(s,e,t){s.inventory[e]=(s.inventory[e]??0)+t}function R(s,e,t){const n=s.inventory[e]??0;return n<t?!1:(s.inventory[e]=n-t,!0)}function he(s){let e=0;for(const[t,n]of Object.entries(s.inventory))if(n>0){const a=p(t);a&&(e+=a.weight*n)}return e}function mt(s){return he(s)/s.carryCapacity}function ge(s){const e=mt(s);return e<=.5?20*(1-e*2):e<=1?0:-50*(e-1)}function $(s){const e=_e(s.levelInfo.stats);return Math.max(10,s.speed+ge(s)+e)}function ft(s,e,t){const n=p(e);return!n||!n.equipSlot||y(s,e)<=0?!1:(n.twoHanded?(G(s,"mainHand"),G(s,"offHand"),s.equipment.mainHand=e,s.equipment.offHand=e):(G(s,t),s.equipment[t]=e),R(s,e,1),!0)}function G(s,e){const t=s.equipment[e];if(!t)return!1;const n=p(t);return n!=null&&n.twoHanded&&e==="mainHand"||n!=null&&n.twoHanded&&e==="offHand"?(delete s.equipment.mainHand,delete s.equipment.offHand,L(s,t,1)):(delete s.equipment[e],L(s,t,1)),!0}function q(s){let e=0;const t=new Set;for(const[n,a]of Object.entries(s.equipment))if(a&&!t.has(a)){t.add(a);const r=s.equipmentInstances[n];if(r&&r.armorBonus!==void 0)e+=r.armorBonus;else{const i=p(a);i!=null&&i.armorBonus&&(e+=i.armorBonus)}}return e}function D(s){let e=0;const t=new Set;for(const n of Object.values(s.equipment))if(n&&!t.has(n)){t.add(n);const a=p(n);a!=null&&a.rangedBonus&&(e+=a.rangedBonus)}return e}const se=1,ne=3;function ht(s){const e=s.equipment.mainHand;if(!e)return{min:se,max:ne};const t=s.equipmentInstances.mainHand;if(t&&t.minDamage!==void 0&&t.maxDamage!==void 0)return{min:t.minDamage,max:t.maxDamage};const n=p(e);return(n==null?void 0:n.minDamage)!==void 0&&(n==null?void 0:n.maxDamage)!==void 0?{min:n.minDamage,max:n.maxDamage}:{min:se,max:ne}}function gt(s){const e=s.equipment.mainHand,t=s.levelInfo.stats;if(!e)return Math.floor(t.strength*.5+t.agility*.3);const n=p(e);if(!n)return Math.floor(t.strength*.5+t.agility*.3);let a=0;return n.strengthScaling&&(a+=t.strength*n.strengthScaling),n.agilityScaling&&(a+=t.agility*n.agilityScaling),n.precisionScaling&&(a+=t.precision*n.precisionScaling),Math.floor(a)}function pe(s){const e=ht(s),t=gt(s);return{min:e.min+t,max:e.max+t}}function ye(s){const e=pe(s);return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function P(s,e){const t=e/(e+20);return Math.max(1,Math.floor(s*(1-t)))}function Q(s){const e=s.equipment.mainHand;if(!e)return 0;const t=s.equipmentInstances.mainHand;if(t&&t.accuracy!==void 0)return t.accuracy;const n=p(e);return(n==null?void 0:n.accuracy)??0}function F(s){let e=0;const t=new Set;for(const n of Object.values(s.equipment))if(n&&!t.has(n)){t.add(n);const a=p(n);a!=null&&a.dodgePenalty&&(e+=a.dodgePenalty)}return e}function pt(s){const e=s.equipment.offHand;if(!e)return 0;const t=s.equipmentInstances.offHand;if(t&&t.blockBonus!==void 0)return t.blockBonus;const n=p(e);return(n==null?void 0:n.blockBonus)??0}function yt(s){const e=s.equipment.offHand;if(!e)return 0;const t=s.equipmentInstances.offHand;if(t&&t.armorBonus!==void 0)return t.armorBonus;const n=p(e);return n!=null&&n.blockBonus?n.armorBonus??0:0}const ve={cave:{id:"cave",name:"Dark Cave",description:"A dark cave entrance yawns before you.",discoveryChance:.08,discoveryMessage:"You discover the entrance to a dark cave!",exitDiscoveryChance:.15,availableEnemies:["wolf","snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["cavern"]},forest:{id:"forest",name:"Dense Forest",description:"A dense forest with towering trees.",discoveryChance:.1,discoveryMessage:"You find a path leading into a dense forest!",exitDiscoveryChance:.12,availableEnemies:["rabbit","deer","wolf","boar"],availableResources:["berryBush","fallenBranches","tallGrass"],childLocations:["clearing"]},ruins:{id:"ruins",name:"Ancient Ruins",description:"Crumbling stone structures from a forgotten age.",discoveryChance:.05,discoveryMessage:"You stumble upon ancient ruins hidden in the landscape!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["ruinsCrypt"]},village:{id:"village",name:"Abandoned Village",description:"An eerily quiet abandoned village.",discoveryChance:.04,discoveryMessage:"You discover an abandoned village!",exitDiscoveryChance:.2,availableEnemies:["bandit"],availableResources:["fallenBranches"],childLocations:["villageWell"],isSafe:!1},cavern:{id:"cavern",name:"Deep Cavern",description:"A vast underground cavern with dripping stalactites.",discoveryChance:.1,discoveryMessage:"You find a passage leading deeper into the cavern!",exitDiscoveryChance:.12,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"cave"},clearing:{id:"clearing",name:"Forest Clearing",description:"A peaceful clearing in the forest.",discoveryChance:.12,discoveryMessage:"You emerge into a sunlit clearing!",exitDiscoveryChance:.25,availableEnemies:["rabbit","deer"],availableResources:["berryBush","tallGrass"],parentId:"forest",isSafe:!0},ruinsCrypt:{id:"ruinsCrypt",name:"Ancient Crypt",description:"A dusty crypt beneath the ruins.",discoveryChance:.08,discoveryMessage:"You find stairs descending into a crypt!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"ruins"},villageWell:{id:"villageWell",name:"Village Well",description:"An old well in the village center.",discoveryChance:.15,discoveryMessage:"You notice an old well in the village!",exitDiscoveryChance:.3,availableEnemies:["snake"],availableResources:["rockyOutcrop"],parentId:"village"}};function k(s){return ve[s]}function vt(){return Object.values(ve)}function bt(s){if(s===null)return vt().filter(t=>!t.parentId);const e=k(s);return!e||!e.childLocations?[]:e.childLocations.map(t=>k(t)).filter(t=>t!==void 0)}function kt(s){const e=bt(s);for(const t of e)if(Math.random()<t.discoveryChance)return t;return null}function Ct(s){if(s===null)return!1;const e=k(s);return e?Math.random()<e.exitDiscoveryChance:!1}const be={berryBush:{id:"berryBush",name:"Berry Bush",description:"A bush laden with ripe berries.",gatherActionId:"gather-berries",discoveryChance:.2,discoveryMessage:"You stumble upon a bush laden with ripe berries!",depletionChance:.6,dropOffChance:.15},fallenBranches:{id:"fallenBranches",name:"Fallen Branches",description:"Some fallen branches on the ground.",gatherActionId:"gather-sticks",discoveryChance:.2,discoveryMessage:"You find some fallen branches on the ground.",depletionChance:.5,dropOffChance:.1},rockyOutcrop:{id:"rockyOutcrop",name:"Rocky Outcrop",description:"Some useful rocks jutting from the ground.",gatherActionId:"gather-rocks",discoveryChance:.15,discoveryMessage:"You notice some useful rocks nearby.",depletionChance:.4,dropOffChance:.05},tallGrass:{id:"tallGrass",name:"Tall Grass",description:"A patch of tall grass with useful fibers.",gatherActionId:"gather-fiber",discoveryChance:.2,discoveryMessage:"You find a patch of tall grass.",depletionChance:.5,dropOffChance:.12}};function V(s){return be[s]}function ae(){return Object.values(be)}function Lt(s){if(s===null)return ae();const e=k(s);return!e||!e.availableResources||e.availableResources.length===0?ae():e.availableResources.map(t=>V(t)).filter(t=>t!==void 0)}function wt(s=null){const e=Lt(s);let t=0;const n=Math.random();for(const a of e)if(t+=a.discoveryChance,n<t)return a;return null}const St={campfire:{id:"campfire",name:"Craft Campfire",description:"Craft a portable campfire using sticks and rocks.",inputs:{sticks:5,rocks:3},outputs:{campfire:1},tickCost:400},cookedMeat:{id:"cookedMeat",name:"Cook Meat",description:"Cook raw meat on the campfire.",inputs:{rawMeat:1},outputs:{cookedMeat:1},tickCost:200,requiresCampfire:!0},leather:{id:"leather",name:"Process Leather",description:"Process raw leather at the campfire. Requires a knife.",inputs:{rawLeather:2},outputs:{leather:1},tickCost:300,requiresCampfire:!0},stoneKnife:{id:"stoneKnife",name:"Craft Stone Knife",description:"Craft a stone knife from rocks and sticks.",inputs:{rocks:2,sticks:1},outputs:{stoneKnife:1},tickCost:250},stoneSpear:{id:"stoneSpear",name:"Craft Stone Spear",description:"Craft a stone spear from rocks, sticks, and fiber.",inputs:{rocks:1,sticks:3,fiber:2},outputs:{stoneSpear:1},tickCost:300},bow:{id:"bow",name:"Craft Bow",description:"Craft a bow from sticks and fiber.",inputs:{sticks:3,fiber:5},outputs:{bow:1},tickCost:400},arrow:{id:"arrow",name:"Craft Arrows",description:"Craft arrows from sticks and rocks.",inputs:{sticks:2,rocks:1},outputs:{arrow:5},tickCost:150},woodenShield:{id:"woodenShield",name:"Craft Wooden Shield",description:"Craft a wooden shield from sticks and fiber.",inputs:{sticks:6,fiber:3},outputs:{woodenShield:1},tickCost:350},leatherHelm:{id:"leatherHelm",name:"Craft Leather Helm",description:"Craft a leather helmet.",inputs:{leather:2},outputs:{leatherHelm:1},tickCost:200},leatherChest:{id:"leatherChest",name:"Craft Leather Chest",description:"Craft a leather chestpiece.",inputs:{leather:4},outputs:{leatherChest:1},tickCost:300},leatherLegs:{id:"leatherLegs",name:"Craft Leather Leggings",description:"Craft leather leggings.",inputs:{leather:3},outputs:{leatherLegs:1},tickCost:250},leatherBoots:{id:"leatherBoots",name:"Craft Leather Boots",description:"Craft leather boots.",inputs:{leather:2},outputs:{leatherBoots:1},tickCost:200}};function C(s){return St[s]}function O(s,e,t){if(s.requiresCampfire&&!t.has("campfire"))return{canCraft:!1,reason:"Requires a placed campfire."};for(const[n,a]of Object.entries(s.inputs)){const r=e[n]??0;if(r<a)return{canCraft:!1,reason:`Need ${a} ${n}, have ${r}.`}}return{canCraft:!0}}function j(s,e){for(const[t,n]of Object.entries(s.inputs))e[t]=(e[t]??0)-n;for(const[t,n]of Object.entries(s.outputs))e[t]=(e[t]??0)+n}function x(s,e,t,n){const{canCraft:a,reason:r}=O(s,t,n);if(!a)return{success:!1,failed:!1,message:r};const i=e.skills.crafting,o=i.level,c=Ze(o),l=Math.random()<c;for(const[d,f]of Object.entries(s.inputs))t[d]=(t[d]??0)-f;const u=l?A.craftFailure:A.craftSuccess,m=_(i,u);if(l)return{success:!1,failed:!0,message:`Crafting failed! Materials were lost. (+${u} crafting XP)`,skillGain:m};const h=[];for(const[d,f]of Object.entries(s.outputs)){const g=Z(d)?et(o):"normal";for(let v=0;v<f;v++)if(Z(d)){const b=at(d,g);h.push({itemId:d,quality:g,instance:b})}else h.push({itemId:d,quality:"normal"});t[d]=(t[d]??0)+f}return{success:!0,failed:!1,message:Mt(h,u),craftedItems:h,skillGain:m}}function Mt(s,e){if(!s||s.length===0)return"Crafted successfully!";const n=s[0].quality,a=new Map;for(const o of s)a.set(o.itemId,(a.get(o.itemId)??0)+1);const r=Array.from(a.entries()).map(([o,c])=>c>1?`${c}x ${o}`:o).join(", ");let i="";return n!=="normal"&&(i=` (${n.charAt(0).toUpperCase()+n.slice(1)} quality!)`),`Crafted ${r}${i} (+${e} crafting XP)`}const Et={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(s,e)=>({success:!0,message:"You rest, recovering some energy."})},At={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(s,e)=>{var o,c,l;if((o=e==null?void 0:e.game)!=null&&o.structures.has("campfire"))return{success:!1,message:"You can't wander off with a campfire burning! Pick it up or smother it first."};const t=((c=e==null?void 0:e.game)==null?void 0:c.currentLocation)??null;if(t!==null&&!((l=e==null?void 0:e.game)!=null&&l.foundExit)&&Ct(t)){const m=k(t);return{success:!0,message:`You find a way out of ${(m==null?void 0:m.name)??"this location"}!`,foundExit:!0}}const n=kt(t);if(n)return{success:!0,message:n.discoveryMessage,foundLocation:n.id};const a=wt(t);if(a)return{success:!0,message:a.discoveryMessage,foundResource:a.id};const r=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:r[Math.floor(Math.random()*r.length)]}}},$t={id:"gather-berries",name:"Gather Berries",description:"Pick berries from the bush.",tickCost:150,tags:["gathering","non-combat"],execute:(s,e)=>{const t=2+Math.floor(Math.random()*3);return L(s,"berries",t),{success:!0,message:`You gather ${t} berries. (${y(s,"berries")} total)`}}},xt={id:"gather-sticks",name:"Gather Sticks",description:"Collect sticks from the ground.",tickCost:100,tags:["gathering","non-combat"],execute:(s,e)=>{const t=2+Math.floor(Math.random()*3);return L(s,"sticks",t),{success:!0,message:`You gather ${t} sticks. (${y(s,"sticks")} total)`}}},It={id:"gather-rocks",name:"Gather Rocks",description:"Collect rocks from the ground.",tickCost:120,tags:["gathering","non-combat"],execute:(s,e)=>{const t=1+Math.floor(Math.random()*2);return L(s,"rocks",t),{success:!0,message:`You gather ${t} rocks. (${y(s,"rocks")} total)`}}},Ht={id:"gather-fiber",name:"Gather Fiber",description:"Collect fiber from tall grass.",tickCost:100,tags:["gathering","non-combat"],execute:(s,e)=>{const t=3+Math.floor(Math.random()*3);return L(s,"fiber",t),{success:!0,message:`You gather ${t} fiber. (${y(s,"fiber")} total)`}}},Bt={id:"craft-campfire",name:"Craft Campfire",description:"Craft a portable campfire. (5 sticks, 3 rocks)",tickCost:400,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=C("campfire"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:a,reason:r}=O(t,s.inventory,n);return a?(j(t,s.inventory),{success:!0,message:"You craft a campfire. Place it to cook meat!"}):{success:!1,message:r}}},qt={id:"place-campfire",name:"Place Campfire",description:"Place your campfire on the ground.",tickCost:50,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return y(s,"campfire")<=0?{success:!1,message:"You have no campfire to place."}:(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?{success:!1,message:"A campfire is already placed."}:(R(s,"campfire",1),e!=null&&e.game&&e.game.structures.add("campfire"),{success:!0,message:"You place the campfire. You can now cook meat!"})}},Tt={id:"pickup-campfire",name:"Pick Up Campfire",description:"Pick up your placed campfire.",tickCost:50,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?(e.game.structures.delete("campfire"),L(s,"campfire",1),{success:!0,message:"You pick up the campfire."}):{success:!1,message:"No campfire is placed."}}},Dt={id:"smother-campfire",name:"Smother Campfire",description:"Extinguish and discard your placed campfire.",tickCost:25,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?(e.game.structures.delete("campfire"),{success:!0,message:"You smother the campfire. It is destroyed."}):{success:!1,message:"No campfire is placed."}}},Pt={id:"cook-meat",name:"Cook Meat",description:"Cook raw meat on the campfire.",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=C("cookedMeat"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:a,reason:r}=O(t,s.inventory,n);return a?(j(t,s.inventory),{success:!0,message:`You cook the meat. (${y(s,"cookedMeat")} cooked meat)`}):{success:!1,message:r}}},Rt={id:"craft-stone-knife",name:"Craft Stone Knife",description:"Craft a stone knife. (2 rocks, 1 stick)",tickCost:250,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("stoneKnife"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A fast weapon that scales with agility!"}}},Ot={id:"craft-stone-spear",name:"Craft Stone Spear",description:"Craft a stone spear. (1 rock, 3 sticks, 2 fiber)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("stoneSpear"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A powerful weapon that scales with strength!"}}},Yt={id:"craft-bow",name:"Craft Bow",description:"Craft a bow. (3 sticks, 5 fiber)",tickCost:400,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("bow"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it and craft arrows to shoot!"}}},Gt={id:"craft-arrows",name:"Craft Arrows",description:"Craft 5 arrows. (2 sticks, 1 rock)",tickCost:150,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=C("arrow"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:a,reason:r}=O(t,s.inventory,n);return a?(j(t,s.inventory),{success:!0,message:`You craft 5 arrows. (${y(s,"arrow")} total)`}):{success:!1,message:r}}},Nt={id:"craft-wooden-shield",name:"Craft Wooden Shield",description:"Craft a wooden shield. (6 sticks, 3 fiber)",tickCost:350,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("woodenShield"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it for blocking!"}}},_t={id:"process-leather",name:"Process Leather",description:"Process raw leather at campfire. (2 raw leather)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=C("leather"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:a,reason:r}=O(t,s.inventory,n);return a?(j(t,s.inventory),{success:!0,message:`You process the leather. (${y(s,"leather")} leather)`}):{success:!1,message:r}}},Ft={id:"craft-leather-helm",name:"Craft Leather Helm",description:"Craft a leather helmet. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("leatherHelm"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},jt={id:"craft-leather-chest",name:"Craft Leather Chest",description:"Craft a leather chestpiece. (4 leather)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("leatherChest"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},Ut={id:"craft-leather-legs",name:"Craft Leather Leggings",description:"Craft leather leggings. (3 leather)",tickCost:250,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("leatherLegs"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},Wt={id:"craft-leather-boots",name:"Craft Leather Boots",description:"Craft leather boots. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var r;const t=C("leatherBoots"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,a=x(t,s,s.inventory,n);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}};function z(s,e,t,n){var r;const a=p(s);return{id:e,name:t,description:`Eat ${((r=a==null?void 0:a.name)==null?void 0:r.toLowerCase())??s} to restore saturation.`,tickCost:n,tags:["consumption","non-combat"],execute:(i,o)=>{var u,m;if(y(i,s)<=0)return{success:!1,message:`You have no ${((u=a==null?void 0:a.name)==null?void 0:u.toLowerCase())??s} to eat.`};R(i,s,1);const l=(a==null?void 0:a.saturationGain)??1;return ot(i,l),{success:!0,message:`You eat the ${((m=a==null?void 0:a.name)==null?void 0:m.toLowerCase())??s}. (+${l} saturation, ${i.saturation}/${i.maxSaturation})`}}}}const Kt=z("berries","eat-berries","Eat Berries",50),Xt=z("cookedMeat","eat-cooked-meat","Eat Cooked Meat",75),Vt=z("rawMeat","eat-raw-meat","Eat Raw Meat",50),Qt={id:"attack",name:"Attack",description:"Strike your enemy with equipped weapon.",tickCost:200,tags:["combat","offensive"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to attack."};const t=e.encounter.enemy;w(s.levelInfo,"strength",1),w(s.levelInfo,"precision",.5);const n=s.equipment.mainHand,a=tt(n),r=ye(s),i=Q(s),o=F(t),c=N(s,t,r,{attackerWeaponAccuracy:i,defenderArmorPenalty:o}),l=c.hit?A.combatHit:A.combatMiss,u=_(s.skills[a],l);if(!c.hit)return{success:!0,message:c.dodged?`The ${t.name} dodges your attack!`:`You swing at the ${t.name} but miss!`};const m=q(t),h=P(c.damage,m);I(t,h),c.critical&&w(s.levelInfo,"luck",1);const d=c.critical?" Critical hit!":"",f=u.levelsGained>0?` ${a} leveled up!`:"";return S(t)?{success:!0,message:`You strike the ${t.name} for ${h} damage.${d}${f} (${t.health}/${t.maxHealth} HP)`}:{success:!0,message:`You strike the ${t.name} for ${h} damage.${d}${f} Defeated!`,encounterEnded:!0}}},zt={id:"throw-rock",name:"Throw Rock",description:"Throw a rock at your enemy. Ranged attack.",tickCost:150,tags:["combat","offensive","ranged"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to throw at."};if(y(s,"rocks")<=0)return{success:!1,message:"You have no rocks to throw."};R(s,"rocks",1);const t=e.encounter.enemy;w(s.levelInfo,"precision",1),w(s.levelInfo,"agility",.3);const n=5,a=10,r=De(s.levelInfo.stats);let i=n+r+Math.floor(Math.random()*(a-n+1));const o=D(s),c=e.encounter.enemyFleeing?Math.floor(o/2):0;i+=c;const l=F(t),u=N(s,t,i,{attackerWeaponAccuracy:5,defenderArmorPenalty:l}),m=u.hit?A.combatHit:A.combatMiss,h=_(s.skills.throwing,m);if(!u.hit)return{success:!0,message:u.dodged?`The ${t.name} dodges your thrown rock!`:`You throw a rock at the ${t.name} but miss!`};u.critical&&w(s.levelInfo,"luck",1);const d=q(t),f=P(u.damage,d);I(t,f);const g=u.critical?" Critical hit!":"",v=h.levelsGained>0?" Throwing leveled up!":"";return S(t)?{success:!0,message:`Your rock hits the ${t.name} for ${f} damage.${g}${v} (${t.health}/${t.maxHealth} HP)`}:{success:!0,message:`Your rock strikes the ${t.name} for ${f} damage.${g}${v} Defeated!`,encounterEnded:!0}}},Jt={id:"ranged-attack",name:"Shoot Arrow",description:"Fire an arrow at your enemy. Very effective against fleeing targets.",tickCost:180,tags:["combat","offensive","ranged"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to shoot."};if(s.equipment.mainHand!=="bow")return{success:!1,message:"You need a bow equipped."};if(y(s,"arrow")<=0)return{success:!1,message:"You have no arrows."};R(s,"arrow",1);const n=e.encounter.enemy;w(s.levelInfo,"precision",1.5),w(s.levelInfo,"agility",.5);let a=ye(s);const r=D(s),i=e.encounter.enemyFleeing?r:0;a+=i;const o=Q(s),c=F(n),l=N(s,n,a,{attackerWeaponAccuracy:o,defenderArmorPenalty:c}),u=l.hit?A.combatHit:A.combatMiss,m=_(s.skills.archery,u);if(!l.hit)return{success:!0,message:l.dodged?`The ${n.name} narrowly dodges your arrow!`:`Your arrow flies past the ${n.name}!`};l.critical&&w(s.levelInfo,"luck",1);const h=q(n),d=P(l.damage,h);I(n,d);const f=l.critical?" Critical hit!":"",g=m.levelsGained>0?" Archery leveled up!":"";if(!S(n)){const v=e.encounter.enemyFleeing?" as it flees":"";return{success:!0,message:`Your arrow strikes the ${n.name}${v} for ${d} damage.${f}${g} Defeated!`,encounterEnded:!0}}return{success:!0,message:`Your arrow hits the ${n.name} for ${d} damage.${f}${g} (${n.health}/${n.maxHealth} HP)`}}},Zt={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const t=e.encounter.enemy,n=$(s),a=$(t),r=n/a,o=Math.min(.9,.4*r);return Math.random()<o?{success:!0,message:`You turn and run from the ${t.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${t.name} blocks your escape!`,fled:!1}}},es={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const t=e.encounter.enemy,n=$(s),a=$(t),r=n/a,o=Math.min(.85,.5*r);return Math.random()<o?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${t.name}!`}):{success:!0,message:`The ${t.name} escapes into the distance.`,encounterEnded:!0}}},ts={id:"let-go",name:"Let Go",description:"Allow the enemy to escape.",tickCost:50,tags:["combat"],execute:(s,e)=>e!=null&&e.encounter?{success:!0,message:`You let the ${e.encounter.enemy.name} flee.`,encounterEnded:!0}:{success:!1,message:"Nothing to let go."}},ss={id:"exit-location",name:"Exit Location",description:"Leave the current location through a discovered exit.",tickCost:100,tags:["basic","exploration","movement","non-combat","location"],execute:(s,e)=>{var n,a,r;if((n=e==null?void 0:e.game)!=null&&n.structures.has("campfire"))return{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."};if(((a=e==null?void 0:e.game)==null?void 0:a.currentLocation)===null)return{success:!1,message:"You are already in the wilderness."};if(!((r=e==null?void 0:e.game)!=null&&r.foundExit))return{success:!1,message:"You haven't found a way out yet. Keep exploring!"};const t=k(e.game.currentLocation);return{success:!0,message:`You make your way out of ${(t==null?void 0:t.name)??"the location"}...`}}};function ns(s,e){return{id:`enter-location-${s}`,name:`Enter ${e}`,description:`Enter the ${e}.`,tickCost:150,tags:["basic","exploration","movement","non-combat","location"],execute:(t,n)=>{var a;return(a=n==null?void 0:n.game)!=null&&a.structures.has("campfire")?{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."}:{success:!0,message:`You prepare to enter ${e}...`}}}}const as=[Qt,zt,Jt,Zt,es,ts],rs=[$t,xt,It,Ht],is=[Bt,qt,Tt,Dt,Pt,Rt,Ot,Yt,Gt,Nt,_t,Ft,jt,Ut,Wt],os=[Kt,Xt,Vt],cs=[ss],ls=[Et,At,...as,...rs,...is,...os,...cs],us=1e4,ds=100,ms=100,fs=15,hs={vitality:5,strength:5,agility:5,precision:5,endurance:3,arcane:0,luck:2};function gs(){return fe("player","Player",{maxTicks:us,speed:ds,maxHealth:ms,damage:fs,actions:ls,stats:hs,level:0})}const T=[{id:"rabbit",name:"Rabbit",maxHealth:15,damage:2,speed:150,fleeThreshold:.9,aggressiveness:.05,loot:{rawMeat:{min:1,max:1,chance:1}},statGrowth:{vitality:.5,strength:.2,agility:3,precision:.5,baseLevel:1,xpReward:8}},{id:"deer",name:"Deer",maxHealth:35,damage:6,speed:130,fleeThreshold:.8,aggressiveness:.1,loot:{rawMeat:{min:2,max:3,chance:1},rawLeather:{min:1,max:2,chance:.9}},statGrowth:{vitality:1,strength:.5,agility:2,precision:.5,baseLevel:1,xpReward:15}},{id:"wolf",name:"Wolf",maxHealth:50,damage:10,speed:120,fleeThreshold:.3,aggressiveness:.6,loot:{rawMeat:{min:1,max:2,chance:.9},rawLeather:{min:1,max:2,chance:.7}},statGrowth:{vitality:1.5,strength:1,agility:1.5,precision:1,baseLevel:1,xpReward:25}},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8,loot:{rawMeat:{min:2,max:4,chance:1},rawLeather:{min:1,max:3,chance:.8}},statGrowth:{vitality:3,strength:2,agility:.5,precision:1,baseLevel:2,xpReward:35}},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4,loot:{rawMeat:{min:1,max:1,chance:.5},venomGland:{min:1,max:2,chance:.8}},statGrowth:{vitality:.5,strength:2.5,agility:3,precision:2,baseLevel:1,xpReward:30}},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5,loot:{},usesInventory:!0,statGrowth:{vitality:1.5,strength:1.5,agility:1.5,precision:1.5,baseLevel:2,xpReward:40}}];function ps(){const s={};return Math.random()<.5&&(s.berries=Math.floor(Math.random()*4)+1),Math.random()<.6&&(s.sticks=Math.floor(Math.random()*3)+1),Math.random()<.4&&(s.rocks=Math.floor(Math.random()*2)+1),Math.random()<.3&&(s.rawMeat=Math.floor(Math.random()*2)+1),Math.random()<.2&&(s.cookedMeat=1),s}function ys(s,e){const{baseLevel:t}=s.statGrowth,n=Math.floor((e-1)*.4),a=Math.floor(Math.random()*3)-1;return Math.max(1,t+n+a)}function vs(s,e){const{statGrowth:t}=s,n=ce(),a=()=>.8+Math.random()*.4,r=Math.max(0,e-1);return n.vitality=Math.floor(t.vitality*r*a()),n.strength=Math.floor(t.strength*r*a()),n.agility=Math.floor(t.agility*r*a()),n.precision=Math.floor(t.precision*r*a()),n.endurance=0,n.arcane=0,n.luck=Math.floor(Math.random()*2),n}function bs(s,e=1){const t=s.usesInventory?ps():{},n=ys(s,e),a=vs(s,n),r=1+(n-1)*.1,i=Math.floor(s.maxHealth*r),o=Math.floor(s.damage*r);return fe(s.id,s.name,{maxHealth:i,damage:o,speed:s.speed,maxTicks:5e3,inventory:t,actions:[],level:n,stats:a})}function ks(s,e=0){const t=U(s);if(!t)return{};if(t.usesInventory)return{...s.inventory};const n={};for(const[a,r]of Object.entries(t.loot))if(Math.random()<r.chance){const i=Math.floor(Math.random()*(r.max-r.min+1))+r.min,o=Math.floor(i*e);n[a]=i+o}return n}function Cs(s){if(s===null)return T;const e=k(s);return!e||!e.availableEnemies||e.availableEnemies.length===0?T:e.availableEnemies.map(t=>T.find(n=>n.id===t)).filter(t=>t!==void 0)}function Ls(s=1,e=null){const t=Cs(e);let n;if(s<=2){const r=t.filter(o=>o.id==="rabbit"||o.id==="deer"),i=t.filter(o=>o.id!=="rabbit"&&o.id!=="deer"&&o.statGrowth.baseLevel<=s);Math.random()<.5&&r.length>0?n=r:i.length>0?n=i:n=r.length>0?r:t}else n=t.filter(r=>r.statGrowth.baseLevel<=s),n.length===0&&(n=t);n.length===0&&(n=T);const a=n[Math.floor(Math.random()*n.length)];return bs(a,s)}function ws(s,e){const t=U(s);if(!t)return 10;const n=t.statGrowth.xpReward,a=s.levelInfo.level,r=a-e;let i=1;return r>0?i=1+r*.1:r<0&&(i=Math.max(.1,1+r*.15)),Math.floor(n*a*i)}function U(s){return T.find(e=>e.id===s.id)}function Ss(s){const e=s.damage,t=Math.floor(e*.3),n=Math.max(1,e-t),a=e+t,r=Te(s.levelInfo.stats);return n+r+Math.floor(Math.random()*(a-n+1))}function Ms(s,e=1,t=null){return{enemy:s??Ls(e,t),playerFleeing:!1,enemyFleeing:!1,ended:!1}}function B(s,e){s.ended=!0,s.result=e}function Es(s,e){const t=s.enemy,n=U(t);if(s.playerFleeing)return Is(s,e);if(s.enemyFleeing)return xs(s,e);const a=t.health/t.maxHealth,r=(n==null?void 0:n.fleeThreshold)??.3,i=(n==null?void 0:n.aggressiveness)??.5;if(a<=r){const o=e.health/e.maxHealth,c=(1-i)*(1-o*.5);if(Math.random()<c)return $s(s)}return As(s,e)}function As(s,e){const t=s.enemy,n=Ss(t),a=Q(t),r=F(e),i=pt(e),o=yt(e),c=N(t,e,n,{attackerWeaponAccuracy:a,defenderArmorPenalty:r,defenderBlockBonus:i,defenderShieldArmor:o});if(!c.hit&&!c.blocked)return{type:"attack",message:c.dodged?`You dodge the ${t.name}'s attack!`:`The ${t.name} attacks but misses!`,damage:0};if(c.blocked){const f=q(e),g=D(e),v=f+Math.floor(g/3),b=P(c.damage,v);I(e,b);const M=c.critical?" (crit blocked!)":"";return S(e)?{type:"attack",message:`You block the ${t.name}'s attack, taking ${b} damage.${M} (${e.health}/${e.maxHealth} HP)`,damage:b}:{type:"attack",message:`You block the ${t.name}'s attack but take ${b} damage.${M} You have been defeated!`,damage:b,encounterEnded:!0}}const l=q(e),u=D(e),m=l+Math.floor(u/3),h=P(c.damage,m);I(e,h);const d=c.critical?" Critical hit!":"";return S(e)?{type:"attack",message:`The ${t.name} strikes you for ${h} damage.${d} (${e.health}/${e.maxHealth} HP)`,damage:h}:{type:"attack",message:`The ${t.name} strikes you for ${h} damage.${d} You have been defeated!`,damage:h,encounterEnded:!0}}function $s(s){return s.enemyFleeing=!0,{type:"flee",message:`The ${s.enemy.name} turns to flee!`,fled:!1}}function xs(s,e){const t=s.enemy,n=$(t),a=$(e),r=n/a,o=Math.min(.9,.4*r);return Math.random()<o?{type:"flee",message:`The ${t.name} escapes!`,fled:!0,encounterEnded:!0}:(s.enemyFleeing=!1,{type:"flee",message:`The ${t.name} fails to escape and turns to fight!`,fled:!1})}function Is(s,e){const t=s.enemy,n=U(t),a=(n==null?void 0:n.aggressiveness)??.5,r=e.health/e.maxHealth,i=a+(1-r)*.3;if(Math.random()<i){const o=$(t),c=$(e),l=o/c,u=Math.min(.85,.5*l);return Math.random()<u?(s.playerFleeing=!1,{type:"chase",message:`The ${t.name} catches up to you!`}):{type:"chase",message:`The ${t.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${t.name} lets you flee.`,encounterEnded:!0}}function Hs(s,e){const t=s.enemy,n=t.speed*2;X(t,n);const a=200;return t.ticks<a?null:(t.ticks-=a,Es(s,e))}function Bs(s,e,t){e.fled===!0&&(s.playerFleeing=!0),e.encounterEnded&&(S(s.enemy)?s.playerFleeing||e.fled?B(s,"player_escaped"):s.enemyFleeing&&B(s,"enemy_escaped"):B(s,"victory"))}const re=2,qs=1,ie=500,oe=10,Ts=.1;class Ds{constructor(){H(this,"state");H(this,"listeners",new Map);this.state=this.createInitialState()}createInitialState(){return{player:gs(),turn:0,log:[],encounter:null,availableNodes:[],structures:new Set,pendingLoot:null,gameOver:!1,currentLocation:null,locationStack:[],discoveredLocations:{},foundExit:!1}}restart(){this.state=this.createInitialState(),this.log("A new journey begins..."),this.emit("turn")}start(){this.log("Welcome to Iterra.")}performAction(e){if(this.state.gameOver)return!1;const t=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;const n=this.getEffectiveTickCost(e);if(t.ticks<n)return this.log(`Not enough ticks for ${e.name}. Need ${n}, have ${t.ticks}.`),!1;rt(t,n),e.tickGain&&X(t,e.tickGain);const a={encounter:this.state.encounter??void 0,game:this.state},r=e.execute(t,a);if(this.state.turn++,this.log(r.message),r.foundResource){const i=r.foundResource;this.state.availableNodes.push({nodeId:i,distance:0})}if(r.foundLocation&&this.discoverLocation(r.foundLocation),r.foundExit&&this.findExit(),e.id==="exit-location"&&r.success&&this.exitLocation(),e.id.startsWith("enter-location-")&&r.success){const i=e.id.replace("enter-location-","");this.enterLocation(i)}return e.tags.includes("gathering")&&this.processResourceDepletion(e.id),this.state.encounter?(Bs(this.state.encounter,r),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()):(e.id==="wander"&&(this.processNodeDropOff(),this.processLocationDropOff()),e.id==="wander"&&!r.foundResource&&!r.foundLocation&&!r.foundExit?this.checkForEncounter(.25):e.tags.includes("combat")||this.checkForEncounter(.03)),this.processHunger(),this.processRegen(),this.processStarvation(),this.processPassOut(),this.emit("turn"),!0}processHunger(){const e=this.state.player,t=Fe(e.levelInfo.stats);Math.random()<Ts*(1-t)&&te(e,1)}processRegen(){const e=this.state.player;lt(e)&&e.health<e.maxHealth&&(it(e,re),te(e,qs),this.log(`You feel restored. (+${re} HP, ${e.health}/${e.maxHealth})`))}processStarvation(){const e=this.state.player;if(ut(e)){const t=dt();I(e,t),this.log(`You are starving! (-${t} HP, ${e.health}/${e.maxHealth})`),S(e)||(this.log("You have starved to death..."),this.triggerGameOver())}}canAffordAnyAction(){const e=this.getAvailableActions(),t=this.state.player;return e.some(n=>t.ticks>=this.getEffectiveTickCost(n))}processPassOut(){if(this.state.gameOver||this.canAffordAnyAction())return;const e=this.state.player;if(this.log("You collapse from exhaustion..."),I(e,oe),X(e,ie),this.state.turn++,this.log(`You wake up weakened. (-${oe} HP, +${ie} ticks)`),!S(e)){this.log("You never wake up..."),this.triggerGameOver();return}this.state.encounter&&!this.state.encounter.ended&&(this.log(`The ${this.state.encounter.enemy.name} attacks while you're vulnerable!`),this.processEnemyTurns()),this.emit("turn")}triggerGameOver(){this.state.gameOver=!0,this.log("GAME OVER"),this.emit("game-over")}processResourceDepletion(e){var i;const n={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e];if(!n)return;const a=V(n);if(!a)return;const r=(i=this.state.availableNodes.map((o,c)=>({n:o,i:c})).filter(({n:o})=>o.nodeId===n).sort((o,c)=>o.n.distance-c.n.distance)[0])==null?void 0:i.i;r!==void 0&&Math.random()<a.depletionChance&&this.state.availableNodes.splice(r,1)}processNodeDropOff(){const e=[];for(let t=0;t<this.state.availableNodes.length;t++){const n=this.state.availableNodes[t],a=V(n.nodeId);if(!a)continue;const r=a.dropOffChance,i=1+n.distance*.1,o=Math.min(.5,r*i);Math.random()<o?e.push(t):n.distance++}for(let t=e.length-1;t>=0;t--)this.state.availableNodes.splice(e[t],1)}processLocationDropOff(){for(const[e,t]of Object.entries(this.state.discoveredLocations)){const n=k(e);if(!n||(n.parentId??null)!==this.state.currentLocation)continue;const r=[],i=.08;for(let o=0;o<t.entrances.length;o++){const c=t.entrances[o],l=1+c.distance*.15,u=Math.min(.4,i*l);Math.random()<u?r.push(o):c.distance++}for(let o=r.length-1;o>=0;o--)t.entrances.splice(r[o],1);t.entrances.length===0&&delete this.state.discoveredLocations[e]}}checkForEncounter(e=.25){this.getCurrentLocation().isSafe||Math.random()<e&&this.startEncounter()}startEncounter(e){const t=this.state.player.levelInfo.level,n=this.state.currentLocation,a=Ms(e,t,n);this.state.encounter=a;const r=a.enemy.levelInfo.level,i=r>1?` (Lv.${r})`:"";this.log(`A wild ${a.enemy.name}${i} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,t=this.state.player,n=Hs(e,t);n&&(this.log(n.message),n.encounterEnded&&(S(t)?n.fled?B(e,"enemy_escaped"):e.playerFleeing&&B(e,"player_escaped"):B(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,t=this.state.encounter.enemy,n=this.state.player;switch(e){case"victory":this.log(`You defeated the ${t.name}!`);const a=ws(t,n.levelInfo.level),{levelsGained:r,autoStats:i}=He(n.levelInfo,a);if(this.log(`+${a} XP`),r>0){if(ee(n),this.log(`LEVEL UP! You are now level ${n.levelInfo.level}!`),i.length>0){const o={};for(const l of i)o[l]=(o[l]||0)+1;const c=Object.entries(o).map(([l,u])=>`+${u} ${K[l]}`).join(", ");this.log(`Auto stats: ${c}`)}n.levelInfo.freeStatPoints>0&&this.log(`You have ${n.levelInfo.freeStatPoints} stat points to allocate!`),this.emit("level-up")}this.setPendingLoot(t);break;case"defeat":this.log("You have been defeated..."),this.state.encounter=null,this.triggerGameOver();return;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${t.name} got away.`);break}this.state.encounter=null,this.emit("encounter-end")}setPendingLoot(e){const t=We(this.state.player.levelInfo.stats),n=ks(e,t),a={};for(const[r,i]of Object.entries(n))i>0&&(a[r]=i);if(Object.keys(a).length>0){this.state.pendingLoot=a;const r=Object.entries(a).map(([i,o])=>{const c=p(i);return`${o} ${(c==null?void 0:c.name)??i}`});this.log(`Loot available: ${r.join(", ")}`)}}takeLoot(e,t=1){if(!this.state.pendingLoot||!this.state.pendingLoot[e])return!1;const n=this.state.pendingLoot[e],a=Math.min(t,n);L(this.state.player,e,a),this.state.pendingLoot[e]-=a,this.state.pendingLoot[e]<=0&&delete this.state.pendingLoot[e],Object.keys(this.state.pendingLoot).length===0&&(this.state.pendingLoot=null);const r=p(e);return this.log(`Took ${a} ${(r==null?void 0:r.name)??e}.`),this.emit("turn"),!0}takeAllLoot(){if(this.state.pendingLoot){for(const[e,t]of Object.entries(this.state.pendingLoot))L(this.state.player,e,t);this.log("Took all loot."),this.state.pendingLoot=null,this.emit("turn")}}leaveLoot(){this.state.pendingLoot&&(this.log("Left the loot behind."),this.state.pendingLoot=null,this.emit("turn"))}dropItem(e,t=1){const n=this.state.player,a=y(n,e);if(a<=0)return!1;const r=Math.min(t,a);n.inventory[e]-=r,n.inventory[e]<=0&&delete n.inventory[e];const i=p(e);return this.log(`Dropped ${r} ${(i==null?void 0:i.name)??e}.`),this.emit("turn"),!0}equip(e,t){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const n=this.state.player,a=p(e);return a?ft(n,e,t)?(this.log(`Equipped ${a.name}.`),this.emit("turn"),!0):(this.log(`Cannot equip ${a.name}.`),!1):!1}unequip(e){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const t=this.state.player,n=t.equipment[e];if(!n)return!1;const a=p(n);return G(t,e)?(this.log(`Unequipped ${(a==null?void 0:a.name)??n}.`),this.emit("turn"),!0):!1}allocateStat(e){const t=this.state.player;return qe(t.levelInfo,e)?(ee(t),this.log(`+1 ${K[e]}!`),this.emit("turn"),!0):(this.log("No stat points available."),!1)}log(e){const t={turn:this.state.turn,message:e};this.state.log.unshift(t),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){var n;(n=this.listeners.get(e))==null||n.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(n=>n(this))}getAvailableActions(){var l;let e=[...this.state.player.actions];const t=this.getEnterableLocations();for(const u of t)e.push(ns(u.id,u.name));const n=this.state.encounter!==null,a=((l=this.state.encounter)==null?void 0:l.enemyFleeing)??!1,r=this.state.player,i={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"},o={"eat-berries":"berries","eat-cooked-meat":"cookedMeat","eat-raw-meat":"rawMeat"},c={"craft-campfire":{requiresItems:{sticks:5,rocks:3}},"place-campfire":{requiresNoCampfire:!0,requiresItems:{campfire:1}},"pickup-campfire":{requiresCampfire:!0},"smother-campfire":{requiresCampfire:!0},"cook-meat":{requiresCampfire:!0,requiresItems:{rawMeat:1}},"craft-stone-knife":{requiresItems:{rocks:2,sticks:1}},"craft-stone-spear":{requiresItems:{rocks:1,sticks:3,fiber:2}},"craft-bow":{requiresItems:{sticks:3,fiber:5}},"craft-arrows":{requiresItems:{sticks:2,rocks:1}},"craft-wooden-shield":{requiresItems:{sticks:6,fiber:3}},"process-leather":{requiresCampfire:!0,requiresItems:{rawLeather:2}},"craft-leather-helm":{requiresItems:{leather:2}},"craft-leather-chest":{requiresItems:{leather:4}},"craft-leather-legs":{requiresItems:{leather:3}},"craft-leather-boots":{requiresItems:{leather:2}}};return e.filter(u=>{var f;if(n&&u.tags.includes("non-combat")||!n&&u.tags.includes("combat")||u.id==="chase"&&!a||u.id==="let-go"&&!a||u.id==="flee"&&((f=this.state.encounter)!=null&&f.playerFleeing))return!1;const m=i[u.id];if(m&&!this.state.availableNodes.some(g=>g.nodeId===m))return!1;const h=o[u.id];if(h&&y(r,h)<=0)return!1;const d=c[u.id];if(d){if(d.requiresCampfire&&!this.state.structures.has("campfire")||d.requiresNoCampfire&&this.state.structures.has("campfire"))return!1;if(d.requiresItems){for(const[g,v]of Object.entries(d.requiresItems))if(y(r,g)<v)return!1}}return!(u.id==="throw-rock"&&y(r,"rocks")<=0||u.id==="ranged-attack"&&(r.equipment.mainHand!=="bow"||y(r,"arrow")<=0)||u.id==="wander"&&this.state.structures.has("campfire")||u.id==="exit-location"&&(this.state.currentLocation===null||!this.state.foundExit||this.state.structures.has("campfire"))||u.id.startsWith("enter-location-")&&this.state.structures.has("campfire"))})}filterActions(e){const t=this.getAvailableActions(),n=e.toLowerCase().trim();let a=t;return n&&(a=t.filter(r=>{const i=r.name.toLowerCase().includes(n),o=r.description.toLowerCase().includes(n),c=r.tags.some(l=>l.toLowerCase().includes(n));return i||o||c})),this.sortActionsByPriority(a)}getActionPriority(e){var o;const t=this.state.player,n=this.state.encounter!==null,a=((o=this.state.encounter)==null?void 0:o.enemyFleeing)??!1;let r=0;if(n)return e.id==="attack"&&(r+=100),e.id==="flee"&&(r+=80),e.id==="ranged-attack"&&t.equipment.mainHand==="bow"&&(r+=95),e.id==="throw-rock"&&(r+=70),e.id==="chase"&&a&&(r+=90),e.id==="let-go"&&a&&(r+=60),r;const i=t.saturation/t.maxSaturation;if(e.tags.includes("consumption")&&(i<.3?r+=100:i<.5?r+=80:r+=30),e.id==="idle"){r+=40;const c=t.ticks/t.maxTicks;c<.1?r+=80:c<.2?r+=50:c<.3&&(r+=30)}if(e.id==="wander"&&(r+=60),e.tags.includes("gathering")&&(r+=50),e.tags.includes("crafting"))if(e.id==="craft-arrows"&&t.equipment.mainHand==="bow"){const c=y(t,"arrow");c<5?r+=85:c<15?r+=60:r+=25}else e.id==="cook-meat"?r+=70:e.id==="process-leather"?r+=55:e.id==="craft-stone-knife"||e.id==="craft-stone-spear"||e.id==="craft-bow"?t.equipment.mainHand?r+=25:r+=75:e.id.startsWith("craft-leather-")?r+=45:e.id==="craft-wooden-shield"?t.equipment.offHand?r+=20:r+=55:e.id==="craft-campfire"?y(t,"campfire")===0&&!this.state.structures.has("campfire")?r+=50:r+=5:e.id==="place-campfire"?r+=55:e.id==="pickup-campfire"?r+=15:e.id==="smother-campfire"?r+=10:r+=30;return r}sortActionsByPriority(e){return[...e].sort((t,n)=>{const a=this.getActionPriority(t);return this.getActionPriority(n)-a})}getGroupedActions(){const e=this.sortActionsByPriority(this.getAvailableActions());if(this.state.encounter!==null)return[{category:"Combat",actions:e}];const n={Suggested:[],Explore:[],Gather:[],Eat:[],Craft:[],Other:[]},a=e.slice(0,3);n.Suggested=a;for(const r of e)r.id==="idle"||r.id==="wander"?n.Explore.push(r):r.tags.includes("gathering")?n.Gather.push(r):r.tags.includes("consumption")?n.Eat.push(r):r.tags.includes("crafting")?n.Craft.push(r):n.Other.push(r);return Object.entries(n).filter(([r,i])=>i.length>0).map(([r,i])=>({category:r,actions:i}))}discoverLocation(e){const t=k(e);t&&(this.state.discoveredLocations[e]?this.state.discoveredLocations[e].entrances.push({distance:0}):this.state.discoveredLocations[e]={locationId:e,entrances:[{distance:0}]},this.log(t.discoveryMessage),this.emit("location-discovered"))}enterLocation(e){const t=k(e);if(!t)return this.log("Unknown location."),!1;const n=this.state.discoveredLocations[e];return!n||n.entrances.length===0?(this.log(`You haven't found an entrance to ${t.name}.`),!1):t.parentId!==(this.state.currentLocation??void 0)?(this.log(`You can't reach ${t.name} from here.`),!1):(n.entrances.sort((a,r)=>a.distance-r.distance),n.entrances.shift(),n.entrances.length===0&&delete this.state.discoveredLocations[e],this.state.currentLocation!==null&&this.state.locationStack.push(this.state.currentLocation),this.state.currentLocation=e,this.state.foundExit=!1,this.state.availableNodes=[],this.log(`You enter ${t.name}.`),this.emit("location-entered"),!0)}exitLocation(){if(this.state.currentLocation===null)return this.log("You are already in the wilderness."),!1;if(!this.state.foundExit)return this.log("You haven't found a way out yet. Keep exploring!"),!1;const e=k(this.state.currentLocation),t=this.state.locationStack.pop()??null;if(this.state.currentLocation=t,this.state.foundExit=!1,this.state.availableNodes=[],t===null)this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to the wilderness.`);else{const n=k(t);this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to ${(n==null?void 0:n.name)??"the previous area"}.`)}return this.emit("location-exited"),!0}findExit(){if(this.state.currentLocation===null)return;this.state.foundExit=!0;const e=k(this.state.currentLocation);this.log(`You find an exit from ${(e==null?void 0:e.name)??"this location"}!`),this.emit("exit-found")}getCurrentLocation(){if(this.state.currentLocation===null)return{id:null,name:"Wilderness",isSafe:!1};const e=k(this.state.currentLocation);return{id:this.state.currentLocation,name:(e==null?void 0:e.name)??"Unknown",isSafe:(e==null?void 0:e.isSafe)??!1}}getAvailableNodeInfo(e){const t=this.state.availableNodes.filter(a=>a.nodeId===e);if(t.length===0)return null;const n=Math.min(...t.map(a=>a.distance));return{count:t.length,closestDistance:n}}getEffectiveTickCost(e){const t=e.tickCost,n=50,r={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e.id];if(r){const i=this.getAvailableNodeInfo(r);if(i)return t+i.closestDistance*n}if(e.id.startsWith("enter-location-")){const i=e.id.replace("enter-location-",""),c=this.getEnterableLocations().find(l=>l.id===i);if(c)return t+c.closestDistance*n}return t}getEnterableLocations(){const e=[];for(const[t,n]of Object.entries(this.state.discoveredLocations)){if(n.entrances.length===0)continue;const a=k(t);if(!a||(a.parentId??null)!==this.state.currentLocation)continue;const i=Math.min(...n.entrances.map(o=>o.distance));e.push({id:t,name:a.name,entrances:n.entrances.length,closestDistance:i})}return e}}class Ps{constructor(e){H(this,"game");H(this,"actionGroupState",new Map);H(this,"elements");this.game=e,this.elements={levelCount:document.getElementById("level-count"),xpCount:document.getElementById("xp-count"),xpNext:document.getElementById("xp-next"),tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),saturationCount:document.getElementById("saturation-count"),maxSaturation:document.getElementById("max-saturation"),weightCount:document.getElementById("weight-count"),maxWeight:document.getElementById("max-weight"),characterStatsList:document.getElementById("character-stats-list"),freePointsDisplay:document.getElementById("free-points-display"),equipmentList:document.getElementById("equipment-list"),inventoryList:document.getElementById("inventory-list"),structuresPanel:document.getElementById("structures-panel"),structuresList:document.getElementById("structures-list"),lootPanel:document.getElementById("loot-panel"),lootList:document.getElementById("loot-list"),takeAllLoot:document.getElementById("take-all-loot"),leaveLoot:document.getElementById("leave-loot"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status"),gameOverPanel:document.getElementById("game-over-panel"),restartButton:document.getElementById("restart-button"),locationPanel:document.getElementById("location-panel"),locationIcon:document.getElementById("location-icon"),locationName:document.getElementById("location-name"),locationDetails:document.getElementById("location-details"),exitStatus:document.getElementById("exit-status"),discoveredLocations:document.getElementById("discovered-locations")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),this.elements.restartButton.addEventListener("click",()=>{this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.render()}),this.elements.takeAllLoot.addEventListener("click",()=>{this.game.takeAllLoot()}),this.elements.leaveLoot.addEventListener("click",()=>{this.game.leaveLoot()}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())}),document.querySelectorAll(".collapsible .section-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".collapsible");if(t){const n=t.querySelector(".section-content"),a=t.classList.toggle("collapsed"),r=e.querySelector(".toggle-icon");r&&(r.textContent=a?"":""),n&&(n.style.display=a?"none":"")}})}),window.matchMedia("(max-width: 600px)").matches&&document.querySelectorAll(".collapsed-mobile").forEach(e=>{e.classList.add("collapsed");const t=e.querySelector(".section-content"),n=e.querySelector(".toggle-icon");t&&(t.style.display="none"),n&&(n.textContent="")})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderCharacterStats(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("level-up",()=>{this.renderStatus(),this.renderCharacterStats()}),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("game-over",()=>{this.renderGameOver()}),this.game.on("location-entered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-exited",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-discovered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("exit-found",()=>{this.renderLocation(),this.renderActions()})}renderGameOver(){this.elements.gameOverPanel.classList.remove("hidden")}render(){this.renderStatus(),this.renderCharacterStats(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player,t=e.levelInfo;this.elements.levelCount.textContent=t.level.toString(),this.elements.xpCount.textContent=t.xp.toString(),this.elements.xpNext.textContent=t.xpToNextLevel.toString(),this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString(),this.elements.saturationCount.textContent=e.saturation.toString(),this.elements.maxSaturation.textContent=e.maxSaturation.toString();const n=he(e),a=ge(e),r=a>0?"+":"";this.elements.weightCount.textContent=n.toFixed(1),this.elements.maxWeight.textContent=`${e.carryCapacity} (${r}${Math.round(a)} spd)`}renderCharacterStats(){const t=this.game.state.player.levelInfo,n=t.stats,a=t.freeStatPoints,r=this.game.state.encounter!==null;a>0?(this.elements.freePointsDisplay.textContent=`(${a} points)`,this.elements.freePointsDisplay.classList.add("has-points")):(this.elements.freePointsDisplay.textContent="",this.elements.freePointsDisplay.classList.remove("has-points"));let i="";for(const o of W){const c=n[o],l=K[o],u=Ke[o],m=a>0&&!r;i+=`
        <div class="stat-row">
          <span class="stat-name" title="${u}">${l}</span>
          <span class="stat-value">${c}</span>
          ${m?`<button class="allocate-btn" data-stat="${o}" title="Allocate point">+</button>`:""}
        </div>
      `}this.elements.characterStatsList.innerHTML=i,this.elements.characterStatsList.querySelectorAll(".allocate-btn").forEach(o=>{o.addEventListener("click",c=>{const l=c.target.getAttribute("data-stat");l&&this.game.allocateStat(l)})})}renderEquipment(){const e=this.game.state.player,t=e.equipment,n=this.game.state.encounter!==null,a=[{slot:"mainHand",label:"Main Hand"},{slot:"offHand",label:"Off Hand"},{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"}],r=pe(e),i=q(e),o=D(e),c=[];c.push(`${r.min}-${r.max} Dmg`),i>0&&c.push(`+${i} Armor`),o>0&&c.push(`+${o} Ranged`);let l="";c.length>0&&(l+=`<div class="equipment-bonuses">${c.join(" | ")}</div>`);const u=t.mainHand&&t.mainHand===t.offHand?t.mainHand:null;for(const{slot:m,label:h}of a){const d=t[m];if(m==="offHand"&&u)continue;const f=d?p(d):null,g=(f==null?void 0:f.name)??"Empty",b=(f==null?void 0:f.twoHanded)?"Both Hands":h;l+=`
        <div class="equipment-slot">
          <span class="slot-label">${b}:</span>
          <span class="slot-item">${g}</span>
          ${d&&!n?`<button class="unequip-btn" data-slot="${m}" title="Unequip"></button>`:""}
        </div>
      `}this.elements.equipmentList.innerHTML=l,this.elements.equipmentList.querySelectorAll(".unequip-btn").forEach(m=>{m.addEventListener("click",h=>{const d=h.target.getAttribute("data-slot");d&&this.game.unequip(d)})})}renderInventory(){const t=this.game.state.player.inventory,n=this.game.state.encounter!==null,a=Object.entries(t).filter(([r,i])=>i>0).map(([r,i])=>{const o=p(r),c=(o==null?void 0:o.name)??r,l=(o==null?void 0:o.equipSlot)&&!n;return`
          <div class="inventory-item">
            <span class="item-name">${c}: <span class="item-count">${i}</span></span>
            <div class="item-actions">
              ${l?`<button class="equip-btn" data-item-id="${r}" data-slot="${o.equipSlot}" title="Equip">E</button>`:""}
              <button class="drop-btn" data-item-id="${r}" title="Drop 1">-</button>
            </div>
          </div>
        `});a.length===0?this.elements.inventoryList.innerHTML='<span class="inventory-empty">Empty</span>':(this.elements.inventoryList.innerHTML=a.join(""),this.elements.inventoryList.querySelectorAll(".equip-btn").forEach(r=>{r.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id"),c=i.target.getAttribute("data-slot");o&&c&&this.game.equip(o,c)})}),this.elements.inventoryList.querySelectorAll(".drop-btn").forEach(r=>{r.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id");o&&this.game.dropItem(o,1)})}))}renderStructures(){const e=this.game.state.structures;if(e.size===0){this.elements.structuresPanel.classList.add("hidden");return}this.elements.structuresPanel.classList.remove("hidden");const t={campfire:"Campfire"},n=Array.from(e).map(a=>`<span class="structure-item">${t[a]??a}</span>`);this.elements.structuresList.innerHTML=n.join("")}renderLocation(){const e=this.game.getCurrentLocation(),t=this.game.state.foundExit,n=this.game.getEnterableLocations();if(this.elements.locationName.textContent=e.name,e.id===null?this.elements.locationIcon.textContent="":e.isSafe?this.elements.locationIcon.textContent="":this.elements.locationIcon.textContent="",e.id!==null||n.length>0)if(this.elements.locationDetails.classList.remove("hidden"),e.id!==null?t?this.elements.exitStatus.innerHTML='<span class="exit-found"> Exit found</span>':this.elements.exitStatus.innerHTML='<span class="exit-searching">Searching for exit...</span>':this.elements.exitStatus.innerHTML="",n.length>0){const r=n.map(i=>{const o=i.entrances>1?` (${i.entrances})`:"";return`<span class="discovered-location"> ${i.name}${o}</span>`}).join("");this.elements.discoveredLocations.innerHTML=r}else this.elements.discoveredLocations.innerHTML="";else this.elements.locationDetails.classList.add("hidden")}renderLoot(){const e=this.game.state.pendingLoot;if(!e){this.elements.lootPanel.classList.add("hidden");return}this.elements.lootPanel.classList.remove("hidden");const t=Object.entries(e).filter(([n,a])=>a>0).map(([n,a])=>{const r=p(n),i=(r==null?void 0:r.name)??n,o=(r==null?void 0:r.weight)??0;return`
          <div class="loot-item">
            <span class="item-name">${i}: ${a} (${(o*a).toFixed(1)} wt)</span>
            <button class="take-btn" data-item-id="${n}" title="Take 1">+</button>
          </div>
        `});this.elements.lootList.innerHTML=t.join(""),this.elements.lootList.querySelectorAll(".take-btn").forEach(n=>{n.addEventListener("click",a=>{const r=a.target.getAttribute("data-item-id");r&&this.game.takeLoot(r,1)})})}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const t=e.enemy;this.elements.enemyName.textContent=t.name,this.elements.enemyHealth.textContent=t.health.toString(),this.elements.enemyMaxHealth.textContent=t.maxHealth.toString();let n="";e.enemyFleeing?n="Enemy is fleeing!":e.playerFleeing&&(n="You are fleeing!"),this.elements.encounterStatus.textContent=n}renderActions(){const e=this.elements.actionSearch.value;if(e.trim()){const t=this.game.filterActions(e);this.elements.actionsList.innerHTML=t.map(n=>this.renderActionItem(n)).join("")}else{const t=this.game.getGroupedActions();this.elements.actionsList.innerHTML=t.map((n,a)=>{const r=a===0,i=this.actionGroupState.get(n.category),o=i!==void 0?i:r;return this.renderActionGroup(n.category,n.actions,o)}).join("")}this.elements.actionsList.querySelectorAll(".action-item").forEach(t=>{const n=t.getAttribute("data-action-id");t.addEventListener("click",()=>{const a=this.game.getAvailableActions().find(r=>r.id===n);a&&this.handleActionClick(a)})}),this.elements.actionsList.querySelectorAll(".action-category-header").forEach(t=>{t.addEventListener("click",()=>{const n=t.getAttribute("data-category"),a=t.nextElementSibling,r=t.classList.toggle("collapsed");n&&this.actionGroupState.set(n,!r);const i=t.querySelector(".category-toggle");i&&(i.textContent=r?"":""),a&&(a.style.display=r?"none":"flex")})})}renderActionGroup(e,t,n=!0){const a=t.map(o=>this.renderActionItem(o)).join(""),r=n?"":"collapsed",i=n?"flex":"none";return`
      <div class="action-category">
        <div class="action-category-header ${r}" data-category="${e}">
          <span class="category-toggle">${n?"":""}</span>
          <span class="category-name">${e}</span>
          <span class="category-count">${t.length}</span>
        </div>
        <div class="action-category-content" style="display: ${i}">
          ${a}
        </div>
      </div>
    `}renderActionItem(e){const t=this.game.state.player,n=this.game.getEffectiveTickCost(e),a=t.ticks>=n,r=n>e.tickCost;let i;if(e.tickGain&&n){const c=e.tickGain-n;i=`${n} cost, +${c} net`}else e.tickGain?i=`+${e.tickGain} ticks`:i=`${n} ticks`;return`
      <div class="action-item ${a?"":"disabled"}${r?" has-distance":""}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${a?"affordable":""}">${i}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(t=>`
        <div class="log-entry">
          <span class="timestamp">[${t.turn}]</span>
          ${t.message}
        </div>
      `).join("")}}const J=new Ds,Rs=new Ps(J);Rs.render();J.start();window.game=J;
