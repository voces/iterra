var pt=Object.defineProperty;var yt=(t,e,s)=>e in t?pt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var $=(t,e,s)=>yt(t,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const kt=[{tier:"masterwork",minValue:90},{tier:"excellent",minValue:75},{tier:"good",minValue:50},{tier:"normal",minValue:25},{tier:"poor",minValue:10},{tier:"broken",minValue:0}],vt=10,bt={broken:"Shoddy",poor:"Poor",normal:"Normal",good:"Good",excellent:"Excellent",masterwork:"Masterwork"};function Ye(t){for(const{tier:e,minValue:s}of kt)if(t>=s)return e;return"broken"}function St(t){return .5+t/100*1}function ne(t){const e=Ye(t);return bt[e]}const je=2,Fe=["unarmed","knife","spear","archery","throwing","shield","crafting","butchering","skinning"],Ct=50,Lt=1.3,wt={unarmed:"Unarmed",knife:"Knife",spear:"Spear",archery:"Archery",throwing:"Throwing",shield:"Shield",crafting:"Crafting",butchering:"Butchering",skinning:"Skinning"},Et={unarmed:"Fighting with fists. Increases unarmed damage and hit chance.",knife:"Skill with knives and daggers. Faster attacks, more crits.",spear:"Mastery of spears and polearms. Higher damage and reach.",archery:"Proficiency with bows. Better accuracy and damage at range.",throwing:"Throwing weapons accurately. Rocks, javelins, etc.",shield:"Shield blocking effectiveness. Better block chance and reduction.",crafting:"General crafting ability. Better quality items, fewer failures.",butchering:"Extracting meat from corpses. Higher yield and fewer failures.",skinning:"Extracting hides from corpses. Higher yield and fewer failures."};function At(t=0){return{level:t,xp:0,xpToNextLevel:me(t+1),lastGainedAt:-1}}function Ue(){const t={};for(const e of Fe)t[e]=At(0);return t}function me(t){return Math.floor(Ct*Math.pow(t,Lt))}function Y(t,e,s=0){t.xp+=e,t.lastGainedAt=s;let n=0;for(;t.xp>=t.xpToNextLevel;)t.xp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=me(t.level+1),n++;return{levelsGained:n,newLevel:t.level}}function Mt(t){return t*.01}function $t(t){return .25/(1+t/50)}function We(t){return .3/(1+t/50)}function Qe(t){return t/(t+100)}function fe(t){const e=t/(t+100),s=e*70,n=15-5*e,i=(Math.random()-.5)*2*n,a=Math.random()<.05?10+Math.random()*10:0,r=Math.max(0,Math.min(100,s+i+a));return Math.round(r)}const B={combatHit:10,combatMiss:3,craftSuccess:15,craftFailure:5,harvestSuccess:12,harvestFailure:4};function Ht(t){return t&&{sticks:"unarmed",stoneKnife:"knife",ironKnife:"knife",steelKnife:"knife",stoneSpear:"spear",ironSpear:"spear",steelSpear:"spear",bow:"archery",longbow:"archery",crossbow:"archery"}[t]||"unarmed"}function qt(t){return t?{sticks:"Bash",stoneKnife:"Slash",ironKnife:"Slash",steelKnife:"Slash",stoneSpear:"Thrust",ironSpear:"Thrust",steelSpear:"Thrust",bow:"Shoot"}[t]||"Strike":"Punch"}const oe=["vitality","strength","agility","precision","endurance","arcane","luck"],Tt=100,Bt=1.5,It=3,xt=2;function Ke(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function Rt(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function Dt(t=1,e){const s=Ke();return e&&Object.assign(s,e),{level:t,xp:0,xpToNextLevel:Z(t+1),freeStatPoints:0,stats:s,statUsage:Rt()}}function Z(t){return Math.floor(Tt*Math.pow(t,Bt))}function Pt(t,e){t.xp+=e;let s=0;const n=[];for(;t.xp>=t.xpToNextLevel;){t.xp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=Z(t.level+1),t.freeStatPoints+=xt,s++;const i=Ot(t,It);n.push(...i)}return{levelsGained:s,autoStats:n}}function Ot(t,e){const s=[],n=t.statUsage,i=Object.values(n).reduce((a,r)=>a+r,0);for(let a=0;a<e;a++){let r;if(i===0||Math.random()<.3)r=oe[Math.floor(Math.random()*oe.length)];else{let o=Math.random()*i;r="vitality";for(const[c,l]of Object.entries(n))if(o-=l,o<=0){r=c;break}}t.stats[r]++,s.push(r)}return Object.keys(t.statUsage).forEach(a=>{t.statUsage[a]=0}),s}function Nt(t,e){return t.freeStatPoints<=0?!1:(t.freeStatPoints--,t.stats[e]++,!0)}function I(t,e,s=1){t.statUsage[e]+=s}function Ve(t){return t.vitality*5+t.endurance*2}function _t(t){const e=t.strength,s=Math.floor(t.strength*t.agility*.05);return e+s}function Gt(t){const e=t.precision,s=Math.floor(t.precision*t.agility*.05);return e+s}function Yt(t,e,s=0){return t.precision*5+t.agility*3+e*2+s+10}function jt(t,e,s=0){return Math.max(0,t.agility*5+t.luck*2+e*2+10-s)}function Ft(t,e,s=0){return s===0?0:t.strength*3+t.agility*2+e*2+s}function Ut(t,e=0){return t.strength*2+e}function Wt(t,e){return t===0?0:t/(t+e*.7)}function Qt(t,e,s,n){const i=s+1,a=n+1,r=2*i/(i+a);return t/(t+e)*r}function Kt(t){return t.agility*2}function Xe(t){return t.endurance}function Vt(t){return Math.min(.5,t.endurance*.01)}function Xt(t){return Math.min(.3,t.luck*.015+t.precision*.005)}function zt(t){return 1.5+t.luck*.02}function he(t){return t.luck*.05}function ge(t,e,s,n={}){const{attackerWeaponAccuracy:i=0,attackerSkillLevel:a=0,defenderArmorPenalty:r=0,defenderBlockBonus:o=0,defenderShieldArmor:c=0,defenderShieldSkillLevel:l=0}=n,d=t.levelInfo.stats,m=e.levelInfo.stats,p=t.levelInfo.level,h=e.levelInfo.level,u=a,f=Yt(d,p,i+u),y=1+Mt(a);let g=Math.floor(s*y);const C=Xt(d),L=Math.random()<C;if(L){const w=zt(d);g=Math.floor(g*w)}if(o>0){const w=l,N=Ft(m,h,o+w),U=Wt(N,f);if(Math.random()<U){const j=Ut(m,c),W=Math.max(1,g-j);return{hit:!0,dodged:!1,blocked:!0,critical:L,damage:W,message:L?"blocked critical":"blocked"}}}const S=jt(m,h,r),k=Qt(f,S,p,h),v=Math.random();if(v>k){const w=v<k+.15;return{hit:!1,dodged:w,blocked:!1,critical:!1,damage:0,message:w?"dodged":"missed"}}return{hit:!0,dodged:!1,blocked:!1,critical:L,damage:g,message:L?"critical":"hit"}}const ce={vitality:"Vitality",strength:"Strength",agility:"Agility",precision:"Precision",endurance:"Endurance",arcane:"Arcane",luck:"Luck"},Jt={vitality:"+5 Max HP per point",strength:"+1 Melee damage, +3 Block Rating, block damage reduction",agility:"+5 Dodge Rating, +3 Attack Rating, +2 Speed",precision:"+5 Attack Rating, +1 Ranged damage",endurance:"+1 Max Saturation, reduces hunger decay",arcane:"Magic capacity (future)",luck:"+2 Dodge Rating, crit chance, loot bonus"},ze={cave:{id:"cave",name:"Dark Cave",description:"A dark cave entrance yawns before you.",discoveryChance:.02,discoveryMessage:"You discover the entrance to a dark cave!",exitDiscoveryChance:.15,availableEnemies:["wolf","snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["cavern"]},forest:{id:"forest",name:"Dense Forest",description:"A dense forest with towering trees.",discoveryChance:.025,discoveryMessage:"You find a path leading into a dense forest!",exitDiscoveryChance:.12,availableEnemies:["rabbit","deer","wolf","boar"],availableResources:["berryBush","fallenBranches","tallGrass"],childLocations:["clearing"]},ruins:{id:"ruins",name:"Ancient Ruins",description:"Crumbling stone structures from a forgotten age.",discoveryChance:.012,discoveryMessage:"You stumble upon ancient ruins hidden in the landscape!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["ruinsCrypt"]},village:{id:"village",name:"Abandoned Village",description:"An eerily quiet abandoned village.",discoveryChance:.01,discoveryMessage:"You discover an abandoned village!",exitDiscoveryChance:.2,availableEnemies:["bandit"],availableResources:["fallenBranches"],childLocations:["villageWell"],isSafe:!1},cavern:{id:"cavern",name:"Deep Cavern",description:"A vast underground cavern with dripping stalactites.",discoveryChance:.025,discoveryMessage:"You find a passage leading deeper into the cavern!",exitDiscoveryChance:.12,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"cave"},clearing:{id:"clearing",name:"Forest Clearing",description:"A peaceful clearing in the forest.",discoveryChance:.03,discoveryMessage:"You emerge into a sunlit clearing!",exitDiscoveryChance:.25,availableEnemies:["rabbit","deer"],availableResources:["berryBush","tallGrass"],parentId:"forest",isSafe:!0},ruinsCrypt:{id:"ruinsCrypt",name:"Ancient Crypt",description:"A dusty crypt beneath the ruins.",discoveryChance:.02,discoveryMessage:"You find stairs descending into a crypt!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"ruins"},villageWell:{id:"villageWell",name:"Village Well",description:"An old well in the village center.",discoveryChance:.04,discoveryMessage:"You notice an old well in the village!",exitDiscoveryChance:.3,availableEnemies:["snake"],availableResources:["rockyOutcrop"],parentId:"village"}};function M(t){return ze[t]}function Zt(){return Object.values(ze)}function es(t){if(t===null)return Zt().filter(s=>!s.parentId);const e=M(t);return!e||!e.childLocations?[]:e.childLocations.map(s=>M(s)).filter(s=>s!==void 0)}function ts(t){const e=es(t);for(const s of e)if(Math.random()<s.discoveryChance)return s;return null}function ss(t){if(t===null)return!1;const e=M(t);return e?Math.random()<e.exitDiscoveryChance:!1}const T=[{id:"rabbit",name:"Rabbit",maxHealth:15,damage:2,speed:150,fleeThreshold:.9,aggressiveness:.05,loot:{rawMeat:{min:1,max:1,chance:1}},statGrowth:{vitality:.5,strength:.2,agility:3,precision:.5,baseLevel:1,xpReward:8}},{id:"deer",name:"Deer",maxHealth:35,damage:6,speed:130,fleeThreshold:.8,aggressiveness:.1,loot:{rawMeat:{min:2,max:3,chance:1},rawLeather:{min:1,max:2,chance:.9}},statGrowth:{vitality:1,strength:.5,agility:2,precision:.5,baseLevel:1,xpReward:15}},{id:"wolf",name:"Wolf",maxHealth:50,damage:10,speed:120,fleeThreshold:.3,aggressiveness:.6,loot:{rawMeat:{min:1,max:2,chance:.9},rawLeather:{min:1,max:2,chance:.7}},statGrowth:{vitality:1.5,strength:1,agility:1.5,precision:1,baseLevel:1,xpReward:25}},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8,loot:{rawMeat:{min:2,max:4,chance:1},rawLeather:{min:1,max:3,chance:.8}},statGrowth:{vitality:3,strength:2,agility:.5,precision:1,baseLevel:2,xpReward:35}},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4,loot:{rawMeat:{min:1,max:1,chance:.5},venomGland:{min:1,max:2,chance:.8}},statGrowth:{vitality:.5,strength:2.5,agility:3,precision:2,baseLevel:1,xpReward:30}},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5,loot:{},usesInventory:!0,statGrowth:{vitality:1.5,strength:1.5,agility:1.5,precision:1.5,baseLevel:2,xpReward:40}}];function ns(){const t={};return Math.random()<.5&&(t.berries=Math.floor(Math.random()*4)+1),Math.random()<.6&&(t.sticks=Math.floor(Math.random()*3)+1),Math.random()<.4&&(t.rocks=Math.floor(Math.random()*2)+1),Math.random()<.3&&(t.rawMeat=Math.floor(Math.random()*2)+1),Math.random()<.2&&(t.cookedMeat=1),t}function as(t,e){const{baseLevel:s}=t.statGrowth,n=Math.floor((e-1)*.4),i=Math.floor(Math.random()*3)-1;return Math.max(1,s+n+i)}function is(t,e){const{statGrowth:s}=t,n=Ke(),i=()=>.8+Math.random()*.4,a=Math.max(0,e-1);return n.vitality=Math.floor(s.vitality*a*i()),n.strength=Math.floor(s.strength*a*i()),n.agility=Math.floor(s.agility*a*i()),n.precision=Math.floor(s.precision*a*i()),n.endurance=0,n.arcane=0,n.luck=Math.floor(Math.random()*2),n}function rs(t,e=1){const s=t.usesInventory?ns():{},n=as(t,e),i=is(t,n),a=1+(n-1)*.1,r=Math.floor(t.maxHealth*a),o=Math.floor(t.damage*a);return st(t.id,t.name,{maxHealth:r,damage:o,speed:t.speed,maxTicks:5e3,inventory:s,actions:[],level:n,stats:i})}function os(t,e=0){const s=V(t);if(!s)return{};if(s.usesInventory)return{...t.inventory};const n={};for(const[i,a]of Object.entries(s.loot))if(Math.random()<a.chance){const r=Math.floor(Math.random()*(a.max-a.min+1))+a.min,o=Math.floor(r*e);n[i]=r+o}return n}const Je=["rawMeat","venomGland"],Ze=["rawLeather"];function x(t){const e=T.find(s=>s.id===t);return!e||e.usesInventory?!1:Object.keys(e.loot).some(s=>Je.includes(s))}function R(t){const e=T.find(s=>s.id===t);return!e||e.usesInventory?!1:Object.keys(e.loot).some(s=>Ze.includes(s))}function cs(t,e=0,s=0){const n=T.find(a=>a.id===t);if(!n||n.usesInventory)return{};const i={};for(const[a,r]of Object.entries(n.loot))if(Je.includes(a)&&Math.random()<r.chance){const o=Math.floor(Math.random()*(r.max-r.min+1))+r.min,c=Math.floor(o*e),l=Math.floor(o*s);i[a]=o+c+l}return i}function ls(t,e=0,s=0){const n=T.find(a=>a.id===t);if(!n||n.usesInventory)return{};const i={};for(const[a,r]of Object.entries(n.loot))if(Ze.includes(a)&&Math.random()<r.chance){const o=Math.floor(Math.random()*(r.max-r.min+1))+r.min,c=Math.floor(o*e),l=Math.floor(o*s);i[a]=o+c+l}return i}function us(t){if(t===null)return T;const e=M(t);return!e||!e.availableEnemies||e.availableEnemies.length===0?T:e.availableEnemies.map(s=>T.find(n=>n.id===s)).filter(s=>s!==void 0)}function ds(t=1,e=null){const s=us(e);let n;if(t<=2){const a=s.filter(o=>o.id==="rabbit"||o.id==="deer"),r=s.filter(o=>o.id!=="rabbit"&&o.id!=="deer"&&o.statGrowth.baseLevel<=t);Math.random()<.5&&a.length>0?n=a:r.length>0?n=r:n=a.length>0?a:s}else n=s.filter(a=>a.statGrowth.baseLevel<=t),n.length===0&&(n=s);n.length===0&&(n=T);const i=n[Math.floor(Math.random()*n.length)];return rs(i,t)}function ms(t,e){const s=V(t);if(!s)return 10;const n=s.statGrowth.xpReward,i=t.levelInfo.level,a=i-e;let r=1;return a>0?r=1+a*.1:a<0&&(r=Math.max(.1,1+a*.15)),Math.floor(n*i*r)}function V(t){return T.find(e=>e.id===t.id)}const He={berries:{id:"berries",name:"Berries",description:"Sweet, ripe berries. Can be eaten for sustenance.",stackable:!0,tags:["food","raw","foraged"],weight:.1,saturationGain:4},sticks:{id:"sticks",name:"Sticks",description:"Dry wooden sticks. Useful for crafting or as a makeshift weapon.",stackable:!0,tags:["material","wood","foraged","weapon"],weight:.5,equipSlot:"mainHand",minDamage:1,maxDamage:4,strengthScaling:.3,agilityScaling:.2,accuracy:0},rocks:{id:"rocks",name:"Rocks",description:"Sturdy rocks. Can be thrown or used for crafting.",stackable:!0,tags:["material","stone","foraged","throwable"],weight:2},fiber:{id:"fiber",name:"Fiber",description:"Plant fiber from tall grass. Used for crafting rope and bindings.",stackable:!0,tags:["material","foraged"],weight:.2},rawMeat:{id:"rawMeat",name:"Raw Meat",description:"Raw meat from a slain creature. Should be cooked before eating.",stackable:!0,tags:["food","raw","meat"],weight:1,saturationGain:2},cookedMeat:{id:"cookedMeat",name:"Cooked Meat",description:"Well-cooked meat. Nutritious and filling.",stackable:!0,tags:["food","cooked","meat"],weight:1,saturationGain:8},rawLeather:{id:"rawLeather",name:"Raw Leather",description:"Untreated animal hide. Must be processed at a campfire with a knife.",stackable:!0,tags:["material","loot"],weight:2},venomGland:{id:"venomGland",name:"Venom Gland",description:"A gland filled with potent venom. Handle with care.",stackable:!0,tags:["material","loot","poison"],weight:.3},leather:{id:"leather",name:"Leather",description:"Treated leather, ready for crafting armor.",stackable:!0,tags:["material","crafted"],weight:1.5},arrow:{id:"arrow",name:"Arrow",description:"A simple arrow. Requires a bow to use.",stackable:!0,tags:["ammo","crafted"],weight:.1},stoneKnife:{id:"stoneKnife",name:"Stone Knife",description:"A sharp flint knife. Good for combat and processing leather.",stackable:!1,tags:["weapon","tool","crafted"],weight:1,equipSlot:"mainHand",minDamage:3,maxDamage:8,strengthScaling:.5,agilityScaling:1,accuracy:15},stoneSpear:{id:"stoneSpear",name:"Stone Spear",description:"A spear with a stone tip. Decent reach and damage.",stackable:!1,tags:["weapon","crafted"],weight:2.5,equipSlot:"mainHand",minDamage:5,maxDamage:12,strengthScaling:1,agilityScaling:.5,accuracy:5},bow:{id:"bow",name:"Bow",description:"A wooden bow. Requires arrows. Effective against fleeing enemies.",stackable:!1,tags:["weapon","ranged","crafted"],weight:1.5,equipSlot:"mainHand",twoHanded:!0,minDamage:4,maxDamage:10,precisionScaling:1,agilityScaling:.3,rangedBonus:15,accuracy:20},woodenShield:{id:"woodenShield",name:"Wooden Shield",description:"A crude wooden shield. Block attacks to reduce damage.",stackable:!1,tags:["armor","shield","crafted"],weight:3,equipSlot:"offHand",armorBonus:5,blockBonus:25},leatherHelm:{id:"leatherHelm",name:"Leather Helm",description:"A hardened leather helmet.",stackable:!1,tags:["armor","crafted"],weight:1,equipSlot:"head",armorBonus:3,dodgePenalty:2},leatherChest:{id:"leatherChest",name:"Leather Chest",description:"A leather chestpiece offering decent protection.",stackable:!1,tags:["armor","crafted"],weight:3,equipSlot:"chest",armorBonus:6,dodgePenalty:5},leatherLegs:{id:"leatherLegs",name:"Leather Leggings",description:"Leather leg protection.",stackable:!1,tags:["armor","crafted"],weight:2,equipSlot:"legs",armorBonus:4,dodgePenalty:3},leatherBoots:{id:"leatherBoots",name:"Leather Boots",description:"Sturdy leather boots.",stackable:!1,tags:["armor","crafted"],weight:1.5,equipSlot:"feet",armorBonus:2,dodgePenalty:1},campfire:{id:"campfire",name:"Campfire",description:"A portable campfire kit. Place it to cook meat.",stackable:!1,tags:["structure","crafted"],weight:5}};function et(t){if(!t.startsWith("corpse_"))return null;const e=t.slice(7).split("_");if(e.length===0)return null;const s=e[e.length-1];return s==="butchered"||s==="skinned"?{enemyId:e.slice(0,-1).join("_"),state:s}:{enemyId:e.join("_"),state:"fresh"}}function fs(t){const e=et(t);if(!e)return;const s=T.find(i=>i.id===e.enemyId);if(!s)return;const n=e.state==="butchered"?" (Butchered)":e.state==="skinned"?" (Skinned)":"";return{id:t,name:`${s.name} Corpse${n}`,description:`The corpse of a ${s.name.toLowerCase()}.${n?" "+n.slice(2,-1)+".":""}`,stackable:!1,tags:["corpse"],weight:15}}function b(t){return He[t]?He[t]:fs(t)}function tt(t){return et(t)}function hs(t,e){const s=b(t);if(!s)throw new Error(`Unknown item: ${t}`);const n=St(e),i=Ye(e),r={itemId:t,quality:i==="broken"?"poor":i,qualityValue:e};return s.minDamage!==void 0&&(r.minDamage=Math.max(1,Math.floor(s.minDamage*n))),s.maxDamage!==void 0&&(r.maxDamage=Math.max(1,Math.floor(s.maxDamage*n))),s.armorBonus!==void 0&&(r.armorBonus=Math.max(1,Math.floor(s.armorBonus*n))),s.blockBonus!==void 0&&(r.blockBonus=Math.max(1,Math.floor(s.blockBonus*n))),s.accuracy!==void 0&&(r.accuracy=Math.floor(s.accuracy*n)),r}function gs(t){const e=b(t);return e?e.equipSlot!==void 0||e.tags.includes("weapon")||e.tags.includes("armor")||e.tags.includes("shield"):!1}function st(t,e,s={}){const{maxTicks:n=1e4,speed:i=100,carryCapacity:a=30,maxHealth:r=100,damage:o=10,saturation:c=10,maxSaturation:l=20,inventory:d={},materialQualities:m={},equipment:p={},equipmentInstances:h={},actions:u=[],level:f=1,stats:y,skills:g,backSlots:C=[null,null,null]}=s,L=Dt(f,y),S=r+Ve(L.stats),k=l+Xe(L.stats);return{id:t,name:e,ticks:n,maxTicks:n,speed:i,carryCapacity:a,health:S,maxHealth:S,damage:o,saturation:c,maxSaturation:k,inventory:{...d},materialQualities:{...m},equipment:{...p},equipmentInstances:{...h},actions:[...u],levelInfo:L,skills:g??Ue(),backSlots:[...C]}}function le(t,e=100,s=20){const n=t.levelInfo.stats,i=t.maxHealth;t.maxHealth=e+Ve(n),t.maxSaturation=s+Xe(n),t.maxHealth>i&&(t.health+=t.maxHealth-i),t.health=Math.min(t.health,t.maxHealth),t.saturation=Math.min(t.saturation,t.maxSaturation)}function ue(t,e){t.ticks=Math.min(t.ticks+e,t.maxTicks)}function ps(t,e){return t.ticks<e?!1:(t.ticks-=e,!0)}function F(t,e){t.health=Math.max(0,t.health-e)}function ys(t,e){t.health=Math.min(t.maxHealth,t.health+e)}function D(t){return t.health>0}function ks(t,e){t.saturation=Math.min(t.maxSaturation,t.saturation+e)}function qe(t,e){t.saturation=Math.max(0,t.saturation-e)}const vs=10;function bs(t){return t.saturation>vs}function Ss(t){return t.saturation<=0}function Cs(t){return 5}function E(t,e){return t.inventory[e]??0}function A(t,e,s){t.inventory[e]=(t.inventory[e]??0)+s}function pe(t,e,s,n){t.inventory[e]=(t.inventory[e]??0)+s,t.materialQualities[e]||(t.materialQualities[e]=[]);for(let i=0;i<s;i++)t.materialQualities[e].push(n);t.materialQualities[e].sort((i,a)=>i-a)}function q(t,e,s){const n=t.inventory[e]??0;return n<s?!1:(t.inventory[e]=n-s,t.materialQualities[e]&&(t.materialQualities[e].splice(0,s),t.materialQualities[e].length===0&&delete t.materialQualities[e]),!0)}function Ls(t,e,s){const n=t.inventory[e]??0;if(n<s)return null;t.inventory[e]=n-s;const i=[];if(t.materialQualities[e]){for(let a=0;a<s&&t.materialQualities[e].length>0;a++)i.push(t.materialQualities[e].shift());t.materialQualities[e].length===0&&delete t.materialQualities[e]}else for(let a=0;a<s;a++)i.push(50);return i}function nt(t){let e=0;for(const[s,n]of Object.entries(t.inventory))if(n>0){const i=b(s);i&&(e+=i.weight*n)}return e}function ws(t){return nt(t)/t.carryCapacity}function at(t){const e=ws(t);return e<=.5?20*(1-e*2):e<=1?0:-50*(e-1)}function P(t){const e=Kt(t.levelInfo.stats);return Math.max(10,t.speed+at(t)+e)}function Es(t,e,s){const n=b(e);if(!n||!n.equipSlot)return!1;const i=E(t,e)>0,a=t.backSlots.includes(e);return!i&&!a?!1:(n.twoHanded?(J(t,"mainHand"),J(t,"offHand"),t.equipment.mainHand=e,t.equipment.offHand=e):(J(t,s),t.equipment[s]=e),i?q(t,e,1):a&&lt(t,e),!0)}function J(t,e){const s=t.equipment[e];if(!s)return!1;const n=b(s);return n!=null&&n.twoHanded&&e==="mainHand"||n!=null&&n.twoHanded&&e==="offHand"?(delete t.equipment.mainHand,delete t.equipment.offHand,A(t,s,1)):(delete t.equipment[e],A(t,s,1)),!0}function Q(t){let e=0;const s=new Set;for(const[n,i]of Object.entries(t.equipment))if(i&&!s.has(i)){s.add(i);const a=t.equipmentInstances[n];if(a&&a.armorBonus!==void 0)e+=a.armorBonus;else{const r=b(i);r!=null&&r.armorBonus&&(e+=r.armorBonus)}}return e}function K(t){let e=0;const s=new Set;for(const n of Object.values(t.equipment))if(n&&!s.has(n)){s.add(n);const i=b(n);i!=null&&i.rangedBonus&&(e+=i.rangedBonus)}return e}const Te=1,Be=3;function As(t){const e=t.equipment.mainHand;if(!e)return{min:Te,max:Be};const s=t.equipmentInstances.mainHand;if(s&&s.minDamage!==void 0&&s.maxDamage!==void 0)return{min:s.minDamage,max:s.maxDamage};const n=b(e);return(n==null?void 0:n.minDamage)!==void 0&&(n==null?void 0:n.maxDamage)!==void 0?{min:n.minDamage,max:n.maxDamage}:{min:Te,max:Be}}function Ms(t){const e=t.equipment.mainHand,s=t.levelInfo.stats;if(!e)return Math.floor(s.strength*.5+s.agility*.3);const n=b(e);if(!n)return Math.floor(s.strength*.5+s.agility*.3);let i=0;return n.strengthScaling&&(i+=s.strength*n.strengthScaling),n.agilityScaling&&(i+=s.agility*n.agilityScaling),n.precisionScaling&&(i+=s.precision*n.precisionScaling),Math.floor(i)}function it(t){const e=As(t),s=Ms(t);return{min:e.min+s,max:e.max+s}}function $s(t){const e=it(t);return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function ee(t,e){const s=e/(e+20);return Math.max(1,Math.floor(t*(1-s)))}function rt(t){const e=t.equipment.mainHand;if(!e)return 0;const s=t.equipmentInstances.mainHand;if(s&&s.accuracy!==void 0)return s.accuracy;const n=b(e);return(n==null?void 0:n.accuracy)??0}function ye(t){let e=0;const s=new Set;for(const n of Object.values(t.equipment))if(n&&!s.has(n)){s.add(n);const i=b(n);i!=null&&i.dodgePenalty&&(e+=i.dodgePenalty)}return e}function Hs(t){const e=t.equipment.offHand;if(!e)return 0;const s=t.equipmentInstances.offHand;if(s&&s.blockBonus!==void 0)return s.blockBonus;const n=b(e);return(n==null?void 0:n.blockBonus)??0}function qs(t){const e=t.equipment.offHand;if(!e)return 0;const s=t.equipmentInstances.offHand;if(s&&s.armorBonus!==void 0)return s.armorBonus;const n=b(e);return n!=null&&n.blockBonus?n.armorBonus??0:0}function ae(t){const e=b(t);return e?e.equipSlot==="mainHand"||e.equipSlot==="offHand":!1}function G(t){const e=b(t);return(e==null?void 0:e.twoHanded)===!0}function ot(t){let e=0,s=0;for(const n of t.backSlots)n!==null&&(G(n)?e++:s++);return{twoHanded:e,oneHanded:s}}function te(t,e){return!(!ae(e)||!t.backSlots.some(n=>n===null)||t.backSlots.includes(e)||G(e)&&ot(t).twoHanded>=je)}function ct(t){return t.backSlots}function Ts(t,e,s,n=!1){if(!te(t,e))return!1;const i=E(t,e)>0,a=t.equipment.mainHand===e,r=t.equipment.offHand===e&&t.equipment.offHand!==t.equipment.mainHand;if(!i&&!a&&!r)return!1;let o;if(o=t.backSlots.findIndex(c=>c===null),o===-1)return!1;if(n)if(a){const c=b(e);c!=null&&c.twoHanded?(delete t.equipment.mainHand,delete t.equipment.offHand):delete t.equipment.mainHand}else r?delete t.equipment.offHand:i&&q(t,e,1);else if(i)q(t,e,1);else if(a){const c=b(e);c!=null&&c.twoHanded?(delete t.equipment.mainHand,delete t.equipment.offHand):delete t.equipment.mainHand}else r&&delete t.equipment.offHand;return t.backSlots[o]=e,!0}function lt(t,e){const s=t.backSlots.findIndex(n=>n===e);return s===-1?!1:(t.backSlots[s]=null,A(t,e,1),!0)}function Ie(t,e){const s=t.backSlots.findIndex(a=>a===e);if(s===-1)return null;const n=t.equipment.mainHand;t.backSlots[s]=null,n&&ae(n)&&(t.backSlots[s]=n);const i=b(e);return i!=null&&i.twoHanded?(t.equipment.mainHand=e,t.equipment.offHand=e):(t.equipment.mainHand=e,t.equipment.offHand===n&&delete t.equipment.offHand),n??null}const ut={berryBush:{id:"berryBush",name:"Berry Bush",description:"A bush laden with ripe berries.",gatherActionId:"gather-berries",discoveryChance:.2,discoveryMessage:"You stumble upon a bush laden with ripe berries!",depletionChance:.6,dropOffChance:.15},fallenBranches:{id:"fallenBranches",name:"Fallen Branches",description:"Some fallen branches on the ground.",gatherActionId:"gather-sticks",discoveryChance:.2,discoveryMessage:"You find some fallen branches on the ground.",depletionChance:.5,dropOffChance:.1},rockyOutcrop:{id:"rockyOutcrop",name:"Rocky Outcrop",description:"Some useful rocks jutting from the ground.",gatherActionId:"gather-rocks",discoveryChance:.15,discoveryMessage:"You notice some useful rocks nearby.",depletionChance:.4,dropOffChance:.05},tallGrass:{id:"tallGrass",name:"Tall Grass",description:"A patch of tall grass with useful fibers.",gatherActionId:"gather-fiber",discoveryChance:.2,discoveryMessage:"You find a patch of tall grass.",depletionChance:.5,dropOffChance:.12}};function de(t){return ut[t]}function xe(){return Object.values(ut)}function Bs(t){if(t===null)return xe();const e=M(t);return!e||!e.availableResources||e.availableResources.length===0?xe():e.availableResources.map(s=>de(s)).filter(s=>s!==void 0)}function Is(t=null){const e=Bs(t);let s=0;const n=Math.random();for(const i of e)if(s+=i.discoveryChance,n<s)return i;return null}const xs={campfire:{id:"campfire",name:"Craft Campfire",description:"Craft a portable campfire using sticks and rocks.",inputs:{sticks:5,rocks:3},outputs:{campfire:1},tickCost:400},cookedMeat:{id:"cookedMeat",name:"Cook Meat",description:"Cook raw meat on the campfire.",inputs:{rawMeat:1},outputs:{cookedMeat:1},tickCost:200,requiresCampfire:!0},leather:{id:"leather",name:"Process Leather",description:"Process raw leather at the campfire. Requires a knife.",inputs:{rawLeather:2},outputs:{leather:1},tickCost:300,requiresCampfire:!0},stoneKnife:{id:"stoneKnife",name:"Craft Stone Knife",description:"Craft a stone knife from rocks and sticks.",inputs:{rocks:2,sticks:1},outputs:{stoneKnife:1},tickCost:250},stoneSpear:{id:"stoneSpear",name:"Craft Stone Spear",description:"Craft a stone spear from rocks, sticks, and fiber.",inputs:{rocks:1,sticks:3,fiber:2},outputs:{stoneSpear:1},tickCost:300},bow:{id:"bow",name:"Craft Bow",description:"Craft a bow from sticks and fiber.",inputs:{sticks:3,fiber:5},outputs:{bow:1},tickCost:400},arrow:{id:"arrow",name:"Craft Arrows",description:"Craft arrows from sticks and rocks.",inputs:{sticks:2,rocks:1},outputs:{arrow:5},tickCost:150},woodenShield:{id:"woodenShield",name:"Craft Wooden Shield",description:"Craft a wooden shield from sticks and fiber.",inputs:{sticks:6,fiber:3},outputs:{woodenShield:1},tickCost:350},leatherHelm:{id:"leatherHelm",name:"Craft Leather Helm",description:"Craft a leather helmet.",inputs:{leather:2},outputs:{leatherHelm:1},tickCost:200},leatherChest:{id:"leatherChest",name:"Craft Leather Chest",description:"Craft a leather chestpiece.",inputs:{leather:4},outputs:{leatherChest:1},tickCost:300},leatherLegs:{id:"leatherLegs",name:"Craft Leather Leggings",description:"Craft leather leggings.",inputs:{leather:3},outputs:{leatherLegs:1},tickCost:250},leatherBoots:{id:"leatherBoots",name:"Craft Leather Boots",description:"Craft leather boots.",inputs:{leather:2},outputs:{leatherBoots:1},tickCost:200}};function H(t){return xs[t]}function X(t,e,s){if(t.requiresCampfire&&!s.has("campfire"))return{canCraft:!1,reason:"Requires a placed campfire."};for(const[n,i]of Object.entries(t.inputs)){const a=e[n]??0;if(a<i)return{canCraft:!1,reason:`Need ${i} ${n}, have ${a}.`}}return{canCraft:!0}}function ie(t,e){for(const[s,n]of Object.entries(t.inputs))e[s]=(e[s]??0)-n;for(const[s,n]of Object.entries(t.outputs))e[s]=(e[s]??0)+n}function O(t,e,s,n,i=0){const{canCraft:a,reason:r}=X(t,s,n);if(!a)return{success:!1,failed:!1,broken:!1,message:r};const o=e.skills.crafting,c=o.level,l=[];for(const[S,k]of Object.entries(t.inputs)){const v=Ls(e,S,k);v&&l.push(...v),s[S]=e.inventory[S]??0}const d=l.length>0?l.reduce((S,k)=>S+k,0)/l.length:50,m=l.length>0?Math.min(...l):50,p=m<vt,h=p?B.craftFailure:B.craftSuccess,u=Y(o,h,i);if(p)return{success:!1,failed:!0,broken:!0,message:`Crafting failed! ${ne(m)} quality materials broke apart. (+${h} crafting XP)`,skillGain:u};const f=$t(c);if(Math.random()<f)return{success:!1,failed:!0,broken:!1,message:`Crafting failed! Materials were lost. (+${h} crafting XP)`,skillGain:u};const g=fe(c),C=Math.round(g*.6+d*.4),L=[];for(const[S,k]of Object.entries(t.outputs)){for(let v=0;v<k;v++)if(gs(S)){const w=hs(S,C);L.push({itemId:S,quality:w.quality,qualityValue:C,instance:w})}else pe(e,S,1,C),L.push({itemId:S,quality:"normal",qualityValue:C});s[S]=(s[S]??0)+k}return{success:!0,failed:!1,broken:!1,message:Rs(L,h,C),craftedItems:L,skillGain:u}}function Rs(t,e,s){if(!t||t.length===0)return"Crafted successfully!";const n=new Map;for(const o of t)n.set(o.itemId,(n.get(o.itemId)??0)+1);const i=Array.from(n.entries()).map(([o,c])=>{var d;const l=((d=b(o))==null?void 0:d.name)??o;return c>1?`${c}x ${l}`:l}).join(", "),a=ne(s);let r="";return a!=="Normal"&&(r=` (${a} quality!)`),`Crafted ${i}${r} (+${e} crafting XP)`}const Ds={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(t,e)=>({success:!0,message:"You rest, recovering some energy."})},Ps={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(t,e)=>{var o,c,l;if((o=e==null?void 0:e.game)!=null&&o.structures.has("campfire"))return{success:!1,message:"You can't wander off with a campfire burning! Pick it up or smother it first."};const s=((c=e==null?void 0:e.game)==null?void 0:c.currentLocation)??null;if(s!==null&&!((l=e==null?void 0:e.game)!=null&&l.foundExit)&&ss(s)){const m=M(s);return{success:!0,message:`You find a way out of ${(m==null?void 0:m.name)??"this location"}!`,foundExit:!0}}const n=ts(s);if(n)return{success:!0,message:n.discoveryMessage,foundLocation:n.id};const i=Is(s);if(i)return{success:!0,message:i.discoveryMessage,foundResource:i.id};const a=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:a[Math.floor(Math.random()*a.length)]}}},Os={id:"gather-berries",name:"Gather Berries",description:"Pick berries from the bush.",tickCost:150,tags:["gathering","non-combat"],execute:(t,e)=>{const s=2+Math.floor(Math.random()*3);return A(t,"berries",s),{success:!0,message:`You gather ${s} berries. (${E(t,"berries")} total)`}}},Ns={id:"gather-sticks",name:"Gather Sticks",description:"Collect sticks from the ground.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const s=2+Math.floor(Math.random()*3);return A(t,"sticks",s),{success:!0,message:`You gather ${s} sticks. (${E(t,"sticks")} total)`}}},_s={id:"gather-rocks",name:"Gather Rocks",description:"Collect rocks from the ground.",tickCost:120,tags:["gathering","non-combat"],execute:(t,e)=>{const s=1+Math.floor(Math.random()*2);return A(t,"rocks",s),{success:!0,message:`You gather ${s} rocks. (${E(t,"rocks")} total)`}}},Gs={id:"gather-fiber",name:"Gather Fiber",description:"Collect fiber from tall grass.",tickCost:100,tags:["gathering","non-combat"],execute:(t,e)=>{const s=3+Math.floor(Math.random()*3);return A(t,"fiber",s),{success:!0,message:`You gather ${s} fiber. (${E(t,"fiber")} total)`}}},Ys={id:"craft-campfire",name:"Craft Campfire",description:"Craft a portable campfire. (5 sticks, 3 rocks)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var r;const s=H("campfire"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,{canCraft:i,reason:a}=X(s,t.inventory,n);return i?(ie(s,t.inventory),{success:!0,message:"You craft a campfire. Place it to cook meat!"}):{success:!1,message:a}}},js={id:"place-campfire",name:"Place Campfire",description:"Place your campfire on the ground.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return E(t,"campfire")<=0?{success:!1,message:"You have no campfire to place."}:(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?{success:!1,message:"A campfire is already placed."}:(q(t,"campfire",1),e!=null&&e.game&&e.game.structures.add("campfire"),{success:!0,message:"You place the campfire. You can now cook meat!"})}},Fs={id:"pickup-campfire",name:"Pick Up Campfire",description:"Pick up your placed campfire.",tickCost:50,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?(e.game.structures.delete("campfire"),A(t,"campfire",1),{success:!0,message:"You pick up the campfire."}):{success:!1,message:"No campfire is placed."}}},Us={id:"smother-campfire",name:"Smother Campfire",description:"Extinguish and discard your placed campfire.",tickCost:25,tags:["crafting","non-combat"],execute:(t,e)=>{var s;return(s=e==null?void 0:e.game)!=null&&s.structures.has("campfire")?(e.game.structures.delete("campfire"),{success:!0,message:"You smother the campfire. It is destroyed."}):{success:!1,message:"No campfire is placed."}}},Ws={id:"cook-meat",name:"Cook Meat",description:"Cook raw meat on the campfire.",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var r;const s=H("cookedMeat"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,{canCraft:i,reason:a}=X(s,t.inventory,n);return i?(ie(s,t.inventory),{success:!0,message:`You cook the meat. (${E(t,"cookedMeat")} cooked meat)`}):{success:!1,message:a}}},Qs={id:"craft-stone-knife",name:"Craft Stone Knife",description:"Craft a stone knife. (2 rocks, 1 stick)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("stoneKnife"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A fast weapon that scales with agility!"}}},Ks={id:"craft-stone-spear",name:"Craft Stone Spear",description:"Craft a stone spear. (1 rock, 3 sticks, 2 fiber)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("stoneSpear"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A powerful weapon that scales with strength!"}}},Vs={id:"craft-bow",name:"Craft Bow",description:"Craft a bow. (3 sticks, 5 fiber)",tickCost:400,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("bow"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it and craft arrows to shoot!"}}},Xs={id:"craft-arrows",name:"Craft Arrows",description:"Craft 5 arrows. (2 sticks, 1 rock)",tickCost:150,tags:["crafting","non-combat"],execute:(t,e)=>{var r;const s=H("arrow"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,{canCraft:i,reason:a}=X(s,t.inventory,n);return i?(ie(s,t.inventory),{success:!0,message:`You craft 5 arrows. (${E(t,"arrow")} total)`}):{success:!1,message:a}}},zs={id:"craft-wooden-shield",name:"Craft Wooden Shield",description:"Craft a wooden shield. (6 sticks, 3 fiber)",tickCost:350,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("woodenShield"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it for blocking!"}}},Js={id:"process-leather",name:"Process Leather",description:"Process raw leather at campfire. (2 raw leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var r;const s=H("leather"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,{canCraft:i,reason:a}=X(s,t.inventory,n);return i?(ie(s,t.inventory),{success:!0,message:`You process the leather. (${E(t,"leather")} leather)`}):{success:!1,message:a}}},Zs={id:"craft-leather-helm",name:"Craft Leather Helm",description:"Craft a leather helmet. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("leatherHelm"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},en={id:"craft-leather-chest",name:"Craft Leather Chest",description:"Craft a leather chestpiece. (4 leather)",tickCost:300,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("leatherChest"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},tn={id:"craft-leather-legs",name:"Craft Leather Leggings",description:"Craft leather leggings. (3 leather)",tickCost:250,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("leatherLegs"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},sn={id:"craft-leather-boots",name:"Craft Leather Boots",description:"Craft leather boots. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(t,e)=>{var r,o;const s=H("leatherBoots"),n=((r=e==null?void 0:e.game)==null?void 0:r.structures)??new Set,i=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=O(s,t,t.inventory,n,i);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}};function nn(t){for(const e of Object.keys(t.inventory)){const s=tt(e);if(s&&s.state!=="butchered"&&x(s.enemyId))return{itemId:e,enemyId:s.enemyId}}return null}function an(t){for(const e of Object.keys(t.inventory)){const s=tt(e);if(s&&s.state!=="skinned"&&R(s.enemyId))return{itemId:e,enemyId:s.enemyId}}return null}const rn={id:"butcher",name:"Butcher",description:"Extract meat from a corpse. Skill affects success and yield.",tickCost:200,tags:["harvesting","non-combat"],execute:(t,e)=>{var S;const s=(S=e==null?void 0:e.game)==null?void 0:S.pendingCorpse,n=nn(t);let i,a,r=!1,o=null;if(s&&!s.butchered&&x(s.enemyId))i=s.enemyId,a=s.enemyName;else if(n){i=n.enemyId;const k=b(n.itemId);a=(k==null?void 0:k.name.replace(" Corpse","").replace(" (Skinned)",""))??i,r=!0,o=n.itemId}else return s!=null&&s.butchered?{success:!1,message:`The ${s.enemyName} has already been butchered.`}:s&&!x(s.enemyId)?{success:!1,message:`The ${s.enemyName} has nothing to butcher.`}:{success:!1,message:"No corpse to butcher."};const c=t.skills.butchering,l=We(c.level);if(Math.random()<l){const v=Y(c,B.harvestFailure).levelsGained>0?" Butchering leveled up!":"";return r&&o?(q(t,o,1),R(i)&&A(t,`corpse_${i}_butchered`,1)):s&&(s.butchered=!0),{success:!0,message:`You fail to properly butcher the ${a}, ruining the meat.${v}`}}const d=Qe(c.level),m=he(t.levelInfo.stats),p=cs(i,d,m),h=fe(c.level),u=ne(h);for(const[k,v]of Object.entries(p))pe(t,k,v,h);r&&o?(q(t,o,1),R(i)&&A(t,`corpse_${i}_butchered`,1)):s&&(s.butchered=!0);const y=Y(c,B.harvestSuccess).levelsGained>0?" Butchering leveled up!":"",g=Object.entries(p).map(([k,v])=>{const w=b(k);return`${v} ${(w==null?void 0:w.name)??k}`}),C=g.length>0?g.join(", "):"nothing",L=u!=="Normal"?` (${u} quality)`:"";return{success:!0,message:`You butcher the ${a} and obtain ${C}${L}.${y}`}}},on={id:"skin",name:"Skin",description:"Extract hides from a corpse. Skill affects success and yield.",tickCost:200,tags:["harvesting","non-combat"],execute:(t,e)=>{var S;const s=(S=e==null?void 0:e.game)==null?void 0:S.pendingCorpse,n=an(t);let i,a,r=!1,o=null;if(s&&!s.skinned&&R(s.enemyId))i=s.enemyId,a=s.enemyName;else if(n){i=n.enemyId;const k=b(n.itemId);a=(k==null?void 0:k.name.replace(" Corpse","").replace(" (Butchered)",""))??i,r=!0,o=n.itemId}else return s!=null&&s.skinned?{success:!1,message:`The ${s.enemyName} has already been skinned.`}:s&&!R(s.enemyId)?{success:!1,message:`The ${s.enemyName} has nothing to skin.`}:{success:!1,message:"No corpse to skin."};const c=t.skills.skinning,l=We(c.level);if(Math.random()<l){const v=Y(c,B.harvestFailure).levelsGained>0?" Skinning leveled up!":"";return r&&o?(q(t,o,1),x(i)&&A(t,`corpse_${i}_skinned`,1)):s&&(s.skinned=!0),{success:!0,message:`You fail to properly skin the ${a}, ruining the hide.${v}`}}const d=Qe(c.level),m=he(t.levelInfo.stats),p=ls(i,d,m),h=fe(c.level),u=ne(h);for(const[k,v]of Object.entries(p))pe(t,k,v,h);r&&o?(q(t,o,1),x(i)&&A(t,`corpse_${i}_skinned`,1)):s&&(s.skinned=!0);const y=Y(c,B.harvestSuccess).levelsGained>0?" Skinning leveled up!":"",g=Object.entries(p).map(([k,v])=>{const w=b(k);return`${v} ${(w==null?void 0:w.name)??k}`}),C=g.length>0?g.join(", "):"nothing",L=u!=="Normal"?` (${u} quality)`:"";return{success:!0,message:`You skin the ${a} and obtain ${C}${L}.${y}`}}},cn={id:"pickup-corpse",name:"Pick Up Corpse",description:"Pick up the corpse and add it to your inventory.",tickCost:100,tags:["harvesting","non-combat"],execute:(t,e)=>{var i;const s=(i=e==null?void 0:e.game)==null?void 0:i.pendingCorpse;if(!s)return{success:!1,message:"No corpse to pick up."};let n=`corpse_${s.enemyId}`;return s.butchered?n+="_butchered":s.skinned&&(n+="_skinned"),A(t,n,1),{success:!0,message:`You hoist the ${s.enemyName}'s corpse onto your shoulders. It's heavy!`,clearCorpse:!0}}};function ke(t,e,s,n){var a;const i=b(t);return{id:e,name:s,description:`Eat ${((a=i==null?void 0:i.name)==null?void 0:a.toLowerCase())??t} to restore saturation.`,tickCost:n,tags:["consumption","non-combat"],execute:(r,o)=>{var d,m;if(E(r,t)<=0)return{success:!1,message:`You have no ${((d=i==null?void 0:i.name)==null?void 0:d.toLowerCase())??t} to eat.`};q(r,t,1);const l=(i==null?void 0:i.saturationGain)??1;return ks(r,l),{success:!0,message:`You eat the ${((m=i==null?void 0:i.name)==null?void 0:m.toLowerCase())??t}. (+${l} saturation, ${r.saturation}/${r.maxSaturation})`}}}}const ln=ke("berries","eat-berries","Eat Berries",50),un=ke("cookedMeat","eat-cooked-meat","Eat Cooked Meat",75),dn=ke("rawMeat","eat-raw-meat","Eat Raw Meat",50);function Re(t,e=!1){var d;const s=t?b(t):null,n=qt(t),i=(s==null?void 0:s.name)??"Fists",a=((d=s==null?void 0:s.tags)==null?void 0:d.includes("ranged"))??!1,c=200+(e?50:0),l=["combat","offensive","weapon-attack"];return a&&l.push("ranged"),{id:t?`attack-${t}`:"attack-unarmed",name:e?`${n} (${i}) [Back]`:`${n} (${i})`,description:t?`Attack with your ${i.toLowerCase()}.${e?" (Drawing from back)":""}`:"Attack with your bare fists.",tickCost:c,tags:l,execute:(m,p)=>{var Le,we,Ee,Ae,Me;if(!(p!=null&&p.encounter))return{success:!1,message:"Nothing to attack."};if(e&&t){const z=m.equipment.mainHand;if(z&&G(z)){const $e=ot(m);if((G(t)?$e.twoHanded-1:$e.twoHanded)+1>je){const gt=((we=(Le=b(z))==null?void 0:Le.name)==null?void 0:we.toLowerCase())??"weapon";return{success:!1,message:`Cannot switch to ${i.toLowerCase()} - no room for your ${gt} on your back.`}}}}if(a&&t==="bow"){if(E(m,"arrow")<=0)return{success:!1,message:"You have no arrows."};q(m,"arrow",1)}const h=p.encounter.enemy;a?(I(m.levelInfo,"precision",1),I(m.levelInfo,"agility",.5)):(I(m.levelInfo,"strength",1),I(m.levelInfo,"precision",.5));const u=Ht(t),f=$s(m),y=rt(m),g=ye(h),C=a?K(m):0,L=p.encounter.enemyFleeing?C:0,S=m.skills[u].level,k=((Ae=(Ee=h.skills)==null?void 0:Ee.shield)==null?void 0:Ae.level)??0,v=ge(m,h,f+L,{attackerWeaponAccuracy:y,attackerSkillLevel:S,defenderArmorPenalty:g,defenderShieldSkillLevel:k}),w=v.hit?B.combatHit:B.combatMiss,N=((Me=p==null?void 0:p.game)==null?void 0:Me.turn)??0,U=Y(m.skills[u],w,N),j=n.toLowerCase(),W=a&&t==="bow"?{type:"arrow",outcome:v.hit?"hit":v.dodged?"dodged":"missed"}:void 0;if(!v.hit)return e&&t&&Ie(m,t),{success:!0,message:v.dodged?`The ${h.name} dodges your ${j}!`:`You ${j} at the ${h.name} but miss!`,projectileUsed:W};const ht=Q(h),re=ee(v.damage,ht);F(h,re),v.critical&&I(m.levelInfo,"luck",1);const Se=v.critical?" Critical hit!":"",Ce=U.levelsGained>0?` ${u} leveled up!`:"";return e&&t&&Ie(m,t),D(h)?{success:!0,message:`You ${j} the ${h.name} for ${re} damage.${Se}${Ce} (${h.health}/${h.maxHealth} HP)`,projectileUsed:W}:{success:!0,message:`You ${j} the ${h.name} for ${re} damage.${Se}${Ce} Defeated!`,encounterEnded:!0,projectileUsed:W}}}}const mn={id:"throw-rock",name:"Throw Rock",description:"Throw a rock at your enemy. Ranged attack.",tickCost:150,tags:["combat","offensive","ranged"],execute:(t,e)=>{var S,k,v;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to throw at."};if(E(t,"rocks")<=0)return{success:!1,message:"You have no rocks to throw."};q(t,"rocks",1);const s=e.encounter.enemy;I(t.levelInfo,"precision",1),I(t.levelInfo,"agility",.3);const n=5,i=10,a=Gt(t.levelInfo.stats);let r=n+a+Math.floor(Math.random()*(i-n+1));const o=K(t),c=e.encounter.enemyFleeing?Math.floor(o/2):0;r+=c;const l=ye(s),d=t.skills.throwing.level,m=((k=(S=s.skills)==null?void 0:S.shield)==null?void 0:k.level)??0,p=ge(t,s,r,{attackerWeaponAccuracy:5,attackerSkillLevel:d,defenderArmorPenalty:l,defenderShieldSkillLevel:m}),h=p.hit?B.combatHit:B.combatMiss,u=((v=e==null?void 0:e.game)==null?void 0:v.turn)??0,f=Y(t.skills.throwing,h,u);if(!p.hit)return{success:!0,message:p.dodged?`The ${s.name} dodges your thrown rock!`:`You throw a rock at the ${s.name} but miss!`,projectileUsed:{type:"rock",outcome:p.dodged?"dodged":"missed"}};p.critical&&I(t.levelInfo,"luck",1);const y=Q(s),g=ee(p.damage,y);F(s,g);const C=p.critical?" Critical hit!":"",L=f.levelsGained>0?" Throwing leveled up!":"";return D(s)?{success:!0,message:`Your rock hits the ${s.name} for ${g} damage.${C}${L} (${s.health}/${s.maxHealth} HP)`,projectileUsed:{type:"rock",outcome:"hit"}}:{success:!0,message:`Your rock strikes the ${s.name} for ${g} damage.${C}${L} Defeated!`,encounterEnded:!0,projectileUsed:{type:"rock",outcome:"hit"}}}},fn={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const s=e.encounter.enemy,n=e.encounter.aggressiveness;if(n<.2)return{success:!0,message:`You back away from the ${s.name} and leave.`,fled:!0};const i=P(t),a=P(s),r=i/a,o=.4+(1-n)*.3,c=Math.min(.9,o*r);return Math.random()<c?{success:!0,message:`You turn and run from the ${s.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${s.name} blocks your escape!`,fled:!1}}},hn={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(t,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const s=e.encounter.enemy,n=P(t),i=P(s),a=n/i,o=Math.min(.85,.5*a);return Math.random()<o?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${s.name}!`}):{success:!0,message:`The ${s.name} escapes into the distance.`,encounterEnded:!0}}},gn={id:"exit-location",name:"Exit Location",description:"Leave the current location through a discovered exit.",tickCost:100,tags:["basic","exploration","movement","non-combat","location"],execute:(t,e)=>{var n,i,a;if((n=e==null?void 0:e.game)!=null&&n.structures.has("campfire"))return{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."};if(((i=e==null?void 0:e.game)==null?void 0:i.currentLocation)===null)return{success:!1,message:"You are already in the wilderness."};if(!((a=e==null?void 0:e.game)!=null&&a.foundExit))return{success:!1,message:"You haven't found a way out yet. Keep exploring!"};const s=M(e.game.currentLocation);return{success:!0,message:`You make your way out of ${(s==null?void 0:s.name)??"the location"}...`}}};function pn(t,e){return{id:`enter-location-${t}`,name:`Enter ${e}`,description:`Enter the ${e}.`,tickCost:150,tags:["basic","exploration","movement","non-combat","location"],execute:(s,n)=>{var i;return(i=n==null?void 0:n.game)!=null&&i.structures.has("campfire")?{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."}:{success:!0,message:`You prepare to enter ${e}...`}}}}const yn=[mn,fn,hn],kn=[Os,Ns,_s,Gs],vn=[Ys,js,Fs,Us,Ws,Qs,Ks,Vs,Xs,zs,Js,Zs,en,tn,sn],bn=[ln,un,dn],Sn=[rn,on,cn],Cn=[gn],dt=[Ds,Ps,...yn,...kn,...vn,...bn,...Sn,...Cn],Ln=1e4,wn=100,En=100,An=15,Mn={vitality:5,strength:5,agility:5,precision:5,endurance:3,arcane:0,luck:2};function $n(){return st("player","Player",{maxTicks:Ln,speed:wn,maxHealth:En,damage:An,actions:dt,stats:Mn,level:0})}const Hn=1,ve="iterra_save";function mt(t){return{id:t.id,name:t.name,ticks:t.ticks,maxTicks:t.maxTicks,speed:t.speed,carryCapacity:t.carryCapacity,health:t.health,maxHealth:t.maxHealth,damage:t.damage,saturation:t.saturation,maxSaturation:t.maxSaturation,inventory:{...t.inventory},materialQualities:{...t.materialQualities},equipment:{...t.equipment},equipmentInstances:{...t.equipmentInstances},levelInfo:{...t.levelInfo,stats:{...t.levelInfo.stats},statUsage:{...t.levelInfo.statUsage}},skills:{...t.skills},backSlots:[...t.backSlots]}}function ft(t,e){const s=e?[...dt]:[],n=qn(t.skills),i=Tn(t.levelInfo),a=[null,null,null];if(t.backSlots)for(let o=0;o<3&&o<t.backSlots.length;o++){const c=t.backSlots[o];typeof c=="string"?a[o]=c:c&&typeof c=="object"&&"itemId"in c&&(a[o]=c.itemId)}const r={id:t.id,name:t.name,ticks:t.ticks,maxTicks:t.maxTicks,speed:t.speed,carryCapacity:t.carryCapacity??30,health:t.health,maxHealth:t.maxHealth,damage:t.damage,saturation:t.saturation,maxSaturation:t.maxSaturation,inventory:t.inventory??{},materialQualities:t.materialQualities??{},equipment:t.equipment??{},equipmentInstances:t.equipmentInstances??{},levelInfo:i,skills:n,actions:s,backSlots:a};return e&&le(r),r}function qn(t){const e=Ue();if(!t)return e;const s={...e};for(const[n,i]of Object.entries(t))i&&typeof i=="object"&&(s[n]={level:i.level??0,xp:i.xp??0,xpToNextLevel:me((i.level??0)+1),lastGainedAt:i.lastGainedAt??-1});return s}function Tn(t){const e={vitality:5,strength:5,agility:5,precision:5,endurance:3,arcane:0,luck:2},s={vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0};return t?{level:t.level??1,xp:t.xp??0,xpToNextLevel:Z((t.level??1)+1),freeStatPoints:t.freeStatPoints??0,stats:{...e,...t.stats},statUsage:{...s,...t.statUsage}}:{level:1,xp:0,xpToNextLevel:Z(2),freeStatPoints:0,stats:e,statUsage:s}}function Bn(t){return{enemy:mt(t.enemy),playerFleeing:t.playerFleeing,enemyFleeing:t.enemyFleeing,aggressiveness:t.aggressiveness,ended:t.ended,result:t.result,projectilesUsed:{...t.projectilesUsed}}}function In(t){return{enemy:ft(t.enemy,!1),playerFleeing:t.playerFleeing,enemyFleeing:t.enemyFleeing,aggressiveness:t.aggressiveness,ended:t.ended,result:t.result,projectilesUsed:t.projectilesUsed??{arrows:{hit:0,dodged:0,blocked:0,missed:0},rocks:{hit:0,dodged:0,blocked:0,missed:0}}}}function xn(t){return{version:Hn,savedAt:Date.now(),player:mt(t.player),turn:t.turn,log:t.log.slice(0,50),encounter:t.encounter?Bn(t.encounter):null,availableNodes:[...t.availableNodes],structures:Array.from(t.structures),pendingLoot:t.pendingLoot?{...t.pendingLoot}:null,pendingCorpse:t.pendingCorpse?{...t.pendingCorpse}:null,gameOver:t.gameOver,currentLocation:t.currentLocation,locationStack:[...t.locationStack],discoveredLocations:{...t.discoveredLocations},foundExit:t.foundExit}}function Rn(t){return{player:ft(t.player,!0),turn:t.turn??0,log:t.log??[],encounter:t.encounter?In(t.encounter):null,availableNodes:t.availableNodes??[],structures:new Set(t.structures??[]),pendingLoot:t.pendingLoot??null,pendingCorpse:t.pendingCorpse??null,gameOver:t.gameOver??!1,currentLocation:t.currentLocation??null,locationStack:t.locationStack??[],discoveredLocations:t.discoveredLocations??{},foundExit:t.foundExit??!1}}function Dn(t){try{const e=xn(t),s=JSON.stringify(e);return localStorage.setItem(ve,s),!0}catch(e){return console.error("Failed to save game:",e),!1}}function Pn(){try{const t=localStorage.getItem(ve);if(!t)return null;const e=JSON.parse(t);return!e||typeof e!="object"||!e.player?(console.warn("Invalid save data structure"),null):Rn(e)}catch(t){return console.error("Failed to load game:",t),null}}function De(){localStorage.removeItem(ve)}const be="iterra_tracking",Pe=500;function On(t){try{const e=t.length>Pe?t.slice(-Pe):t,s=JSON.stringify(e);return localStorage.setItem(be,s),!0}catch(e){return console.error("Failed to save tracking records:",e),!1}}function Nn(){try{const t=localStorage.getItem(be);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error("Failed to load tracking records:",t),[]}}function _n(){localStorage.removeItem(be)}function Gn(t){const e=t.damage,s=Math.floor(e*.3),n=Math.max(1,e-s),i=e+s,a=_t(t.levelInfo.stats);return n+a+Math.floor(Math.random()*(i-n+1))}function Yn(t,e=1,s=null){const n=t??ds(e,s),i=V(n),a=(i==null?void 0:i.aggressiveness)??.5;return{enemy:n,playerFleeing:!1,enemyFleeing:!1,aggressiveness:a,ended:!1,projectilesUsed:{arrows:{hit:0,dodged:0,blocked:0,missed:0},rocks:{hit:0,dodged:0,blocked:0,missed:0}}}}function _(t,e){t.ended=!0,t.result=e}function jn(t,e){const s=t.enemy,n=V(s),i=t.aggressiveness;if(t.playerFleeing)return Qn(t,e);if(t.enemyFleeing)return Wn(t,e);const a=s.health/s.maxHealth,r=(n==null?void 0:n.fleeThreshold)??.3;if(a<=r){const o=e.health/e.maxHealth,c=(1-i)*(1-o*.5);if(Math.random()<c)return Un(t)}return i<.2?{type:"attack",message:`The ${s.name} watches you cautiously.`,damage:0}:Fn(t,e)}function Fn(t,e){const s=t.enemy,n=Gn(s),i=rt(s),a=ye(e),r=Hs(e),o=qs(e),c=ge(s,e,n,{attackerWeaponAccuracy:i,defenderArmorPenalty:a,defenderBlockBonus:r,defenderShieldArmor:o});if(!c.hit&&!c.blocked)return{type:"attack",message:c.dodged?`You dodge the ${s.name}'s attack!`:`The ${s.name} attacks but misses!`,damage:0};if(c.blocked){const u=Q(e),f=K(e),y=u+Math.floor(f/3),g=ee(c.damage,y);F(e,g);const C=c.critical?" (crit blocked!)":"";return D(e)?{type:"attack",message:`You block the ${s.name}'s attack, taking ${g} damage.${C} (${e.health}/${e.maxHealth} HP)`,damage:g}:{type:"attack",message:`You block the ${s.name}'s attack but take ${g} damage.${C} You have been defeated!`,damage:g,encounterEnded:!0}}const l=Q(e),d=K(e),m=l+Math.floor(d/3),p=ee(c.damage,m);F(e,p);const h=c.critical?" Critical hit!":"";return D(e)?{type:"attack",message:`The ${s.name} strikes you for ${p} damage.${h} (${e.health}/${e.maxHealth} HP)`,damage:p}:{type:"attack",message:`The ${s.name} strikes you for ${p} damage.${h} You have been defeated!`,damage:p,encounterEnded:!0}}function Un(t){return t.enemyFleeing=!0,{type:"flee",message:`The ${t.enemy.name} turns to flee!`,fled:!1}}function Wn(t,e){const s=t.enemy,n=P(s),i=P(e),a=n/i,o=Math.min(.9,.4*a);return Math.random()<o?{type:"flee",message:`The ${s.name} escapes!`,fled:!0,encounterEnded:!0}:(t.enemyFleeing=!1,{type:"flee",message:`The ${s.name} fails to escape and turns to fight!`,fled:!1})}function Qn(t,e){const s=t.enemy,n=t.aggressiveness;if(n<.2)return{type:"chase",message:`The ${s.name} lets you go.`,encounterEnded:!0};const i=e.health/e.maxHealth,a=n+(1-i)*.3;if(Math.random()<a){const r=P(s),o=P(e),c=r/o,l=Math.min(.85,.5*c);return Math.random()<l?(t.playerFleeing=!1,{type:"chase",message:`The ${s.name} catches up to you!`}):{type:"chase",message:`The ${s.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${s.name} lets you flee.`,encounterEnded:!0}}function Kn(t,e){const s=t.enemy,n=s.speed*2;ue(s,n);const i=200;return s.ticks<i?null:(s.ticks-=i,jn(t,e))}const Vn=.3,Xn=.1;function zn(t,e,s,n){if(e.fled===!0&&(t.playerFleeing=!0),n!=null&&n.isAttack?t.aggressiveness=Math.min(1,t.aggressiveness+Vn):n!=null&&n.isIdle&&(t.aggressiveness=Math.max(0,t.aggressiveness-Xn)),e.projectileUsed){const{type:i,outcome:a}=e.projectileUsed;i==="arrow"?t.projectilesUsed.arrows[a]++:i==="rock"&&t.projectilesUsed.rocks[a]++}if(t.enemyFleeing&&!(n!=null&&n.isChase)&&!e.encounterEnded){_(t,"enemy_escaped");return}e.encounterEnded&&(D(t.enemy)?t.playerFleeing||e.fled?_(t,"player_escaped"):t.enemyFleeing&&_(t,"enemy_escaped"):_(t,"victory"))}const Oe={hit:1,blocked:.9,dodged:.7,missed:.6},Jn=.95,Zn=.6,ea=.25;function ta(t){const e=t.result==="enemy_escaped",{arrows:s,rocks:n}=t.projectilesUsed;let i=0,a=0;for(const[r,o]of Object.entries(s)){if(o<=0)continue;let c=Zn*Oe[r];e&&(c*=ea);for(let l=0;l<o;l++)Math.random()<c&&i++}for(const[r,o]of Object.entries(n)){if(o<=0)continue;const c=Jn*Oe[r];for(let l=0;l<o;l++)Math.random()<c&&a++}return{arrows:i,rocks:a}}const Ne=2,sa=1,_e=500,Ge=10,na=.1;class aa{constructor(){$(this,"state");$(this,"listeners",new Map);$(this,"actionTrackingRecords",[]);$(this,"trackingEnabled",!0);$(this,"currentLocationCache",null);$(this,"enterableLocationsCache",null);this.state=this.createInitialState(),this.actionTrackingRecords=Nn()}createInitialState(){return{player:$n(),turn:0,log:[],encounter:null,availableNodes:[],structures:new Set,pendingLoot:null,pendingCorpse:null,gameOver:!1,currentLocation:null,locationStack:[],discoveredLocations:{},foundExit:!1}}restart(){De(),this.state=this.createInitialState(),this.invalidateLocationCache(),this.log("A new journey begins..."),this.emit("turn")}start(){this.log("Welcome to Iterra.")}performAction(e){if(this.state.gameOver)return!1;const s=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;const n=this.getEffectiveTickCost(e);if(s.ticks<n)return this.log(`Not enough ticks for ${e.name}. Need ${n}, have ${s.ticks}.`),!1;this.recordAction(e),ps(s,n),e.tickGain&&ue(s,e.tickGain);const i={encounter:this.state.encounter??void 0,game:this.state},a=e.execute(s,i);if(this.state.turn++,this.log(a.message),e.id==="wander"&&!this.state.encounter&&(this.processNodeDropOff(),this.processLocationDropOff(),this.processCorpseDropOff()),a.foundResource){const r=a.foundResource;this.state.availableNodes.push({nodeId:r,distance:0})}if(a.foundLocation&&this.discoverLocation(a.foundLocation),a.foundExit&&this.findExit(),e.id==="exit-location"&&a.success&&this.exitLocation(),e.id.startsWith("enter-location-")&&a.success){const r=e.id.replace("enter-location-","");this.enterLocation(r)}if(e.tags.includes("gathering")&&this.processResourceDepletion(e.id),e.tags.includes("harvesting")&&this.processCorpseCleanup(),a.clearCorpse&&(this.state.pendingCorpse=null),this.state.encounter){const r=e.tags.includes("offensive"),o=e.id==="chase",c=e.id==="idle",l={isAttack:r,isChase:o,isIdle:c};zn(this.state.encounter,a,s,l),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()}else e.id==="wander"&&!a.foundResource&&!a.foundLocation&&!a.foundExit?this.checkForEncounter(.25):e.tags.includes("combat")||this.checkForEncounter(.03);return this.processHunger(),this.processRegen(),this.processStarvation(),this.processPassOut(),this.emit("turn"),!0}processHunger(){const e=this.state.player,s=Vt(e.levelInfo.stats);Math.random()<na*(1-s)&&qe(e,1)}processRegen(){const e=this.state.player;bs(e)&&e.health<e.maxHealth&&(ys(e,Ne),qe(e,sa),this.log(`You feel restored. (+${Ne} HP, ${e.health}/${e.maxHealth})`))}processStarvation(){const e=this.state.player;if(Ss(e)){const s=Cs();F(e,s),this.log(`You are starving! (-${s} HP, ${e.health}/${e.maxHealth})`),D(e)||(this.log("You have starved to death..."),this.triggerGameOver())}}canAffordAnyAction(){const e=this.getAvailableActions(),s=this.state.player;return e.some(n=>s.ticks>=this.getEffectiveTickCost(n))}processPassOut(){if(this.state.gameOver||this.canAffordAnyAction())return;const e=this.state.player;if(this.log("You collapse from exhaustion..."),F(e,Ge),ue(e,_e),this.state.turn++,this.log(`You wake up weakened. (-${Ge} HP, +${_e} ticks)`),!D(e)){this.log("You never wake up..."),this.triggerGameOver();return}this.state.encounter&&!this.state.encounter.ended&&(this.log(`The ${this.state.encounter.enemy.name} attacks while you're vulnerable!`),this.processEnemyTurns()),this.emit("turn")}triggerGameOver(){this.state.gameOver=!0,this.log("GAME OVER"),this.emit("game-over")}processResourceDepletion(e){var r;const n={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e];if(!n)return;const i=de(n);if(!i)return;const a=(r=this.state.availableNodes.map((o,c)=>({n:o,i:c})).filter(({n:o})=>o.nodeId===n).sort((o,c)=>o.n.distance-c.n.distance)[0])==null?void 0:r.i;a!==void 0&&(Math.random()<i.depletionChance?this.state.availableNodes.splice(a,1):this.state.availableNodes[a].distance=0)}processNodeDropOff(){const e=[];for(let s=0;s<this.state.availableNodes.length;s++){const n=this.state.availableNodes[s],i=de(n.nodeId);if(!i)continue;const a=i.dropOffChance,r=1+n.distance*.1,o=Math.min(.5,a*r);Math.random()<o?e.push(s):n.distance++}for(let s=e.length-1;s>=0;s--)this.state.availableNodes.splice(e[s],1)}processLocationDropOff(){let e=!1;for(const[s,n]of Object.entries(this.state.discoveredLocations)){const i=M(s);if(!i||(i.parentId??null)!==this.state.currentLocation)continue;const r=[],o=.08;for(let c=0;c<n.entrances.length;c++){const l=n.entrances[c],d=1+l.distance*.15,m=Math.min(.4,o*d);Math.random()<m?(r.push(c),e=!0):(l.distance++,e=!0)}for(let c=r.length-1;c>=0;c--)n.entrances.splice(r[c],1);n.entrances.length===0&&delete this.state.discoveredLocations[s]}e&&this.invalidateLocationCache()}processCorpseDropOff(){const e=this.state.pendingCorpse;if(!e)return;const s=.25,n=1+e.distance*.1,i=Math.min(.5,s*n);Math.random()<i?(this.state.pendingCorpse=null,this.log(`You wander away from the ${e.enemyName}'s corpse.`)):e.distance++}processCorpseCleanup(){const e=this.state.pendingCorpse;if(!e)return;const s=x(e.enemyId),n=R(e.enemyId),i=!s||e.butchered,a=!n||e.skinned;i&&a&&(this.state.pendingCorpse=null)}checkForEncounter(e=.25){this.getCurrentLocation().isSafe||Math.random()<e&&this.startEncounter()}startEncounter(e){const s=this.state.player.levelInfo.level,n=this.state.currentLocation,i=Yn(e,s,n);this.state.encounter=i;const a=i.enemy.levelInfo.level,r=a>1?` (Lv.${a})`:"";this.log(`A wild ${i.enemy.name}${r} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,s=this.state.player,n=Kn(e,s);n&&(this.log(n.message),n.encounterEnded&&(D(s)?n.fled?_(e,"enemy_escaped"):e.playerFleeing&&_(e,"player_escaped"):_(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,s=this.state.encounter.enemy,n=this.state.player;switch(e){case"victory":this.log(`You defeated the ${s.name}!`);const i=ms(s,n.levelInfo.level),{levelsGained:a,autoStats:r}=Pt(n.levelInfo,i);if(this.log(`+${i} XP`),a>0){if(le(n),this.log(`LEVEL UP! You are now level ${n.levelInfo.level}!`),r.length>0){const o={};for(const l of r)o[l]=(o[l]||0)+1;const c=Object.entries(o).map(([l,d])=>`+${d} ${ce[l]}`).join(", ");this.log(`Auto stats: ${c}`)}n.levelInfo.freeStatPoints>0&&this.log(`You have ${n.levelInfo.freeStatPoints} stat points to allocate!`),this.emit("level-up")}this.handleEnemyDeath(s),this.recoverProjectiles();break;case"defeat":this.log("You have been defeated..."),this.state.encounter=null,this.triggerGameOver();return;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${s.name} got away.`),this.recoverProjectiles();break}this.state.encounter=null,this.emit("encounter-end")}handleEnemyDeath(e){const s=V(e);if(s!=null&&s.usesInventory){this.setPendingLoot(e);return}const n=x(e.id),i=R(e.id);if(n||i){this.state.pendingCorpse={enemyId:e.id,enemyName:e.name,butchered:!1,skinned:!1,distance:0};const a=[];n&&a.push("butchered"),i&&a.push("skinned"),this.log(`The ${e.name}'s corpse can be ${a.join(" and ")}.`)}}recoverProjectiles(){if(!this.state.encounter)return;const e=ta(this.state.encounter),s=this.state.player,n=[];e.arrows>0&&(A(s,"arrow",e.arrows),n.push(`${e.arrows} arrow${e.arrows>1?"s":""}`)),e.rocks>0&&(A(s,"rocks",e.rocks),n.push(`${e.rocks} rock${e.rocks>1?"s":""}`)),n.length>0&&this.log(`Recovered: ${n.join(", ")}`)}setPendingLoot(e){const s=he(this.state.player.levelInfo.stats),n=os(e,s),i={};for(const[a,r]of Object.entries(n))r>0&&(i[a]=r);if(Object.keys(i).length>0){this.state.pendingLoot=i;const a=Object.entries(i).map(([r,o])=>{const c=b(r);return`${o} ${(c==null?void 0:c.name)??r}`});this.log(`Loot available: ${a.join(", ")}`)}}takeLoot(e,s=1){if(!this.state.pendingLoot||!this.state.pendingLoot[e])return!1;const n=this.state.pendingLoot[e],i=Math.min(s,n);A(this.state.player,e,i),this.state.pendingLoot[e]-=i,this.state.pendingLoot[e]<=0&&delete this.state.pendingLoot[e],Object.keys(this.state.pendingLoot).length===0&&(this.state.pendingLoot=null);const a=b(e);return this.log(`Took ${i} ${(a==null?void 0:a.name)??e}.`),this.emit("turn"),!0}takeAllLoot(){if(this.state.pendingLoot){for(const[e,s]of Object.entries(this.state.pendingLoot))A(this.state.player,e,s);this.log("Took all loot."),this.state.pendingLoot=null,this.emit("turn")}}leaveLoot(){this.state.pendingLoot&&(this.log("Left the loot behind."),this.state.pendingLoot=null,this.emit("turn"))}dropItem(e,s=1){const n=this.state.player,i=E(n,e);if(i<=0)return!1;const a=Math.min(s,i);n.inventory[e]-=a,n.inventory[e]<=0&&delete n.inventory[e];const r=b(e);return this.log(`Dropped ${a} ${(r==null?void 0:r.name)??e}.`),this.emit("turn"),!0}equip(e,s){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const n=this.state.player,i=b(e);return i?Es(n,e,s)?(this.log(`Equipped ${i.name}.`),this.emit("turn"),!0):(this.log(`Cannot equip ${i.name}.`),!1):!1}unequip(e){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const s=this.state.player,n=s.equipment[e];if(!n)return!1;const i=b(n);return J(s,e)?(this.log(`Unequipped ${(i==null?void 0:i.name)??n}.`),this.emit("turn"),!0):!1}allocateStat(e){const s=this.state.player;return Nt(s.levelInfo,e)?(le(s),this.log(`+1 ${ce[e]}!`),this.emit("turn"),!0):(this.log("No stat points available."),!1)}addToBackSlots(e,s=!1){if(this.state.encounter)return this.log("Can't modify back slots during combat!"),!1;const n=this.state.player;if(!ae(e))return this.log("That item cannot be stored on your back."),!1;if(!te(n,e)){const i=b(e),a=n.backSlots.includes(e),r=n.backSlots.filter(o=>o!==null).length;return a?this.log("That weapon is already on your back."):r>=3?this.log("Back slots are full (max 3 weapons)."):i!=null&&i.twoHanded?this.log("Cannot add more two-handed weapons (max 2)."):this.log("Cannot add weapon to back slots."),!1}if(Ts(n,e,void 0,s)){const i=b(e);return this.log(`Added ${(i==null?void 0:i.name)??e} to back slots.`),this.emit("turn"),!0}return this.log("Cannot add weapon to back slots."),!1}removeFromBackSlots(e){if(this.state.encounter)return this.log("Can't modify back slots during combat!"),!1;const s=this.state.player;if(lt(s,e)){const n=b(e);return this.log(`Removed ${(n==null?void 0:n.name)??e} from back slots.`),this.emit("turn"),!0}return this.log("Weapon not found in back slots."),!1}getBackSlotsInfo(){const e=this.state.player;return{weapons:e.backSlots,equipped:e.equipment.mainHand}}log(e){const s={turn:this.state.turn,message:e};this.state.log.unshift(s),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,s){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s)}off(e,s){var n;(n=this.listeners.get(e))==null||n.delete(s)}emit(e){var s;(s=this.listeners.get(e))==null||s.forEach(n=>n(this)),e==="turn"&&this.autoSave()}autoSave(){Dn(this.state),this.emit("save")}loadFromSave(){const e=Pn();return e?(this.state=e,this.invalidateLocationCache(),this.emit("load"),this.emit("turn"),!0):!1}clearSaveData(){De()}getAvailableActions(){var l;let e=[...this.state.player.actions];const s=this.getEnterableLocations();for(const d of s)e.push(pn(d.id,d.name));const n=this.state.encounter!==null,i=((l=this.state.encounter)==null?void 0:l.enemyFleeing)??!1,a=this.state.player;if(n){const d=a.equipment.mainHand;e.push(Re(d,!1));const m=ct(a);for(const p of m)p!==null&&p!==d&&e.push(Re(p,!0))}const r={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"},o={"eat-berries":"berries","eat-cooked-meat":"cookedMeat","eat-raw-meat":"rawMeat"},c={"craft-campfire":{requiresItems:{sticks:5,rocks:3}},"place-campfire":{requiresNoCampfire:!0,requiresItems:{campfire:1}},"pickup-campfire":{requiresCampfire:!0},"smother-campfire":{requiresCampfire:!0},"cook-meat":{requiresCampfire:!0,requiresItems:{rawMeat:1}},"craft-stone-knife":{requiresItems:{rocks:2,sticks:1}},"craft-stone-spear":{requiresItems:{rocks:1,sticks:3,fiber:2}},"craft-bow":{requiresItems:{sticks:3,fiber:5}},"craft-arrows":{requiresItems:{sticks:2,rocks:1}},"craft-wooden-shield":{requiresItems:{sticks:6,fiber:3}},"process-leather":{requiresCampfire:!0,requiresItems:{rawLeather:2}},"craft-leather-helm":{requiresItems:{leather:2}},"craft-leather-chest":{requiresItems:{leather:4}},"craft-leather-legs":{requiresItems:{leather:3}},"craft-leather-boots":{requiresItems:{leather:2}}};return e.filter(d=>{var u;if(n&&d.tags.includes("non-combat")||!n&&d.tags.includes("combat")||d.id==="chase"&&!i||d.id==="flee"&&((u=this.state.encounter)!=null&&u.playerFleeing))return!1;const m=r[d.id];if(m&&!this.state.availableNodes.some(f=>f.nodeId===m))return!1;const p=o[d.id];if(p&&E(a,p)<=0)return!1;const h=c[d.id];if(h){if(h.requiresCampfire&&!this.state.structures.has("campfire")||h.requiresNoCampfire&&this.state.structures.has("campfire"))return!1;if(h.requiresItems){for(const[f,y]of Object.entries(h.requiresItems))if(E(a,f)<y)return!1}}if(d.id==="throw-rock"&&E(a,"rocks")<=0||d.id==="attack-bow"&&E(a,"arrow")<=0||d.id==="wander"&&this.state.structures.has("campfire"))return!1;if(d.tags.includes("harvesting")){const f=this.state.pendingCorpse;if(!f||d.id==="butcher"&&(!x(f.enemyId)||f.butchered)||d.id==="skin"&&(!R(f.enemyId)||f.skinned))return!1}return!(d.id==="exit-location"&&(this.state.currentLocation===null||!this.state.foundExit||this.state.structures.has("campfire"))||d.id.startsWith("enter-location-")&&this.state.structures.has("campfire"))})}filterActions(e){const s=this.getAvailableActions(),n=e.toLowerCase().trim();let i=s;return n&&(i=s.filter(a=>{const r=a.name.toLowerCase().includes(n),o=a.description.toLowerCase().includes(n),c=a.tags.some(l=>l.toLowerCase().includes(n));return r||o||c})),this.sortActionsByPriority(i)}getActionPriority(e){var o;const s=this.state.player,n=this.state.encounter!==null,i=((o=this.state.encounter)==null?void 0:o.enemyFleeing)??!1;let a=0;if(n)return e.tags.includes("weapon-attack")?(a+=100,a):(e.id==="attack"&&(a+=100),e.id==="flee"&&(a+=80),e.id==="throw-rock"&&(a+=70),e.id==="chase"&&i&&(a+=90),a);const r=s.saturation/s.maxSaturation;if(e.tags.includes("consumption")&&(r<.3?a+=100:r<.5?a+=80:a+=30),e.id==="idle"){a+=40;const c=s.ticks/s.maxTicks;c<.1?a+=80:c<.2?a+=50:c<.3&&(a+=30)}if(e.id==="wander"&&(a+=60),e.tags.includes("gathering")&&(a+=50),e.tags.includes("harvesting")&&(a+=90),e.tags.includes("crafting"))if(e.id==="craft-arrows"&&s.equipment.mainHand==="bow"){const c=E(s,"arrow");c<5?a+=85:c<15?a+=60:a+=25}else e.id==="cook-meat"?a+=70:e.id==="process-leather"?a+=55:e.id==="craft-stone-knife"||e.id==="craft-stone-spear"||e.id==="craft-bow"?s.equipment.mainHand?a+=25:a+=75:e.id.startsWith("craft-leather-")?a+=45:e.id==="craft-wooden-shield"?s.equipment.offHand?a+=20:a+=55:e.id==="craft-campfire"?E(s,"campfire")===0&&!this.state.structures.has("campfire")?a+=50:a+=5:e.id==="place-campfire"?a+=55:e.id==="pickup-campfire"?a+=15:e.id==="smother-campfire"?a+=10:a+=30;return a}sortActionsByPriority(e){return[...e].sort((s,n)=>{const i=this.getActionPriority(s);return this.getActionPriority(n)-i})}getGroupedActions(){const e=this.sortActionsByPriority(this.getAvailableActions());if(this.state.encounter!==null)return[{category:"Combat",actions:e}];const n={Suggested:[],Harvest:[],Explore:[],Gather:[],Eat:[],Craft:[],Other:[]},i=e.slice(0,3);n.Suggested=i;for(const a of e)a.id==="idle"||a.id==="wander"||a.id==="exit-location"||a.id.startsWith("enter-location-")?n.Explore.push(a):a.tags.includes("harvesting")?n.Harvest.push(a):a.tags.includes("gathering")?n.Gather.push(a):a.tags.includes("consumption")?n.Eat.push(a):a.tags.includes("crafting")?n.Craft.push(a):n.Other.push(a);return Object.entries(n).filter(([a,r])=>r.length>0).map(([a,r])=>({category:a,actions:r}))}createStateSnapshot(){const e=this.state.player,s=this.state.encounter;return{turn:this.state.turn,ticks:e.ticks,maxTicks:e.maxTicks,health:e.health,maxHealth:e.maxHealth,saturation:e.saturation,maxSaturation:e.maxSaturation,inCombat:s!==null,enemyName:s==null?void 0:s.enemy.name,enemyHealth:s==null?void 0:s.enemy.health,enemyMaxHealth:s==null?void 0:s.enemy.maxHealth,enemyFleeing:s==null?void 0:s.enemyFleeing,playerFleeing:s==null?void 0:s.playerFleeing,availableNodes:this.state.availableNodes.map(n=>n.nodeId),hasCorpse:this.state.pendingCorpse!==null,inventory:{berries:E(e,"berries"),rawMeat:E(e,"raw-meat"),cookedMeat:E(e,"cooked-meat"),arrows:E(e,"arrow"),rocks:E(e,"rock")},mainHand:e.equipment.mainHand??null,offHand:e.equipment.offHand??null,hasCampfire:E(e,"campfire")>0,campfirePlaced:this.state.structures.has("campfire"),currentLocation:this.state.currentLocation,foundExit:this.state.foundExit}}recordAction(e){if(!this.trackingEnabled)return;const s=this.getAvailableActions(),n=this.sortActionsByPriority(s),i=n.slice(0,3).map(o=>o.id),a=n.map(o=>({id:o.id,name:o.name,tickCost:o.tickCost,effectiveCost:this.getEffectiveTickCost(o),priority:this.getActionPriority(o),tags:o.tags})),r={timestamp:Date.now(),state:this.createStateSnapshot(),availableActions:a,suggestedActions:i,takenAction:e.id,wasSuggested:i.includes(e.id)};this.actionTrackingRecords.push(r),On(this.actionTrackingRecords)}getTrackingRecords(){return this.actionTrackingRecords}clearTrackingRecords(){this.actionTrackingRecords=[],_n()}setTrackingEnabled(e){this.trackingEnabled=e}isTrackingEnabled(){return this.trackingEnabled}exportTrackingData(){const e={exportedAt:new Date().toISOString(),recordCount:this.actionTrackingRecords.length,records:this.actionTrackingRecords};return JSON.stringify(e,null,2)}getTrackingSummary(){const e=this.actionTrackingRecords,s=e.length,n=e.filter(o=>o.wasSuggested).length,i=s-n,a=s>0?n/s:0,r={};for(const o of e)r[o.takenAction]=(r[o.takenAction]||0)+1;return{totalActions:s,suggestedFollowed:n,suggestedIgnored:i,followRate:a,actionBreakdown:r}}discoverLocation(e){const s=M(e);s&&(this.state.discoveredLocations[e]?this.state.discoveredLocations[e].entrances.push({distance:0}):this.state.discoveredLocations[e]={locationId:e,entrances:[{distance:0}]},this.invalidateLocationCache(),this.log(s.discoveryMessage),this.emit("location-discovered"))}enterLocation(e){const s=M(e);if(!s)return this.log("Unknown location."),!1;const n=this.state.discoveredLocations[e];return!n||n.entrances.length===0?(this.log(`You haven't found an entrance to ${s.name}.`),!1):s.parentId!==(this.state.currentLocation??void 0)?(this.log(`You can't reach ${s.name} from here.`),!1):(n.entrances.sort((i,a)=>i.distance-a.distance),n.entrances.shift(),n.entrances.length===0&&delete this.state.discoveredLocations[e],this.state.currentLocation!==null&&this.state.locationStack.push(this.state.currentLocation),this.state.currentLocation=e,this.state.foundExit=!1,this.state.availableNodes=[],this.invalidateLocationCache(),this.log(`You enter ${s.name}.`),this.emit("location-entered"),!0)}exitLocation(){if(this.state.currentLocation===null)return this.log("You are already in the wilderness."),!1;if(!this.state.foundExit)return this.log("You haven't found a way out yet. Keep exploring!"),!1;const e=M(this.state.currentLocation),s=this.state.locationStack.pop()??null;if(this.state.currentLocation=s,this.state.foundExit=!1,this.state.availableNodes=[],this.invalidateLocationCache(),s===null)this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to the wilderness.`);else{const n=M(s);this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to ${(n==null?void 0:n.name)??"the previous area"}.`)}return this.emit("location-exited"),!0}findExit(){if(this.state.currentLocation===null)return;this.state.foundExit=!0;const e=M(this.state.currentLocation);this.log(`You find an exit from ${(e==null?void 0:e.name)??"this location"}!`),this.emit("exit-found")}invalidateLocationCache(){this.currentLocationCache=null,this.enterableLocationsCache=null}getCurrentLocation(){if(this.currentLocationCache!==null)return this.currentLocationCache;if(this.state.currentLocation===null)return this.currentLocationCache={id:null,name:"Wilderness",isSafe:!1},this.currentLocationCache;const e=M(this.state.currentLocation);return this.currentLocationCache={id:this.state.currentLocation,name:(e==null?void 0:e.name)??"Unknown",isSafe:(e==null?void 0:e.isSafe)??!1},this.currentLocationCache}getAvailableNodeInfo(e){const s=this.state.availableNodes.filter(i=>i.nodeId===e);if(s.length===0)return null;const n=Math.min(...s.map(i=>i.distance));return{count:s.length,closestDistance:n}}getEffectiveTickCost(e){const s=e.tickCost,n=50,a={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e.id];if(a){const r=this.getAvailableNodeInfo(a);if(r)return s+r.closestDistance*n}if(e.id.startsWith("enter-location-")){const r=e.id.replace("enter-location-",""),c=this.getEnterableLocations().find(l=>l.id===r);if(c)return s+c.closestDistance*n}return s}getEnterableLocations(){if(this.enterableLocationsCache!==null)return this.enterableLocationsCache;const e=[];for(const[s,n]of Object.entries(this.state.discoveredLocations)){if(n.entrances.length===0)continue;const i=M(s);if(!i||(i.parentId??null)!==this.state.currentLocation)continue;const r=Math.min(...n.entrances.map(o=>o.distance));e.push({id:s,name:i.name,entrances:n.entrances.length,closestDistance:r})}return this.enterableLocationsCache=e,e}}class ia{constructor(e){$(this,"game");$(this,"actionGroupState",new Map);$(this,"selectedInventoryItem",null);$(this,"selectedEquipSlot",null);$(this,"selectedBackSlot",null);$(this,"elements");this.game=e,this.elements={levelCount:document.getElementById("level-count"),xpCount:document.getElementById("xp-count"),xpNext:document.getElementById("xp-next"),tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),saturationCount:document.getElementById("saturation-count"),maxSaturation:document.getElementById("max-saturation"),weightCount:document.getElementById("weight-count"),maxWeight:document.getElementById("max-weight"),characterStatsList:document.getElementById("character-stats-list"),freePointsDisplay:document.getElementById("free-points-display"),equipmentList:document.getElementById("equipment-list"),inventoryList:document.getElementById("inventory-list"),structuresPanel:document.getElementById("structures-panel"),structuresList:document.getElementById("structures-list"),lootPanel:document.getElementById("loot-panel"),lootList:document.getElementById("loot-list"),takeAllLoot:document.getElementById("take-all-loot"),leaveLoot:document.getElementById("leave-loot"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status"),gameOverPanel:document.getElementById("game-over-panel"),restartButton:document.getElementById("restart-button"),skillsList:document.getElementById("skills-list"),locationPanel:document.getElementById("location-panel"),locationIcon:document.getElementById("location-icon"),locationName:document.getElementById("location-name"),locationDetails:document.getElementById("location-details"),exitStatus:document.getElementById("exit-status"),discoveredLocations:document.getElementById("discovered-locations"),trackingIndicator:document.getElementById("tracking-indicator"),trackingCount:document.getElementById("tracking-count"),trackingSummary:document.getElementById("tracking-summary"),copyTracking:document.getElementById("copy-tracking"),clearTracking:document.getElementById("clear-tracking"),trackingEnabled:document.getElementById("tracking-enabled"),menuButton:document.getElementById("menu-button"),menuDropdown:document.getElementById("menu-dropdown"),newGameButton:document.getElementById("new-game-button")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),this.elements.restartButton.addEventListener("click",()=>{this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.render()}),this.elements.takeAllLoot.addEventListener("click",()=>{this.game.takeAllLoot()}),this.elements.leaveLoot.addEventListener("click",()=>{this.game.leaveLoot()}),this.elements.menuButton.addEventListener("click",e=>{e.stopPropagation(),this.elements.menuDropdown.classList.toggle("hidden")}),document.addEventListener("click",()=>{this.elements.menuDropdown.classList.add("hidden")}),this.elements.newGameButton.addEventListener("click",()=>{confirm("Start a new game? All progress will be lost.")&&(this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.elements.menuDropdown.classList.add("hidden"),this.render())}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())}),document.querySelectorAll(".collapsible .section-header").forEach(e=>{e.addEventListener("click",()=>{const s=e.closest(".collapsible");if(s){const n=s.querySelector(".section-content"),i=s.classList.toggle("collapsed"),a=e.querySelector(".toggle-icon");a&&(a.textContent=i?"":""),n&&(n.style.display=i?"none":"")}})}),window.matchMedia("(max-width: 600px)").matches&&document.querySelectorAll(".collapsed-mobile").forEach(e=>{e.classList.add("collapsed");const s=e.querySelector(".section-content"),n=e.querySelector(".toggle-icon");s&&(s.style.display="none"),n&&(n.textContent="")}),this.elements.copyTracking.addEventListener("click",()=>{const e=this.game.exportTrackingData();navigator.clipboard.writeText(e).then(()=>{const s=this.elements.copyTracking,n=s.textContent;s.textContent="Copied!",setTimeout(()=>{s.textContent=n},1500)})}),this.elements.clearTracking.addEventListener("click",()=>{this.game.clearTrackingRecords(),this.renderTracking()}),this.elements.trackingEnabled.addEventListener("change",()=>{this.game.setTrackingEnabled(this.elements.trackingEnabled.checked),this.renderTracking()})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderTracking(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("level-up",()=>{this.renderStatus(),this.renderCharacterStats()}),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions(),this.renderCharacterStats()}),this.game.on("game-over",()=>{this.renderGameOver()}),this.game.on("location-entered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-exited",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-discovered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("exit-found",()=>{this.renderLocation(),this.renderActions()})}renderGameOver(){this.elements.gameOverPanel.classList.remove("hidden")}render(){this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderTracking(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player,s=e.levelInfo;this.elements.levelCount.textContent=s.level.toString(),this.elements.xpCount.textContent=s.xp.toString(),this.elements.xpNext.textContent=s.xpToNextLevel.toString(),this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString(),this.elements.saturationCount.textContent=e.saturation.toString(),this.elements.maxSaturation.textContent=e.maxSaturation.toString();const n=nt(e),i=at(e),a=i>0?"+":"";this.elements.weightCount.textContent=n.toFixed(1),this.elements.maxWeight.textContent=`${e.carryCapacity} (${a}${Math.round(i)} spd)`}renderCharacterStats(){const s=this.game.state.player.levelInfo,n=s.stats,i=s.freeStatPoints,a=this.game.state.encounter!==null;i>0?(this.elements.freePointsDisplay.textContent=`(${i} points)`,this.elements.freePointsDisplay.classList.add("has-points")):(this.elements.freePointsDisplay.textContent="",this.elements.freePointsDisplay.classList.remove("has-points"));let r="";for(const o of oe){const c=n[o],l=ce[o],d=Jt[o],m=i>0&&!a;r+=`
        <div class="stat-row">
          <span class="stat-name" title="${d}">${l}</span>
          <span class="stat-value">${c}</span>
          ${m?`<button class="allocate-btn" data-stat="${o}" title="Allocate point">+</button>`:""}
        </div>
      `}this.elements.characterStatsList.innerHTML=r,this.elements.characterStatsList.querySelectorAll(".allocate-btn").forEach(o=>{o.addEventListener("click",c=>{const l=c.target.getAttribute("data-stat");l&&this.game.allocateStat(l)})})}renderSkills(){const s=this.game.state.player.skills,n=Fe.filter(a=>{const r=s[a];return r.level>0||r.xp>0}).sort((a,r)=>s[r].lastGainedAt-s[a].lastGainedAt);if(n.length===0){this.elements.skillsList.innerHTML='<div class="no-skills">No skills yet. Fight or craft to gain skills!</div>';return}let i="";for(const a of n){const r=s[a],o=wt[a],c=Et[a],l=r.xpToNextLevel>0?Math.floor(r.xp/r.xpToNextLevel*100):100;i+=`
        <div class="skill-row" title="${c}">
          <span class="skill-name">${o}</span>
          <span class="skill-level">${r.level}</span>
          <div class="skill-xp-bar">
            <div class="skill-xp-fill" style="width: ${l}%"></div>
          </div>
          <span class="skill-xp">${r.xp}/${r.xpToNextLevel}</span>
        </div>
      `}this.elements.skillsList.innerHTML=i}renderEquipment(){const e=this.game.state.player,s=e.equipment,n=this.game.state.encounter!==null,i=it(e),a=Q(e),r=K(e),o=[];o.push(`${i.min}-${i.max} Dmg`),a>0&&o.push(`+${a} Armor`),r>0&&o.push(`+${r} Ranged`);let c="";o.length>0&&(c+=`<div class="equipment-bonuses">${o.join(" | ")}</div>`);const l=s.mainHand&&s.mainHand===s.offHand?s.mainHand:null,d=[{slot:"mainHand",label:"Main Hand"},{slot:"offHand",label:"Off Hand"}];for(const{slot:u,label:f}of d){const y=s[u];if(u==="offHand"&&l)continue;const g=y?b(y):null,C=(g==null?void 0:g.name)??"Empty",S=(g==null?void 0:g.twoHanded)?"Both Hands":f,k=this.selectedEquipSlot===u,v=k?"selected":"";let w="";if(k&&y&&!n){const N=[];if(N.push(`<button class="item-action-btn unequip-btn" data-slot="${u}">Unequip</button>`),(u==="mainHand"||u==="offHand")&&te(e,y)){const U=G(y)?"2H":"1H";N.push(`<button class="item-action-btn equip-back-slot-btn" data-item-id="${y}">Add to Back (${U})</button>`)}w=`<div class="item-expanded-actions">${N.join("")}</div>`}c+=`
        <div class="equipment-slot ${v}" data-slot="${u}">
          <div class="slot-header">
            <span class="slot-label">${S}:</span>
            <span class="slot-item">${C}</span>
          </div>
          ${w}
        </div>
      `}const m=ct(e),p=["Left Back","Mid Back","Right Back"];for(let u=0;u<3;u++){const f=m[u],y=f?b(f):null,g=(y==null?void 0:y.name)??"Empty",C=f?G(f)?"2H":"1H":"",L=this.selectedBackSlot===u,S=L?"selected":"";let k="";if(L&&f&&!n){const w=[];w.push(`<button class="item-action-btn equip-from-back-btn" data-item-id="${f}">Equip to Hands</button>`),w.push(`<button class="item-action-btn remove-back-slot-btn" data-item-id="${f}">Remove from Back</button>`),k=`<div class="item-expanded-actions">${w.join("")}</div>`}const v=f?`${g} (${C})`:"Empty";c+=`
        <div class="equipment-slot back-slot-item ${S}" data-back-index="${u}">
          <div class="slot-header">
            <span class="slot-label">${p[u]}:</span>
            <span class="slot-item">${v}</span>
          </div>
          ${k}
        </div>
      `}const h=[{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"}];for(const{slot:u,label:f}of h){const y=s[u],g=y?b(y):null,C=(g==null?void 0:g.name)??"Empty",L=this.selectedEquipSlot===u,S=L?"selected":"";let k="";if(L&&y&&!n){const v=[];v.push(`<button class="item-action-btn unequip-btn" data-slot="${u}">Unequip</button>`),k=`<div class="item-expanded-actions">${v.join("")}</div>`}c+=`
        <div class="equipment-slot ${S}" data-slot="${u}">
          <div class="slot-header">
            <span class="slot-label">${f}:</span>
            <span class="slot-item">${C}</span>
          </div>
          ${k}
        </div>
      `}this.elements.equipmentList.innerHTML=c,this.elements.equipmentList.querySelectorAll(".equipment-slot").forEach(u=>{const f=u.querySelector(".slot-header");f&&f.addEventListener("click",y=>{y.stopPropagation();const g=u.getAttribute("data-slot"),C=s[g];g&&C&&!n&&(this.selectedEquipSlot=this.selectedEquipSlot===g?null:g,this.selectedInventoryItem=null,this.selectedBackSlot=null,this.renderEquipment(),this.renderInventory())})}),this.elements.equipmentList.querySelectorAll(".back-slot-item").forEach(u=>{const f=u.querySelector(".slot-header");f&&f.addEventListener("click",y=>{y.stopPropagation();const g=parseInt(u.getAttribute("data-back-index")??"-1",10),C=m[g];g>=0&&C&&!n&&(this.selectedBackSlot=this.selectedBackSlot===g?null:g,this.selectedEquipSlot=null,this.selectedInventoryItem=null,this.renderEquipment(),this.renderInventory())})}),this.elements.equipmentList.querySelectorAll(".unequip-btn").forEach(u=>{u.addEventListener("click",f=>{f.stopPropagation();const y=f.target.getAttribute("data-slot");y&&(this.game.unequip(y),this.selectedEquipSlot=null)})}),this.elements.equipmentList.querySelectorAll(".equip-back-slot-btn").forEach(u=>{u.addEventListener("click",f=>{f.stopPropagation();const y=f.target.getAttribute("data-item-id");y&&(this.game.addToBackSlots(y,!0),this.selectedEquipSlot=null)})}),this.elements.equipmentList.querySelectorAll(".equip-from-back-btn").forEach(u=>{u.addEventListener("click",f=>{f.stopPropagation();const y=f.target.getAttribute("data-item-id");y&&(this.game.equip(y,"mainHand"),this.selectedBackSlot=null)})}),this.elements.equipmentList.querySelectorAll(".remove-back-slot-btn").forEach(u=>{u.addEventListener("click",f=>{f.stopPropagation();const y=f.target.getAttribute("data-item-id");y&&(this.game.removeFromBackSlots(y),this.selectedBackSlot=null)})})}renderInventory(){const e=this.game.state.player,s=e.inventory,n=this.game.state.encounter!==null,i=Object.entries(s).filter(([r,o])=>o>0);if(i.length===0){this.elements.inventoryList.innerHTML='<span class="inventory-empty">Empty</span>';return}const a=i.map(([r,o])=>{const c=b(r),l=(c==null?void 0:c.name)??r,d=this.selectedInventoryItem===r,m=d?"selected":"";let p="";if(d){const h=[];if(c!=null&&c.equipSlot&&!n)if(c.twoHanded)h.push(`<button class="item-action-btn equip-btn" data-item-id="${r}" data-slot="mainHand">Equip (Both Hands)</button>`);else if(c.equipSlot==="mainHand")h.push(`<button class="item-action-btn equip-btn" data-item-id="${r}" data-slot="mainHand">Equip (Main Hand)</button>`);else if(c.equipSlot==="offHand")h.push(`<button class="item-action-btn equip-btn" data-item-id="${r}" data-slot="offHand">Equip (Off Hand)</button>`);else{const u=c.equipSlot.charAt(0).toUpperCase()+c.equipSlot.slice(1);h.push(`<button class="item-action-btn equip-btn" data-item-id="${r}" data-slot="${c.equipSlot}">Equip (${u})</button>`)}if(ae(r)&&!n&&te(e,r)){const u=G(r)?"2H":"1H";h.push(`<button class="item-action-btn back-slot-btn" data-item-id="${r}">Add to Back (${u})</button>`)}h.push(`<button class="item-action-btn drop-btn" data-item-id="${r}" data-amount="1">Drop 1</button>`),o>1&&h.push(`<button class="item-action-btn drop-all-btn" data-item-id="${r}" data-amount="${o}">Drop All (${o})</button>`),p=`<div class="item-expanded-actions">${h.join("")}</div>`}return`
        <div class="inventory-item ${m}" data-item-id="${r}">
          <div class="item-header">
            <span class="item-name">${l}</span>
            <span class="item-count">${o}</span>
          </div>
          ${p}
        </div>
      `});this.elements.inventoryList.innerHTML=a.join(""),this.elements.inventoryList.querySelectorAll(".inventory-item").forEach(r=>{const o=r.querySelector(".item-header");o&&o.addEventListener("click",c=>{c.stopPropagation();const l=r.getAttribute("data-item-id");l&&(this.selectedInventoryItem=this.selectedInventoryItem===l?null:l,this.selectedEquipSlot=null,this.selectedBackSlot=null,this.renderInventory(),this.renderEquipment())})}),this.elements.inventoryList.querySelectorAll(".equip-btn").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();const c=o.target.getAttribute("data-item-id"),l=o.target.getAttribute("data-slot");c&&l&&(this.game.equip(c,l),this.selectedInventoryItem=null)})}),this.elements.inventoryList.querySelectorAll(".back-slot-btn").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();const c=o.target.getAttribute("data-item-id");c&&(this.game.addToBackSlots(c),this.selectedInventoryItem=null)})}),this.elements.inventoryList.querySelectorAll(".drop-btn, .drop-all-btn").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();const c=o.target.getAttribute("data-item-id"),l=parseInt(o.target.getAttribute("data-amount")??"1",10);c&&(this.game.dropItem(c,l),this.selectedInventoryItem=null)})})}renderStructures(){const e=this.game.state.structures;if(e.size===0){this.elements.structuresPanel.classList.add("hidden");return}this.elements.structuresPanel.classList.remove("hidden");const s={campfire:"Campfire"},n=Array.from(e).map(i=>`<span class="structure-item">${s[i]??i}</span>`);this.elements.structuresList.innerHTML=n.join("")}renderLocation(){const e=this.game.getCurrentLocation(),s=this.game.state.foundExit,n=this.game.getEnterableLocations();if(this.elements.locationName.textContent=e.name,e.id===null?this.elements.locationIcon.textContent="":e.isSafe?this.elements.locationIcon.textContent="":this.elements.locationIcon.textContent="",e.id!==null||n.length>0)if(this.elements.locationDetails.classList.remove("hidden"),e.id!==null?s?this.elements.exitStatus.innerHTML='<span class="exit-found"> Exit found</span>':this.elements.exitStatus.innerHTML='<span class="exit-searching">Searching for exit...</span>':this.elements.exitStatus.innerHTML="",n.length>0){const a=n.map(r=>{const o=r.entrances>1?` (${r.entrances})`:"";return`<span class="discovered-location"> ${r.name}${o}</span>`}).join("");this.elements.discoveredLocations.innerHTML=a}else this.elements.discoveredLocations.innerHTML="";else this.elements.locationDetails.classList.add("hidden")}renderLoot(){const e=this.game.state.pendingLoot;if(!e){this.elements.lootPanel.classList.add("hidden");return}this.elements.lootPanel.classList.remove("hidden");const s=Object.entries(e).filter(([n,i])=>i>0).map(([n,i])=>{const a=b(n),r=(a==null?void 0:a.name)??n,o=(a==null?void 0:a.weight)??0;return`
          <div class="loot-item">
            <span class="item-name">${r}: ${i} (${(o*i).toFixed(1)} wt)</span>
            <button class="take-btn" data-item-id="${n}" title="Take 1">+</button>
          </div>
        `});this.elements.lootList.innerHTML=s.join(""),this.elements.lootList.querySelectorAll(".take-btn").forEach(n=>{n.addEventListener("click",i=>{const a=i.target.getAttribute("data-item-id");a&&this.game.takeLoot(a,1)})})}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const s=e.enemy;this.elements.enemyName.textContent=s.name,this.elements.enemyHealth.textContent=s.health.toString(),this.elements.enemyMaxHealth.textContent=s.maxHealth.toString();let n="";e.enemyFleeing?n="Enemy is fleeing!":e.playerFleeing&&(n="You are fleeing!"),this.elements.encounterStatus.textContent=n}renderActions(){const e=this.elements.actionSearch.value;if(e.trim()){const s=this.game.filterActions(e);this.elements.actionsList.innerHTML=s.map(n=>this.renderActionItem(n)).join("")}else{const s=this.game.getGroupedActions();this.elements.actionsList.innerHTML=s.map((n,i)=>{const a=i===0,r=this.actionGroupState.get(n.category),o=r!==void 0?r:a;return this.renderActionGroup(n.category,n.actions,o)}).join("")}this.elements.actionsList.querySelectorAll(".action-item").forEach(s=>{const n=s.getAttribute("data-action-id");s.addEventListener("click",()=>{const i=this.game.getAvailableActions().find(a=>a.id===n);i&&this.handleActionClick(i)})}),this.elements.actionsList.querySelectorAll(".action-category-header").forEach(s=>{s.addEventListener("click",()=>{const n=s.getAttribute("data-category"),i=s.nextElementSibling,a=s.classList.toggle("collapsed");n&&this.actionGroupState.set(n,!a);const r=s.querySelector(".category-toggle");r&&(r.textContent=a?"":""),i&&(i.style.display=a?"none":"flex")})})}renderActionGroup(e,s,n=!0){const i=s.map(o=>this.renderActionItem(o)).join(""),a=n?"":"collapsed",r=n?"flex":"none";return`
      <div class="action-category">
        <div class="action-category-header ${a}" data-category="${e}">
          <span class="category-toggle">${n?"":""}</span>
          <span class="category-name">${e}</span>
          <span class="category-count">${s.length}</span>
        </div>
        <div class="action-category-content" style="display: ${r}">
          ${i}
        </div>
      </div>
    `}renderActionItem(e){const s=this.game.state.player,n=this.game.getEffectiveTickCost(e),i=s.ticks>=n,a=n>e.tickCost;let r;if(e.tickGain&&n){const c=e.tickGain-n;r=`${n} cost, +${c} net`}else e.tickGain?r=`+${e.tickGain} ticks`:r=`${n} ticks`;return`
      <div class="action-item ${i?"":"disabled"}${a?" has-distance":""}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${i?"affordable":""}">${r}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderTracking(){const e=this.game.isTrackingEnabled(),s=this.game.getTrackingSummary();if(this.elements.trackingIndicator.textContent=e?"Recording":"Paused",this.elements.trackingIndicator.className=e?"tracking-on":"tracking-off",this.elements.trackingCount.textContent=`${s.totalActions} actions`,this.elements.trackingEnabled.checked=e,s.totalActions>0){const n=(s.followRate*100).toFixed(0);this.elements.trackingSummary.innerHTML=`
        Suggestions followed: <span class="follow-rate">${n}%</span>
        (${s.suggestedFollowed}/${s.totalActions})
      `}else this.elements.trackingSummary.innerHTML="No actions recorded yet."}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(s=>`
        <div class="log-entry">
          <span class="timestamp">[${s.turn}]</span>
          ${s.message}
        </div>
      `).join("")}}const se=new aa,ra=new ia(se);ra.render();se.loadFromSave()?console.log("Game loaded from save"):se.start();window.game=se;
