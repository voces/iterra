var Ne=Object.defineProperty;var Ge=(s,e,t)=>e in s?Ne(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var x=(s,e,t)=>Ge(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const ye=["unarmed","knife","spear","archery","throwing","shield","crafting","butchering","skinning"],Ye=50,_e=1.3,je={unarmed:"Unarmed",knife:"Knife",spear:"Spear",archery:"Archery",throwing:"Throwing",shield:"Shield",crafting:"Crafting",butchering:"Butchering",skinning:"Skinning"},Fe={unarmed:"Fighting with fists. Increases unarmed damage and hit chance.",knife:"Skill with knives and daggers. Faster attacks, more crits.",spear:"Mastery of spears and polearms. Higher damage and reach.",archery:"Proficiency with bows. Better accuracy and damage at range.",throwing:"Throwing weapons accurately. Rocks, javelins, etc.",shield:"Shield blocking effectiveness. Better block chance and reduction.",crafting:"General crafting ability. Better quality items, fewer failures.",butchering:"Extracting meat from corpses. Higher yield and fewer failures.",skinning:"Extracting hides from corpses. Higher yield and fewer failures."};function Ue(s=0){return{level:s,xp:0,xpToNextLevel:ve(s+1),lastGainedAt:-1}}function We(){const s={};for(const e of ye)s[e]=Ue(0);return s}function ve(s){return Math.floor(Ye*Math.pow(s,_e))}function q(s,e,t=0){s.xp+=e,s.lastGainedAt=t;let n=0;for(;s.xp>=s.xpToNextLevel;)s.xp-=s.xpToNextLevel,s.level++,s.xpToNextLevel=ve(s.level+1),n++;return{levelsGained:n,newLevel:s.level}}function Qe(s){return s*.01}function Ke(s){return .25/(1+s/50)}function ke(s){return .3/(1+s/50)}function be(s){return s/(s+100)}function se(s){const e=s/(s+100),t=e*70,n=15-5*e,r=(Math.random()-.5)*2*n,a=Math.random()<.05?10+Math.random()*10:0,i=Math.max(0,Math.min(100,t+r+a));return Math.round(i)}const A={combatHit:10,combatMiss:3,craftSuccess:15,craftFailure:5,harvestSuccess:12,harvestFailure:4};function Ve(s){return s&&{stoneKnife:"knife",ironKnife:"knife",steelKnife:"knife",stoneSpear:"spear",ironSpear:"spear",steelSpear:"spear",bow:"archery",longbow:"archery",crossbow:"archery"}[s]||"unarmed"}const J=["vitality","strength","agility","precision","endurance","arcane","luck"],Xe=100,ze=1.5,Je=3,Ze=2;function Ce(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function et(){return{vitality:0,strength:0,agility:0,precision:0,endurance:0,arcane:0,luck:0}}function tt(s=1,e){const t=Ce();return e&&Object.assign(t,e),{level:s,xp:0,xpToNextLevel:we(s+1),freeStatPoints:0,stats:t,statUsage:et()}}function we(s){return Math.floor(Xe*Math.pow(s,ze))}function st(s,e){s.xp+=e;let t=0;const n=[];for(;s.xp>=s.xpToNextLevel;){s.xp-=s.xpToNextLevel,s.level++,s.xpToNextLevel=we(s.level+1),s.freeStatPoints+=Ze,t++;const r=nt(s,Je);n.push(...r)}return{levelsGained:t,autoStats:n}}function nt(s,e){const t=[],n=s.statUsage,r=Object.values(n).reduce((a,i)=>a+i,0);for(let a=0;a<e;a++){let i;if(r===0||Math.random()<.3)i=J[Math.floor(Math.random()*J.length)];else{let o=Math.random()*r;i="vitality";for(const[c,l]of Object.entries(n))if(o-=l,o<=0){i=c;break}}s.stats[i]++,t.push(i)}return Object.keys(s.statUsage).forEach(a=>{s.statUsage[a]=0}),t}function at(s,e){return s.freeStatPoints<=0?!1:(s.freeStatPoints--,s.stats[e]++,!0)}function I(s,e,t=1){s.statUsage[e]+=t}function Le(s){return s.vitality*5+s.endurance*2}function rt(s){const e=s.strength,t=Math.floor(s.strength*s.agility*.05);return e+t}function it(s){const e=s.precision,t=Math.floor(s.precision*s.agility*.05);return e+t}function ot(s,e,t=0){return s.precision*5+s.agility*3+e*2+t+10}function ct(s,e,t=0){return Math.max(0,s.agility*5+s.luck*2+e*2+10-t)}function lt(s,e,t=0){return t===0?0:s.strength*3+s.agility*2+e*2+t}function ut(s,e=0){return s.strength*2+e}function dt(s,e){return s===0?0:s/(s+e*.7)}function mt(s,e,t,n){const r=t+1,a=n+1,i=2*r/(r+a);return s/(s+e)*i}function ft(s){return s.agility*2}function Se(s){return s.endurance}function ht(s){return Math.min(.5,s.endurance*.01)}function gt(s){return Math.min(.3,s.luck*.015+s.precision*.005)}function pt(s){return 1.5+s.luck*.02}function ne(s){return s.luck*.05}function K(s,e,t,n={}){const{attackerWeaponAccuracy:r=0,attackerSkillLevel:a=0,defenderArmorPenalty:i=0,defenderBlockBonus:o=0,defenderShieldArmor:c=0,defenderShieldSkillLevel:l=0}=n,u=s.levelInfo.stats,d=e.levelInfo.stats,m=s.levelInfo.level,h=e.levelInfo.level,y=a,g=ot(u,m,r+y),v=1+Qe(a);let f=Math.floor(t*v);const p=gt(u),C=Math.random()<p;if(C){const B=pt(u);f=Math.floor(f*B)}if(o>0){const B=l,Re=lt(d,h,o+B),Pe=dt(Re,g);if(Math.random()<Pe){const xe=ut(d,c),Oe=Math.max(1,f-xe);return{hit:!0,dodged:!1,blocked:!0,critical:C,damage:Oe,message:C?"blocked critical":"blocked"}}}const k=ct(d,h,i),L=mt(g,k,m,h),M=Math.random();if(M>L){const B=M<L+.15;return{hit:!1,dodged:B,blocked:!1,critical:!1,damage:0,message:B?"dodged":"missed"}}return{hit:!0,dodged:!1,blocked:!1,critical:C,damage:f,message:C?"critical":"hit"}}const Z={vitality:"Vitality",strength:"Strength",agility:"Agility",precision:"Precision",endurance:"Endurance",arcane:"Arcane",luck:"Luck"},yt={vitality:"+5 Max HP per point",strength:"+1 Melee damage, +3 Block Rating, block damage reduction",agility:"+5 Dodge Rating, +3 Attack Rating, +2 Speed",precision:"+5 Attack Rating, +1 Ranged damage",endurance:"+1 Max Saturation, reduces hunger decay",arcane:"Magic capacity (future)",luck:"+2 Dodge Rating, crit chance, loot bonus"},vt=[{tier:"masterwork",minValue:90},{tier:"excellent",minValue:75},{tier:"good",minValue:50},{tier:"normal",minValue:25},{tier:"poor",minValue:10},{tier:"broken",minValue:0}],kt=10,bt={broken:"Shoddy",poor:"Poor",normal:"Normal",good:"Good",excellent:"Excellent",masterwork:"Masterwork"};function Me(s){for(const{tier:e,minValue:t}of vt)if(s>=t)return e;return"broken"}function Ct(s){return .5+s/100*1}function V(s){const e=Me(s);return bt[e]}const wt={berries:{id:"berries",name:"Berries",description:"Sweet, ripe berries. Can be eaten for sustenance.",stackable:!0,tags:["food","raw","foraged"],weight:.1,saturationGain:4},sticks:{id:"sticks",name:"Sticks",description:"Dry wooden sticks. Useful for crafting or as a makeshift weapon.",stackable:!0,tags:["material","wood","foraged","weapon"],weight:.5,equipSlot:"mainHand",minDamage:1,maxDamage:4,strengthScaling:.3,agilityScaling:.2,accuracy:0},rocks:{id:"rocks",name:"Rocks",description:"Sturdy rocks. Can be thrown or used for crafting.",stackable:!0,tags:["material","stone","foraged","throwable"],weight:2},fiber:{id:"fiber",name:"Fiber",description:"Plant fiber from tall grass. Used for crafting rope and bindings.",stackable:!0,tags:["material","foraged"],weight:.2},rawMeat:{id:"rawMeat",name:"Raw Meat",description:"Raw meat from a slain creature. Should be cooked before eating.",stackable:!0,tags:["food","raw","meat"],weight:1,saturationGain:2},cookedMeat:{id:"cookedMeat",name:"Cooked Meat",description:"Well-cooked meat. Nutritious and filling.",stackable:!0,tags:["food","cooked","meat"],weight:1,saturationGain:8},rawLeather:{id:"rawLeather",name:"Raw Leather",description:"Untreated animal hide. Must be processed at a campfire with a knife.",stackable:!0,tags:["material","loot"],weight:2},venomGland:{id:"venomGland",name:"Venom Gland",description:"A gland filled with potent venom. Handle with care.",stackable:!0,tags:["material","loot","poison"],weight:.3},leather:{id:"leather",name:"Leather",description:"Treated leather, ready for crafting armor.",stackable:!0,tags:["material","crafted"],weight:1.5},arrow:{id:"arrow",name:"Arrow",description:"A simple arrow. Requires a bow to use.",stackable:!0,tags:["ammo","crafted"],weight:.1},stoneKnife:{id:"stoneKnife",name:"Stone Knife",description:"A sharp flint knife. Good for combat and processing leather.",stackable:!1,tags:["weapon","tool","crafted"],weight:1,equipSlot:"mainHand",minDamage:3,maxDamage:8,strengthScaling:.5,agilityScaling:1,accuracy:15},stoneSpear:{id:"stoneSpear",name:"Stone Spear",description:"A spear with a stone tip. Decent reach and damage.",stackable:!1,tags:["weapon","crafted"],weight:2.5,equipSlot:"mainHand",minDamage:5,maxDamage:12,strengthScaling:1,agilityScaling:.5,accuracy:5},bow:{id:"bow",name:"Bow",description:"A wooden bow. Requires arrows. Effective against fleeing enemies.",stackable:!1,tags:["weapon","ranged","crafted"],weight:1.5,equipSlot:"mainHand",twoHanded:!0,minDamage:4,maxDamage:10,precisionScaling:1,agilityScaling:.3,rangedBonus:15,accuracy:20},woodenShield:{id:"woodenShield",name:"Wooden Shield",description:"A crude wooden shield. Block attacks to reduce damage.",stackable:!1,tags:["armor","shield","crafted"],weight:3,equipSlot:"offHand",armorBonus:5,blockBonus:25},leatherHelm:{id:"leatherHelm",name:"Leather Helm",description:"A hardened leather helmet.",stackable:!1,tags:["armor","crafted"],weight:1,equipSlot:"head",armorBonus:3,dodgePenalty:2},leatherChest:{id:"leatherChest",name:"Leather Chest",description:"A leather chestpiece offering decent protection.",stackable:!1,tags:["armor","crafted"],weight:3,equipSlot:"chest",armorBonus:6,dodgePenalty:5},leatherLegs:{id:"leatherLegs",name:"Leather Leggings",description:"Leather leg protection.",stackable:!1,tags:["armor","crafted"],weight:2,equipSlot:"legs",armorBonus:4,dodgePenalty:3},leatherBoots:{id:"leatherBoots",name:"Leather Boots",description:"Sturdy leather boots.",stackable:!1,tags:["armor","crafted"],weight:1.5,equipSlot:"feet",armorBonus:2,dodgePenalty:1},campfire:{id:"campfire",name:"Campfire",description:"A portable campfire kit. Place it to cook meat.",stackable:!1,tags:["structure","crafted"],weight:5}};function b(s){return wt[s]}function Lt(s,e){const t=b(s);if(!t)throw new Error(`Unknown item: ${s}`);const n=Ct(e),r=Me(e),i={itemId:s,quality:r==="broken"?"poor":r,qualityValue:e};return t.minDamage!==void 0&&(i.minDamage=Math.max(1,Math.floor(t.minDamage*n))),t.maxDamage!==void 0&&(i.maxDamage=Math.max(1,Math.floor(t.maxDamage*n))),t.armorBonus!==void 0&&(i.armorBonus=Math.max(1,Math.floor(t.armorBonus*n))),t.blockBonus!==void 0&&(i.blockBonus=Math.max(1,Math.floor(t.blockBonus*n))),t.accuracy!==void 0&&(i.accuracy=Math.floor(t.accuracy*n)),i}function St(s){const e=b(s);return e?e.equipSlot!==void 0||e.tags.includes("weapon")||e.tags.includes("armor")||e.tags.includes("shield"):!1}function Ee(s,e,t={}){const{maxTicks:n=1e4,speed:r=100,carryCapacity:a=30,maxHealth:i=100,damage:o=10,saturation:c=10,maxSaturation:l=20,inventory:u={},materialQualities:d={},equipment:m={},equipmentInstances:h={},actions:y=[],level:g=1,stats:v,skills:f}=t,p=tt(g,v),C=i+Le(p.stats),k=l+Se(p.stats);return{id:s,name:e,ticks:n,maxTicks:n,speed:r,carryCapacity:a,health:C,maxHealth:C,damage:o,saturation:c,maxSaturation:k,inventory:{...u},materialQualities:{...d},equipment:{...m},equipmentInstances:{...h},actions:[...y],levelInfo:p,skills:f??We()}}function ce(s,e=100,t=20){const n=s.levelInfo.stats,r=s.maxHealth;s.maxHealth=e+Le(n),s.maxSaturation=t+Se(n),s.maxHealth>r&&(s.health+=s.maxHealth-r),s.health=Math.min(s.health,s.maxHealth),s.saturation=Math.min(s.saturation,s.maxSaturation)}function ee(s,e){s.ticks=Math.min(s.ticks+e,s.maxTicks)}function Mt(s,e){return s.ticks<e?!1:(s.ticks-=e,!0)}function P(s,e){s.health=Math.max(0,s.health-e)}function Et(s,e){s.health=Math.min(s.maxHealth,s.health+e)}function H(s){return s.health>0}function At(s,e){s.saturation=Math.min(s.maxSaturation,s.saturation+e)}function le(s,e){s.saturation=Math.max(0,s.saturation-e)}const $t=10;function Bt(s){return s.saturation>$t}function It(s){return s.saturation<=0}function Ht(s){return 5}function w(s,e){return s.inventory[e]??0}function E(s,e,t){s.inventory[e]=(s.inventory[e]??0)+t}function ae(s,e,t,n){s.inventory[e]=(s.inventory[e]??0)+t,s.materialQualities[e]||(s.materialQualities[e]=[]);for(let r=0;r<t;r++)s.materialQualities[e].push(n);s.materialQualities[e].sort((r,a)=>r-a)}function _(s,e,t){const n=s.inventory[e]??0;return n<t?!1:(s.inventory[e]=n-t,s.materialQualities[e]&&(s.materialQualities[e].splice(0,t),s.materialQualities[e].length===0&&delete s.materialQualities[e]),!0)}function Tt(s,e,t){const n=s.inventory[e]??0;if(n<t)return null;s.inventory[e]=n-t;const r=[];if(s.materialQualities[e]){for(let a=0;a<t&&s.materialQualities[e].length>0;a++)r.push(s.materialQualities[e].shift());s.materialQualities[e].length===0&&delete s.materialQualities[e]}else for(let a=0;a<t;a++)r.push(50);return r}function Ae(s){let e=0;for(const[t,n]of Object.entries(s.inventory))if(n>0){const r=b(t);r&&(e+=r.weight*n)}return e}function qt(s){return Ae(s)/s.carryCapacity}function $e(s){const e=qt(s);return e<=.5?20*(1-e*2):e<=1?0:-50*(e-1)}function D(s){const e=ft(s.levelInfo.stats);return Math.max(10,s.speed+$e(s)+e)}function Dt(s,e,t){const n=b(e);return!n||!n.equipSlot||w(s,e)<=0?!1:(n.twoHanded?(U(s,"mainHand"),U(s,"offHand"),s.equipment.mainHand=e,s.equipment.offHand=e):(U(s,t),s.equipment[t]=e),_(s,e,1),!0)}function U(s,e){const t=s.equipment[e];if(!t)return!1;const n=b(t);return n!=null&&n.twoHanded&&e==="mainHand"||n!=null&&n.twoHanded&&e==="offHand"?(delete s.equipment.mainHand,delete s.equipment.offHand,E(s,t,1)):(delete s.equipment[e],E(s,t,1)),!0}function N(s){let e=0;const t=new Set;for(const[n,r]of Object.entries(s.equipment))if(r&&!t.has(r)){t.add(r);const a=s.equipmentInstances[n];if(a&&a.armorBonus!==void 0)e+=a.armorBonus;else{const i=b(r);i!=null&&i.armorBonus&&(e+=i.armorBonus)}}return e}function G(s){let e=0;const t=new Set;for(const n of Object.values(s.equipment))if(n&&!t.has(n)){t.add(n);const r=b(n);r!=null&&r.rangedBonus&&(e+=r.rangedBonus)}return e}const ue=1,de=3;function Rt(s){const e=s.equipment.mainHand;if(!e)return{min:ue,max:de};const t=s.equipmentInstances.mainHand;if(t&&t.minDamage!==void 0&&t.maxDamage!==void 0)return{min:t.minDamage,max:t.maxDamage};const n=b(e);return(n==null?void 0:n.minDamage)!==void 0&&(n==null?void 0:n.maxDamage)!==void 0?{min:n.minDamage,max:n.maxDamage}:{min:ue,max:de}}function Pt(s){const e=s.equipment.mainHand,t=s.levelInfo.stats;if(!e)return Math.floor(t.strength*.5+t.agility*.3);const n=b(e);if(!n)return Math.floor(t.strength*.5+t.agility*.3);let r=0;return n.strengthScaling&&(r+=t.strength*n.strengthScaling),n.agilityScaling&&(r+=t.agility*n.agilityScaling),n.precisionScaling&&(r+=t.precision*n.precisionScaling),Math.floor(r)}function Be(s){const e=Rt(s),t=Pt(s);return{min:e.min+t,max:e.max+t}}function Ie(s){const e=Be(s);return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function Y(s,e){const t=e/(e+20);return Math.max(1,Math.floor(s*(1-t)))}function re(s){const e=s.equipment.mainHand;if(!e)return 0;const t=s.equipmentInstances.mainHand;if(t&&t.accuracy!==void 0)return t.accuracy;const n=b(e);return(n==null?void 0:n.accuracy)??0}function X(s){let e=0;const t=new Set;for(const n of Object.values(s.equipment))if(n&&!t.has(n)){t.add(n);const r=b(n);r!=null&&r.dodgePenalty&&(e+=r.dodgePenalty)}return e}function xt(s){const e=s.equipment.offHand;if(!e)return 0;const t=s.equipmentInstances.offHand;if(t&&t.blockBonus!==void 0)return t.blockBonus;const n=b(e);return(n==null?void 0:n.blockBonus)??0}function Ot(s){const e=s.equipment.offHand;if(!e)return 0;const t=s.equipmentInstances.offHand;if(t&&t.armorBonus!==void 0)return t.armorBonus;const n=b(e);return n!=null&&n.blockBonus?n.armorBonus??0:0}const He={cave:{id:"cave",name:"Dark Cave",description:"A dark cave entrance yawns before you.",discoveryChance:.08,discoveryMessage:"You discover the entrance to a dark cave!",exitDiscoveryChance:.15,availableEnemies:["wolf","snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["cavern"]},forest:{id:"forest",name:"Dense Forest",description:"A dense forest with towering trees.",discoveryChance:.1,discoveryMessage:"You find a path leading into a dense forest!",exitDiscoveryChance:.12,availableEnemies:["rabbit","deer","wolf","boar"],availableResources:["berryBush","fallenBranches","tallGrass"],childLocations:["clearing"]},ruins:{id:"ruins",name:"Ancient Ruins",description:"Crumbling stone structures from a forgotten age.",discoveryChance:.05,discoveryMessage:"You stumble upon ancient ruins hidden in the landscape!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],childLocations:["ruinsCrypt"]},village:{id:"village",name:"Abandoned Village",description:"An eerily quiet abandoned village.",discoveryChance:.04,discoveryMessage:"You discover an abandoned village!",exitDiscoveryChance:.2,availableEnemies:["bandit"],availableResources:["fallenBranches"],childLocations:["villageWell"],isSafe:!1},cavern:{id:"cavern",name:"Deep Cavern",description:"A vast underground cavern with dripping stalactites.",discoveryChance:.1,discoveryMessage:"You find a passage leading deeper into the cavern!",exitDiscoveryChance:.12,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"cave"},clearing:{id:"clearing",name:"Forest Clearing",description:"A peaceful clearing in the forest.",discoveryChance:.12,discoveryMessage:"You emerge into a sunlit clearing!",exitDiscoveryChance:.25,availableEnemies:["rabbit","deer"],availableResources:["berryBush","tallGrass"],parentId:"forest",isSafe:!0},ruinsCrypt:{id:"ruinsCrypt",name:"Ancient Crypt",description:"A dusty crypt beneath the ruins.",discoveryChance:.08,discoveryMessage:"You find stairs descending into a crypt!",exitDiscoveryChance:.1,availableEnemies:["snake","bandit"],availableResources:["rockyOutcrop"],parentId:"ruins"},villageWell:{id:"villageWell",name:"Village Well",description:"An old well in the village center.",discoveryChance:.15,discoveryMessage:"You notice an old well in the village!",exitDiscoveryChance:.3,availableEnemies:["snake"],availableResources:["rockyOutcrop"],parentId:"village"}};function S(s){return He[s]}function Nt(){return Object.values(He)}function Gt(s){if(s===null)return Nt().filter(t=>!t.parentId);const e=S(s);return!e||!e.childLocations?[]:e.childLocations.map(t=>S(t)).filter(t=>t!==void 0)}function Yt(s){const e=Gt(s);for(const t of e)if(Math.random()<t.discoveryChance)return t;return null}function _t(s){if(s===null)return!1;const e=S(s);return e?Math.random()<e.exitDiscoveryChance:!1}const Te={berryBush:{id:"berryBush",name:"Berry Bush",description:"A bush laden with ripe berries.",gatherActionId:"gather-berries",discoveryChance:.2,discoveryMessage:"You stumble upon a bush laden with ripe berries!",depletionChance:.6,dropOffChance:.15},fallenBranches:{id:"fallenBranches",name:"Fallen Branches",description:"Some fallen branches on the ground.",gatherActionId:"gather-sticks",discoveryChance:.2,discoveryMessage:"You find some fallen branches on the ground.",depletionChance:.5,dropOffChance:.1},rockyOutcrop:{id:"rockyOutcrop",name:"Rocky Outcrop",description:"Some useful rocks jutting from the ground.",gatherActionId:"gather-rocks",discoveryChance:.15,discoveryMessage:"You notice some useful rocks nearby.",depletionChance:.4,dropOffChance:.05},tallGrass:{id:"tallGrass",name:"Tall Grass",description:"A patch of tall grass with useful fibers.",gatherActionId:"gather-fiber",discoveryChance:.2,discoveryMessage:"You find a patch of tall grass.",depletionChance:.5,dropOffChance:.12}};function te(s){return Te[s]}function me(){return Object.values(Te)}function jt(s){if(s===null)return me();const e=S(s);return!e||!e.availableResources||e.availableResources.length===0?me():e.availableResources.map(t=>te(t)).filter(t=>t!==void 0)}function Ft(s=null){const e=jt(s);let t=0;const n=Math.random();for(const r of e)if(t+=r.discoveryChance,n<t)return r;return null}const Ut={campfire:{id:"campfire",name:"Craft Campfire",description:"Craft a portable campfire using sticks and rocks.",inputs:{sticks:5,rocks:3},outputs:{campfire:1},tickCost:400},cookedMeat:{id:"cookedMeat",name:"Cook Meat",description:"Cook raw meat on the campfire.",inputs:{rawMeat:1},outputs:{cookedMeat:1},tickCost:200,requiresCampfire:!0},leather:{id:"leather",name:"Process Leather",description:"Process raw leather at the campfire. Requires a knife.",inputs:{rawLeather:2},outputs:{leather:1},tickCost:300,requiresCampfire:!0},stoneKnife:{id:"stoneKnife",name:"Craft Stone Knife",description:"Craft a stone knife from rocks and sticks.",inputs:{rocks:2,sticks:1},outputs:{stoneKnife:1},tickCost:250},stoneSpear:{id:"stoneSpear",name:"Craft Stone Spear",description:"Craft a stone spear from rocks, sticks, and fiber.",inputs:{rocks:1,sticks:3,fiber:2},outputs:{stoneSpear:1},tickCost:300},bow:{id:"bow",name:"Craft Bow",description:"Craft a bow from sticks and fiber.",inputs:{sticks:3,fiber:5},outputs:{bow:1},tickCost:400},arrow:{id:"arrow",name:"Craft Arrows",description:"Craft arrows from sticks and rocks.",inputs:{sticks:2,rocks:1},outputs:{arrow:5},tickCost:150},woodenShield:{id:"woodenShield",name:"Craft Wooden Shield",description:"Craft a wooden shield from sticks and fiber.",inputs:{sticks:6,fiber:3},outputs:{woodenShield:1},tickCost:350},leatherHelm:{id:"leatherHelm",name:"Craft Leather Helm",description:"Craft a leather helmet.",inputs:{leather:2},outputs:{leatherHelm:1},tickCost:200},leatherChest:{id:"leatherChest",name:"Craft Leather Chest",description:"Craft a leather chestpiece.",inputs:{leather:4},outputs:{leatherChest:1},tickCost:300},leatherLegs:{id:"leatherLegs",name:"Craft Leather Leggings",description:"Craft leather leggings.",inputs:{leather:3},outputs:{leatherLegs:1},tickCost:250},leatherBoots:{id:"leatherBoots",name:"Craft Leather Boots",description:"Craft leather boots.",inputs:{leather:2},outputs:{leatherBoots:1},tickCost:200}};function $(s){return Ut[s]}function j(s,e,t){if(s.requiresCampfire&&!t.has("campfire"))return{canCraft:!1,reason:"Requires a placed campfire."};for(const[n,r]of Object.entries(s.inputs)){const a=e[n]??0;if(a<r)return{canCraft:!1,reason:`Need ${r} ${n}, have ${a}.`}}return{canCraft:!0}}function z(s,e){for(const[t,n]of Object.entries(s.inputs))e[t]=(e[t]??0)-n;for(const[t,n]of Object.entries(s.outputs))e[t]=(e[t]??0)+n}function R(s,e,t,n,r=0){const{canCraft:a,reason:i}=j(s,t,n);if(!a)return{success:!1,failed:!1,broken:!1,message:i};const o=e.skills.crafting,c=o.level,l=[];for(const[k,L]of Object.entries(s.inputs)){const M=Tt(e,k,L);M&&l.push(...M),t[k]=e.inventory[k]??0}const u=l.length>0?l.reduce((k,L)=>k+L,0)/l.length:50,d=l.length>0?Math.min(...l):50,m=d<kt,h=m?A.craftFailure:A.craftSuccess,y=q(o,h,r);if(m)return{success:!1,failed:!0,broken:!0,message:`Crafting failed! ${V(d)} quality materials broke apart. (+${h} crafting XP)`,skillGain:y};const g=Ke(c);if(Math.random()<g)return{success:!1,failed:!0,broken:!1,message:`Crafting failed! Materials were lost. (+${h} crafting XP)`,skillGain:y};const f=se(c),p=Math.round(f*.6+u*.4),C=[];for(const[k,L]of Object.entries(s.outputs)){for(let M=0;M<L;M++)if(St(k)){const B=Lt(k,p);C.push({itemId:k,quality:B.quality,qualityValue:p,instance:B})}else ae(e,k,1,p),C.push({itemId:k,quality:"normal",qualityValue:p});t[k]=(t[k]??0)+L}return{success:!0,failed:!1,broken:!1,message:Wt(C,h,p),craftedItems:C,skillGain:y}}function Wt(s,e,t){if(!s||s.length===0)return"Crafted successfully!";const n=new Map;for(const o of s)n.set(o.itemId,(n.get(o.itemId)??0)+1);const r=Array.from(n.entries()).map(([o,c])=>c>1?`${c}x ${o}`:o).join(", "),a=V(t);let i="";return a!=="Normal"&&(i=` (${a} quality!)`),`Crafted ${r}${i} (+${e} crafting XP)`}const T=[{id:"rabbit",name:"Rabbit",maxHealth:15,damage:2,speed:150,fleeThreshold:.9,aggressiveness:.05,loot:{rawMeat:{min:1,max:1,chance:1}},statGrowth:{vitality:.5,strength:.2,agility:3,precision:.5,baseLevel:1,xpReward:8}},{id:"deer",name:"Deer",maxHealth:35,damage:6,speed:130,fleeThreshold:.8,aggressiveness:.1,loot:{rawMeat:{min:2,max:3,chance:1},rawLeather:{min:1,max:2,chance:.9}},statGrowth:{vitality:1,strength:.5,agility:2,precision:.5,baseLevel:1,xpReward:15}},{id:"wolf",name:"Wolf",maxHealth:50,damage:10,speed:120,fleeThreshold:.3,aggressiveness:.6,loot:{rawMeat:{min:1,max:2,chance:.9},rawLeather:{min:1,max:2,chance:.7}},statGrowth:{vitality:1.5,strength:1,agility:1.5,precision:1,baseLevel:1,xpReward:25}},{id:"boar",name:"Wild Boar",maxHealth:80,damage:15,speed:90,fleeThreshold:.2,aggressiveness:.8,loot:{rawMeat:{min:2,max:4,chance:1},rawLeather:{min:1,max:3,chance:.8}},statGrowth:{vitality:3,strength:2,agility:.5,precision:1,baseLevel:2,xpReward:35}},{id:"snake",name:"Venomous Snake",maxHealth:30,damage:20,speed:140,fleeThreshold:.5,aggressiveness:.4,loot:{rawMeat:{min:1,max:1,chance:.5},venomGland:{min:1,max:2,chance:.8}},statGrowth:{vitality:.5,strength:2.5,agility:3,precision:2,baseLevel:1,xpReward:30}},{id:"bandit",name:"Bandit",maxHealth:70,damage:14,speed:100,fleeThreshold:.25,aggressiveness:.5,loot:{},usesInventory:!0,statGrowth:{vitality:1.5,strength:1.5,agility:1.5,precision:1.5,baseLevel:2,xpReward:40}}];function Qt(){const s={};return Math.random()<.5&&(s.berries=Math.floor(Math.random()*4)+1),Math.random()<.6&&(s.sticks=Math.floor(Math.random()*3)+1),Math.random()<.4&&(s.rocks=Math.floor(Math.random()*2)+1),Math.random()<.3&&(s.rawMeat=Math.floor(Math.random()*2)+1),Math.random()<.2&&(s.cookedMeat=1),s}function Kt(s,e){const{baseLevel:t}=s.statGrowth,n=Math.floor((e-1)*.4),r=Math.floor(Math.random()*3)-1;return Math.max(1,t+n+r)}function Vt(s,e){const{statGrowth:t}=s,n=Ce(),r=()=>.8+Math.random()*.4,a=Math.max(0,e-1);return n.vitality=Math.floor(t.vitality*a*r()),n.strength=Math.floor(t.strength*a*r()),n.agility=Math.floor(t.agility*a*r()),n.precision=Math.floor(t.precision*a*r()),n.endurance=0,n.arcane=0,n.luck=Math.floor(Math.random()*2),n}function Xt(s,e=1){const t=s.usesInventory?Qt():{},n=Kt(s,e),r=Vt(s,n),a=1+(n-1)*.1,i=Math.floor(s.maxHealth*a),o=Math.floor(s.damage*a);return Ee(s.id,s.name,{maxHealth:i,damage:o,speed:s.speed,maxTicks:5e3,inventory:t,actions:[],level:n,stats:r})}function zt(s,e=0){const t=F(s);if(!t)return{};if(t.usesInventory)return{...s.inventory};const n={};for(const[r,a]of Object.entries(t.loot))if(Math.random()<a.chance){const i=Math.floor(Math.random()*(a.max-a.min+1))+a.min,o=Math.floor(i*e);n[r]=i+o}return n}const qe=["rawMeat","venomGland"],De=["rawLeather"];function W(s){const e=T.find(t=>t.id===s);return!e||e.usesInventory?!1:Object.keys(e.loot).some(t=>qe.includes(t))}function Q(s){const e=T.find(t=>t.id===s);return!e||e.usesInventory?!1:Object.keys(e.loot).some(t=>De.includes(t))}function Jt(s,e=0,t=0){const n=T.find(a=>a.id===s);if(!n||n.usesInventory)return{};const r={};for(const[a,i]of Object.entries(n.loot))if(qe.includes(a)&&Math.random()<i.chance){const o=Math.floor(Math.random()*(i.max-i.min+1))+i.min,c=Math.floor(o*e),l=Math.floor(o*t);r[a]=o+c+l}return r}function Zt(s,e=0,t=0){const n=T.find(a=>a.id===s);if(!n||n.usesInventory)return{};const r={};for(const[a,i]of Object.entries(n.loot))if(De.includes(a)&&Math.random()<i.chance){const o=Math.floor(Math.random()*(i.max-i.min+1))+i.min,c=Math.floor(o*e),l=Math.floor(o*t);r[a]=o+c+l}return r}function es(s){if(s===null)return T;const e=S(s);return!e||!e.availableEnemies||e.availableEnemies.length===0?T:e.availableEnemies.map(t=>T.find(n=>n.id===t)).filter(t=>t!==void 0)}function ts(s=1,e=null){const t=es(e);let n;if(s<=2){const a=t.filter(o=>o.id==="rabbit"||o.id==="deer"),i=t.filter(o=>o.id!=="rabbit"&&o.id!=="deer"&&o.statGrowth.baseLevel<=s);Math.random()<.5&&a.length>0?n=a:i.length>0?n=i:n=a.length>0?a:t}else n=t.filter(a=>a.statGrowth.baseLevel<=s),n.length===0&&(n=t);n.length===0&&(n=T);const r=n[Math.floor(Math.random()*n.length)];return Xt(r,s)}function ss(s,e){const t=F(s);if(!t)return 10;const n=t.statGrowth.xpReward,r=s.levelInfo.level,a=r-e;let i=1;return a>0?i=1+a*.1:a<0&&(i=Math.max(.1,1+a*.15)),Math.floor(n*r*i)}function F(s){return T.find(e=>e.id===s.id)}const ns={id:"idle",name:"Idle",description:"Rest and recover ticks.",tickCost:100,tickGain:200,tags:["basic","recovery"],execute:(s,e)=>({success:!0,message:"You rest, recovering some energy."})},as={id:"wander",name:"Wander",description:"Wander aimlessly, perhaps discovering something.",tickCost:300,tags:["basic","exploration","movement","non-combat"],execute:(s,e)=>{var o,c,l;if((o=e==null?void 0:e.game)!=null&&o.structures.has("campfire"))return{success:!1,message:"You can't wander off with a campfire burning! Pick it up or smother it first."};const t=((c=e==null?void 0:e.game)==null?void 0:c.currentLocation)??null;if(t!==null&&!((l=e==null?void 0:e.game)!=null&&l.foundExit)&&_t(t)){const d=S(t);return{success:!0,message:`You find a way out of ${(d==null?void 0:d.name)??"this location"}!`,foundExit:!0}}const n=Yt(t);if(n)return{success:!0,message:n.discoveryMessage,foundLocation:n.id};const r=Ft(t);if(r)return{success:!0,message:r.discoveryMessage,foundResource:r.id};const a=["You wander through familiar paths.","You explore a quiet corner.","You meander without purpose, but feel refreshed.","Your wandering reveals nothing new, but clears your mind."];return{success:!0,message:a[Math.floor(Math.random()*a.length)]}}},rs={id:"gather-berries",name:"Gather Berries",description:"Pick berries from the bush.",tickCost:150,tags:["gathering","non-combat"],execute:(s,e)=>{const t=2+Math.floor(Math.random()*3);return E(s,"berries",t),{success:!0,message:`You gather ${t} berries. (${w(s,"berries")} total)`}}},is={id:"gather-sticks",name:"Gather Sticks",description:"Collect sticks from the ground.",tickCost:100,tags:["gathering","non-combat"],execute:(s,e)=>{const t=2+Math.floor(Math.random()*3);return E(s,"sticks",t),{success:!0,message:`You gather ${t} sticks. (${w(s,"sticks")} total)`}}},os={id:"gather-rocks",name:"Gather Rocks",description:"Collect rocks from the ground.",tickCost:120,tags:["gathering","non-combat"],execute:(s,e)=>{const t=1+Math.floor(Math.random()*2);return E(s,"rocks",t),{success:!0,message:`You gather ${t} rocks. (${w(s,"rocks")} total)`}}},cs={id:"gather-fiber",name:"Gather Fiber",description:"Collect fiber from tall grass.",tickCost:100,tags:["gathering","non-combat"],execute:(s,e)=>{const t=3+Math.floor(Math.random()*3);return E(s,"fiber",t),{success:!0,message:`You gather ${t} fiber. (${w(s,"fiber")} total)`}}},ls={id:"craft-campfire",name:"Craft Campfire",description:"Craft a portable campfire. (5 sticks, 3 rocks)",tickCost:400,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=$("campfire"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:a}=j(t,s.inventory,n);return r?(z(t,s.inventory),{success:!0,message:"You craft a campfire. Place it to cook meat!"}):{success:!1,message:a}}},us={id:"place-campfire",name:"Place Campfire",description:"Place your campfire on the ground.",tickCost:50,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return w(s,"campfire")<=0?{success:!1,message:"You have no campfire to place."}:(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?{success:!1,message:"A campfire is already placed."}:(_(s,"campfire",1),e!=null&&e.game&&e.game.structures.add("campfire"),{success:!0,message:"You place the campfire. You can now cook meat!"})}},ds={id:"pickup-campfire",name:"Pick Up Campfire",description:"Pick up your placed campfire.",tickCost:50,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?(e.game.structures.delete("campfire"),E(s,"campfire",1),{success:!0,message:"You pick up the campfire."}):{success:!1,message:"No campfire is placed."}}},ms={id:"smother-campfire",name:"Smother Campfire",description:"Extinguish and discard your placed campfire.",tickCost:25,tags:["crafting","non-combat"],execute:(s,e)=>{var t;return(t=e==null?void 0:e.game)!=null&&t.structures.has("campfire")?(e.game.structures.delete("campfire"),{success:!0,message:"You smother the campfire. It is destroyed."}):{success:!1,message:"No campfire is placed."}}},fs={id:"cook-meat",name:"Cook Meat",description:"Cook raw meat on the campfire.",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=$("cookedMeat"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:a}=j(t,s.inventory,n);return r?(z(t,s.inventory),{success:!0,message:`You cook the meat. (${w(s,"cookedMeat")} cooked meat)`}):{success:!1,message:a}}},hs={id:"craft-stone-knife",name:"Craft Stone Knife",description:"Craft a stone knife. (2 rocks, 1 stick)",tickCost:250,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("stoneKnife"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A fast weapon that scales with agility!"}}},gs={id:"craft-stone-spear",name:"Craft Stone Spear",description:"Craft a stone spear. (1 rock, 3 sticks, 2 fiber)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("stoneSpear"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" A powerful weapon that scales with strength!"}}},ps={id:"craft-bow",name:"Craft Bow",description:"Craft a bow. (3 sticks, 5 fiber)",tickCost:400,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("bow"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it and craft arrows to shoot!"}}},ys={id:"craft-arrows",name:"Craft Arrows",description:"Craft 5 arrows. (2 sticks, 1 rock)",tickCost:150,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=$("arrow"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:a}=j(t,s.inventory,n);return r?(z(t,s.inventory),{success:!0,message:`You craft 5 arrows. (${w(s,"arrow")} total)`}):{success:!1,message:a}}},vs={id:"craft-wooden-shield",name:"Craft Wooden Shield",description:"Craft a wooden shield. (6 sticks, 3 fiber)",tickCost:350,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("woodenShield"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message+" Equip it for blocking!"}}},ks={id:"process-leather",name:"Process Leather",description:"Process raw leather at campfire. (2 raw leather)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var i;const t=$("leather"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,{canCraft:r,reason:a}=j(t,s.inventory,n);return r?(z(t,s.inventory),{success:!0,message:`You process the leather. (${w(s,"leather")} leather)`}):{success:!1,message:a}}},bs={id:"craft-leather-helm",name:"Craft Leather Helm",description:"Craft a leather helmet. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("leatherHelm"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},Cs={id:"craft-leather-chest",name:"Craft Leather Chest",description:"Craft a leather chestpiece. (4 leather)",tickCost:300,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("leatherChest"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},ws={id:"craft-leather-legs",name:"Craft Leather Leggings",description:"Craft leather leggings. (3 leather)",tickCost:250,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("leatherLegs"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},Ls={id:"craft-leather-boots",name:"Craft Leather Boots",description:"Craft leather boots. (2 leather)",tickCost:200,tags:["crafting","non-combat"],execute:(s,e)=>{var i,o;const t=$("leatherBoots"),n=((i=e==null?void 0:e.game)==null?void 0:i.structures)??new Set,r=((o=e==null?void 0:e.game)==null?void 0:o.turn)??0,a=R(t,s,s.inventory,n,r);return!a.success&&!a.failed?{success:!1,message:a.message}:a.failed?{success:!0,message:a.message}:{success:!0,message:a.message}}},Ss={id:"butcher",name:"Butcher",description:"Extract meat from a corpse. Skill affects success and yield.",tickCost:200,tags:["harvesting","non-combat"],execute:(s,e)=>{var g;const t=(g=e==null?void 0:e.game)==null?void 0:g.pendingCorpse;if(!t)return{success:!1,message:"No corpse to butcher."};if(t.butchered)return{success:!1,message:`The ${t.enemyName} has already been butchered.`};if(!W(t.enemyId))return{success:!1,message:`The ${t.enemyName} has nothing to butcher.`};const n=s.skills.butchering,r=ke(n.level);if(Math.random()<r){const f=q(n,A.harvestFailure).levelsGained>0?" Butchering leveled up!":"";return t.butchered=!0,{success:!0,message:`You fail to properly butcher the ${t.enemyName}, ruining the meat.${f}`}}const a=be(n.level),i=ne(s.levelInfo.stats),o=Jt(t.enemyId,a,i),c=se(n.level),l=V(c);for(const[v,f]of Object.entries(o))ae(s,v,f,c);t.butchered=!0;const d=q(n,A.harvestSuccess).levelsGained>0?" Butchering leveled up!":"",m=Object.entries(o).map(([v,f])=>{const p=b(v);return`${f} ${(p==null?void 0:p.name)??v}`}),h=m.length>0?m.join(", "):"nothing",y=l!=="Normal"?` (${l} quality)`:"";return{success:!0,message:`You butcher the ${t.enemyName} and obtain ${h}${y}.${d}`}}},Ms={id:"skin",name:"Skin",description:"Extract hides from a corpse. Skill affects success and yield.",tickCost:200,tags:["harvesting","non-combat"],execute:(s,e)=>{var g;const t=(g=e==null?void 0:e.game)==null?void 0:g.pendingCorpse;if(!t)return{success:!1,message:"No corpse to skin."};if(t.skinned)return{success:!1,message:`The ${t.enemyName} has already been skinned.`};if(!Q(t.enemyId))return{success:!1,message:`The ${t.enemyName} has nothing to skin.`};const n=s.skills.skinning,r=ke(n.level);if(Math.random()<r){const f=q(n,A.harvestFailure).levelsGained>0?" Skinning leveled up!":"";return t.skinned=!0,{success:!0,message:`You fail to properly skin the ${t.enemyName}, ruining the hide.${f}`}}const a=be(n.level),i=ne(s.levelInfo.stats),o=Zt(t.enemyId,a,i),c=se(n.level),l=V(c);for(const[v,f]of Object.entries(o))ae(s,v,f,c);t.skinned=!0;const d=q(n,A.harvestSuccess).levelsGained>0?" Skinning leveled up!":"",m=Object.entries(o).map(([v,f])=>{const p=b(v);return`${f} ${(p==null?void 0:p.name)??v}`}),h=m.length>0?m.join(", "):"nothing",y=l!=="Normal"?` (${l} quality)`:"";return{success:!0,message:`You skin the ${t.enemyName} and obtain ${h}${y}.${d}`}}},Es={id:"leave-corpse",name:"Leave Corpse",description:"Leave the corpse behind without harvesting.",tickCost:25,tags:["harvesting","non-combat"],execute:(s,e)=>{var n;const t=(n=e==null?void 0:e.game)==null?void 0:n.pendingCorpse;return t?{success:!0,message:`You leave the ${t.enemyName}'s corpse behind.`}:{success:!1,message:"No corpse to leave."}}};function ie(s,e,t,n){var a;const r=b(s);return{id:e,name:t,description:`Eat ${((a=r==null?void 0:r.name)==null?void 0:a.toLowerCase())??s} to restore saturation.`,tickCost:n,tags:["consumption","non-combat"],execute:(i,o)=>{var u,d;if(w(i,s)<=0)return{success:!1,message:`You have no ${((u=r==null?void 0:r.name)==null?void 0:u.toLowerCase())??s} to eat.`};_(i,s,1);const l=(r==null?void 0:r.saturationGain)??1;return At(i,l),{success:!0,message:`You eat the ${((d=r==null?void 0:r.name)==null?void 0:d.toLowerCase())??s}. (+${l} saturation, ${i.saturation}/${i.maxSaturation})`}}}}const As=ie("berries","eat-berries","Eat Berries",50),$s=ie("cookedMeat","eat-cooked-meat","Eat Cooked Meat",75),Bs=ie("rawMeat","eat-raw-meat","Eat Raw Meat",50),Is={id:"attack",name:"Attack",description:"Strike your enemy with equipped weapon.",tickCost:200,tags:["combat","offensive"],execute:(s,e)=>{var p,C,k;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to attack."};const t=e.encounter.enemy;I(s.levelInfo,"strength",1),I(s.levelInfo,"precision",.5);const n=s.equipment.mainHand,r=Ve(n),a=Ie(s),i=re(s),o=X(t),c=s.skills[r].level,l=((C=(p=t.skills)==null?void 0:p.shield)==null?void 0:C.level)??0,u=K(s,t,a,{attackerWeaponAccuracy:i,attackerSkillLevel:c,defenderArmorPenalty:o,defenderShieldSkillLevel:l}),d=u.hit?A.combatHit:A.combatMiss,m=((k=e==null?void 0:e.game)==null?void 0:k.turn)??0,h=q(s.skills[r],d,m);if(!u.hit)return{success:!0,message:u.dodged?`The ${t.name} dodges your attack!`:`You swing at the ${t.name} but miss!`};const y=N(t),g=Y(u.damage,y);P(t,g),u.critical&&I(s.levelInfo,"luck",1);const v=u.critical?" Critical hit!":"",f=h.levelsGained>0?` ${r} leveled up!`:"";return H(t)?{success:!0,message:`You strike the ${t.name} for ${g} damage.${v}${f} (${t.health}/${t.maxHealth} HP)`}:{success:!0,message:`You strike the ${t.name} for ${g} damage.${v}${f} Defeated!`,encounterEnded:!0}}},Hs={id:"throw-rock",name:"Throw Rock",description:"Throw a rock at your enemy. Ranged attack.",tickCost:150,tags:["combat","offensive","ranged"],execute:(s,e)=>{var k,L,M;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to throw at."};if(w(s,"rocks")<=0)return{success:!1,message:"You have no rocks to throw."};_(s,"rocks",1);const t=e.encounter.enemy;I(s.levelInfo,"precision",1),I(s.levelInfo,"agility",.3);const n=5,r=10,a=it(s.levelInfo.stats);let i=n+a+Math.floor(Math.random()*(r-n+1));const o=G(s),c=e.encounter.enemyFleeing?Math.floor(o/2):0;i+=c;const l=X(t),u=s.skills.throwing.level,d=((L=(k=t.skills)==null?void 0:k.shield)==null?void 0:L.level)??0,m=K(s,t,i,{attackerWeaponAccuracy:5,attackerSkillLevel:u,defenderArmorPenalty:l,defenderShieldSkillLevel:d}),h=m.hit?A.combatHit:A.combatMiss,y=((M=e==null?void 0:e.game)==null?void 0:M.turn)??0,g=q(s.skills.throwing,h,y);if(!m.hit)return{success:!0,message:m.dodged?`The ${t.name} dodges your thrown rock!`:`You throw a rock at the ${t.name} but miss!`,projectileUsed:{type:"rock",outcome:m.dodged?"dodged":"missed"}};m.critical&&I(s.levelInfo,"luck",1);const v=N(t),f=Y(m.damage,v);P(t,f);const p=m.critical?" Critical hit!":"",C=g.levelsGained>0?" Throwing leveled up!":"";return H(t)?{success:!0,message:`Your rock hits the ${t.name} for ${f} damage.${p}${C} (${t.health}/${t.maxHealth} HP)`,projectileUsed:{type:"rock",outcome:"hit"}}:{success:!0,message:`Your rock strikes the ${t.name} for ${f} damage.${p}${C} Defeated!`,encounterEnded:!0,projectileUsed:{type:"rock",outcome:"hit"}}}},Ts={id:"ranged-attack",name:"Shoot Arrow",description:"Fire an arrow at your enemy. Very effective against fleeing targets.",tickCost:180,tags:["combat","offensive","ranged"],execute:(s,e)=>{var C,k,L;if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to shoot."};if(s.equipment.mainHand!=="bow")return{success:!1,message:"You need a bow equipped."};if(w(s,"arrow")<=0)return{success:!1,message:"You have no arrows."};_(s,"arrow",1);const n=e.encounter.enemy;I(s.levelInfo,"precision",1.5),I(s.levelInfo,"agility",.5);let r=Ie(s);const a=G(s),i=e.encounter.enemyFleeing?a:0;r+=i;const o=re(s),c=X(n),l=s.skills.archery.level,u=((k=(C=n.skills)==null?void 0:C.shield)==null?void 0:k.level)??0,d=K(s,n,r,{attackerWeaponAccuracy:o,attackerSkillLevel:l,defenderArmorPenalty:c,defenderShieldSkillLevel:u}),m=d.hit?A.combatHit:A.combatMiss,h=((L=e==null?void 0:e.game)==null?void 0:L.turn)??0,y=q(s.skills.archery,m,h);if(!d.hit)return{success:!0,message:d.dodged?`The ${n.name} narrowly dodges your arrow!`:`Your arrow flies past the ${n.name}!`,projectileUsed:{type:"arrow",outcome:d.dodged?"dodged":"missed"}};d.critical&&I(s.levelInfo,"luck",1);const g=N(n),v=Y(d.damage,g);P(n,v);const f=d.critical?" Critical hit!":"",p=y.levelsGained>0?" Archery leveled up!":"";if(!H(n)){const M=e.encounter.enemyFleeing?" as it flees":"";return{success:!0,message:`Your arrow strikes the ${n.name}${M} for ${v} damage.${f}${p} Defeated!`,encounterEnded:!0,projectileUsed:{type:"arrow",outcome:"hit"}}}return{success:!0,message:`Your arrow hits the ${n.name} for ${v} damage.${f}${p} (${n.health}/${n.maxHealth} HP)`,projectileUsed:{type:"arrow",outcome:"hit"}}}},qs={id:"flee",name:"Flee",description:"Attempt to escape from combat.",tickCost:150,tags:["combat","defensive"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to flee from."};const t=e.encounter.enemy,n=D(s),r=D(t),a=n/r,o=Math.min(.9,.4*a);return Math.random()<o?{success:!0,message:`You turn and run from the ${t.name}!`,fled:!0}:{success:!0,message:`You try to flee but the ${t.name} blocks your escape!`,fled:!1}}},Ds={id:"chase",name:"Chase",description:"Pursue a fleeing enemy.",tickCost:250,tags:["combat","offensive"],execute:(s,e)=>{if(!(e!=null&&e.encounter))return{success:!1,message:"Nothing to chase."};if(!e.encounter.enemyFleeing)return{success:!1,message:"The enemy is not fleeing."};const t=e.encounter.enemy,n=D(s),r=D(t),a=n/r,o=Math.min(.85,.5*a);return Math.random()<o?(e.encounter.enemyFleeing=!1,{success:!0,message:`You catch up to the fleeing ${t.name}!`}):{success:!0,message:`The ${t.name} escapes into the distance.`,encounterEnded:!0}}},Rs={id:"let-go",name:"Let Go",description:"Allow the enemy to escape.",tickCost:50,tags:["combat"],execute:(s,e)=>e!=null&&e.encounter?{success:!0,message:`You let the ${e.encounter.enemy.name} flee.`,encounterEnded:!0}:{success:!1,message:"Nothing to let go."}},Ps={id:"exit-location",name:"Exit Location",description:"Leave the current location through a discovered exit.",tickCost:100,tags:["basic","exploration","movement","non-combat","location"],execute:(s,e)=>{var n,r,a;if((n=e==null?void 0:e.game)!=null&&n.structures.has("campfire"))return{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."};if(((r=e==null?void 0:e.game)==null?void 0:r.currentLocation)===null)return{success:!1,message:"You are already in the wilderness."};if(!((a=e==null?void 0:e.game)!=null&&a.foundExit))return{success:!1,message:"You haven't found a way out yet. Keep exploring!"};const t=S(e.game.currentLocation);return{success:!0,message:`You make your way out of ${(t==null?void 0:t.name)??"the location"}...`}}};function xs(s,e){return{id:`enter-location-${s}`,name:`Enter ${e}`,description:`Enter the ${e}.`,tickCost:150,tags:["basic","exploration","movement","non-combat","location"],execute:(t,n)=>{var r;return(r=n==null?void 0:n.game)!=null&&r.structures.has("campfire")?{success:!1,message:"You can't leave with a campfire burning! Pick it up or smother it first."}:{success:!0,message:`You prepare to enter ${e}...`}}}}const Os=[Is,Hs,Ts,qs,Ds,Rs],Ns=[rs,is,os,cs],Gs=[ls,us,ds,ms,fs,hs,gs,ps,ys,vs,ks,bs,Cs,ws,Ls],Ys=[As,$s,Bs],_s=[Ss,Ms,Es],js=[Ps],Fs=[ns,as,...Os,...Ns,...Gs,...Ys,..._s,...js],Us=1e4,Ws=100,Qs=100,Ks=15,Vs={vitality:5,strength:5,agility:5,precision:5,endurance:3,arcane:0,luck:2};function Xs(){return Ee("player","Player",{maxTicks:Us,speed:Ws,maxHealth:Qs,damage:Ks,actions:Fs,stats:Vs,level:0})}function zs(s){const e=s.damage,t=Math.floor(e*.3),n=Math.max(1,e-t),r=e+t,a=rt(s.levelInfo.stats);return n+a+Math.floor(Math.random()*(r-n+1))}function Js(s,e=1,t=null){return{enemy:s??ts(e,t),playerFleeing:!1,enemyFleeing:!1,ended:!1,projectilesUsed:{arrows:{hit:0,dodged:0,blocked:0,missed:0},rocks:{hit:0,dodged:0,blocked:0,missed:0}}}}function O(s,e){s.ended=!0,s.result=e}function Zs(s,e){const t=s.enemy,n=F(t);if(s.playerFleeing)return nn(s,e);if(s.enemyFleeing)return sn(s,e);const r=t.health/t.maxHealth,a=(n==null?void 0:n.fleeThreshold)??.3,i=(n==null?void 0:n.aggressiveness)??.5;if(r<=a){const o=e.health/e.maxHealth,c=(1-i)*(1-o*.5);if(Math.random()<c)return tn(s)}return en(s,e)}function en(s,e){const t=s.enemy,n=zs(t),r=re(t),a=X(e),i=xt(e),o=Ot(e),c=K(t,e,n,{attackerWeaponAccuracy:r,defenderArmorPenalty:a,defenderBlockBonus:i,defenderShieldArmor:o});if(!c.hit&&!c.blocked)return{type:"attack",message:c.dodged?`You dodge the ${t.name}'s attack!`:`The ${t.name} attacks but misses!`,damage:0};if(c.blocked){const y=N(e),g=G(e),v=y+Math.floor(g/3),f=Y(c.damage,v);P(e,f);const p=c.critical?" (crit blocked!)":"";return H(e)?{type:"attack",message:`You block the ${t.name}'s attack, taking ${f} damage.${p} (${e.health}/${e.maxHealth} HP)`,damage:f}:{type:"attack",message:`You block the ${t.name}'s attack but take ${f} damage.${p} You have been defeated!`,damage:f,encounterEnded:!0}}const l=N(e),u=G(e),d=l+Math.floor(u/3),m=Y(c.damage,d);P(e,m);const h=c.critical?" Critical hit!":"";return H(e)?{type:"attack",message:`The ${t.name} strikes you for ${m} damage.${h} (${e.health}/${e.maxHealth} HP)`,damage:m}:{type:"attack",message:`The ${t.name} strikes you for ${m} damage.${h} You have been defeated!`,damage:m,encounterEnded:!0}}function tn(s){return s.enemyFleeing=!0,{type:"flee",message:`The ${s.enemy.name} turns to flee!`,fled:!1}}function sn(s,e){const t=s.enemy,n=D(t),r=D(e),a=n/r,o=Math.min(.9,.4*a);return Math.random()<o?{type:"flee",message:`The ${t.name} escapes!`,fled:!0,encounterEnded:!0}:(s.enemyFleeing=!1,{type:"flee",message:`The ${t.name} fails to escape and turns to fight!`,fled:!1})}function nn(s,e){const t=s.enemy,n=F(t),r=(n==null?void 0:n.aggressiveness)??.5,a=e.health/e.maxHealth,i=r+(1-a)*.3;if(Math.random()<i){const o=D(t),c=D(e),l=o/c,u=Math.min(.85,.5*l);return Math.random()<u?(s.playerFleeing=!1,{type:"chase",message:`The ${t.name} catches up to you!`}):{type:"chase",message:`The ${t.name} chases but you escape!`,encounterEnded:!0}}return{type:"chase",message:`The ${t.name} lets you flee.`,encounterEnded:!0}}function an(s,e){const t=s.enemy,n=t.speed*2;ee(t,n);const r=200;return t.ticks<r?null:(t.ticks-=r,Zs(s,e))}function rn(s,e,t){if(e.fled===!0&&(s.playerFleeing=!0),e.projectileUsed){const{type:n,outcome:r}=e.projectileUsed;n==="arrow"?s.projectilesUsed.arrows[r]++:n==="rock"&&s.projectilesUsed.rocks[r]++}e.encounterEnded&&(H(s.enemy)?s.playerFleeing||e.fled?O(s,"player_escaped"):s.enemyFleeing&&O(s,"enemy_escaped"):O(s,"victory"))}const fe={hit:1,blocked:.9,dodged:.7,missed:.6},on=.95,cn=.6,ln=.25;function un(s){const e=s.result==="enemy_escaped",{arrows:t,rocks:n}=s.projectilesUsed;let r=0,a=0;for(const[i,o]of Object.entries(t)){if(o<=0)continue;let c=cn*fe[i];e&&(c*=ln);for(let l=0;l<o;l++)Math.random()<c&&r++}for(const[i,o]of Object.entries(n)){if(o<=0)continue;const c=on*fe[i];for(let l=0;l<o;l++)Math.random()<c&&a++}return{arrows:r,rocks:a}}const he=2,dn=1,ge=500,pe=10,mn=.1;class fn{constructor(){x(this,"state");x(this,"listeners",new Map);this.state=this.createInitialState()}createInitialState(){return{player:Xs(),turn:0,log:[],encounter:null,availableNodes:[],structures:new Set,pendingLoot:null,pendingCorpse:null,gameOver:!1,currentLocation:null,locationStack:[],discoveredLocations:{},foundExit:!1}}restart(){this.state=this.createInitialState(),this.log("A new journey begins..."),this.emit("turn")}start(){this.log("Welcome to Iterra.")}performAction(e){if(this.state.gameOver)return!1;const t=this.state.player;if(this.state.encounter&&e.tags.includes("non-combat"))return this.log(`Cannot ${e.name.toLowerCase()} during an encounter!`),!1;if(!this.state.encounter&&e.tags.includes("combat"))return this.log(`No enemy to ${e.name.toLowerCase()}.`),!1;const n=this.getEffectiveTickCost(e);if(t.ticks<n)return this.log(`Not enough ticks for ${e.name}. Need ${n}, have ${t.ticks}.`),!1;Mt(t,n),e.tickGain&&ee(t,e.tickGain);const r={encounter:this.state.encounter??void 0,game:this.state},a=e.execute(t,r);if(this.state.turn++,this.log(a.message),a.foundResource){const i=a.foundResource;this.state.availableNodes.push({nodeId:i,distance:0})}if(a.foundLocation&&this.discoverLocation(a.foundLocation),a.foundExit&&this.findExit(),e.id==="exit-location"&&a.success&&this.exitLocation(),e.id.startsWith("enter-location-")&&a.success){const i=e.id.replace("enter-location-","");this.enterLocation(i)}return e.tags.includes("gathering")&&this.processResourceDepletion(e.id),e.tags.includes("harvesting")&&this.processCorpseCleanup(e.id),this.state.encounter?(rn(this.state.encounter,a),this.state.encounter.ended?this.endCurrentEncounter():this.processEnemyTurns()):(e.id==="wander"&&(this.processNodeDropOff(),this.processLocationDropOff()),e.id==="wander"&&!a.foundResource&&!a.foundLocation&&!a.foundExit?this.checkForEncounter(.25):e.tags.includes("combat")||this.checkForEncounter(.03)),this.processHunger(),this.processRegen(),this.processStarvation(),this.processPassOut(),this.emit("turn"),!0}processHunger(){const e=this.state.player,t=ht(e.levelInfo.stats);Math.random()<mn*(1-t)&&le(e,1)}processRegen(){const e=this.state.player;Bt(e)&&e.health<e.maxHealth&&(Et(e,he),le(e,dn),this.log(`You feel restored. (+${he} HP, ${e.health}/${e.maxHealth})`))}processStarvation(){const e=this.state.player;if(It(e)){const t=Ht();P(e,t),this.log(`You are starving! (-${t} HP, ${e.health}/${e.maxHealth})`),H(e)||(this.log("You have starved to death..."),this.triggerGameOver())}}canAffordAnyAction(){const e=this.getAvailableActions(),t=this.state.player;return e.some(n=>t.ticks>=this.getEffectiveTickCost(n))}processPassOut(){if(this.state.gameOver||this.canAffordAnyAction())return;const e=this.state.player;if(this.log("You collapse from exhaustion..."),P(e,pe),ee(e,ge),this.state.turn++,this.log(`You wake up weakened. (-${pe} HP, +${ge} ticks)`),!H(e)){this.log("You never wake up..."),this.triggerGameOver();return}this.state.encounter&&!this.state.encounter.ended&&(this.log(`The ${this.state.encounter.enemy.name} attacks while you're vulnerable!`),this.processEnemyTurns()),this.emit("turn")}triggerGameOver(){this.state.gameOver=!0,this.log("GAME OVER"),this.emit("game-over")}processResourceDepletion(e){var i;const n={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e];if(!n)return;const r=te(n);if(!r)return;const a=(i=this.state.availableNodes.map((o,c)=>({n:o,i:c})).filter(({n:o})=>o.nodeId===n).sort((o,c)=>o.n.distance-c.n.distance)[0])==null?void 0:i.i;a!==void 0&&Math.random()<r.depletionChance&&this.state.availableNodes.splice(a,1)}processNodeDropOff(){const e=[];for(let t=0;t<this.state.availableNodes.length;t++){const n=this.state.availableNodes[t],r=te(n.nodeId);if(!r)continue;const a=r.dropOffChance,i=1+n.distance*.1,o=Math.min(.5,a*i);Math.random()<o?e.push(t):n.distance++}for(let t=e.length-1;t>=0;t--)this.state.availableNodes.splice(e[t],1)}processLocationDropOff(){for(const[e,t]of Object.entries(this.state.discoveredLocations)){const n=S(e);if(!n||(n.parentId??null)!==this.state.currentLocation)continue;const a=[],i=.08;for(let o=0;o<t.entrances.length;o++){const c=t.entrances[o],l=1+c.distance*.15,u=Math.min(.4,i*l);Math.random()<u?a.push(o):c.distance++}for(let o=a.length-1;o>=0;o--)t.entrances.splice(a[o],1);t.entrances.length===0&&delete this.state.discoveredLocations[e]}}processCorpseCleanup(e){const t=this.state.pendingCorpse;if(!t)return;if(e==="leave-corpse"){this.state.pendingCorpse=null;return}const n=W(t.enemyId),r=Q(t.enemyId),a=!n||t.butchered,i=!r||t.skinned;a&&i&&(this.state.pendingCorpse=null)}checkForEncounter(e=.25){this.getCurrentLocation().isSafe||Math.random()<e&&this.startEncounter()}startEncounter(e){const t=this.state.player.levelInfo.level,n=this.state.currentLocation,r=Js(e,t,n);this.state.encounter=r;const a=r.enemy.levelInfo.level,i=a>1?` (Lv.${a})`:"";this.log(`A wild ${r.enemy.name}${i} appears!`),this.emit("encounter-start")}processEnemyTurns(){if(!this.state.encounter||this.state.encounter.ended)return;const e=this.state.encounter,t=this.state.player,n=an(e,t);n&&(this.log(n.message),n.encounterEnded&&(H(t)?n.fled?O(e,"enemy_escaped"):e.playerFleeing&&O(e,"player_escaped"):O(e,"defeat"),this.endCurrentEncounter()))}endCurrentEncounter(){if(!this.state.encounter)return;const e=this.state.encounter.result,t=this.state.encounter.enemy,n=this.state.player;switch(e){case"victory":this.log(`You defeated the ${t.name}!`);const r=ss(t,n.levelInfo.level),{levelsGained:a,autoStats:i}=st(n.levelInfo,r);if(this.log(`+${r} XP`),a>0){if(ce(n),this.log(`LEVEL UP! You are now level ${n.levelInfo.level}!`),i.length>0){const o={};for(const l of i)o[l]=(o[l]||0)+1;const c=Object.entries(o).map(([l,u])=>`+${u} ${Z[l]}`).join(", ");this.log(`Auto stats: ${c}`)}n.levelInfo.freeStatPoints>0&&this.log(`You have ${n.levelInfo.freeStatPoints} stat points to allocate!`),this.emit("level-up")}this.handleEnemyDeath(t),this.recoverProjectiles();break;case"defeat":this.log("You have been defeated..."),this.state.encounter=null,this.triggerGameOver();return;case"player_escaped":this.log("You escaped safely.");break;case"enemy_escaped":this.log(`The ${t.name} got away.`),this.recoverProjectiles();break}this.state.encounter=null,this.emit("encounter-end")}handleEnemyDeath(e){const t=F(e);if(t!=null&&t.usesInventory){this.setPendingLoot(e);return}const n=W(e.id),r=Q(e.id);if(n||r){this.state.pendingCorpse={enemyId:e.id,enemyName:e.name,butchered:!1,skinned:!1};const a=[];n&&a.push("butchered"),r&&a.push("skinned"),this.log(`The ${e.name}'s corpse can be ${a.join(" and ")}.`)}}recoverProjectiles(){if(!this.state.encounter)return;const e=un(this.state.encounter),t=this.state.player,n=[];e.arrows>0&&(E(t,"arrow",e.arrows),n.push(`${e.arrows} arrow${e.arrows>1?"s":""}`)),e.rocks>0&&(E(t,"rocks",e.rocks),n.push(`${e.rocks} rock${e.rocks>1?"s":""}`)),n.length>0&&this.log(`Recovered: ${n.join(", ")}`)}setPendingLoot(e){const t=ne(this.state.player.levelInfo.stats),n=zt(e,t),r={};for(const[a,i]of Object.entries(n))i>0&&(r[a]=i);if(Object.keys(r).length>0){this.state.pendingLoot=r;const a=Object.entries(r).map(([i,o])=>{const c=b(i);return`${o} ${(c==null?void 0:c.name)??i}`});this.log(`Loot available: ${a.join(", ")}`)}}takeLoot(e,t=1){if(!this.state.pendingLoot||!this.state.pendingLoot[e])return!1;const n=this.state.pendingLoot[e],r=Math.min(t,n);E(this.state.player,e,r),this.state.pendingLoot[e]-=r,this.state.pendingLoot[e]<=0&&delete this.state.pendingLoot[e],Object.keys(this.state.pendingLoot).length===0&&(this.state.pendingLoot=null);const a=b(e);return this.log(`Took ${r} ${(a==null?void 0:a.name)??e}.`),this.emit("turn"),!0}takeAllLoot(){if(this.state.pendingLoot){for(const[e,t]of Object.entries(this.state.pendingLoot))E(this.state.player,e,t);this.log("Took all loot."),this.state.pendingLoot=null,this.emit("turn")}}leaveLoot(){this.state.pendingLoot&&(this.log("Left the loot behind."),this.state.pendingLoot=null,this.emit("turn"))}dropItem(e,t=1){const n=this.state.player,r=w(n,e);if(r<=0)return!1;const a=Math.min(t,r);n.inventory[e]-=a,n.inventory[e]<=0&&delete n.inventory[e];const i=b(e);return this.log(`Dropped ${a} ${(i==null?void 0:i.name)??e}.`),this.emit("turn"),!0}equip(e,t){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const n=this.state.player,r=b(e);return r?Dt(n,e,t)?(this.log(`Equipped ${r.name}.`),this.emit("turn"),!0):(this.log(`Cannot equip ${r.name}.`),!1):!1}unequip(e){if(this.state.encounter)return this.log("Can't change equipment during combat!"),!1;const t=this.state.player,n=t.equipment[e];if(!n)return!1;const r=b(n);return U(t,e)?(this.log(`Unequipped ${(r==null?void 0:r.name)??n}.`),this.emit("turn"),!0):!1}allocateStat(e){const t=this.state.player;return at(t.levelInfo,e)?(ce(t),this.log(`+1 ${Z[e]}!`),this.emit("turn"),!0):(this.log("No stat points available."),!1)}log(e){const t={turn:this.state.turn,message:e};this.state.log.unshift(t),this.state.log.length>100&&this.state.log.pop(),this.emit("log")}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){var n;(n=this.listeners.get(e))==null||n.delete(t)}emit(e){var t;(t=this.listeners.get(e))==null||t.forEach(n=>n(this))}getAvailableActions(){var l;let e=[...this.state.player.actions];const t=this.getEnterableLocations();for(const u of t)e.push(xs(u.id,u.name));const n=this.state.encounter!==null,r=((l=this.state.encounter)==null?void 0:l.enemyFleeing)??!1,a=this.state.player,i={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"},o={"eat-berries":"berries","eat-cooked-meat":"cookedMeat","eat-raw-meat":"rawMeat"},c={"craft-campfire":{requiresItems:{sticks:5,rocks:3}},"place-campfire":{requiresNoCampfire:!0,requiresItems:{campfire:1}},"pickup-campfire":{requiresCampfire:!0},"smother-campfire":{requiresCampfire:!0},"cook-meat":{requiresCampfire:!0,requiresItems:{rawMeat:1}},"craft-stone-knife":{requiresItems:{rocks:2,sticks:1}},"craft-stone-spear":{requiresItems:{rocks:1,sticks:3,fiber:2}},"craft-bow":{requiresItems:{sticks:3,fiber:5}},"craft-arrows":{requiresItems:{sticks:2,rocks:1}},"craft-wooden-shield":{requiresItems:{sticks:6,fiber:3}},"process-leather":{requiresCampfire:!0,requiresItems:{rawLeather:2}},"craft-leather-helm":{requiresItems:{leather:2}},"craft-leather-chest":{requiresItems:{leather:4}},"craft-leather-legs":{requiresItems:{leather:3}},"craft-leather-boots":{requiresItems:{leather:2}}};return e.filter(u=>{var y;if(n&&u.tags.includes("non-combat")||!n&&u.tags.includes("combat")||u.id==="chase"&&!r||u.id==="let-go"&&!r||u.id==="flee"&&((y=this.state.encounter)!=null&&y.playerFleeing))return!1;const d=i[u.id];if(d&&!this.state.availableNodes.some(g=>g.nodeId===d))return!1;const m=o[u.id];if(m&&w(a,m)<=0)return!1;const h=c[u.id];if(h){if(h.requiresCampfire&&!this.state.structures.has("campfire")||h.requiresNoCampfire&&this.state.structures.has("campfire"))return!1;if(h.requiresItems){for(const[g,v]of Object.entries(h.requiresItems))if(w(a,g)<v)return!1}}if(u.id==="throw-rock"&&w(a,"rocks")<=0||u.id==="ranged-attack"&&(a.equipment.mainHand!=="bow"||w(a,"arrow")<=0)||u.id==="wander"&&this.state.structures.has("campfire"))return!1;if(u.tags.includes("harvesting")){const g=this.state.pendingCorpse;if(!g||u.id==="butcher"&&(!W(g.enemyId)||g.butchered)||u.id==="skin"&&(!Q(g.enemyId)||g.skinned))return!1}return!(u.id==="exit-location"&&(this.state.currentLocation===null||!this.state.foundExit||this.state.structures.has("campfire"))||u.id.startsWith("enter-location-")&&this.state.structures.has("campfire"))})}filterActions(e){const t=this.getAvailableActions(),n=e.toLowerCase().trim();let r=t;return n&&(r=t.filter(a=>{const i=a.name.toLowerCase().includes(n),o=a.description.toLowerCase().includes(n),c=a.tags.some(l=>l.toLowerCase().includes(n));return i||o||c})),this.sortActionsByPriority(r)}getActionPriority(e){var o;const t=this.state.player,n=this.state.encounter!==null,r=((o=this.state.encounter)==null?void 0:o.enemyFleeing)??!1;let a=0;if(n)return e.id==="attack"&&(a+=100),e.id==="flee"&&(a+=80),e.id==="ranged-attack"&&t.equipment.mainHand==="bow"&&(a+=95),e.id==="throw-rock"&&(a+=70),e.id==="chase"&&r&&(a+=90),e.id==="let-go"&&r&&(a+=60),a;const i=t.saturation/t.maxSaturation;if(e.tags.includes("consumption")&&(i<.3?a+=100:i<.5?a+=80:a+=30),e.id==="idle"){a+=40;const c=t.ticks/t.maxTicks;c<.1?a+=80:c<.2?a+=50:c<.3&&(a+=30)}if(e.id==="wander"&&(a+=60),e.tags.includes("gathering")&&(a+=50),e.tags.includes("harvesting")&&(e.id==="butcher"||e.id==="skin"?a+=90:e.id==="leave-corpse"&&(a+=20)),e.tags.includes("crafting"))if(e.id==="craft-arrows"&&t.equipment.mainHand==="bow"){const c=w(t,"arrow");c<5?a+=85:c<15?a+=60:a+=25}else e.id==="cook-meat"?a+=70:e.id==="process-leather"?a+=55:e.id==="craft-stone-knife"||e.id==="craft-stone-spear"||e.id==="craft-bow"?t.equipment.mainHand?a+=25:a+=75:e.id.startsWith("craft-leather-")?a+=45:e.id==="craft-wooden-shield"?t.equipment.offHand?a+=20:a+=55:e.id==="craft-campfire"?w(t,"campfire")===0&&!this.state.structures.has("campfire")?a+=50:a+=5:e.id==="place-campfire"?a+=55:e.id==="pickup-campfire"?a+=15:e.id==="smother-campfire"?a+=10:a+=30;return a}sortActionsByPriority(e){return[...e].sort((t,n)=>{const r=this.getActionPriority(t);return this.getActionPriority(n)-r})}getGroupedActions(){const e=this.sortActionsByPriority(this.getAvailableActions());if(this.state.encounter!==null)return[{category:"Combat",actions:e}];const n={Suggested:[],Harvest:[],Explore:[],Gather:[],Eat:[],Craft:[],Other:[]},r=e.slice(0,3);n.Suggested=r;for(const a of e)a.id==="idle"||a.id==="wander"||a.id==="exit-location"||a.id.startsWith("enter-location-")?n.Explore.push(a):a.tags.includes("harvesting")?n.Harvest.push(a):a.tags.includes("gathering")?n.Gather.push(a):a.tags.includes("consumption")?n.Eat.push(a):a.tags.includes("crafting")?n.Craft.push(a):n.Other.push(a);return Object.entries(n).filter(([a,i])=>i.length>0).map(([a,i])=>({category:a,actions:i}))}discoverLocation(e){const t=S(e);t&&(this.state.discoveredLocations[e]?this.state.discoveredLocations[e].entrances.push({distance:0}):this.state.discoveredLocations[e]={locationId:e,entrances:[{distance:0}]},this.log(t.discoveryMessage),this.emit("location-discovered"))}enterLocation(e){const t=S(e);if(!t)return this.log("Unknown location."),!1;const n=this.state.discoveredLocations[e];return!n||n.entrances.length===0?(this.log(`You haven't found an entrance to ${t.name}.`),!1):t.parentId!==(this.state.currentLocation??void 0)?(this.log(`You can't reach ${t.name} from here.`),!1):(n.entrances.sort((r,a)=>r.distance-a.distance),n.entrances.shift(),n.entrances.length===0&&delete this.state.discoveredLocations[e],this.state.currentLocation!==null&&this.state.locationStack.push(this.state.currentLocation),this.state.currentLocation=e,this.state.foundExit=!1,this.state.availableNodes=[],this.log(`You enter ${t.name}.`),this.emit("location-entered"),!0)}exitLocation(){if(this.state.currentLocation===null)return this.log("You are already in the wilderness."),!1;if(!this.state.foundExit)return this.log("You haven't found a way out yet. Keep exploring!"),!1;const e=S(this.state.currentLocation),t=this.state.locationStack.pop()??null;if(this.state.currentLocation=t,this.state.foundExit=!1,this.state.availableNodes=[],t===null)this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to the wilderness.`);else{const n=S(t);this.log(`You exit ${(e==null?void 0:e.name)??"the location"} and return to ${(n==null?void 0:n.name)??"the previous area"}.`)}return this.emit("location-exited"),!0}findExit(){if(this.state.currentLocation===null)return;this.state.foundExit=!0;const e=S(this.state.currentLocation);this.log(`You find an exit from ${(e==null?void 0:e.name)??"this location"}!`),this.emit("exit-found")}getCurrentLocation(){if(this.state.currentLocation===null)return{id:null,name:"Wilderness",isSafe:!1};const e=S(this.state.currentLocation);return{id:this.state.currentLocation,name:(e==null?void 0:e.name)??"Unknown",isSafe:(e==null?void 0:e.isSafe)??!1}}getAvailableNodeInfo(e){const t=this.state.availableNodes.filter(r=>r.nodeId===e);if(t.length===0)return null;const n=Math.min(...t.map(r=>r.distance));return{count:t.length,closestDistance:n}}getEffectiveTickCost(e){const t=e.tickCost,n=50,a={"gather-berries":"berryBush","gather-sticks":"fallenBranches","gather-rocks":"rockyOutcrop","gather-fiber":"tallGrass"}[e.id];if(a){const i=this.getAvailableNodeInfo(a);if(i)return t+i.closestDistance*n}if(e.id.startsWith("enter-location-")){const i=e.id.replace("enter-location-",""),c=this.getEnterableLocations().find(l=>l.id===i);if(c)return t+c.closestDistance*n}return t}getEnterableLocations(){const e=[];for(const[t,n]of Object.entries(this.state.discoveredLocations)){if(n.entrances.length===0)continue;const r=S(t);if(!r||(r.parentId??null)!==this.state.currentLocation)continue;const i=Math.min(...n.entrances.map(o=>o.distance));e.push({id:t,name:r.name,entrances:n.entrances.length,closestDistance:i})}return e}}class hn{constructor(e){x(this,"game");x(this,"actionGroupState",new Map);x(this,"elements");this.game=e,this.elements={levelCount:document.getElementById("level-count"),xpCount:document.getElementById("xp-count"),xpNext:document.getElementById("xp-next"),tickCount:document.getElementById("tick-count"),turnCount:document.getElementById("turn-count"),healthCount:document.getElementById("health-count"),maxHealth:document.getElementById("max-health"),saturationCount:document.getElementById("saturation-count"),maxSaturation:document.getElementById("max-saturation"),weightCount:document.getElementById("weight-count"),maxWeight:document.getElementById("max-weight"),characterStatsList:document.getElementById("character-stats-list"),freePointsDisplay:document.getElementById("free-points-display"),equipmentList:document.getElementById("equipment-list"),inventoryList:document.getElementById("inventory-list"),structuresPanel:document.getElementById("structures-panel"),structuresList:document.getElementById("structures-list"),lootPanel:document.getElementById("loot-panel"),lootList:document.getElementById("loot-list"),takeAllLoot:document.getElementById("take-all-loot"),leaveLoot:document.getElementById("leave-loot"),actionSearch:document.getElementById("action-search"),actionsList:document.getElementById("actions-list"),gameLog:document.getElementById("game-log"),encounterPanel:document.getElementById("encounter-panel"),enemyName:document.getElementById("enemy-name"),enemyHealth:document.getElementById("enemy-health"),enemyMaxHealth:document.getElementById("enemy-max-health"),encounterStatus:document.getElementById("encounter-status"),gameOverPanel:document.getElementById("game-over-panel"),restartButton:document.getElementById("restart-button"),skillsList:document.getElementById("skills-list"),locationPanel:document.getElementById("location-panel"),locationIcon:document.getElementById("location-icon"),locationName:document.getElementById("location-name"),locationDetails:document.getElementById("location-details"),exitStatus:document.getElementById("exit-status"),discoveredLocations:document.getElementById("discovered-locations")},this.setupEventListeners(),this.subscribeToGame()}setupEventListeners(){this.elements.actionSearch.addEventListener("input",()=>{this.renderActions()}),this.elements.restartButton.addEventListener("click",()=>{this.game.restart(),this.elements.gameOverPanel.classList.add("hidden"),this.render()}),this.elements.takeAllLoot.addEventListener("click",()=>{this.game.takeAllLoot()}),this.elements.leaveLoot.addEventListener("click",()=>{this.game.leaveLoot()}),document.addEventListener("keydown",e=>{e.key==="/"&&document.activeElement!==this.elements.actionSearch&&(e.preventDefault(),this.elements.actionSearch.focus()),e.key==="Escape"&&(this.elements.actionSearch.blur(),this.elements.actionSearch.value="",this.renderActions())}),document.querySelectorAll(".collapsible .section-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".collapsible");if(t){const n=t.querySelector(".section-content"),r=t.classList.toggle("collapsed"),a=e.querySelector(".toggle-icon");a&&(a.textContent=r?"":""),n&&(n.style.display=r?"none":"")}})}),window.matchMedia("(max-width: 600px)").matches&&document.querySelectorAll(".collapsed-mobile").forEach(e=>{e.classList.add("collapsed");const t=e.querySelector(".section-content"),n=e.querySelector(".toggle-icon");t&&(t.style.display="none"),n&&(n.textContent="")})}subscribeToGame(){this.game.on("turn",()=>{this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions()}),this.game.on("log",()=>this.renderLog()),this.game.on("level-up",()=>{this.renderStatus(),this.renderCharacterStats()}),this.game.on("encounter-start",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("encounter-end",()=>{this.renderEncounter(),this.renderActions()}),this.game.on("game-over",()=>{this.renderGameOver()}),this.game.on("location-entered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-exited",()=>{this.renderLocation(),this.renderActions()}),this.game.on("location-discovered",()=>{this.renderLocation(),this.renderActions()}),this.game.on("exit-found",()=>{this.renderLocation(),this.renderActions()})}renderGameOver(){this.elements.gameOverPanel.classList.remove("hidden")}render(){this.renderStatus(),this.renderCharacterStats(),this.renderSkills(),this.renderEquipment(),this.renderInventory(),this.renderStructures(),this.renderEncounter(),this.renderLoot(),this.renderLocation(),this.renderActions(),this.renderLog()}renderStatus(){const e=this.game.state.player,t=e.levelInfo;this.elements.levelCount.textContent=t.level.toString(),this.elements.xpCount.textContent=t.xp.toString(),this.elements.xpNext.textContent=t.xpToNextLevel.toString(),this.elements.tickCount.textContent=e.ticks.toString(),this.elements.turnCount.textContent=this.game.state.turn.toString(),this.elements.healthCount.textContent=e.health.toString(),this.elements.maxHealth.textContent=e.maxHealth.toString(),this.elements.saturationCount.textContent=e.saturation.toString(),this.elements.maxSaturation.textContent=e.maxSaturation.toString();const n=Ae(e),r=$e(e),a=r>0?"+":"";this.elements.weightCount.textContent=n.toFixed(1),this.elements.maxWeight.textContent=`${e.carryCapacity} (${a}${Math.round(r)} spd)`}renderCharacterStats(){const t=this.game.state.player.levelInfo,n=t.stats,r=t.freeStatPoints,a=this.game.state.encounter!==null;r>0?(this.elements.freePointsDisplay.textContent=`(${r} points)`,this.elements.freePointsDisplay.classList.add("has-points")):(this.elements.freePointsDisplay.textContent="",this.elements.freePointsDisplay.classList.remove("has-points"));let i="";for(const o of J){const c=n[o],l=Z[o],u=yt[o],d=r>0&&!a;i+=`
        <div class="stat-row">
          <span class="stat-name" title="${u}">${l}</span>
          <span class="stat-value">${c}</span>
          ${d?`<button class="allocate-btn" data-stat="${o}" title="Allocate point">+</button>`:""}
        </div>
      `}this.elements.characterStatsList.innerHTML=i,this.elements.characterStatsList.querySelectorAll(".allocate-btn").forEach(o=>{o.addEventListener("click",c=>{const l=c.target.getAttribute("data-stat");l&&this.game.allocateStat(l)})})}renderSkills(){const t=this.game.state.player.skills,n=ye.filter(a=>{const i=t[a];return i.level>0||i.xp>0}).sort((a,i)=>t[i].lastGainedAt-t[a].lastGainedAt);if(n.length===0){this.elements.skillsList.innerHTML='<div class="no-skills">No skills yet. Fight or craft to gain skills!</div>';return}let r="";for(const a of n){const i=t[a],o=je[a],c=Fe[a],l=i.xpToNextLevel>0?Math.floor(i.xp/i.xpToNextLevel*100):100;r+=`
        <div class="skill-row" title="${c}">
          <span class="skill-name">${o}</span>
          <span class="skill-level">${i.level}</span>
          <div class="skill-xp-bar">
            <div class="skill-xp-fill" style="width: ${l}%"></div>
          </div>
          <span class="skill-xp">${i.xp}/${i.xpToNextLevel}</span>
        </div>
      `}this.elements.skillsList.innerHTML=r}renderEquipment(){const e=this.game.state.player,t=e.equipment,n=this.game.state.encounter!==null,r=[{slot:"mainHand",label:"Main Hand"},{slot:"offHand",label:"Off Hand"},{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"}],a=Be(e),i=N(e),o=G(e),c=[];c.push(`${a.min}-${a.max} Dmg`),i>0&&c.push(`+${i} Armor`),o>0&&c.push(`+${o} Ranged`);let l="";c.length>0&&(l+=`<div class="equipment-bonuses">${c.join(" | ")}</div>`);const u=t.mainHand&&t.mainHand===t.offHand?t.mainHand:null;for(const{slot:d,label:m}of r){const h=t[d];if(d==="offHand"&&u)continue;const y=h?b(h):null,g=(y==null?void 0:y.name)??"Empty",f=(y==null?void 0:y.twoHanded)?"Both Hands":m;l+=`
        <div class="equipment-slot">
          <span class="slot-label">${f}:</span>
          <span class="slot-item">${g}</span>
          ${h&&!n?`<button class="unequip-btn" data-slot="${d}" title="Unequip"></button>`:""}
        </div>
      `}this.elements.equipmentList.innerHTML=l,this.elements.equipmentList.querySelectorAll(".unequip-btn").forEach(d=>{d.addEventListener("click",m=>{const h=m.target.getAttribute("data-slot");h&&this.game.unequip(h)})})}renderInventory(){const t=this.game.state.player.inventory,n=this.game.state.encounter!==null,r=Object.entries(t).filter(([a,i])=>i>0).map(([a,i])=>{const o=b(a),c=(o==null?void 0:o.name)??a,l=(o==null?void 0:o.equipSlot)&&!n;return`
          <div class="inventory-item">
            <span class="item-name">${c}: <span class="item-count">${i}</span></span>
            <div class="item-actions">
              ${l?`<button class="equip-btn" data-item-id="${a}" data-slot="${o.equipSlot}" title="Equip">E</button>`:""}
              <button class="drop-btn" data-item-id="${a}" title="Drop 1">-</button>
            </div>
          </div>
        `});r.length===0?this.elements.inventoryList.innerHTML='<span class="inventory-empty">Empty</span>':(this.elements.inventoryList.innerHTML=r.join(""),this.elements.inventoryList.querySelectorAll(".equip-btn").forEach(a=>{a.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id"),c=i.target.getAttribute("data-slot");o&&c&&this.game.equip(o,c)})}),this.elements.inventoryList.querySelectorAll(".drop-btn").forEach(a=>{a.addEventListener("click",i=>{const o=i.target.getAttribute("data-item-id");o&&this.game.dropItem(o,1)})}))}renderStructures(){const e=this.game.state.structures;if(e.size===0){this.elements.structuresPanel.classList.add("hidden");return}this.elements.structuresPanel.classList.remove("hidden");const t={campfire:"Campfire"},n=Array.from(e).map(r=>`<span class="structure-item">${t[r]??r}</span>`);this.elements.structuresList.innerHTML=n.join("")}renderLocation(){const e=this.game.getCurrentLocation(),t=this.game.state.foundExit,n=this.game.getEnterableLocations();if(this.elements.locationName.textContent=e.name,e.id===null?this.elements.locationIcon.textContent="":e.isSafe?this.elements.locationIcon.textContent="":this.elements.locationIcon.textContent="",e.id!==null||n.length>0)if(this.elements.locationDetails.classList.remove("hidden"),e.id!==null?t?this.elements.exitStatus.innerHTML='<span class="exit-found"> Exit found</span>':this.elements.exitStatus.innerHTML='<span class="exit-searching">Searching for exit...</span>':this.elements.exitStatus.innerHTML="",n.length>0){const a=n.map(i=>{const o=i.entrances>1?` (${i.entrances})`:"";return`<span class="discovered-location"> ${i.name}${o}</span>`}).join("");this.elements.discoveredLocations.innerHTML=a}else this.elements.discoveredLocations.innerHTML="";else this.elements.locationDetails.classList.add("hidden")}renderLoot(){const e=this.game.state.pendingLoot;if(!e){this.elements.lootPanel.classList.add("hidden");return}this.elements.lootPanel.classList.remove("hidden");const t=Object.entries(e).filter(([n,r])=>r>0).map(([n,r])=>{const a=b(n),i=(a==null?void 0:a.name)??n,o=(a==null?void 0:a.weight)??0;return`
          <div class="loot-item">
            <span class="item-name">${i}: ${r} (${(o*r).toFixed(1)} wt)</span>
            <button class="take-btn" data-item-id="${n}" title="Take 1">+</button>
          </div>
        `});this.elements.lootList.innerHTML=t.join(""),this.elements.lootList.querySelectorAll(".take-btn").forEach(n=>{n.addEventListener("click",r=>{const a=r.target.getAttribute("data-item-id");a&&this.game.takeLoot(a,1)})})}renderEncounter(){const e=this.game.state.encounter;if(!e){this.elements.encounterPanel.classList.add("hidden");return}this.elements.encounterPanel.classList.remove("hidden");const t=e.enemy;this.elements.enemyName.textContent=t.name,this.elements.enemyHealth.textContent=t.health.toString(),this.elements.enemyMaxHealth.textContent=t.maxHealth.toString();let n="";e.enemyFleeing?n="Enemy is fleeing!":e.playerFleeing&&(n="You are fleeing!"),this.elements.encounterStatus.textContent=n}renderActions(){const e=this.elements.actionSearch.value;if(e.trim()){const t=this.game.filterActions(e);this.elements.actionsList.innerHTML=t.map(n=>this.renderActionItem(n)).join("")}else{const t=this.game.getGroupedActions();this.elements.actionsList.innerHTML=t.map((n,r)=>{const a=r===0,i=this.actionGroupState.get(n.category),o=i!==void 0?i:a;return this.renderActionGroup(n.category,n.actions,o)}).join("")}this.elements.actionsList.querySelectorAll(".action-item").forEach(t=>{const n=t.getAttribute("data-action-id");t.addEventListener("click",()=>{const r=this.game.getAvailableActions().find(a=>a.id===n);r&&this.handleActionClick(r)})}),this.elements.actionsList.querySelectorAll(".action-category-header").forEach(t=>{t.addEventListener("click",()=>{const n=t.getAttribute("data-category"),r=t.nextElementSibling,a=t.classList.toggle("collapsed");n&&this.actionGroupState.set(n,!a);const i=t.querySelector(".category-toggle");i&&(i.textContent=a?"":""),r&&(r.style.display=a?"none":"flex")})})}renderActionGroup(e,t,n=!0){const r=t.map(o=>this.renderActionItem(o)).join(""),a=n?"":"collapsed",i=n?"flex":"none";return`
      <div class="action-category">
        <div class="action-category-header ${a}" data-category="${e}">
          <span class="category-toggle">${n?"":""}</span>
          <span class="category-name">${e}</span>
          <span class="category-count">${t.length}</span>
        </div>
        <div class="action-category-content" style="display: ${i}">
          ${r}
        </div>
      </div>
    `}renderActionItem(e){const t=this.game.state.player,n=this.game.getEffectiveTickCost(e),r=t.ticks>=n,a=n>e.tickCost;let i;if(e.tickGain&&n){const c=e.tickGain-n;i=`${n} cost, +${c} net`}else e.tickGain?i=`+${e.tickGain} ticks`:i=`${n} ticks`;return`
      <div class="action-item ${r?"":"disabled"}${a?" has-distance":""}" data-action-id="${e.id}">
        <div class="action-info">
          <span class="action-name">${e.name}</span>
        </div>
        <span class="action-cost ${r?"affordable":""}">${i}</span>
      </div>
    `}handleActionClick(e){this.game.performAction(e)}renderLog(){const e=this.game.state.log.slice(0,20);this.elements.gameLog.innerHTML=e.map(t=>`
        <div class="log-entry">
          <span class="timestamp">[${t.turn}]</span>
          ${t.message}
        </div>
      `).join("")}}const oe=new fn,gn=new hn(oe);gn.render();oe.start();window.game=oe;
